<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Fitness | Admin – Nutrición</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; background-color: #0a0a0a; color: #e5e7eb; }
    .navbar { background-color: #111827; }
    .navbar-brand { color: #3b82f6 !important; font-weight: 700; }
    .card { background:#111827; border-radius: 12px; }
    .form-label { color:#9ca3af; }
    .form-control, .form-select, textarea { background:#0f172a; color:#e5e7eb; border-color:#1f2937; }
    .form-control:focus, .form-select:focus, textarea:focus { border-color:#3b82f6; box-shadow: 0 0 0 .2rem rgba(59,130,246,.25); }
    .muted { color:#9ca3af; }
    .list-group-item { background:#111827; color:#e5e7eb; cursor:pointer; }
    .badge-active { background:#10b981; }
    pre { background:#0f172a; color:#e5e7eb; padding:10px; border-radius:8px; overflow:auto; }
  </style>
  <meta name="robots" content="noindex,nofollow"/>
  <meta name="referrer" content="no-referrer"/>
  <meta http-equiv="Cache-Control" content="no-store"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <meta http-equiv="Expires" content="0"/>
</head>
<body>
  <nav class="navbar navbar-expand-lg">
    <div class="container">
      <a class="navbar-brand" href="/">AI Fitness</a>
      <div class="d-flex align-items-center">
        <!--<a href="/about" class="btn btn-outline-light btn-sm me-2">Acerca de</a>-->
        <div class="dropdown">
          <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" id="adminMenuBtn" data-bs-toggle="dropdown" aria-expanded="false">
            Admin
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="adminMenuBtn">
            <li><a class="dropdown-item" href="/admin/plans">Planes (Entrenamiento)</a></li>
            <li><a class="dropdown-item" href="/admin/meal_plans">Meal Plans (Nutrición)</a></li>
          </ul>
        </div>
      </div>
    </div>
  </nav>

  <main class="container py-4">
    <h2 class="mb-3">Planes de nutrición (Admin)</h2>
    <p class="muted mb-4">Busca y gestiona meal_plans por usuario. Requiere token de administrador.</p>

    <div class="row g-4">
      <div class="col-lg-4">
        <div class="card">
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label">Admin Token</label>
              <input id="adminToken" type="password" class="form-control" placeholder="Token admin">
              <div class="form-text">Se envía en cabecera X-Admin-Token.</div>
            </div>
            <div class="mb-3">
              <label class="form-label">Usuario</label>
              <input id="adminUserId" type="text" class="form-control" placeholder="user_id o username/email (si está logueado)">
            </div>
            <div class="d-grid">
              <button id="btnSearchPlans" class="btn btn-primary">Buscar planes</button>
            </div>
            <div id="adminMsg" class="mt-3 text-info"></div>
            <hr/>
            <h6 class="mb-2">Meal plans</h6>
            <ul id="adminPlanList" class="list-group list-group-flush"></ul>
          </div>
        </div>
      </div>

      <div class="col-lg-8">
        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Editar meal_plan</h5>
              <span id="adminPlanActiveBadge" class="badge" style="display:none;">Activo</span>
            </div>
            <small id="adminPlanMeta" class="muted"></small>
            <hr/>

            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Backend</label>
                <input id="fBackend" type="text" class="form-control" placeholder="backend" readonly>
              </div>
              <div class="col-md-6">
                <label class="form-label">Plan ID (vinculado)</label>
                <input id="fPlanId" type="text" class="form-control" placeholder="plan_id">
              </div>

              <div class="col-12">
                <label class="form-label">Notas</label>
                <input id="fNotes" type="text" class="form-control" placeholder="Notas opcionales">
              </div>

              <div class="col-12">
                <label class="form-label">Output JSON</label>
                <textarea id="fOutput" class="form-control" rows="14" placeholder="JSON del output"></textarea>
                <div class="form-text">Puedes editar el JSON completo del output. Debe ser válido.</div>
              </div>
            </div>

            <div class="d-flex gap-2 mt-3">
              <button id="btnSavePlan" class="btn btn-success">Guardar cambios</button>
              <button id="btnReloadPlan" class="btn btn-outline-light">Recargar</button>
              <button id="btnActivatePlan" class="btn btn-outline-info">Activar</button>
              <button id="btnDeactivatePlan" class="btn btn-outline-warning">Desactivar</button>
              <button id="btnDeletePlan" class="btn btn-outline-danger">Borrar</button>
            </div>
            <div id="adminSaveMsg" class="mt-2 text-info"></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    (function(){
      let currentPlan = null;

      function resolveUserId(input) {
        const typed = (input || '').trim();
        try {
          const raw = localStorage.getItem('ai_fitness_user');
          if (raw) {
            const u = JSON.parse(raw);
            const loggedId = String(u.user_id || u._id || '').trim();
            const uname = (u.username || '').trim();
            const email = (u.email || '').trim().toLowerCase();
            if (!typed || typed === uname || typed.toLowerCase() === email) {
              return loggedId || typed;
            }
          }
        } catch(e) {}
        return typed;
      }

      async function loadPlans(){
        const msg = document.getElementById('adminMsg');
        const list = document.getElementById('adminPlanList');
        const uid = resolveUserId(document.getElementById('adminUserId').value);
        if(!uid){ msg.textContent = 'Ingresa un user_id'; return; }
        msg.textContent = 'Buscando meal_plans...'; list.innerHTML = '';
        try{
          const resp = await fetch(`/meal_plans/${encodeURIComponent(uid)}?limit=50`);
          if(!resp.ok){
            const err = await resp.json().catch(()=>({error:'Error desconocido'}));
            throw new Error(err.error || `HTTP ${resp.status}`);
          }
          const rows = await resp.json();
          msg.textContent = rows.length ? '' : 'Sin meal_plans';
          const frag = document.createDocumentFragment();
          rows.forEach(p => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-start';
            const left = document.createElement('div');
            const ts = (p.created_at || '').toString().replace('T',' ').replace('Z','');
            left.innerHTML = `<div><strong>${p._id}</strong></div><small class="muted">${ts}</small>`;
            const right = document.createElement('div');
            if(p.active){ const b = document.createElement('span'); b.className='badge badge-active'; b.textContent='Activo'; right.appendChild(b); }
            li.appendChild(left); li.appendChild(right);
            li.addEventListener('click', ()=> renderPlan(p));
            frag.appendChild(li);
          });
          list.appendChild(frag);
          if(rows[0]) renderPlan(rows[0]);
        }catch(e){ msg.textContent = `Error: ${e.message}`; }
      }

      function renderPlan(p){
        currentPlan = p;
        document.getElementById('adminPlanMeta').textContent = `user_id: ${p.user_id || '-'} · creado: ${(p.created_at||'').toString().replace('T',' ').replace('Z','')} · id: ${p._id}`;
        const badge = document.getElementById('adminPlanActiveBadge');
        badge.style.display = p.active ? 'inline-block' : 'none';
        document.getElementById('fBackend').value = (p.backend ?? '') || '';
        document.getElementById('fPlanId').value = (p.plan_id ?? '') || '';
        document.getElementById('fNotes').value = (p.notes ?? '') || '';
        try {
          document.getElementById('fOutput').value = JSON.stringify(p.output ?? {}, null, 2);
        } catch(e) {
          document.getElementById('fOutput').value = '';
        }
        document.getElementById('adminSaveMsg').textContent = '';
      }

      function collectChanges(){
        const body = { };
        const notes = document.getElementById('fNotes').value.trim();
        const planId = document.getElementById('fPlanId').value.trim();
        const out = document.getElementById('fOutput').value;
        if(notes !== '') body.notes = notes; else body.notes = null;
        if(planId !== '') body.plan_id = planId; else body.plan_id = null;
        if(out.trim() !== ''){
          try {
            body.output = JSON.parse(out);
          } catch(e) {
            throw new Error('Output JSON inválido');
          }
        }
        return body;
      }

      async function savePlan(){
        const msg = document.getElementById('adminSaveMsg');
        if(!currentPlan){ msg.textContent = 'Selecciona un meal_plan'; return; }
        const token = document.getElementById('adminToken').value.trim();
        if(!token){ msg.textContent = 'Ingresa Admin Token'; return; }
        let body;
        try { body = collectChanges(); } catch(e){ msg.textContent = `Error: ${e.message}`; return; }
        msg.textContent = 'Guardando...';
        try{
          const resp = await fetch(`/meal_plans/${encodeURIComponent(currentPlan._id)}/edit`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Admin-Token': token },
            body: JSON.stringify(body)
          });
          if(!resp.ok){
            const err = await resp.json().catch(()=>({error:'Error desconocido'}));
            throw new Error(err.error || `HTTP ${resp.status}`);
          }
          const updated = await resp.json();
          msg.textContent = 'Cambios guardados';
          if(updated && updated.meal_plan){ renderPlan(updated.meal_plan); }
        }catch(e){ msg.textContent = `Error: ${e.message}`; }
      }

      document.getElementById('btnSearchPlans').addEventListener('click', loadPlans);
      document.getElementById('btnSavePlan').addEventListener('click', savePlan);
      document.getElementById('btnReloadPlan').addEventListener('click', ()=>{ if(currentPlan) renderPlan(currentPlan); });

      document.getElementById('btnActivatePlan').addEventListener('click', async ()=>{
        const msg = document.getElementById('adminSaveMsg');
        if(!currentPlan){ msg.textContent = 'Selecciona un meal_plan'; return; }
        const token = document.getElementById('adminToken').value.trim();
        if(!token){ msg.textContent = 'Ingresa Admin Token'; return; }
        msg.textContent = 'Activando...';
        try{
          const resp = await fetch(`/meal_plans/${encodeURIComponent(currentPlan._id)}/activate`, { method:'POST', headers: { 'X-Admin-Token': token } });
          if(!resp.ok){ const err = await resp.json().catch(()=>({error:'Error desconocido'})); throw new Error(err.error || `HTTP ${resp.status}`); }
          msg.textContent = 'Meal plan activado';
          loadPlans();
        }catch(e){ msg.textContent = `Error: ${e.message}`; }
      });

      document.getElementById('btnDeactivatePlan').addEventListener('click', async ()=>{
        const msg = document.getElementById('adminSaveMsg');
        if(!currentPlan){ msg.textContent = 'Selecciona un meal_plan'; return; }
        const token = document.getElementById('adminToken').value.trim();
        if(!token){ msg.textContent = 'Ingresa Admin Token'; return; }
        msg.textContent = 'Desactivando...';
        try{
          const resp = await fetch(`/meal_plans/${encodeURIComponent(currentPlan._id)}/deactivate`, { method:'POST', headers: { 'X-Admin-Token': token } });
          if(!resp.ok){ const err = await resp.json().catch(()=>({error:'Error desconocido'})); throw new Error(err.error || `HTTP ${resp.status}`); }
          msg.textContent = 'Meal plan desactivado';
          loadPlans();
        }catch(e){ msg.textContent = `Error: ${e.message}`; }
      });

      document.getElementById('btnDeletePlan').addEventListener('click', async ()=>{
        const msg = document.getElementById('adminSaveMsg');
        if(!currentPlan){ msg.textContent = 'Selecciona un meal_plan'; return; }
        const token = document.getElementById('adminToken').value.trim();
        if(!token){ msg.textContent = 'Ingresa Admin Token'; return; }
        if(!confirm('¿Seguro que deseas borrar este meal_plan?')) return;
        msg.textContent = 'Borrando...';
        try{
          const resp = await fetch(`/meal_plans/${encodeURIComponent(currentPlan._id)}`, { method:'DELETE', headers: { 'X-Admin-Token': token } });
          if(!resp.ok){ const err = await resp.json().catch(()=>({error:'Error desconocido'})); throw new Error(err.error || `HTTP ${resp.status}`); }
          msg.textContent = 'Meal plan borrado';
          currentPlan = null;
          loadPlans();
        }catch(e){ msg.textContent = `Error: ${e.message}`; }
      });

      // Autorellenar usuario con el del login si existe
      window.addEventListener('DOMContentLoaded', ()=>{
        try{
          const raw = localStorage.getItem('ai_fitness_user');
          if(raw){
            const u = JSON.parse(raw);
            const display = (u.username || '').trim();
            if(display){ document.getElementById('adminUserId').value = display; }
          }
        }catch(e){}
      });
    })();
  </script>
</body>
</html>
