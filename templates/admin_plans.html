<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Fitness | Admin · Edición de Planes</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; background-color: #0a0a0a; color: #e5e7eb; }
    .navbar { background-color: #111827; }
    .navbar-brand { color: #3b82f6 !important; font-weight: 700; }
    .card { background:#111827; border-radius: 12px; }
    .form-label { color:#9ca3af; }
    .form-control, .form-select { background:#0f172a; color:#e5e7eb; border-color:#1f2937; }
    .form-control:focus, .form-select:focus { border-color:#3b82f6; box-shadow: 0 0 0 .2rem rgba(59,130,246,.25); }
    .muted { color:#9ca3af; }
    .list-group-item { background:#111827; color:#e5e7eb; }
    .badge-active { background:#10b981; }
  </style>
  <meta name="robots" content="noindex,nofollow"/>
  <meta name="referrer" content="no-referrer"/>
  <meta http-equiv="Cache-Control" content="no-store"/>
</head>
<body>
  <nav class="navbar navbar-expand-lg">
    <div class="container">
      <a class="navbar-brand" href="/">AI Fitness</a>
      <div class="d-flex align-items-center">
        <a href="/dashboard" class="btn btn-outline-light btn-sm me-2">Dashboard</a>
        <a href="/plan" class="btn btn-outline-light btn-sm me-2">Mi Plan</a>
        <a href="/about" class="btn btn-outline-light btn-sm me-2">Acerca de</a>
        <span class="badge bg-secondary">Admin</span>
      </div>
    </div>
  </nav>

  <main class="container py-4">
    <h2 class="mb-3">Edición ligera de planes (Admin)</h2>
    <p class="muted mb-4">Busca planes por usuario, edita notas y ajustes manuales. Requiere token de administrador.</p>

    <div class="row g-4">
      <div class="col-lg-4">
        <div class="card">
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label">Admin Token</label>
              <input id="adminToken" type="password" class="form-control" placeholder="Token admin">
              <div class="form-text">Se envía en cabecera X-Admin-Token.</div>
            </div>
            <div class="mb-3">
              <label class="form-label">Usuario</label>
              <input id="adminUserId" type="text" class="form-control" placeholder="user_id o username/email (si está logueado)">
            </div>
            <div class="d-grid">
              <button id="btnSearchPlans" class="btn btn-primary">Buscar planes</button>
            </div>
            <div id="adminMsg" class="mt-3 text-info"></div>
            <hr/>
            <h6 class="mb-2">Planes</h6>
            <ul id="adminPlanList" class="list-group list-group-flush"></ul>
          </div>
        </div>
      </div>

      <div class="col-lg-8">
        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Editar plan</h5>
              <span id="adminPlanActiveBadge" class="badge" style="display:none;">Activo</span>
            </div>
            <small id="adminPlanMeta" class="muted"></small>
            <hr/>

            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">Calorías/día</label>
                <input id="fCalories" type="number" class="form-control" placeholder="p.ej. 2300">
              </div>
              <div class="col-md-4">
                <label class="form-label">Delta kcal</label>
                <input id="fKcalDelta" type="number" class="form-control" placeholder="p.ej. -250">
              </div>
              <div class="col-md-4">
                <label class="form-label">Cardio</label>
                <input id="fCardio" type="text" class="form-control" placeholder="p.ej. 2x LISS 30'">
              </div>

              <div class="col-md-4">
                <label class="form-label">Objetivo (goal)</label>
                <select id="fGoal" class="form-select">
                  <option value="">(sin definir)</option>
                  <option value="gain_muscle">Ganar músculo</option>
                  <option value="lose_fat">Perder grasa</option>
                  <option value="maintain">Mantener</option>
                </select>
              </div>

              <div class="col-md-4">
                <label class="form-label">Proteína (g)</label>
                <input id="fProt" type="number" class="form-control" placeholder="p.ej. 160">
              </div>
              <div class="col-md-4">
                <label class="form-label">Carbohidratos (g)</label>
                <input id="fCarb" type="number" class="form-control" placeholder="p.ej. 250">
              </div>
              <div class="col-md-4">
                <label class="form-label">Grasas (g)</label>
                <input id="fFat" type="number" class="form-control" placeholder="p.ej. 70">
              </div>

              <div class="col-md-6">
                <label class="form-label">Volumen Δ</label>
                <input id="fVolumeDelta" type="number" step="0.01" class="form-control" placeholder="p.ej. -0.12">
              </div>
              <div class="col-12">
                <label class="form-label">Notas</label>
                <textarea id="fNotes" rows="4" class="form-control" placeholder="Notas internas o indicaciones del coach"></textarea>
              </div>
            </div>

            <div class="d-flex gap-2 mt-3">
              <button id="btnSavePlan" class="btn btn-success">Guardar cambios</button>
              <button id="btnReloadPlan" class="btn btn-outline-light">Revertir</button>
              <button id="btnDeactivatePlan" class="btn btn-warning">Desactivar</button>
              <button id="btnDeletePlan" class="btn btn-danger">Borrar</button>
            </div>
            <div id="adminSaveMsg" class="mt-2"></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    (function(){
      let currentPlan = null;

      function resolveUserId(input) {
        const typed = (input || '').trim();
        try {
          const raw = localStorage.getItem('ai_fitness_user');
          if (raw) {
            const u = JSON.parse(raw);
            const loggedId = String(u.user_id || u._id || '').trim();
            const uname = (u.username || '').trim();
            const email = (u.email || '').trim().toLowerCase();
            if (!typed || typed === uname || typed.toLowerCase() === email) {
              return loggedId || typed;
            }
          }
        } catch(e) {}
        return typed;
      }

      async function loadPlans(){
        const msg = document.getElementById('adminMsg');
        const list = document.getElementById('adminPlanList');
        const uid = resolveUserId(document.getElementById('adminUserId').value);
        if(!uid){ msg.textContent = 'Ingresa un user_id'; return; }
        msg.textContent = 'Buscando planes...'; list.innerHTML = '';
        try{
          const resp = await fetch(`/plans/${encodeURIComponent(uid)}?limit=50`);
          if(!resp.ok){
            const err = await resp.json().catch(()=>({error:'Error desconocido'}));
            throw new Error(err.error || `HTTP ${resp.status}`);
          }
          const rows = await resp.json();
          msg.textContent = rows.length ? '' : 'Sin planes';
          const frag = document.createDocumentFragment();
          rows.forEach(p => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-start';
            const left = document.createElement('div');
            const ts = (p.created_at || '').toString().replace('T',' ').replace('Z','');
            left.innerHTML = `<div><strong>${p._id}</strong></div><small class="muted">${ts}</small>`;
            const right = document.createElement('div');
            if(p.active){ const b = document.createElement('span'); b.className='badge badge-active'; b.textContent='Activo'; right.appendChild(b); }
            li.appendChild(left); li.appendChild(right);
            li.addEventListener('click', ()=> renderPlan(p));
            frag.appendChild(li);
          });
          list.appendChild(frag);
          if(rows[0]) renderPlan(rows[0]);
        }catch(e){ msg.textContent = `Error: ${e.message}`; }
      }

      function renderPlan(p){
        currentPlan = p;
        document.getElementById('adminPlanMeta').textContent = `user_id: ${p.user_id || '-'} · creado: ${(p.created_at||'').toString().replace('T',' ').replace('Z','')} · id: ${p._id}`;
        const badge = document.getElementById('adminPlanActiveBadge');
        badge.style.display = p.active ? 'inline-block' : 'none';
        const np = p.nutrition_plan || {}; const tr = p.training_plan || {}; const m = (np.macros || {});
        document.getElementById('fCalories').value = (np.calories_per_day ?? np.kcal_obj ?? '') || '';
        document.getElementById('fKcalDelta').value = (np.kcal_delta ?? '') || '';
        document.getElementById('fCardio').value = (tr.cardio ?? '') || '';
        document.getElementById('fProt').value = (m.protein ?? m.p ?? '') || '';
        document.getElementById('fCarb').value = (m.carbs ?? m.c ?? '') || '';
        document.getElementById('fFat').value = (m.fat ?? m.g ?? '') || '';
        document.getElementById('fVolumeDelta').value = (tr.ai_volumen_delta_ratio ?? '') || '';
        document.getElementById('fNotes').value = (p.notes ?? '') || '';
        document.getElementById('fGoal').value = (p.goal ?? '') || '';
        document.getElementById('adminSaveMsg').textContent = '';
      }

      function collectChanges(){
        const body = { };
        const np = {};
        const tr = {};
        const macros = {};
        const cal = document.getElementById('fCalories').value.trim();
        const kcald = document.getElementById('fKcalDelta').value.trim();
        const cardio = document.getElementById('fCardio').value.trim();
        const goal = document.getElementById('fGoal').value.trim();
        const p = document.getElementById('fProt').value.trim();
        const c = document.getElementById('fCarb').value.trim();
        const g = document.getElementById('fFat').value.trim();
        const vol = document.getElementById('fVolumeDelta').value.trim();
        const notes = document.getElementById('fNotes').value.trim();
        if(cal !== '') np.calories_per_day = Number(cal);
        if(kcald !== '') np.kcal_delta = Number(kcald);
        if(p !== '') macros.protein = Number(p);
        if(c !== '') macros.carbs = Number(c);
        if(g !== '') macros.fat = Number(g);
        if(Object.keys(macros).length) np.macros = macros;
        if(cardio !== '') tr.cardio = cardio;
        if(vol !== '') tr.ai_volumen_delta_ratio = Number(vol);
        if(Object.keys(np).length) body.nutrition_plan = np;
        if(Object.keys(tr).length) body.training_plan = tr;
        if(notes !== '') body.notes = notes; else body.notes = null;
        if(goal !== '') body.goal = goal; else body.goal = null;
        return body;
      }

      async function savePlan(){
        const msg = document.getElementById('adminSaveMsg');
        if(!currentPlan){ msg.textContent = 'Selecciona un plan'; return; }
        const token = document.getElementById('adminToken').value.trim();
        if(!token){ msg.textContent = 'Ingresa Admin Token'; return; }
        const body = collectChanges();
        msg.textContent = 'Guardando...';
        try{
          const resp = await fetch(`/plans/${encodeURIComponent(currentPlan._id)}/edit`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Admin-Token': token },
            body: JSON.stringify(body)
          });
          if(!resp.ok){
            const err = await resp.json().catch(()=>({error:'Error desconocido'}));
            throw new Error(err.error || `HTTP ${resp.status}`);
          }
          msg.textContent = 'Cambios guardados';
        }catch(e){ msg.textContent = `Error: ${e.message}`; }
      }

      document.getElementById('btnSearchPlans').addEventListener('click', loadPlans);
      document.getElementById('btnSavePlan').addEventListener('click', savePlan);
      document.getElementById('btnReloadPlan').addEventListener('click', ()=>{ if(currentPlan) renderPlan(currentPlan); });

      document.getElementById('btnDeactivatePlan').addEventListener('click', async ()=>{
        const msg = document.getElementById('adminSaveMsg');
        if(!currentPlan){ msg.textContent = 'Selecciona un plan'; return; }
        const token = document.getElementById('adminToken').value.trim();
        if(!token){ msg.textContent = 'Ingresa Admin Token'; return; }
        msg.textContent = 'Desactivando...';
        try{
          const resp = await fetch(`/plans/${encodeURIComponent(currentPlan._id)}/deactivate`, { method:'POST', headers: { 'X-Admin-Token': token } });
          if(!resp.ok){ const err = await resp.json().catch(()=>({error:'Error desconocido'})); throw new Error(err.error || `HTTP ${resp.status}`); }
          msg.textContent = 'Plan desactivado';
          loadPlans();
        }catch(e){ msg.textContent = `Error: ${e.message}`; }
      });

      document.getElementById('btnDeletePlan').addEventListener('click', async ()=>{
        const msg = document.getElementById('adminSaveMsg');
        if(!currentPlan){ msg.textContent = 'Selecciona un plan'; return; }
        const token = document.getElementById('adminToken').value.trim();
        if(!token){ msg.textContent = 'Ingresa Admin Token'; return; }
        if(!confirm('¿Seguro que deseas borrar este plan?')) return;
        msg.textContent = 'Borrando...';
        try{
          const resp = await fetch(`/plans/${encodeURIComponent(currentPlan._id)}`, { method:'DELETE', headers: { 'X-Admin-Token': token } });
          if(!resp.ok){ const err = await resp.json().catch(()=>({error:'Error desconocido'})); throw new Error(err.error || `HTTP ${resp.status}`); }
          msg.textContent = 'Plan borrado';
          currentPlan = null;
          loadPlans();
        }catch(e){ msg.textContent = `Error: ${e.message}`; }
      });

      // Autorellenar usuario con el del login si existe
      window.addEventListener('DOMContentLoaded', ()=>{
        try{
          const raw = localStorage.getItem('ai_fitness_user');
          if(raw){
            const u = JSON.parse(raw);
            const display = (u.username || '').trim();
            if(display){ document.getElementById('adminUserId').value = display; }
          }
        }catch(e){}
      });
    })();
  </script>
</body>
</html>
