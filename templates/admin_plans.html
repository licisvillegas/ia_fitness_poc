<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Fitness | Admin · Edición de Planes</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="/static/css/theme.css" rel="stylesheet">
  <link href="/static/css/sidebar.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
  <style>
    /* Theme overrides are handled by theme.css */

    .form-control:focus,
    .form-select:focus {
      background: var(--bg-input);
      color: var(--text-main);
      border-color: var(--primary);
      box-shadow: 0 0 0 .2rem rgba(59, 130, 246, .25);
    }

    .form-text {
      color: var(--text-secondary);
    }

    .badge-active {
      background: #10b981;
      color: var(--text-main)fff;
    }

    .action-toolbar {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .action-toolbar .action-buttons {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .action-toolbar .token-group {
      min-width: 220px;
      max-width: 260px;
    }

    @media (max-width: 768px) {
      .action-toolbar {
        flex-direction: column;
        align-items: stretch;
      }

      .action-toolbar .action-buttons {
        flex-wrap: wrap;
      }

      .action-toolbar .token-group {
        width: 100%;
        max-width: none;
      }

      .action-toolbar .ms-auto {
        width: 100%;
        justify-content: flex-start;
      }
    }
  </style>
  <meta name="robots" content="noindex,nofollow" />
  <meta name="referrer" content="no-referrer" />
  <meta http-equiv="Cache-Control" content="no-store" />
</head>

<body>
  {% include 'components/sidebar_admin.html' %}

  <div class="main-content">
    <!-- Navbar Removed -->

    <main class="container py-4">
      <h2 class="mb-3">Edición ligera de planes (Admin)</h2>
      <p class="muted mb-4">Busca planes por usuario, edita notas y ajustes manuales. Requiere token de administrador.
      </p>

      <div class="row g-4">
        <div class="col-lg-4">
          <div class="card">
            <div class="card-body">
              <div class="mb-3">
                <label class="form-label">Usuario</label>
                <div class="input-group">
                  <input type="text" class="form-control" id="userSearchTerm"
                    placeholder="Buscar: nombre, email o ID...">
                  <button class="btn btn-outline-secondary" type="button" id="btnLookupUser">
                    <i class="fas fa-search"></i>
                  </button>
                  <button class="btn btn-outline-secondary" type="button" id="btnClearUserSearch" title="Limpiar">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
                <!-- Hidden field for compatibility -->
                <input id="adminUserId" type="hidden">
                <div id="userSearchResults" class="list-group mt-1 position-absolute shadow-sm"
                  style="z-index: 1000; display: none; width: 90%;"></div>
              </div>
              <div class="d-grid">
                <button id="btnSearchPlans" class="btn btn-primary">Buscar planes</button>
              </div>
              <div id="adminMsg" class="mt-3 text-info"></div>
              <hr />
              <h6 class="mb-2">Planes</h6>
              <ul id="adminPlanList" class="list-group list-group-flush"></ul>
            </div>
          </div>
        </div>

        <div class="col-lg-8">
          <div class="card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Editar plan</h5>
                <span id="adminPlanActiveBadge" class="badge" style="display:none;">Activo</span>
              </div>
              <small id="adminPlanMeta" class="muted"></small>
              <hr />

              <div class="row g-3">
                <div class="col-md-4">
                  <label class="form-label">Calorías/día</label>
                  <input id="fCalories" type="number" class="form-control" placeholder="p.ej. 2300">
                </div>
                <div class="col-md-4">
                  <label class="form-label">Delta kcal</label>
                  <input id="fKcalDelta" type="number" class="form-control" placeholder="p.ej. -250">
                </div>
                <div class="col-md-4">
                  <label class="form-label">Cardio</label>
                  <input id="fCardio" type="text" class="form-control" placeholder="p.ej. 2x LISS 30'">
                </div>

                <div class="col-md-4">
                  <label class="form-label">Objetivo (goal)</label>
                  <select id="fGoal" class="form-select">
                    <option value="">(sin definir)</option>
                    <option value="gain_muscle">Ganar músculo</option>
                    <option value="lose_fat">Perder grasa</option>
                    <option value="maintain">Mantener</option>
                  </select>
                </div>

                <div class="col-md-4">
                  <label class="form-label">Proteína (g)</label>
                  <input id="fProt" type="number" class="form-control" placeholder="p.ej. 160">
                </div>
                <div class="col-md-4">
                  <label class="form-label">Carbohidratos (g)</label>
                  <input id="fCarb" type="number" class="form-control" placeholder="p.ej. 250">
                </div>
                <div class="col-md-4">
                  <label class="form-label">Grasas (g)</label>
                  <input id="fFat" type="number" class="form-control" placeholder="p.ej. 70">
                </div>

                <div class="col-md-6">
                  <label class="form-label">Volumen Δ</label>
                  <input id="fVolumeDelta" type="number" step="0.01" class="form-control" placeholder="p.ej. -0.12">
                </div>
                <div class="col-12">
                  <label class="form-label">Notas</label>
                  <textarea id="fNotes" rows="4" class="form-control"
                    placeholder="Notas internas o indicaciones del coach"></textarea>
                </div>
              </div>

              <div class="action-toolbar mt-4 pt-3 border-top border-secondary">
                <div class="action-buttons">
                  <button id="btnSavePlan" class="btn btn-success"><i class="fas fa-save me-1"></i> Guardar</button>
                  <button id="btnReloadPlan" class="btn btn-outline-light"><i class="fas fa-sync me-1"></i>
                    Recargar</button>
                  <div class="vr bg-secondary mx-1"></div>
                  <button id="btnDeactivatePlan" class="btn btn-outline-warning"><i class="fas fa-ban me-1"></i>
                    Desactivar</button>
                  <button id="btnDeletePlan" class="btn btn-outline-danger"><i class="fas fa-trash me-1"></i>
                    Borrar</button>
                </div>
                <div class="action-token">
                  <div class="input-group input-group-sm token-group">
                    <span class="input-group-text bg-dark border-secondary text-secondary">Token</span>
                    <input id="adminToken" type="password" class="form-control bg-dark text-white border-secondary"
                      placeholder="Admin">
                  </div>
                </div>
              </div>
              <div id="adminSaveMsg" class="mt-2"></div>

            </div>
          </div>
        </div>
      </div>

      <!-- Plan Generator Section (Hidden by default) -->
      <div class="card mt-4" id="planGeneratorCard" style="display: none;">
        <div class="card-body border-top border-primary border-3">
          <h5 class="card-title text-primary"><i class="fas fa-magic me-2"></i>Generar Nuevo Plan Base</h5>
          <p class="small text-secondary">Genera un plan inicial calculado por algoritmo (sin IA compleja) para este
            usuario.</p>

          <div class="row g-3 align-items-end">
            <div class="col-md-3">
              <label class="form-label">Peso (kg)</label>
              <input type="number" id="genWeight" class="form-control" placeholder="Ej. 75">
            </div>
            <div class="col-md-3">
              <label class="form-label">Objetivo</label>
              <select id="genGoal" class="form-select">
                <option value="gain_muscle">Ganar Músculo</option>
                <option value="lose_fat">Perder Grasa</option>
                <option value="maintain">Mantenimiento</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Nivel</label>
              <select id="genLevel" class="form-select">
                <option value="beginner">Principiante</option>
                <option value="intermediate">Intermedio</option>
                <option value="advanced">Avanzado</option>
              </select>
            </div>
            <div class="col-md-3">
              <button id="btnDoGenerate" class="btn btn-primary w-100">
                <i class="fas fa-play me-1"></i> Generar
              </button>
            </div>
          </div>
          <div id="genMsg" class="mt-2 small fw-bold"></div>
        </div>
      </div>

    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/user_search.js"></script>
    <script>
      (function () {
        let currentPlan = null;

        // --- Standard User Search Logic ---
        function selectUser(u) {
          // Auto-trigger load
          loadPlans();
        }

        initUserSearch({
          inputId: "userSearchTerm",
          resultsId: "userSearchResults",
          hiddenId: "adminUserId",
          buttonId: "btnLookupUser",
          clearButtonId: "btnClearUserSearch",
          storageKey: "admin_working_user",
          onSelect: selectUser
        });
        // ----------------------------------

        function resolveUserId(input) {
          const typed = (input || '').trim();
          try {
            const raw = localStorage.getItem('ai_fitness_user');
            if (raw) {
              const u = JSON.parse(raw);
              const loggedId = String(u.user_id || u._id || '').trim();
              const uname = (u.username || '').trim();
              const email = (u.email || '').trim().toLowerCase();
              if (!typed || typed === uname || typed.toLowerCase() === email) {
                return loggedId || typed;
              }
            }
          } catch (e) { }
          return typed;
        }

        async function loadPlans() {
          const msg = document.getElementById('adminMsg');
          const list = document.getElementById('adminPlanList');
          const uid = resolveUserId(document.getElementById('adminUserId').value);
          if (!uid) { msg.textContent = 'Ingresa un user_id'; return; }
          msg.textContent = 'Buscando planes...'; list.innerHTML = '';
          try {
            const resp = await fetch(`/plans/${encodeURIComponent(uid)}?limit=50`);
            if (!resp.ok) {
              const err = await resp.json().catch(() => ({ error: 'Error desconocido' }));
              throw new Error(err.error || `HTTP ${resp.status}`);
            }
            const rows = await resp.json();
            msg.textContent = rows.length ? '' : 'Sin planes';

            // Toggle Generator if empty
            const genCard = document.getElementById('planGeneratorCard');
            if (rows.length === 0) {
              msg.innerHTML = '<span class="text-warning">Sin planes.</span> <a href="#" class="fw-bold" onclick="document.getElementById(\'planGeneratorCard\').style.display=\'block\';return false;">Generar uno nuevo</a>';
              genCard.style.display = 'block';
            } else {
              genCard.style.display = 'none';
            }

            const frag = document.createDocumentFragment();
            rows.forEach(p => {
              const li = document.createElement('li');
              li.className = 'list-group-item d-flex justify-content-between align-items-start';
              const left = document.createElement('div');
              const ts = (p.created_at || '').toString().replace('T', ' ').replace('Z', '');
              left.innerHTML = `<div><strong>${p._id}</strong></div><small class="muted">${ts}</small>`;
              const right = document.createElement('div');
              if (p.active) { const b = document.createElement('span'); b.className = 'badge badge-active'; b.textContent = 'Activo'; right.appendChild(b); }
              li.appendChild(left); li.appendChild(right);
              li.addEventListener('click', () => renderPlan(p));
              frag.appendChild(li);
            });
            list.appendChild(frag);
            if (rows[0]) renderPlan(rows[0]);
          } catch (e) { msg.textContent = `Error: ${e.message}`; }
        }

        function renderPlan(p) {
          currentPlan = p;
          document.getElementById('adminPlanMeta').textContent = `user_id: ${p.user_id || '-'} · creado: ${(p.created_at || '').toString().replace('T', ' ').replace('Z', '')} · id: ${p._id}`;
          const badge = document.getElementById('adminPlanActiveBadge');
          badge.style.display = p.active ? 'inline-block' : 'none';
          const np = p.nutrition_plan || {}; const tr = p.training_plan || {}; const m = (np.macros || {});
          document.getElementById('fCalories').value = (np.calories_per_day ?? np.kcal_obj ?? '') || '';
          document.getElementById('fKcalDelta').value = (np.kcal_delta ?? '') || '';
          document.getElementById('fCardio').value = (tr.cardio ?? '') || '';
          document.getElementById('fProt').value = (m.protein ?? m.p ?? '') || '';
          document.getElementById('fCarb').value = (m.carbs ?? m.c ?? '') || '';
          document.getElementById('fFat').value = (m.fat ?? m.g ?? '') || '';
          document.getElementById('fVolumeDelta').value = (tr.ai_volumen_delta_ratio ?? '') || '';
          document.getElementById('fNotes').value = (p.notes ?? '') || '';
          document.getElementById('fGoal').value = (p.goal ?? '') || '';
          document.getElementById('adminSaveMsg').textContent = '';
        }

        function collectChanges() {
          const body = {};
          const np = {};
          const tr = {};
          const macros = {};
          const cal = document.getElementById('fCalories').value.trim();
          const kcald = document.getElementById('fKcalDelta').value.trim();
          const cardio = document.getElementById('fCardio').value.trim();
          const goal = document.getElementById('fGoal').value.trim();
          const p = document.getElementById('fProt').value.trim();
          const c = document.getElementById('fCarb').value.trim();
          const g = document.getElementById('fFat').value.trim();
          const vol = document.getElementById('fVolumeDelta').value.trim();
          const notes = document.getElementById('fNotes').value.trim();
          if (cal !== '') np.calories_per_day = Number(cal);
          if (kcald !== '') np.kcal_delta = Number(kcald);
          if (p !== '') macros.protein = Number(p);
          if (c !== '') macros.carbs = Number(c);
          if (g !== '') macros.fat = Number(g);
          if (Object.keys(macros).length) np.macros = macros;
          if (cardio !== '') tr.cardio = cardio;
          if (vol !== '') tr.ai_volumen_delta_ratio = Number(vol);
          if (Object.keys(np).length) body.nutrition_plan = np;
          if (Object.keys(tr).length) body.training_plan = tr;
          if (notes !== '') body.notes = notes; else body.notes = null;
          if (goal !== '') body.goal = goal; else body.goal = null;
          return body;
        }

        async function savePlan() {
          const msg = document.getElementById('adminSaveMsg');
          if (!currentPlan) { msg.textContent = 'Selecciona un plan'; return; }
          const token = document.getElementById('adminToken').value.trim();
          if (!token) { msg.textContent = 'Ingresa Admin Token'; return; }
          const body = collectChanges();
          msg.textContent = 'Guardando...';
          try {
            const resp = await fetch(`/plans/${encodeURIComponent(currentPlan._id)}/edit`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'X-Admin-Token': token },
              body: JSON.stringify(body)
            });
            if (!resp.ok) {
              const err = await resp.json().catch(() => ({ error: 'Error desconocido' }));
              throw new Error(err.error || `HTTP ${resp.status}`);
            }
            msg.textContent = 'Cambios guardados';
          } catch (e) { msg.textContent = `Error: ${e.message}`; }
        }

        document.getElementById('btnSearchPlans').addEventListener('click', loadPlans);
        document.getElementById('btnSavePlan').addEventListener('click', savePlan);
        document.getElementById('btnReloadPlan').addEventListener('click', () => { if (currentPlan) renderPlan(currentPlan); });

        document.getElementById('btnDeactivatePlan').addEventListener('click', async () => {
          const msg = document.getElementById('adminSaveMsg');
          if (!currentPlan) { msg.textContent = 'Selecciona un plan'; return; }
          const token = document.getElementById('adminToken').value.trim();
          if (!token) { msg.textContent = 'Ingresa Admin Token'; return; }
          msg.textContent = 'Desactivando...';
          try {
            const resp = await fetch(`/plans/${encodeURIComponent(currentPlan._id)}/deactivate`, { method: 'POST', headers: { 'X-Admin-Token': token } });
            if (!resp.ok) { const err = await resp.json().catch(() => ({ error: 'Error desconocido' })); throw new Error(err.error || `HTTP ${resp.status}`); }
            msg.textContent = 'Plan desactivado';
            loadPlans();
          } catch (e) { msg.textContent = `Error: ${e.message}`; }
        });

        document.getElementById('btnDeletePlan').addEventListener('click', async () => {
          const msg = document.getElementById('adminSaveMsg');
          if (!currentPlan) { msg.textContent = 'Selecciona un plan'; return; }
          const token = document.getElementById('adminToken').value.trim();
          if (!token) { msg.textContent = 'Ingresa Admin Token'; return; }
          const confirmed = await showConfirmModal("Eliminar plan", "¿Seguro que deseas borrar este plan?", "danger");
          if (!confirmed) return;
          msg.textContent = 'Borrando...';
          try {
            const resp = await fetch(`/plans/${encodeURIComponent(currentPlan._id)}`, { method: 'DELETE', headers: { 'X-Admin-Token': token } });
            if (!resp.ok) { const err = await resp.json().catch(() => ({ error: 'Error desconocido' })); throw new Error(err.error || `HTTP ${resp.status}`); }
            msg.textContent = 'Plan borrado';
            currentPlan = null;
            loadPlans();
          } catch (e) { msg.textContent = `Error: ${e.message}`; }
        });

        // --- Generator Logic ---
        document.getElementById('btnDoGenerate').addEventListener('click', async () => {
          const uid = resolveUserId(document.getElementById('adminUserId').value);
          const weight = document.getElementById('genWeight').value;
          const goal = document.getElementById('genGoal').value;
          const msg = document.getElementById('genMsg');

          if (!uid || !weight) { msg.textContent = "Faltan datos (User ID o Peso)"; return; }

          msg.textContent = "Generando...";
          try {
            const payload = {
              user_id: uid,
              weight_kg: Number(weight),
              goal: goal
            };
            const resp = await fetch('/generate_plan', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            if (!resp.ok) {
              const err = await resp.json();
              throw new Error(err.error || 'Error al generar');
            }
            msg.textContent = "Plan generado exitosamente!";
            msg.className = "mt-2 small fw-bold text-success";
            loadPlans();
          } catch (e) {
            msg.textContent = "Error: " + e.message;
            msg.className = "mt-2 small fw-bold text-danger";
          }
        });

        // Autorellenar usuario con el contexto admin o el del login
        window.addEventListener('DOMContentLoaded', () => {
          try {
            // Priority 1: Contexto de trabajo Admin (si existe)
            const ctx = localStorage.getItem('admin_working_user');
            if (ctx) {
              const u = JSON.parse(ctx);
              if (u && u.user_id) {
                selectUser(u);
                return; // Stop here, we have a context
              }
            }

            // Priority 2: Session User (fallback)
            const raw = localStorage.getItem('ai_fitness_user');
            if (raw) {
              const u = JSON.parse(raw);
              const display = (u.username || '').trim();
              if (display) { document.getElementById('adminUserId').value = display; }
            }
          } catch (e) { }
        });
      })();
    </script>
  </div> <!-- End main-content -->
</body>

</html>
