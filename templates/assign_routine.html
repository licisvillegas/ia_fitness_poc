<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asignar Rutinas | Smart Workout</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <link href="/static/css/theme.css" rel="stylesheet">
    <link href="/static/css/sidebar.css" rel="stylesheet">

    <style>
        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Poppins', sans-serif;
        }

        .page-header {
            padding: 2rem 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 2rem;
        }

        /* User Selector Styling */
        .user-select-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        /* Routine Card Styling */
        .routine-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .routine-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }

        .routine-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            border-color: var(--primary);
        }

        .routine-header {
            background: linear-gradient(135deg, var(--bg-card-hover) 0%, var(--bg-card) 100%);
            padding: 1.25rem;
            border-bottom: 1px solid var(--border-color);
        }

        .routine-body {
            padding: 1.25rem;
        }

        .routine-stats {
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .btn-assign {
            width: 100%;
            background: rgba(37, 99, 235, 0.1);
            color: var(--primary);
            border: 1px solid var(--primary);
            font-weight: 600;
            padding: 0.6rem;
            transition: all 0.2s;
        }

        .btn-assign:hover:not(:disabled) {
            background: var(--primary);
            color: var(--text-main);
        }

        .btn-assign:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: transparent;
            border-color: var(--border-color);
            color: var(--text-muted);
        }

        .btn-remove {
            width: 100%;
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid #ef4444;
            font-weight: 600;
            padding: 0.6rem;
            transition: all 0.2s;
        }

        .btn-remove:hover:not(:disabled) {
            background: #ef4444;
            color: var(--text-main);
        }

        .btn-remove:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: transparent;
            border-color: var(--border-color);
            color: var(--text-muted);
        }

        /* Selected User Badge */
        .selected-user-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.9rem;
            margin-top: 0.5rem;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        /* Search Box */
        .search-box {
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            color: var(--text-main);
        }

        .search-box:focus {
            background: var(--bg-input);
            border-color: var(--primary);
            color: var(--text-main);
            box-shadow: none;
        }

        select.form-select {
            background-color: var(--bg-input);
            border-color: var(--border-color);
            color: var(--text-main);
        }

        select.form-select:focus {
            background-color: var(--bg-input);
            color: var(--text-main);
            border-color: var(--primary);
            box-shadow: none;
        }
    </style>
</head>

<body>

    <!-- Sidebar Component -->
    {% include 'components/sidebar_admin.html' %}

    <div class="main-content">
        <div class="container">

            <!-- Header -->
            <div class="page-header d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1 fw-bold text-gradient">Asignar Rutinas</h2>
                    <p class="text-muted mb-0">Gestiona y asigna templates de entrenamiento a tus usuarios.</p>
                </div>
                <a href="/workout/dashboard" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Volver al Dashboard
                </a>
            </div>

            <!-- User Selector Section -->
            <div class="user-select-container">
                <label class="form-label text-primary fw-bold mb-2">1. Seleccionar Usuario</label>
                <div class="row align-items-center g-3">
                    <div class="col-md-6">
                        <div class="position-relative">
                            <div class="input-group">
                                <input type="text" class="form-control" id="userSearchTerm"
                                    placeholder="Buscar: nombre, email o ID...">
                                <button class="btn btn-outline-secondary" type="button" id="btnLookupUser">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            <input id="selectedUserId" type="hidden">
                            <div id="userSearchResults" class="list-group mt-1 position-absolute shadow-sm"
                                style="z-index: 1000; display: none; width: 90%;"></div>
                        </div>
                        <button id="btnClearUserSearch" class="btn btn-outline-secondary btn-sm mt-2" title="Limpiar">
                            <i class="fas fa-times"></i> Limpiar
                        </button>
                    </div>
                    <div class="col-md-6">
                        <div id="selectedUserDisplay" style="display: none;">
                            <span class="text-muted small me-2">Asignando a:</span>
                            <div class="selected-user-badge">
                                <i class="fas fa-user-check"></i>
                                <span id="badgeName">Nombre Usuario</span>
                            </div>
                        </div>
                        <div id="noUserDisplay" class="text-muted small">
                            <i class="fas fa-info-circle me-1"></i> Selecciona un usuario para habilitar la asignación.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Routines List Section -->
            <div>
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <label class="form-label text-primary fw-bold mb-0">2. Seleccionar Rutina (Templates)</label>
                    <div class="d-flex gap-2 align-items-center">
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button"
                                id="muscleFilterBtn" data-bs-toggle="dropdown" aria-expanded="false">
                                Filtrar Músculos
                            </button>
                            <ul class="dropdown-menu dropdown-menu-dark p-3" aria-labelledby="muscleFilterBtn"
                                style="min-width: 240px; max-height: 360px; overflow-y: auto;" id="muscleDropdownList">
                                <li>
                                    <div class="form-check">
                                        <input class="form-check-input muscle-check" type="checkbox" value="all"
                                            id="checkAll" checked>
                                        <label class="form-check-label" for="checkAll">Todos</label>
                                    </div>
                                </li>
                                <li>
                                    <hr class="dropdown-divider">
                                </li>
                                <!-- Populated via JS -->
                            </ul>
                        </div>
                        <div style="width: 250px;">
                            <input type="text" id="passFilter" class="form-control search-box form-control-sm"
                                placeholder="Buscar rutina...">
                        </div>
                    </div>
                </div>

                <div id="loadingRoutines" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2 text-muted">Cargando templates...</p>
                </div>

                <div id="routinesGrid" class="routine-grid" style="display: none;">
                    <!-- Cards injected via JS -->
                </div>

                <div id="emptyState" class="text-center py-5 text-muted" style="display: none;">
                    <i class="fas fa-dumbbell fa-3x mb-3 opacity-50"></i>
                    <p>No se encontraron rutinas disponibles.</p>
                </div>
            </div>

        </div>
    </div>

    <!-- Toast for feedback -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="liveToast" class="toast align-items-center text-white bg-primary border-0" role="alert"
            aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body" id="toastMessage">
                    Acción completada con éxito.
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                    aria-label="Close"></button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/lang.js"></script>
    <script src="/static/js/user_search.js"></script>
    <script src="/static/js/theme.js"></script>
    <script>
        // State
        let selectedUserId = null;
        let allRoutines = [];
        let assignedMap = {};
        let currentMuscles = "all";

        // Elements
        const routinesGrid = document.getElementById('routinesGrid');
        const loadingRoutines = document.getElementById('loadingRoutines');
        const emptyState = document.getElementById('emptyState');
        const routineFilter = document.getElementById('passFilter');
        const selectedUserDisplay = document.getElementById('selectedUserDisplay');
        const noUserDisplay = document.getElementById('noUserDisplay');
        const badgeName = document.getElementById('badgeName');

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            loadRoutines();
            loadBodyParts();
            initUserSearch({
                inputId: "userSearchTerm",
                resultsId: "userSearchResults",
                hiddenId: "selectedUserId",
                buttonId: "btnLookupUser",
                clearButtonId: "btnClearUserSearch",
                storageKey: "admin_working_user",
                onSelect: handleUserSelect,
                onClear: clearSelectedUser
            });
        });

        function handleUserSelect(user) {
            if (!user || !user.user_id) return;
            selectedUserId = user.user_id;
            selectedUserDisplay.style.display = 'block';
            noUserDisplay.style.display = 'none';
            badgeName.textContent = user.name || user.username || user.email || user.user_id;
            loadAssignmentsForUser(selectedUserId);
        }

        function clearSelectedUser() {
            selectedUserId = null;
            selectedUserDisplay.style.display = 'none';
            noUserDisplay.style.display = 'block';
            assignedMap = {};
            applyFilters();
        }

        // --- Load Routines ---
        async function loadRoutines() {
            try {
                // Admin endpoint to list all
                const res = await fetch('/api/routines');
                allRoutines = await res.json();

                applyFilters();

                loadingRoutines.style.display = 'none';
                if (allRoutines.length === 0) {
                    emptyState.style.display = 'block';
                } else {
                    routinesGrid.style.display = 'grid';
                }
            } catch (e) {
                console.error(e);
                loadingRoutines.innerHTML = `<p class="text-danger">Error cargando rutinas</p>`;
            }
        }

        // --- Load Assignments for User ---
        async function loadAssignmentsForUser(userId) {
            if (!userId) {
                assignedMap = {};
                applyFilters();
                return;
            }

            try {
                const res = await fetch(`/api/admin/routines/assignments?user_id=${encodeURIComponent(userId)}`);
                const assignments = await res.json();

                assignedMap = {};
                assignments.forEach(a => {
                    assignedMap[a.routine_id] = a;
                });

                applyFilters();
            } catch (e) {
                console.error(e);
                showToast("Error cargando asignaciones", "bg-danger");
            }
        }

        // --- Load Body Parts ---
        async function loadBodyParts() {
            try {
                const res = await fetch('/workout/api/body-parts');
                const parts = await res.json();
                const muscleList = document.getElementById('muscleDropdownList');

                parts.forEach(p => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <div class="form-check">
                            <input class="form-check-input muscle-check" type="checkbox" value="${p.key}" id="check_${p.key}">
                            <label class="form-check-label" for="check_${p.key}">${p.label_es || p.label}</label>
                        </div>
                    `;
                    muscleList.appendChild(li);
                });

                muscleList.addEventListener('change', (e) => {
                    if (e.target.classList.contains('muscle-check')) {
                        handleMuscleCheckboxChange(e.target);
                        applyFilters();
                    }
                });
            } catch (e) {
                console.error(e);
                showToast("Error cargando grupos musculares", "bg-danger");
            }
        }

        function handleMuscleCheckboxChange(target) {
            const allCheck = document.getElementById('checkAll');
            const checkboxes = document.querySelectorAll('.muscle-check:not(#checkAll)');

            if (target.id === 'checkAll') {
                if (allCheck.checked) {
                    checkboxes.forEach(cb => cb.checked = false);
                    currentMuscles = "all";
                } else {
                    allCheck.checked = true;
                    currentMuscles = "all";
                }
                updateMuscleButtonText();
                return;
            }

            if (target.checked) {
                allCheck.checked = false;
            }

            const selected = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
            if (selected.length === 0) {
                allCheck.checked = true;
                currentMuscles = "all";
            } else {
                currentMuscles = selected;
            }
            updateMuscleButtonText();
        }

        function updateMuscleButtonText() {
            const btn = document.getElementById('muscleFilterBtn');
            if (currentMuscles === "all") {
                btn.textContent = "Filtrar Músculos";
                return;
            }

            const count = Array.isArray(currentMuscles) ? currentMuscles.length : 0;
            btn.textContent = `Músculos (${count})`;
        }

        function getRoutineBodyParts(routine) {
            const parts = new Set();
            if (Array.isArray(routine.routine_body_parts)) {
                routine.routine_body_parts.forEach(p => {
                    if (p) parts.add(String(p).toLowerCase());
                });
            }

            if (parts.size === 0 && Array.isArray(routine.items)) {
                routine.items.forEach(item => {
                    if (item && item.body_part) {
                        parts.add(String(item.body_part).toLowerCase());
                    }
                });
            }

            return Array.from(parts);
        }

        function applyFilters() {
            const term = routineFilter.value.toLowerCase();
            const selected = currentMuscles;

            let filtered = allRoutines.filter(r => r.name && r.name.toLowerCase().includes(term));

            if (selected !== "all" && Array.isArray(selected) && selected.length > 0) {
                const selectedSet = new Set(selected.map(s => String(s).toLowerCase()));
                filtered = filtered.filter(r => {
                    const parts = getRoutineBodyParts(r);
                    if (parts.length === 0) return false;
                    return parts.some(p => selectedSet.has(p));
                });
            }

            renderRoutines(filtered);
        }

        // --- Render Routines ---
        function renderRoutines(routines) {
            routinesGrid.innerHTML = '';

            routines.forEach(routine => {
                const card = document.createElement('div');
                card.className = 'routine-card';

                const exerciseCount = routine.items ? routine.items.length : (routine.exercises ? routine.exercises.length : 0);
                const dateStr = routine.created_at ? new Date(routine.created_at).toLocaleDateString() : 'N/A';
                const assignedInfo = assignedMap[routine._id];
                const isAssigned = Boolean(assignedInfo);
                const assignedUntil = assignedInfo && assignedInfo.expires_at
                    ? new Date(assignedInfo.expires_at).toLocaleDateString()
                    : null;
                const daysValue = assignedInfo && assignedInfo.valid_days ? assignedInfo.valid_days : 30;

                card.innerHTML = `
                <div class="routine-header">
                    <h5 class="mb-0 text-truncate fw-bold" title="${routine.name}">${routine.name}</h5>
                    <small class="text-muted" style="font-size: 0.75rem;">ID: ${routine._id}</small>
                </div>
                <div class="routine-body">
                    <div class="routine-stats">
                        <div class="stat-item" title="Ejercicios">
                            <i class="fas fa-list-ol"></i>
                            <span>${exerciseCount} Ejercicios</span>
                        </div>
                        <div class="stat-item" title="Fecha Creaci?n">
                            <i class="far fa-calendar-alt"></i>
                            <span>${dateStr}</span>
                        </div>
                    </div>
                    
                    <p class="text-muted small mb-3 text-truncate">
                        ${routine.description || "Sin Descripción disponible."}
                    </p>

                    <div class="mb-2">
                        <label class="form-label small text-muted mb-1">Vigencia (dias)</label>
                        <input type="number" min="1" class="form-control form-control-sm"
                            id="days-${routine._id}" value="${daysValue}" ${!selectedUserId ? 'disabled' : ''}>
                    </div>

                    <button class="btn btn-assign btn-sm mb-2"
                        onclick="assignRoutine('${routine._id}', event)"
                        ${!selectedUserId || isAssigned ? 'disabled' : ''}>
                        ${!selectedUserId ? 'Selecciona Usuario Primero' : (isAssigned ? 'Asignada' : '<i class="fas fa-plus-circle me-2"></i>Asignar Rutina')}
                    </button>

                    ${isAssigned ? `
                        <button class="btn btn-assign btn-sm mb-2" onclick="updateAssignment('${routine._id}', event)" ${!selectedUserId ? 'disabled' : ''}>
                            <i class="fas fa-sync-alt me-2"></i>Actualizar Vigencia
                        </button>
                        <button class="btn btn-remove btn-sm mb-2" onclick="unassignRoutine('${routine._id}', event)" ${!selectedUserId ? 'disabled' : ''}>
                            <i class="fas fa-times-circle me-2"></i>Remover Asignacion
                        </button>
                    ` : ''}

                    ${isAssigned ? `
                        <div class="text-muted small">
                            ${assignedUntil ? `Vence: ${assignedUntil}` : 'Asignada sin vencimiento'}
                        </div>
                    ` : ''}
                </div>
            `;
                routinesGrid.appendChild(card);
            });
        }

        // --- Filter logic ---
        routineFilter.addEventListener('input', (e) => {
            applyFilters();
        });

        // --- Assign Action ---
        window.assignRoutine = async (routineId, evt) => {
            if (!selectedUserId) {
                showToast("Debes seleccionar un usuario primero", "bg-warning");
                return;
            }

            const daysInput = document.getElementById(`days-${routineId}`);
            const validDays = parseInt(daysInput ? daysInput.value : '0', 10);
            if (!validDays || validDays <= 0) {
                showToast("Selecciona dias de vigencia validos", "bg-warning");
                return;
            }

            const btn = evt && evt.currentTarget ? evt.currentTarget : null;
            const originalText = btn ? btn.innerHTML : '';
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Asignando...`;
            }

            try {
                const resp = await fetch('/api/admin/routines/assign', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: selectedUserId,
                        routine_id: routineId,
                        valid_days: validDays
                    })
                });

                const data = await resp.json();

                if (resp.ok) {
                    showToast(data.message || "Asignada con exito", "bg-success");
                    await loadAssignmentsForUser(selectedUserId);
                } else {
                    showToast(data.error || "Error al asignar", "bg-danger");
                }
            } catch (e) {
                console.error(e);
                showToast("Error de conexion", "bg-danger");
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }
        };

        window.updateAssignment = async (routineId, evt) => {
            if (!selectedUserId) {
                showToast("Debes seleccionar un usuario primero", "bg-warning");
                return;
            }

            const assignmentInfo = assignedMap[routineId];
            if (!assignmentInfo || !assignmentInfo.assignment_id) {
                showToast("Asignacion no encontrada", "bg-danger");
                return;
            }

            const daysInput = document.getElementById(`days-${routineId}`);
            const validDays = parseInt(daysInput ? daysInput.value : '0', 10);
            if (!validDays || validDays <= 0) {
                showToast("Selecciona dias de vigencia validos", "bg-warning");
                return;
            }

            const btn = evt && evt.currentTarget ? evt.currentTarget : null;
            const originalText = btn ? btn.innerHTML : '';
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Actualizando...`;
            }

            try {
                const resp = await fetch('/api/admin/routines/assignments/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: selectedUserId,
                        routine_id: routineId,
                        assignment_id: assignmentInfo.assignment_id,
                        valid_days: validDays
                    })
                });

                const data = await resp.json();

                if (resp.ok) {
                    showToast(data.message || "Vigencia actualizada", "bg-success");
                    await loadAssignmentsForUser(selectedUserId);
                } else {
                    showToast(data.error || "Error al actualizar", "bg-danger");
                }
            } catch (e) {
                console.error(e);
                showToast("Error de conexion", "bg-danger");
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }
        };

        window.unassignRoutine = async (routineId, evt) => {
            if (!selectedUserId) {
                showToast("Debes seleccionar un usuario primero", "bg-warning");
                return;
            }

            const btn = evt && evt.currentTarget ? evt.currentTarget : null;
            const originalText = btn ? btn.innerHTML : '';
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Removiendo...`;
            }

            try {
                const resp = await fetch('/api/admin/routines/unassign', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: selectedUserId,
                        routine_id: routineId
                    })
                });

                const data = await resp.json();

                if (resp.ok) {
                    showToast(data.message || "Rutina removida", "bg-success");
                    await loadAssignmentsForUser(selectedUserId);
                } else {
                    showToast(data.error || "Error al remover", "bg-danger");
                }
            } catch (e) {
                console.error(e);
                showToast("Error de conexion", "bg-danger");
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }
        };

        // --- Toast Helper ---
        function showToast(msg, bgClass = 'bg-primary') {
            const toastEl = document.getElementById('liveToast');
            const toastBody = document.getElementById('toastMessage');

            toastEl.className = `toast align-items-center text-white border-0 ${bgClass}`;
            toastBody.textContent = msg;

            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        }
    </script>
</body>

</html>