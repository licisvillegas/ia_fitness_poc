<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>AI Fitness | Evaluación Corporal Inteligente</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Poppins", sans-serif;
        background-color: #0a0a0a;
        color: #e5e7eb;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .navbar {
        background-color: #111827;
      }

      .navbar-brand {
        color: #3b82f6 !important;
        font-weight: 700;
      }

      .navbar a {
        color: #e5e7eb !important;
      }

      main {
        flex: 1;
        padding-top: 2rem;
        padding-bottom: 3rem;
      }

      .card {
        background-color: #111827;
        border: 1px solid rgba(59, 130, 246, 0.2);
        box-shadow: 0 8px 24px rgba(15, 23, 42, 0.65);
      }

      .section-title {
        font-weight: 600;
        color: #3b82f6;
      }

      .form-label {
        font-weight: 500;
      }

      .btn-primary {
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        border: none;
        font-weight: 600;
      }

      .btn-outline-light {
        border-color: rgba(148, 163, 184, 0.4);
        color: #e5e7eb;
      }

      .btn-outline-light:hover {
        background-color: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
      }

      .badge-category {
        background-color: rgba(59, 130, 246, 0.25);
        color: #bfdbfe;
        font-weight: 500;
        padding: 0.4rem 0.75rem;
        border-radius: 999px;
        font-size: 0.8rem;
      }

      .result-pre {
        background-color: rgba(15, 23, 42, 0.75);
        border-radius: 0.75rem;
        padding: 1.25rem;
        border: 1px solid rgba(148, 163, 184, 0.25);
        color: #f8fafc;
        max-height: 400px;
        overflow: auto;
        font-size: 0.9rem;
      }

      footer {
        background-color: #111827;
        color: #9ca3af;
        text-align: center;
        padding: 1rem 0;
        margin-top: auto;
      }

      .photo-row {
        background-color: rgba(17, 24, 39, 0.6);
        border: 1px solid rgba(148, 163, 184, 0.2);
        border-radius: 0.75rem;
        padding: 1rem;
      }

      .spinner-border {
        width: 1.75rem;
        height: 1.75rem;
        border-width: 0.2rem;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg shadow-sm">
      <div class="container">
        <a class="navbar-brand" href="#">AI Fitness</a>
        <button
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
          class="navbar-toggler text-light"
          data-bs-target="#navbarNav"
          data-bs-toggle="collapse"
          type="button"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="/">Inicio</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/ai/body_assessment/tester">Evaluación corporal</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/nutrition">Nutrición AI</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <main class="container">
      <div class="row g-4">
        <div class="col-12 col-xl-7">
          <div class="card h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                  <h1 class="h3 mb-1">Panel de evaluación corporal</h1>
                  <p class="mb-0 text-secondary">
                    Introduce datos antropométricos y observaciones de fotos para generar un informe AI.
                  </p>
                </div>
                <span class="badge-category">Agente IA Corporal</span>
              </div>

              <form id="assessment-form">
                <section class="mb-4">
                  <h2 class="section-title h5 mb-3">Información general</h2>
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label" for="user_id">ID de usuario (opcional)</label>
                      <input class="form-control" id="user_id" name="user_id" placeholder="usr_001" type="text" />
                    </div>
                    <div class="col-md-6">
                      <label class="form-label" for="sex">Sexo</label>
                      <select class="form-select" id="sex" name="sex">
                        <option value="male">Masculino</option>
                        <option value="female">Femenino</option>
                      </select>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label" for="age">Edad</label>
                      <input class="form-control" id="age" min="14" name="age" placeholder="30" type="number" />
                    </div>
                    <div class="col-md-6">
                      <label class="form-label" for="goal">Objetivo</label>
                      <select class="form-select" id="goal" name="goal">
                        <option value="">Selecciona…</option>
                        <option value="definicion">Definición</option>
                        <option value="volumen">Volumen</option>
                        <option value="mantenimiento">Mantenimiento</option>
                      </select>
                    </div>
                    <div class="col-12">
                      <label class="form-label" for="notes">Notas para el coach</label>
                      <textarea
                        class="form-control"
                        id="notes"
                        name="notes"
                        placeholder="Ejemplo: Busco definir sin perder demasiada masa magra"
                        rows="2"
                      ></textarea>
                    </div>
                  </div>
                </section>

                <section class="mb-4">
                  <h2 class="section-title h5 mb-3">Medidas corporales</h2>
                  <div class="row g-3">
                    <div class="col-sm-6 col-lg-4">
                      <label class="form-label" for="height_cm">Altura (cm)</label>
                      <input
                        class="form-control"
                        data-measure="height_cm"
                        id="height_cm"
                        placeholder="175"
                        type="number"
                        step="0.1"
                      />
                    </div>
                    <div class="col-sm-6 col-lg-4">
                      <label class="form-label" for="weight_kg">Peso (kg)</label>
                      <input
                        class="form-control"
                        data-measure="weight_kg"
                        id="weight_kg"
                        placeholder="78"
                        type="number"
                        step="0.1"
                      />
                    </div>
                    <div class="col-sm-6 col-lg-4">
                      <label class="form-label" for="waist">Cintura (cm)</label>
                      <input class="form-control" data-measure="waist" id="waist" placeholder="82" type="number" step="0.1" />
                    </div>
                    <div class="col-sm-6 col-lg-4">
                      <label class="form-label" for="abdomen">Abdomen (cm)</label>
                      <input class="form-control" data-measure="abdomen" id="abdomen" placeholder="85" type="number" step="0.1" />
                    </div>
                    <div class="col-sm-6 col-lg-4">
                      <label class="form-label" for="chest">Pecho (cm)</label>
                      <input class="form-control" data-measure="chest" id="chest" placeholder="104" type="number" step="0.1" />
                    </div>
                    <div class="col-sm-6 col-lg-4">
                      <label class="form-label" for="hip">Cadera (cm)</label>
                      <input class="form-control" data-measure="hip" id="hip" placeholder="98" type="number" step="0.1" />
                    </div>
                    <div class="col-sm-6 col-lg-4">
                      <label class="form-label" for="neck">Cuello (cm)</label>
                      <input class="form-control" data-measure="neck" id="neck" placeholder="39" type="number" step="0.1" />
                    </div>
                    <div class="col-sm-6 col-lg-4">
                      <label class="form-label" for="arm_relaxed">Brazo relajado (cm)</label>
                      <input
                        class="form-control"
                        data-measure="arm_relaxed"
                        id="arm_relaxed"
                        placeholder="33"
                        type="number"
                        step="0.1"
                      />
                    </div>
                    <div class="col-sm-6 col-lg-4">
                      <label class="form-label" for="arm_flexed">Brazo contraído (cm)</label>
                      <input
                        class="form-control"
                        data-measure="arm_flexed"
                        id="arm_flexed"
                        placeholder="36"
                        type="number"
                        step="0.1"
                      />
                    </div>
                    <div class="col-sm-6 col-lg-4">
                      <label class="form-label" for="thigh">Muslo (cm)</label>
                      <input class="form-control" data-measure="thigh" id="thigh" placeholder="58" type="number" step="0.1" />
                    </div>
                    <div class="col-sm-6 col-lg-4">
                      <label class="form-label" for="calf">Pantorrilla (cm)</label>
                      <input class="form-control" data-measure="calf" id="calf" placeholder="38" type="number" step="0.1" />
                    </div>
                  </div>
                </section>

                <section class="mb-4">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 class="section-title h5 mb-0">Observaciones de fotos</h2>
                    <button class="btn btn-outline-light btn-sm" id="add-photo" type="button">
                      + Añadir vista
                    </button>
                  </div>
                  <p class="text-secondary small mb-3">
                    Describe brevemente cada foto (frontal, perfil, posterior, etc.), calidad y notas relevantes.
                  </p>
                  <div class="vstack gap-3" id="photo-list"></div>
                </section>

                <div class="d-flex flex-wrap gap-2">
                  <button class="btn btn-primary" id="submit-btn" type="submit">
                    Generar evaluación
                  </button>
                  <button class="btn btn-outline-light" id="load-sample" type="button">
                    Cargar ejemplo rápido
                  </button>
                  <div class="d-none align-items-center gap-2" id="loading-indicator">
                    <div class="spinner-border text-primary" role="status"></div>
                    <span class="text-secondary small">Analizando con el agente…</span>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>

        <div class="col-12 col-xl-5">
          <div class="card h-100">
            <div class="card-body d-flex flex-column">
              <h2 class="section-title h5 mb-3">Resultado del agente</h2>
              <p class="text-secondary small">
                El agente devuelve un JSON estructurado con composición corporal, proporciones, resumen, recomendaciones y feedback sobre las fotos.
              </p>
              <div class="result-pre flex-grow-1" id="result-output">Aún no se ha generado ninguna evaluación.</div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <footer>
      <div class="container">
        <small>AI Fitness © 2025 · Herramientas inteligentes para el bienestar.</small>
      </div>
    </footer>

    <script>
      const photoList = document.getElementById("photo-list");
      const loadingIndicator = document.getElementById("loading-indicator");
      const resultOutput = document.getElementById("result-output");
      const submitBtn = document.getElementById("submit-btn");

      function createPhotoRow(initial = {}) {
        const wrapper = document.createElement("div");
        wrapper.className = "photo-row";
        const uid = `photo_${Date.now()}_${Math.floor(Math.random()*1e6)}`;
        wrapper.innerHTML = `
          <div class="row g-3 align-items-end">
            <div class="col-sm-4">
              <label class="form-label">Vista</label>
              <input type="text" class="form-control photo-view" placeholder="frontal" value="${initial.view || ""}" />
            </div>
            <div class="col-sm-4">
              <label class="form-label">Calidad</label>
              <input type="text" class="form-control photo-quality" placeholder="buena" value="${initial.quality || ""}" />
            </div>
            <div class="col-sm-4">
              <label class="form-label">Notas</label>
              <input type="text" class="form-control photo-notes" placeholder="Luz natural" value="${initial.notes || ""}" />
            </div>
            <div class="col-sm-8">
              <label class="form-label">Archivo de foto</label>
              <input type="file" accept="image/*" class="form-control photo-file" data-file-key="${uid}" />
              <div class="form-text text-secondary">Opcional: adjunta la imagen para análisis del agente.</div>
            </div>
            <div class="col-12 text-end">
              <button type="button" class="btn btn-link text-danger p-0 remove-photo">Eliminar</button>
            </div>
          </div>
        `;

        wrapper.querySelector(".remove-photo").addEventListener("click", () => {
          wrapper.remove();
        });

        return wrapper;
      }

      function ensurePhotoRows() {
        if (!photoList.children.length) {
          photoList.appendChild(
            createPhotoRow({ view: "frontal", quality: "alta", notes: "Fondo neutro" })
          );
        }
      }

      document.getElementById("add-photo").addEventListener("click", () => {
        photoList.appendChild(createPhotoRow());
      });

      ensurePhotoRows();

      const sampleData = {
        user_id: "demo_user_01",
        sex: "male",
        age: 32,
        goal: "definicion",
        notes: "Entreno 4 veces por semana, quiero marcar más el abdomen.",
        measurements: {
          height_cm: 178,
          weight_kg: 80.5,
          waist: 86,
          abdomen: 88,
          chest: 105,
          hip: 99,
          neck: 40,
          arm_relaxed: 33,
          arm_flexed: 36,
          thigh: 59,
          calf: 38,
        },
        photos: [
          { view: "frontal", quality: "buena", notes: "Post entreno" },
          { view: "perfil", quality: "media", notes: "Ligera sombra" },
          { view: "posterior", quality: "buena", notes: "Luz uniforme" },
        ],
      };

      document.getElementById("load-sample").addEventListener("click", () => {
        document.getElementById("user_id").value = sampleData.user_id;
        document.getElementById("sex").value = sampleData.sex;
        document.getElementById("age").value = sampleData.age;
        document.getElementById("goal").value = sampleData.goal;
        document.getElementById("notes").value = sampleData.notes;

        document.querySelectorAll("[data-measure]").forEach((input) => {
          const key = input.getAttribute("data-measure");
          input.value = sampleData.measurements[key] ?? "";
        });

        photoList.innerHTML = "";
        sampleData.photos.forEach((photo) => photoList.appendChild(createPhotoRow(photo)));
        ensurePhotoRows();
      });

      document.getElementById("assessment-form").addEventListener("submit", async (event) => {
        event.preventDefault();

        const form = event.target;
        const payload = {
          user_id: form.user_id.value.trim() || null,
          sex: form.sex.value,
          age: form.age.value ? Number(form.age.value) : null,
          goal: form.goal.value || null,
          notes: form.notes.value.trim() || null,
          measurements: {},
          photos: [],
        };

        form.querySelectorAll("[data-measure]").forEach((input) => {
          const key = input.getAttribute("data-measure");
          const value = input.value.trim();
          if (value !== "") {
            payload.measurements[key] = Number(value);
          }
        });

        const formData = new FormData();
        photoList.querySelectorAll(".photo-row").forEach((row, idx) => {
          const view = row.querySelector(".photo-view").value.trim();
          const quality = row.querySelector(".photo-quality").value.trim();
          const notes = row.querySelector(".photo-notes").value.trim();
          const fileInput = row.querySelector(".photo-file");
          const file = fileInput ? (fileInput.files && fileInput.files[0]) : null;
          const fileKey = file && file.size > 0 ? (fileInput.getAttribute("data-file-key") || `photo_${idx}`) : null;
          if (file && fileKey) {
            formData.append(fileKey, file);
          }
          if (view || quality || notes || fileKey) {
            payload.photos.push({ view, quality, notes, file_key: fileKey });
          }
        });

        loadingIndicator.classList.remove("d-none");
        submitBtn.disabled = true;
        resultOutput.textContent = "Enviando datos al agente…";

        try {
          formData.append("payload", JSON.stringify(payload));
          const response = await fetch("/ai/body_assessment", {
            method: "POST",
            body: formData,
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.error || "Error al generar la evaluación");
          }

          resultOutput.textContent = JSON.stringify(data, null, 2);
        } catch (error) {
          resultOutput.textContent = `⚠️ ${error.message}`;
        } finally {
          loadingIndicator.classList.add("d-none");
          submitBtn.disabled = false;
        }
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
