<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Synapse Fit | Evaluación Corporal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <link href="/static/css/theme.css" rel="stylesheet">
    <link href="/static/css/sidebar.css" rel="stylesheet">
    <link href="/static/css/loader.css" rel="stylesheet">
    <style>
        body {
            font-family: "Poppins", sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            min-height: 100vh;
        }

        .navbar {
            background-color: var(--bg-panel);
        }

        .navbar-brand {
            color: var(--primary) !important;
            font-weight: 700;
        }

        .navbar a {
            color: var(--text-main) !important;
        }

        main {
            flex: 1;
            padding-top: 2rem;
            padding-bottom: 3rem;
        }

        .card {
            background-color: var(--bg-panel);
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .section-title {
            font-weight: 600;
            color: var(--primary);
            border-left: 3px solid var(--primary);
            padding-left: 0.5rem;
        }

        .form-label {
            font-weight: 500;
            color: var(--text-main);
        }

        .form-control,
        .form-select {
            background-color: var(--bg-input);
            border: 1px solid var(--border-color);
            color: var(--text-main);
        }

        .form-control::placeholder {
            color: var(--text-placeholder);
        }

        .form-control:focus,
        .form-select:focus {
            background-color: var(--bg-input);
            border-color: var(--primary);
            color: var(--text-main);
            box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-hover));
            border: none;
            font-weight: 600;
            color: var(--text-main);
        }

        .btn-outline-light {
            border-color: var(--border-color);
            color: var(--text-main);
        }

        .btn-outline-light:hover {
            background-color: var(--bg-card-hover);
            color: var(--primary);
        }

        .badge-category {
            background-color: rgba(59, 130, 246, 0.1);
            color: var(--primary);
            font-weight: 500;
            padding: 0.4rem 0.75rem;
            border-radius: 999px;
            font-size: 0.8rem;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .result-pre {
            background-color: var(--bg-card);
            border-radius: 0.75rem;
            padding: 1.25rem;
            border: 1px solid var(--border-color);
            color: var(--text-main);
            max-height: 400px;
            overflow: auto;
            font-size: 0.9rem;
        }

        footer {
            background-color: var(--bg-panel);
            color: var(--text-muted);
            text-align: center;
            padding: 1rem 0;
            margin-top: auto;
            border-top: 1px solid var(--border-color);
        }

        .photo-row {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1rem;
        }

        .spinner-border {
            width: 1.75rem;
            height: 1.75rem;
            border-width: 0.2rem;
        }

        .img-thumbnail-preview {
            width: 80px;
            height: 80px;
            object-fit: contain;
            background-color: var(--bg-body);
            border-radius: 8px;
            cursor: zoom-in;
            border: 2px solid var(--primary);
            display: none;
            transition: transform 0.2s;
        }

        .img-thumbnail-preview:hover {
            transform: scale(1.1);
        }

        /* Report Styles */
        .metric-card {
            background-color: var(--bg-input);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            height: 100%;
            border: 1px solid var(--border-color);
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .metric-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-focus {
            font-size: 0.9em;
            padding: 0.5em 1em;
        }

        /* New Photo Card Styles */
        .photo-row.card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
        }

        .photo-row .form-select,
        .photo-row .form-control {
            background-color: var(--bg-input);
            border-color: var(--border-color);
            color: var(--text-main);
        }

        .photo-row .form-select:focus,
        .photo-row .form-control:focus {
            border-color: var(--primary);
            box-shadow: none;
        }

        @keyframes alertSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert-modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .alert-modal-backdrop.show {
            display: flex;
        }

        .alert-modal-card {
            width: 100%;
            max-width: 420px;
            background: var(--bg-body);
            border: 1px solid var(--border-color);
            border-radius: 18px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
            padding: 1.5rem;
            color: var(--text-main);
            animation: alertSlideIn 0.25s ease-out;
        }

        .alert-modal-card .alert-title {
            font-weight: 700;
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
        }

        .alert-modal-card .alert-message {
            color: var(--text-muted);
            margin-bottom: 1.25rem;
            line-height: 1.4;
        }

        .image-zoom-light .modal-content {
            background-color: #f2f2f2;
            border-color: #e0e0e0;
        }

        .image-zoom-light .modal-title,
        .image-zoom-light .modal-title.text-white {
            color: #111 !important;
        }

        .image-zoom-light .modal-body {
            background-color: #f2f2f2;
        }

        .image-zoom-light .btn-close {
            filter: none;
        }

        .alert-modal-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        .alert-tone-warning {
            color: #ff9d00;
        }

        .alert-tone-danger {
            color: #ff5c5c;
        }

        .alert-tone-success {
            color: #00ff9d;
        }

        .chevron-rotate {
            transition: transform 0.2s ease;
        }

        .chevron-rotate.rotate-180 {
            transform: rotate(180deg);
        }
    </style>
</head>

<body>
    {% include 'components/sidebar.html' %}
    <div class="main-content">

        <main class="container">
            <div class="row g-4">
                <div class="col-12 col-xl-7">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <h1 class="h3 mb-1">Evaluación Corporal</h1>
                                    <p class="text-secondary small mb-0">Completa el formulario para tu análisis AI</p>
                                </div>
                            </div>

                            <!-- Busqueda admin removida en template de usuario -->

                            <form id="assessment-form">
                                <section class="mb-4">
                                    <h2 class="section-title h5 mb-3">Información general</h2>
                                    <div class="row g-3">
                                        <!-- Campo de usuario oculto/solo lectura -->
                                        <div class="col-md-6" style="display:none;">
                                            <label class="form-label">Usuario</label>
                                            <input type="hidden" id="user_id" name="user_id" />
                                            <input class="form-control" id="display_user_name" type="text" readonly />
                                        </div>

                                        <div class="col-md-6">
                                            <label class="form-label" for="sex">Sexo</label>
                                            <select class="form-select" id="sex" name="sex">
                                                <option value="male">Masculino</option>
                                                <option value="female">Femenino</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label" for="age">Edad</label>
                                            <input class="form-control" id="age" min="14" name="age" placeholder="30"
                                                type="number" />
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label" for="goal">Objetivo</label>
                                            <select class="form-select" id="goal" name="goal">
                                                <option value="">Selecciona…</option>
                                                <option value="fat_loss" {% if defaults.goal=='fat_loss' %}selected{%
                                                    endif %}>Definición (Bajar grasa)</option>
                                                <option value="muscle_gain" {% if defaults.goal=='muscle_gain'
                                                    %}selected{% endif %}>Volumen (Ganar músculo)</option>
                                                <option value="maintenance" {% if defaults.goal=='maintenance'
                                                    %}selected{% endif %}>Mantenimiento</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label" for="activity_level">Nivel de Actividad</label>
                                            <select class="form-select" id="activity_level" name="activity_level">
                                                <option value="sedentary" {% if defaults.activity_level=='sedentary'
                                                    %}selected{% endif %}>Sedentario (Poco o nada)</option>
                                                <option value="lightly_active" {% if
                                                    defaults.activity_level=='lightly_active' %}selected{% endif %}>
                                                    Ligero (1-3 días/sem)</option>
                                                <option value="moderately_active" {% if
                                                    defaults.activity_level=='moderately_active' %}selected{% endif %}>
                                                    Moderado (3-5 días/sem)</option>
                                                <option value="very_active" {% if defaults.activity_level=='very_active'
                                                    %}selected{% endif %}>Fuerte (6-7 días/sem)</option>
                                                <option value="extra_active" {% if
                                                    defaults.activity_level=='extra_active' %}selected{% endif %}>Muy
                                                    Fuerte (Doble sesión)</option>
                                            </select>
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label" for="notes">Notas para el coach</label>
                                            <textarea class="form-control" id="notes" name="notes"
                                                placeholder="Ejemplo: Busco definir sin perder demasiada masa magra"
                                                rows="2"></textarea>
                                        </div>
                                    </div>
                                </section>

                                <section class="mb-4">
                                    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
                                        <button id="bodyMeasuresToggle"
                                            class="btn btn-link text-decoration-none px-0 d-flex align-items-center gap-2"
                                            type="button" aria-expanded="false" aria-controls="bodyMeasuresCollapse">
                                            <span class="section-title h5 mb-0">Medidas corporales</span>
                                            <i class="fas fa-chevron-down text-secondary chevron-rotate"
                                                id="bodyMeasuresChevron"></i>
                                        </button>
                                        <button class="btn btn-outline-info btn-sm" type="button" data-bs-toggle="modal"
                                            data-bs-target="#bodyTrackingModal">
                                            Abrir seguimiento corporal
                                        </button>
                                    </div>
                                    <p class="text-secondary small mb-3">
                                        Puedes abrir el seguimiento corporal para actualizar y al cerrar el modal se
                                        sincronizan los valores.
                                        Tambien puedes escribir aqui.
                                    </p>
                                    <div class="collapse" id="bodyMeasuresCollapse">
                                        <div class="row g-3">
                                            <div class="col-6 col-lg-4">
                                                <label class="form-label small" for="height_cm">Altura (cm)</label>
                                                <input class="form-control" data-measure="height_cm" id="height_cm"
                                                    placeholder="175" type="number" step="0.1" />
                                            </div>
                                            <div class="col-6 col-lg-4">
                                                <label class="form-label small" for="weight_kg">Peso (kg)</label>
                                                <input class="form-control" data-measure="weight_kg" id="weight_kg"
                                                    placeholder="78" type="number" step="0.1" />
                                            </div>
                                            <div class="col-6 col-lg-4">
                                                <label class="form-label small" for="cuello">Cuello (cm)</label>
                                                <input class="form-control" data-measure="cuello" id="cuello"
                                                    placeholder="39" type="number" step="0.1" />
                                            </div>
                                            <div class="col-6 col-lg-4">
                                                <label class="form-label small" for="hombros">Hombros (cm)</label>
                                                <input class="form-control" data-measure="hombros" id="hombros"
                                                    placeholder="112" type="number" step="0.1" />
                                            </div>
                                            <div class="col-6 col-lg-4">
                                                <label class="form-label small" for="torax">Torax (cm)</label>
                                                <input class="form-control" data-measure="torax" id="torax"
                                                    placeholder="104" type="number" step="0.1" />
                                            </div>
                                            <div class="col-6 col-lg-4">
                                                <label class="form-label small" for="cintura">Cintura (cm)</label>
                                                <input class="form-control" data-measure="cintura" id="cintura"
                                                    placeholder="82" type="number" step="0.1" />
                                            </div>
                                            <div class="col-6 col-lg-4">
                                                <label class="form-label small" for="cadera">Cadera (cm)</label>
                                                <input class="form-control" data-measure="cadera" id="cadera"
                                                    placeholder="98" type="number" step="0.1" />
                                            </div>
                                            <div class="col-6 col-lg-4">
                                                <label class="form-label small" for="biceps_izq">Biceps izq (cm)</label>
                                                <input class="form-control" data-measure="biceps_izq" id="biceps_izq"
                                                    placeholder="36" type="number" step="0.1" />
                                            </div>
                                            <div class="col-6 col-lg-4">
                                                <label class="form-label small" for="biceps_der">Biceps der (cm)</label>
                                                <input class="form-control" data-measure="biceps_der" id="biceps_der"
                                                    placeholder="36" type="number" step="0.1" />
                                            </div>
                                            <div class="col-6 col-lg-4">
                                                <label class="form-label small" for="antebrazo_izq">Antebrazo izq
                                                    (cm)</label>
                                                <input class="form-control" data-measure="antebrazo_izq"
                                                    id="antebrazo_izq" placeholder="28" type="number" step="0.1" />
                                            </div>
                                            <div class="col-6 col-lg-4">
                                                <label class="form-label small" for="antebrazo_der">Antebrazo der
                                                    (cm)</label>
                                                <input class="form-control" data-measure="antebrazo_der"
                                                    id="antebrazo_der" placeholder="28" type="number" step="0.1" />
                                            </div>
                                            <div class="col-6 col-lg-4">
                                                <label class="form-label small" for="muslo_izq">Muslo izq (cm)</label>
                                                <input class="form-control" data-measure="muslo_izq" id="muslo_izq"
                                                    placeholder="58" type="number" step="0.1" />
                                            </div>
                                            <div class="col-6 col-lg-4">
                                                <label class="form-label small" for="muslo_der">Muslo der (cm)</label>
                                                <input class="form-control" data-measure="muslo_der" id="muslo_der"
                                                    placeholder="58" type="number" step="0.1" />
                                            </div>
                                            <div class="col-6 col-lg-4">
                                                <label class="form-label small" for="pantorrilla_izq">Pantorrilla izq
                                                    (cm)</label>
                                                <input class="form-control" data-measure="pantorrilla_izq"
                                                    id="pantorrilla_izq" placeholder="38" type="number" step="0.1" />
                                            </div>
                                            <div class="col-6 col-lg-4">
                                                <label class="form-label small" for="pantorrilla_der">Pantorrilla der
                                                    (cm)</label>
                                                <input class="form-control" data-measure="pantorrilla_der"
                                                    id="pantorrilla_der" placeholder="38" type="number" step="0.1" />
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Carrusel de ejemplos visuales -->
                                    <div class="mt-4 border-top border-secondary pt-3">
                                        <h6 class="text-secondary small text-uppercase fw-bold mb-3">Referencias
                                            Visuales</h6>
                                        <div class="d-flex justify-content-center gap-3 overflow-auto pb-2"
                                            style="scrollbar-width: thin;">
                                            <div class="rounded border border-secondary skeleton-pulse position-relative"
                                                style="height: 100px; min-width: 100px; background-color: #f2f2f2; overflow: hidden;">
                                                <img src="/static/images/examples/ref1.png"
                                                    data-male="/static/images/examples/ref1.png"
                                                    data-female="/static/images/examples/rf4.png"
                                                    class="example-img img-skeleton w-100 h-100"
                                                    style="cursor: pointer; object-fit: contain;" alt="Ejemplo 1"
                                                    onclick="openZoomModal(this.src)"
                                                    onload="this.parentElement.classList.remove('skeleton-pulse'); this.classList.add('loaded')">
                                            </div>

                                            <div class="rounded border border-secondary skeleton-pulse position-relative"
                                                style="height: 100px; min-width: 100px; background-color: #f2f2f2; overflow: hidden;">
                                                <img src="/static/images/examples/ref3.png"
                                                    data-male="/static/images/examples/ref3.png"
                                                    data-female="/static/images/examples/rf6.png"
                                                    class="example-img img-skeleton w-100 h-100"
                                                    style="cursor: pointer; object-fit: contain;" alt="Ejemplo 2"
                                                    onclick="openZoomModal(this.src)"
                                                    onload="this.parentElement.classList.remove('skeleton-pulse'); this.classList.add('loaded')">
                                            </div>

                                            <div class="rounded border border-secondary skeleton-pulse position-relative"
                                                style="height: 100px; min-width: 100px; background-color: #f2f2f2; overflow: hidden;">
                                                <img src="/static/images/examples/ref2.png"
                                                    data-male="/static/images/examples/ref2.png"
                                                    data-female="/static/images/examples/rf5.png"
                                                    class="example-img img-skeleton w-100 h-100"
                                                    style="cursor: pointer; object-fit: contain;" alt="Ejemplo 3"
                                                    onclick="openZoomModal(this.src)"
                                                    onload="this.parentElement.classList.remove('skeleton-pulse'); this.classList.add('loaded')">
                                            </div>
                                        </div>
                                        <small class="text-muted" style="font-size: 0.75rem;">* Click para ver en
                                            pantalla completa.</small>
                                    </div>
                                </section>

                                <section class="mb-4">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <button id="photoObservationsToggle"
                                            class="btn btn-link text-decoration-none px-0 d-flex align-items-center gap-2"
                                            type="button" aria-expanded="false"
                                            aria-controls="photoObservationsCollapse">
                                            <span class="section-title h5 mb-0">Observaciones de fotos</span>
                                            <i class="fas fa-chevron-down text-secondary chevron-rotate"
                                                id="photoObservationsChevron"></i>
                                        </button>
                                        <button class="btn btn-outline-light btn-sm" id="add-photo" type="button">
                                            + Anadir vista
                                        </button>
                                    </div>
                                    <div class="collapse" id="photoObservationsCollapse">
                                        <p class="text-secondary small mb-3">
                                            Sube tus fotos (frontal, perfil, posterior).
                                        </p>
                                        <div class="vstack gap-3" id="photo-list"></div>
                                    </div>
                                </section>

                                <div class="d-flex flex-wrap gap-2">
                                    <button class="btn btn-primary" id="submit-btn" type="submit">
                                        Generar evaluación
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-12 col-xl-5">
                    <div class="card h-100">
                        <div class="card-body d-flex flex-column">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h2 class="section-title h5 mb-0">Resultado del agente</h2>
                                <select id="history-selector"
                                    class="form-select form-select-sm bg-dark text-white border-secondary"
                                    style="width: auto; max-width: 150px; font-size: 0.8rem; display:none;">
                                    <option value="new">Nuevo Análisis</option>
                                </select>
                            </div>
                            <!-- Boton historial colocado debajo del selector segun lo solicitado -->
                            <div class="mb-3 text-end">
                                <button type="button" class="btn btn-outline-info btn-sm" onclick="goToHistory()">
                                    <i class="fas fa-history me-2"></i>Ver Historial Completo
                                </button>
                            </div>

                            <!-- Estado placeholder -->
                            <div id="result-placeholder"
                                class="d-flex flex-column align-items-center justify-content-center h-100 py-5 text-secondary opacity-75">
                                <i class="fas fa-chart-pie fa-3x mb-3 opacity-25"></i>
                                <p class="mb-0 fw-light small text-uppercase letter-spacing-1">Esperando datos...</p>
                            </div>

                            <!-- Contenedor de reporte visual -->
                            <div id="result-container" class="d-none flex-column h-100">
                                <ul class="nav nav-tabs border-secondary mb-3 flex-nowrap overflow-auto" role="tablist"
                                    style="white-space: nowrap;">
                                    <li class="nav-item">
                                        <button class="nav-link active text-theme bg-transparent" data-bs-toggle="tab"
                                            data-bs-target="#tab-visual">Reporte Visual</button>
                                    </li>
                                    {% if current_user_role == 'admin' %}
                                    <li class="nav-item admin-only d-none">
                                        <button class="nav-link text-theme bg-transparent" data-bs-toggle="tab"
                                            data-bs-target="#tab-admin-comments">Comentarios Admin</button>
                                    </li>
                                    <li class="nav-item admin-only d-none">
                                        <button class="nav-link text-theme bg-transparent" data-bs-toggle="tab"
                                            data-bs-target="#tab-admin-adjust">Ajustes Manuales</button>
                                    </li>
                                    <li class="nav-item admin-only d-none">
                                        <button class="nav-link text-theme bg-transparent" data-bs-toggle="tab"
                                            data-bs-target="#tab-json">JSON</button>
                                    </li>
                                    {% endif %}
                                </ul>

                                <div class="tab-content flex-grow-1" style="overflow-y:auto; padding-right:5px;">
                                    <!-- Pestana visual -->
                                    <div class="tab-pane fade show active" id="tab-visual">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <span class="badge bg-secondary font-monospace" id="res-backend"></span>
                                            <span class="badge bg-primary badge-focus" id="res-focus"></span>
                                        </div>

                                        <!-- Metricas (siempre visibles) -->
                                        <div class="row g-2 mb-4" id="res-metrics"></div>

                                        <!-- Acordeon para secciones detalladas -->
                                        <div class="accordion" id="assessmentAccordion">

                                            <!-- Resumen -->
                                            <div class="accordion-item bg-transparent border-secondary">
                                                <h2 class="accordion-header" id="headingSummary">
                                                    <button
                                                        class="accordion-button collapsed bg-dark text-white shadow-none"
                                                        type="button" data-bs-toggle="collapse"
                                                        data-bs-target="#collapseSummary">
                                                        <i class="fas fa-align-left me-2 text-primary"></i> Resumen
                                                    </button>
                                                </h2>
                                                <div id="collapseSummary" class="accordion-collapse collapse"
                                                    data-bs-parent="#assessmentAccordion">
                                                    <div class="accordion-body text-theme small">
                                                        <p id="res-summary" class="mb-0"></p>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Gasto energetico -->
                                            <div class="accordion-item bg-transparent border-secondary">
                                                <h2 class="accordion-header" id="headingEnergy">
                                                    <button
                                                        class="accordion-button collapsed bg-dark text-white shadow-none"
                                                        type="button" data-bs-toggle="collapse"
                                                        data-bs-target="#collapseEnergy">
                                                        <i class="fas fa-fire me-2 text-warning"></i> Gasto Energético
                                                    </button>
                                                </h2>
                                                <div id="collapseEnergy" class="accordion-collapse collapse"
                                                    data-bs-parent="#assessmentAccordion">
                                                    <div class="accordion-body">
                                                        <div class="card bg-dark border-secondary">
                                                            <div class="card-body">
                                                                <div
                                                                    class="d-flex justify-content-between align-items-center mb-2">
                                                                    <span
                                                                        class="text-secondary small text-uppercase">Tasa
                                                                        Metabólica Basal (TMB)</span>
                                                                    <span class="text-warning fw-bold fs-5" id="res-tmb"
                                                                        style="text-shadow: 0 0 10px rgba(255, 193, 7, 0.3);">--
                                                                        kcal</span>
                                                                </div>
                                                                <hr class="border-secondary my-2" style="opacity: 0.2">
                                                                <small
                                                                    class="text-info d-block mb-3 text-uppercase fw-bold"
                                                                    style="font-size: 0.75rem; letter-spacing: 1px;">Gasto
                                                                    Total Diario (TDEE)</small>
                                                                <ul class="list-unstyled mb-0 small" id="res-tdee-list">
                                                                </ul>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Proporciones -->
                                            <div class="accordion-item bg-transparent border-secondary">
                                                <h2 class="accordion-header" id="headingProps">
                                                    <button
                                                        class="accordion-button collapsed bg-dark text-white shadow-none"
                                                        type="button" data-bs-toggle="collapse"
                                                        data-bs-target="#collapseProps">
                                                        <i class="fas fa-ruler-combined me-2 text-info"></i> Análisis de
                                                        Proporciones
                                                    </button>
                                                </h2>
                                                <div id="collapseProps" class="accordion-collapse collapse"
                                                    data-bs-parent="#assessmentAccordion">
                                                    <div class="accordion-body">
                                                        <div class="p-3 rounded" style="background: var(--bg-input);">
                                                            <p id="res-symmetry"
                                                                class="mb-2 text-info small fst-italic"></p>
                                                            <div class="d-flex flex-wrap gap-3 small text-secondary">
                                                                <span id="res-prop-wh"></span>
                                                                <span id="res-prop-whip"></span>
                                                                <span id="res-prop-wc"></span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Recomendaciones -->
                                            <div class="accordion-item bg-transparent border-secondary">
                                                <h2 class="accordion-header" id="headingActions">
                                                    <button
                                                        class="accordion-button collapsed bg-dark text-white shadow-none"
                                                        type="button" data-bs-toggle="collapse"
                                                        data-bs-target="#collapseActions">
                                                        <i class="fas fa-clipboard-list me-2 text-success"></i>
                                                        Recomendaciones
                                                    </button>
                                                </h2>
                                                <div id="collapseActions" class="accordion-collapse collapse"
                                                    data-bs-parent="#assessmentAccordion">
                                                    <div class="accordion-body p-0">
                                                        <ul id="res-actions"
                                                            class="list-group list-group-flush bg-transparent"></ul>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Feedback de fotos -->
                                            <div class="accordion-item bg-transparent border-secondary">
                                                <h2 class="accordion-header" id="headingPhotos">
                                                    <button
                                                        class="accordion-button collapsed bg-dark text-white shadow-none"
                                                        type="button" data-bs-toggle="collapse"
                                                        data-bs-target="#collapsePhotos">
                                                        <i class="fas fa-camera-retro me-2 text-secondary"></i> Feedback
                                                        Fotos
                                                    </button>
                                                </h2>
                                                <div id="collapsePhotos" class="accordion-collapse collapse"
                                                    data-bs-parent="#assessmentAccordion">
                                                    <div class="accordion-body p-0">
                                                        <ul id="res-photos"
                                                            class="list-group list-group-flush bg-transparent"></ul>
                                                    </div>
                                                </div>
                                            </div>

                                        </div>
                                    </div>

                                    {% if current_user_role == 'admin' %}
                                    <div class="tab-pane fade admin-only d-none" id="tab-admin-comments">
                                        <div class="row g-3">
                                            <div class="col-12">
                                                <div class="card border-secondary">
                                                    <div class="card-body">
                                                        <h6 class="section-title h6 mb-3">Notas internas (Admin)</h6>
                                                        <textarea id="admin-notes-internal" class="form-control"
                                                            rows="4"
                                                            placeholder="Notas internas para el equipo admin"></textarea>
                                                        <div class="text-secondary small mt-2">Solo visible para
                                                            administradores.</div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-12">
                                                <div class="card border-secondary">
                                                    <div class="card-body">
                                                        <h6 class="section-title h6 mb-3">Notas para la evaluacion</h6>
                                                        <textarea id="admin-notes-user" class="form-control" rows="4"
                                                            placeholder="Comentarios a incluir en la evaluacion del usuario"></textarea>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="tab-pane fade admin-only d-none" id="tab-admin-adjust">
                                        <div class="card border-secondary">
                                            <div class="card-body">
                                                <h6 class="section-title h6 mb-3">Ajustes manuales</h6>
                                                <div class="mb-3">
                                                    <label class="form-label" for="admin-tdee-select">Seleccionar
                                                        TDEE</label>
                                                    <select id="admin-tdee-select" class="form-select"></select>
                                                </div>
                                                <div class="row g-3">
                                                    <div class="col-12 col-md-6">
                                                        <label class="form-label" for="admin-tdee-kcal">TDEE
                                                            (kcal)</label>
                                                        <input id="admin-tdee-kcal" type="number" class="form-control"
                                                            placeholder="Ej: 2200" min="0" step="1">
                                                    </div>
                                                    <div class="col-12 col-md-6">
                                                        <label class="form-label" for="admin-kcal-target">Ajustar
                                                            kcal</label>
                                                        <input id="admin-kcal-target" type="number" class="form-control"
                                                            placeholder="Ej: 2000" min="0" step="1">
                                                    </div>
                                                </div>
                                                <div class="text-secondary small mt-2">
                                                    Estos cambios se guardan junto con la evaluacion.
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Pestana JSON -->
                                    <div class="tab-pane fade admin-only d-none" id="tab-json">
                                        <pre id="result-output" class="result-pre text-small"></pre>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        </footer>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script src="/static/js/lang.js"></script>
        <script src="/static/js/theme.js"></script>

        <!-- Modal de seguimiento corporal -->
        <div class="modal fade" id="bodyTrackingModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-xl">
                <div class="modal-content bg-dark border-secondary">
                    <div class="modal-header border-secondary">
                        <h5 class="modal-title text-white">Seguimiento corporal</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                    </div>
                    <div class="modal-body p-0">
                        <iframe src="/tracking?embed=1" title="Seguimiento corporal" class="w-100 border-0"
                            style="height: 80vh; background: var(--bg-body);"></iframe>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de zoom de imagen -->
        <div class="modal fade" id="imageZoomModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content bg-dark border-secondary">
                    <div class="modal-body p-0 position-relative text-center">
                        <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3"
                            data-bs-dismiss="modal" aria-label="Close"
                            style="z-index: 10; background-color: rgba(0,0,0,0.5); border-radius: 50%; padding: 0.5rem;"></button>
                        <img id="zoomedImage" src="" class="img-fluid" style="max-height: 90vh;" alt="Vista completa">
                    </div>
                </div>
            </div>
        </div>

        <script>
            const photoList = document.getElementById("photo-list");
            const loadingIndicator = document.getElementById("loading-indicator");
            const resultOutput = document.getElementById("result-output");
            const submitBtn = document.getElementById("submit-btn");
            const sexSelect = document.getElementById("sex");
            const exampleImages = Array.from(document.querySelectorAll(".example-img"));
            let zoomModal;
            let photoObservationsApi = null;

            const isAdminUnlocked = () => {
                try {
                    return sessionStorage.getItem('admin_unlocked') === 'true';
                } catch (e) {
                    return false;
                }
            };

            const initAdminTabs = () => {
                if (!isAdminUnlocked()) return;
                document.querySelectorAll('.admin-only').forEach((el) => {
                    el.classList.remove('d-none');
                });
            };

            const updateExampleImages = () => {
                if (!sexSelect || !exampleImages.length) return;
                const useFemale = sexSelect.value === "female";
                exampleImages.forEach((img) => {
                    const nextSrc = useFemale ? img.dataset.female : img.dataset.male;
                    // Check if src is actually changing (ignoring base URL differences if possible, but safe to just reset)
                    if (nextSrc && !img.src.endsWith(nextSrc)) {
                        // Shared Utility
                        window.loadImageWithSkeleton(img, nextSrc);
                    }
                });
            };

            const measurementAliases = {
                height_cm: ["height_cm", "altura_cm", "altura"],
                weight_kg: ["weight_kg", "weight", "peso", "peso_kg"],
                cuello: ["cuello", "neck"],
                hombros: ["hombros", "shoulders"],
                torax: ["torax", "chest", "pecho"],
                cintura: ["cintura", "waist"],
                cadera: ["cadera", "hip", "hips"],
                biceps_izq: ["biceps_izq", "biceps_left", "arm_flexed_left", "arm_relaxed_left", "arm_left"],
                biceps_der: ["biceps_der", "biceps_right", "arm_flexed_right", "arm_relaxed_right", "arm_right"],
                antebrazo_izq: ["antebrazo_izq", "forearm_left"],
                antebrazo_der: ["antebrazo_der", "forearm_right"],
                muslo_izq: ["muslo_izq", "thigh_left"],
                muslo_der: ["muslo_der", "thigh_right"],
                pantorrilla_izq: ["pantorrilla_izq", "calf_left"],
                pantorrilla_der: ["pantorrilla_der", "calf_right"],
            };

            const resolveMeasureValue = (measures, key) => {
                const aliases = measurementAliases[key] || [key];
                for (const alias of aliases) {
                    if (measures[alias] !== undefined && measures[alias] !== null && measures[alias] !== "") {
                        return measures[alias];
                    }
                }
                return null;
            };

            const syncFromTracking = () => {
                try {
                    const stored = localStorage.getItem('updated_body_measurements');
                    if (!stored) return;
                    const data = JSON.parse(stored);

                    const normalizeKey = (rawKey) => {
                        if (!rawKey) return "";
                        let key = rawKey.toLowerCase().replace(/\s+/g, "_");
                        if (key.normalize) {
                            key = key.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                        }

                        let side = "";
                        if (key.includes("_izquierda")) {
                            side = "izq";
                            key = key.replace("_izquierda", "");
                        } else if (key.includes("_derecha")) {
                            side = "der";
                            key = key.replace("_derecha", "");
                        } else if (key.includes("_derecho")) {
                            side = "der";
                            key = key.replace("_derecho", "");
                        } else if (key.includes("_left")) {
                            side = "izq";
                            key = key.replace("_left", "");
                        } else if (key.includes("_right")) {
                            side = "der";
                            key = key.replace("_right", "");
                        }

                        return side ? `${key}_${side}` : key;
                    };

                    // Map tracking keys to form IDs
                    const map = {
                        weight_kg: "weight_kg",
                        cuello: "cuello",
                        torax: "torax",
                        hombros: "hombros",
                        cintura: "cintura",
                        cadera: "cadera",
                        biceps_izq: "biceps_izq",
                        biceps_der: "biceps_der",
                        antebrazo_izq: "antebrazo_izq",
                        antebrazo_der: "antebrazo_der",
                        muslo_izq: "muslo_izq",
                        muslo_der: "muslo_der",
                        pantorrilla_izq: "pantorrilla_izq",
                        pantorrilla_der: "pantorrilla_der",
                        neck: "cuello",
                        chest: "torax",
                        shoulders: "hombros",
                        waist: "cintura",
                        hip: "cadera",
                        hips: "cadera",
                        forearm_left: "antebrazo_izq",
                        forearm_right: "antebrazo_der",
                        forearm_izq: "antebrazo_izq",
                        forearm_der: "antebrazo_der",
                        thigh_left: "muslo_izq",
                        thigh_right: "muslo_der",
                        thigh_izq: "muslo_izq",
                        thigh_der: "muslo_der",
                        calf_left: "pantorrilla_izq",
                        calf_right: "pantorrilla_der",
                        calf_izq: "pantorrilla_izq",
                        calf_der: "pantorrilla_der",
                    };

                    Object.keys(data).forEach(key => {
                        // Handle side specific keys first by checking exact match, then base key
                        const normalizedKey = normalizeKey(key);
                        let targetId = map[normalizedKey] || map[key];

                        if (targetId) {
                            const el = document.getElementById(targetId);
                            if (el && data[key] && data[key] !== "0.0") {
                                el.value = data[key];
                                el.style.borderColor = "var(--primary)";
                            }
                        }
                    });
                } catch (e) { console.error("Sync Error", e); }
            };

            // Independent listener for sync
            document.addEventListener('DOMContentLoaded', () => {
                syncFromTracking();
                const modalParams = document.getElementById('bodyTrackingModal');
                if (modalParams) {
                    modalParams.addEventListener('hidden.bs.modal', syncFromTracking);
                }
            });

            // --- Auto-Load User Data (Standard User Mode) ---
            document.addEventListener('DOMContentLoaded', async () => {
                const modalEl = document.getElementById('imageZoomModal');
                if (modalEl) zoomModal = new bootstrap.Modal(modalEl);
                initAdminTabs();

                const tabLinks = document.querySelectorAll('#result-container .nav-link[data-bs-toggle="tab"]');
                const tabContent = document.querySelector('#result-container .tab-content');
                tabLinks.forEach((tab) => {
                    tab.addEventListener('shown.bs.tab', () => {
                        if (tabContent) tabContent.scrollTop = 0;
                    });
                });

                const tdeeSelect = document.getElementById('admin-tdee-select');
                const tdeeKcalInput = document.getElementById('admin-tdee-kcal');
                if (tdeeSelect && tdeeKcalInput) {
                    tdeeSelect.addEventListener('change', () => {
                        const opt = tdeeSelect.options[tdeeSelect.selectedIndex];
                        if (opt && opt.dataset && opt.dataset.kcal) {
                            tdeeKcalInput.value = opt.dataset.kcal;
                        }
                    });
                }

                if (sexSelect) {
                    sexSelect.addEventListener('change', updateExampleImages);
                    updateExampleImages();
                }

                const measuresCollapse = document.getElementById('bodyMeasuresCollapse');
                const measuresChevron = document.getElementById('bodyMeasuresChevron');
                const measuresToggle = document.getElementById('bodyMeasuresToggle');
                if (measuresCollapse && measuresChevron && measuresToggle) {
                    const collapseApi = new bootstrap.Collapse(measuresCollapse, { toggle: false });
                    measuresToggle.addEventListener('click', (event) => {
                        event.preventDefault();
                        collapseApi.toggle();
                    });
                    measuresCollapse.addEventListener('show.bs.collapse', () => {
                        measuresChevron.classList.add('rotate-180');
                        measuresToggle.setAttribute('aria-expanded', 'true');
                    });
                    measuresCollapse.addEventListener('hide.bs.collapse', () => {
                        measuresChevron.classList.remove('rotate-180');
                        measuresToggle.setAttribute('aria-expanded', 'false');
                    });
                }

                const photoObservationsCollapse = document.getElementById('photoObservationsCollapse');
                const photoObservationsChevron = document.getElementById('photoObservationsChevron');
                const photoObservationsToggle = document.getElementById('photoObservationsToggle');
                if (photoObservationsCollapse && photoObservationsChevron && photoObservationsToggle) {
                    photoObservationsApi = new bootstrap.Collapse(photoObservationsCollapse, { toggle: false });
                    photoObservationsToggle.addEventListener('click', (event) => {
                        event.preventDefault();
                        photoObservationsApi.toggle();
                    });
                    photoObservationsCollapse.addEventListener('show.bs.collapse', () => {
                        photoObservationsChevron.classList.add('rotate-180');
                        photoObservationsToggle.setAttribute('aria-expanded', 'true');
                    });
                    photoObservationsCollapse.addEventListener('hide.bs.collapse', () => {
                        photoObservationsChevron.classList.remove('rotate-180');
                        photoObservationsToggle.setAttribute('aria-expanded', 'false');
                    });
                }

                const userJson = localStorage.getItem('ai_fitness_user');
                let userId = null;

                if (userJson) {
                    try {
                        const user = JSON.parse(userJson);
                        userId = user.user_id; // Standardize on user_id

                        // Set hidden field
                        document.getElementById('user_id').value = userId;
                        // Optional: set display name if elements exist
                        if (document.getElementById('display_user_name')) {
                            document.getElementById("display_user_name").value = user.name || user.username || userId;
                        }

                        const trackingFrame = document.querySelector('#bodyTrackingModal iframe');
                        if (trackingFrame) {
                            const baseUrl = trackingFrame.getAttribute('src') || '/tracking?embed=1';
                            const joiner = baseUrl.includes('?') ? '&' : '?';
                            trackingFrame.setAttribute('src', `${baseUrl}${joiner}user_id=${encodeURIComponent(userId)}`);
                        }

                        loadHistory(userId);

                        // Use new aggregated endpoint
                        showLoader("Sincronizando perfil...");
                        try {
                            const resp = await fetch(`/api/user/my_profile`);
                            if (resp.ok) {
                                const data = await resp.json();
                                // Populate form
                                if (data.sex) document.getElementById("sex").value = data.sex;
                                updateExampleImages();
                                if (data.age) document.getElementById("age").value = data.age;

                                const goalVal = data.goal || data.goals;
                                if (goalVal) document.getElementById("goal").value = goalVal;

                                // Activity level might not be on the profile response if not stored in plan correctly, 
                                // but if it is, set it. Otherwise keep default or 'sedentary'
                                if (data.activity_level) document.getElementById("activity_level").value = data.activity_level;

                                if (data.notes) document.getElementById("notes").value = data.notes;

                                const measures = data.measurements || {};
                                document.querySelectorAll("[data-measure]").forEach(input => {
                                    const key = input.getAttribute("data-measure");
                                    const value = resolveMeasureValue(measures, key);
                                    if (value !== null) input.value = value;
                                });
                            }
                        } catch (e) {
                            console.log('Could not auto-load detailed profile', e);
                        } finally {
                            hideLoader();
                        }

                    } catch (e) { console.error('Error parsing user', e); }
                } else {
                    // Redirect if no user? Or let them browse?
                    // alert("Por favor inicia sesión");
                }
            });

            function createPhotoRow(initial = {}) {
                const wrapper = document.createElement("div");
                wrapper.className = "photo-row card mb-3 border-secondary bg-dark";
                const uid = `photo_${Date.now()}_${Math.floor(Math.random() * 1e6)}`;

                // Simplified Row (No Quality/Notes shown)
                wrapper.innerHTML = `
          <div class="card-body p-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
               <h6 class="card-title mb-0 text-white"><i class="fas fa-camera me-2 text-secondary"></i> Nueva Foto</h6>
               <button type="button" class="btn btn-sm btn-outline-danger remove-photo"><i class="fas fa-trash"></i></button>
            </div>
            <div class="row g-3">
                <div class="col-12">
                    <label class="form-label small text-secondary">Vista</label>
                    <select class="form-select form-select-sm bg-black text-white border-secondary photo-view">
                        <option value="frontal" ${initial.view === 'frontal' ? 'selected' : ''}>Frontal</option>
                        <option value="perfil" ${initial.view === 'perfil' ? 'selected' : ''}>Perfil</option>
                        <option value="posterior" ${initial.view === 'posterior' ? 'selected' : ''}>Posterior</option>
                        <option value="otro" ${initial.view && !['frontal', 'perfil', 'posterior'].includes(initial.view) ? 'selected' : ''}>Otro</option>
                    </select>
                </div>
                <!-- Campos ocultos por compatibilidad -->
                <div class="d-none">
                    <select class="photo-quality"><option value="alta" selected>Alta</option></select>
                    <input type="hidden" class="photo-notes" value="" />
                </div>
                
                <div class="col-12">
                    <div class="d-flex align-items-center gap-3 p-2 border border-secondary rounded bg-black">
                        <div class="flex-grow-1">
                             <input type="file" accept="image/*" class="form-control form-control-sm bg-dark text-secondary border-0 photo-file" data-file-key="${uid}" />
                        </div>
                        <img src="" class="img-thumbnail-preview" style="width:50px; height:50px; object-fit:cover; display:none; border-radius:4px; border:1px solid var(--border-color);" alt="Preview"/>
                    </div>
                </div>
            </div>
          </div>
        `;

                const fileInput = wrapper.querySelector(".photo-file");
                const imgPreview = wrapper.querySelector(".img-thumbnail-preview");

                fileInput.addEventListener('change', function (e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            imgPreview.src = e.target.result;
                            imgPreview.style.display = 'block';
                        }
                        reader.readAsDataURL(file);
                    } else {
                        imgPreview.src = '';
                        imgPreview.style.display = 'none';
                    }
                });

                imgPreview.addEventListener('click', function () {
                    if (imgPreview.src && zoomModal) {
                        document.getElementById('zoomedImage').src = imgPreview.src;
                        zoomModal.show();
                    }
                });

                wrapper.querySelector(".remove-photo").addEventListener("click", () => {
                    wrapper.remove();
                });

                return wrapper;
            }

            function ensurePhotoRows() {
                if (!photoList.children.length) {
                    photoList.appendChild(
                        createPhotoRow({ view: "frontal" })
                    );
                }
            }

            document.getElementById("add-photo").addEventListener("click", () => {
                const photoObservationsCollapse = document.getElementById('photoObservationsCollapse');
                if (photoObservationsApi && photoObservationsCollapse && !photoObservationsCollapse.classList.contains('show')) {
                    photoObservationsApi.show();
                }
                photoList.appendChild(createPhotoRow());
            });

            ensurePhotoRows();

            // History Logic
            let currentHistory = [];
            const historySelector = document.getElementById('history-selector');

            async function loadHistory(userId) {
                showLoader("Buscando historial...");
                try {
                    historySelector.style.display = 'none';
                    historySelector.innerHTML = '<option value="new">Nuevo Análisis</option>';
                    currentHistory = [];

                    const resp = await fetch(`/ai/body_assessment/history/${userId}`);
                    if (resp.ok) {
                        const histData = await resp.json();
                        if (histData.length > 0) {
                            currentHistory = histData;
                            histData.forEach((item, idx) => {
                                const op = document.createElement('option');
                                op.value = idx; // index in currentHistory
                                op.text = item.date;
                                historySelector.appendChild(op);
                            });
                            historySelector.style.display = 'block';
                        }
                    }
                    // Reset view to new
                    renderAssessmentResult(null);
                    historySelector.value = "new";

                } catch (e) {
                    console.error("History error", e);
                } finally {
                    hideLoader();
                }
            }

            historySelector.addEventListener('change', function () {
                if (this.value === 'new') {
                    renderAssessmentResult(null);
                } else {
                    const item = currentHistory[this.value];
                    if (item) {
                        // Construct a mock response object consistent with renderAssessmentResult expectation
                        const mockData = {
                            backend: item.backend,
                            output: item.output,
                            input: item.input || {}
                        };
                        renderAssessmentResult(mockData);
                    }
                }
            });


            document.getElementById("assessment-form").addEventListener("submit", async (event) => {
                event.preventDefault();

                const form = event.target;
                const payload = {
                    user_id: form.user_id.value.trim() || null,
                    sex: form.sex.value,
                    age: form.age.value ? Number(form.age.value) : null,
                    goal: form.goal.value || null,
                    activity_level: form.activity_level.value || "sedentary",
                    notes: form.notes.value.trim() || null,
                    measurements: {},
                    photos: [],
                };

                if (isAdminUnlocked()) {
                    const adminInternalNotes = document.getElementById('admin-notes-internal');
                    const adminUserNotes = document.getElementById('admin-notes-user');
                    const tdeeSelect = document.getElementById('admin-tdee-select');
                    const tdeeKcalInput = document.getElementById('admin-tdee-kcal');
                    const kcalTargetInput = document.getElementById('admin-kcal-target');

                    const internalNotes = adminInternalNotes ? adminInternalNotes.value.trim() : '';
                    const userNotes = adminUserNotes ? adminUserNotes.value.trim() : '';

                    if (internalNotes) {
                        payload.admin_internal_notes = internalNotes;
                    }
                    if (userNotes) {
                        payload.admin_user_notes = userNotes;
                    }

                    if (tdeeSelect || tdeeKcalInput || kcalTargetInput) {
                        const manualAdjustments = {
                            selected_tdee: tdeeSelect && tdeeSelect.value ? tdeeSelect.value : null,
                            tdee_kcal: tdeeKcalInput && tdeeKcalInput.value ? Number(tdeeKcalInput.value) : null,
                            kcal_target: kcalTargetInput && kcalTargetInput.value ? Number(kcalTargetInput.value) : null,
                        };
                        if (manualAdjustments.selected_tdee || manualAdjustments.tdee_kcal || manualAdjustments.kcal_target) {
                            payload.manual_adjustments = manualAdjustments;
                        }
                    }
                }

                form.querySelectorAll("[data-measure]").forEach((input) => {
                    const key = input.getAttribute("data-measure");
                    const value = input.value.trim();
                    if (value !== "") {
                        payload.measurements[key] = Number(value);
                    }
                });

                const formData = new FormData();
                photoList.querySelectorAll(".photo-row").forEach((row, idx) => {
                    const view = row.querySelector(".photo-view").value.trim();
                    const quality = row.querySelector(".photo-quality").value.trim();
                    const notes = row.querySelector(".photo-notes").value.trim();
                    const fileInput = row.querySelector(".photo-file");
                    const file = fileInput ? (fileInput.files && fileInput.files[0]) : null;
                    const fileKey = file && file.size > 0 ? (fileInput.getAttribute("data-file-key") || `photo_${idx}`) : null;
                    if (file && fileKey) {
                        formData.append(fileKey, file);
                    }
                    if (view || quality || notes || fileKey) {
                        payload.photos.push({ view, quality, notes, file_key: fileKey });
                    }
                });

                showLoader("Analizando evaluación con el Agente...");
                submitBtn.disabled = true;

                // Reset UI
                document.getElementById('result-placeholder').style.display = 'block';
                document.getElementById('result-container').style.display = 'none';

                try {
                    const metricsResp = await fetch("/ai/body_assessment/metrics", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload),
                    });
                    const metricsData = await metricsResp.json();
                    if (!metricsResp.ok) {
                        throw new Error(metricsData.error || "Error al generar metricas");
                    }

                    let photoData = null;
                    const hasPhotos = payload.photos.length > 0;
                    if (hasPhotos) {
                        formData.append("payload", JSON.stringify(payload));
                        const photoResp = await fetch("/ai/body_assessment/photos", {
                            method: "POST",
                            body: formData,
                        });
                        photoData = await photoResp.json();
                        if (!photoResp.ok) {
                            throw new Error(photoData.error || "Error al analizar fotos");
                        }
                    }

                    const combined = mergeAssessmentOutputs(metricsData, photoData);
                    renderAssessmentResult(combined);
                    await persistAssessment(combined);
                } catch (e) {
                    console.error(e);
                    showAlertModal("Error", e.message, "danger");
                } finally {
                    submitBtn.disabled = false;
                    hideLoader();
                }
                });

                function mergeAssessmentOutputs(metricsData, photoData) {
                    const combined = {
                        backend: metricsData.backend || "unknown",
                        input: metricsData.input || {},
                        output: Object.assign({}, metricsData.output || {}),
                    };

                    if (photoData && photoData.output) {
                        if (photoData.input && photoData.input.photos) {
                            combined.input.photos = photoData.input.photos;
                        }
                        if (photoData.output.photo_feedback !== undefined) {
                            combined.output.photo_feedback = photoData.output.photo_feedback;
                        }
                        if (photoData.output.proportions && photoData.output.proportions.symmetry_notes) {
                            combined.output.proportions = combined.output.proportions || {};
                            combined.output.proportions.symmetry_notes = photoData.output.proportions.symmetry_notes;
                            combined.output.body_proportions = combined.output.body_proportions || {};
                            combined.output.body_proportions.symmetry_analysis = photoData.output.proportions.symmetry_notes;
                        }
                        if (photoData.backend) {
                            combined.backend = combined.backend + "+" + photoData.backend;
                        }
                    } else if (combined.output.photo_feedback === undefined) {
                        combined.output.photo_feedback = [];
                    }

                    return combined;
                }

                function persistAssessment(combined) {
                    return fetch("/ai/body_assessment/record", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(combined),
                    }).catch((err) => {
                        console.warn("No se pudo guardar la evaluacion:", err);
                    });
                }

            // --- Rendering Logic ---
            function renderAssessmentResult(data) {
                const resultPlace = document.getElementById('result-placeholder');
                const resultCont = document.getElementById('result-container');

                if (!data || !data.output) {
                    resultPlace.classList.remove('d-none');
                    resultPlace.classList.add('d-flex');
                    resultCont.classList.add('d-none');
                    resultCont.classList.remove('d-flex');
                    return;
                }

                resultPlace.classList.add('d-none');
                resultPlace.classList.remove('d-flex');

                resultCont.classList.remove('d-none');
                resultCont.classList.add('d-flex');

                // 1. JSON Raw
                if (resultOutput) {
                    resultOutput.textContent = JSON.stringify(data, null, 2);
                }

                // 2. Populate Visual Elements
                const out = data.output || {};
                const inp = data.input || {};
                const res = data.output; // Alias

                document.getElementById('res-backend').textContent = 'Backend: ' + (data.backend || 'unknown');

                // Focus Badge
                const rec = out.recommendations || {};
                const focus = rec.focus || (inp.goal || 'General');
                const badge = document.getElementById('res-focus');
                badge.textContent = focus.toUpperCase();
                badge.className = 'badge badge-focus ' + (focus === 'fat_loss' ? 'bg-danger' : (focus === 'muscle_gain' ? 'bg-success' : 'bg-info'));

                // Metrics
                const metricsDiv = document.getElementById('res-metrics');
                metricsDiv.innerHTML = `
            <div class="col-6"><div class="metric-card"><div class="metric-value">${res.body_composition?.body_fat_percent}%</div><div class="metric-label">Grasa Corporal (%)</div></div></div>
            <div class="col-6"><div class="metric-card"><div class="metric-value">${res.body_composition?.muscle_mass_percent}%</div><div class="metric-label">Masa Muscular</div></div></div>
            <div class="col-6"><div class="metric-card"><div class="metric-value">${res.body_composition?.lean_mass_kg} kg</div><div class="metric-label">Masa Magra</div></div></div>
            <div class="col-6"><div class="metric-card"><div class="metric-value">${res.body_composition?.fat_mass_kg} kg</div><div class="metric-label">Masa Grasa (kg)</div></div></div>
          `;

                // Summary
                document.getElementById('res-summary').innerText = res.summary || "Sin resumen disponible.";

                // Energy Expenditure
                const energy = res.energy_expenditure || {};
                const tmbVal = energy.tmb ? `${energy.tmb} kcal` : "--";
                document.getElementById('res-tmb').innerText = tmbVal;

                const tdeeList = document.getElementById('res-tdee-list');
                tdeeList.innerHTML = '';
                if (energy.tdee) {
                    const labels = {
                        "sedentary": "Sedentario",
                        "lightly_active": "Ligero (1-3 días)",
                        "moderately_active": "Moderado (3-5 días)",
                        "very_active": "Fuerte (6-7 días)",
                        "extra_active": "Muy fuerte"
                    };
                    for (const [key, val] of Object.entries(energy.tdee)) {
                        const label = labels[key] || key;
                        const isSelected = energy.selected_activity === key;

                        const labelClass = isSelected ? "text-white fw-bold" : "text-secondary";
                        const valueClass = isSelected ? "text-warning fw-bold" : "text-light";
                        const bgClass = isSelected ? "bg-dark border border-warning rounded shadow-sm py-2 px-2 my-2" : "py-1 px-2";
                        const checkIcon = isSelected ? '<i class="fas fa-check-circle text-warning me-2"></i>' : '';

                        tdeeList.innerHTML += `
                    <li class="d-flex justify-content-between align-items-center ${bgClass}">
                        <span class="${labelClass}">${checkIcon}${label}</span>
                        <span class="${valueClass} font-monospace">${val} kcal</span>
                    </li>`;
                    }
                } else {
                    tdeeList.innerHTML = '<li class="text-muted fst-italic">No disponible</li>';
                }

                if (isAdminUnlocked()) {
                    const tdeeSelect = document.getElementById('admin-tdee-select');
                    const tdeeKcalInput = document.getElementById('admin-tdee-kcal');
                    if (tdeeSelect) {
                        tdeeSelect.innerHTML = '';
                        const emptyOpt = document.createElement('option');
                        emptyOpt.value = '';
                        emptyOpt.textContent = 'Selecciona...';
                        tdeeSelect.appendChild(emptyOpt);
                        if (energy.tdee) {
                            const labels = {
                                "sedentary": "Sedentario",
                                "lightly_active": "Ligero (1-3 dias)",
                                "moderately_active": "Moderado (3-5 dias)",
                                "very_active": "Fuerte (6-7 dias)",
                                "extra_active": "Muy fuerte"
                            };
                            Object.entries(energy.tdee).forEach(([key, val]) => {
                                const opt = document.createElement('option');
                                opt.value = key;
                                opt.textContent = `${labels[key] || key} - ${val} kcal`;
                                opt.dataset.kcal = val;
                                if (energy.selected_activity === key) opt.selected = true;
                                tdeeSelect.appendChild(opt);
                            });
                        }
                    }
                    if (tdeeKcalInput && energy.selected_activity && energy.tdee && energy.tdee[energy.selected_activity]) {
                        tdeeKcalInput.value = energy.tdee[energy.selected_activity];
                    }
                }

                // Proportions - Symmetry
                let props = res.body_proportions;

                // Fallback for legacy history items (old format had 'proportions' but not 'body_proportions')
                if (!props && res.proportions) {
                    const old = res.proportions;
                    props = {
                        symmetry_analysis: old.symmetry_notes,
                        waist_to_height_ratio: old.waist_to_height,
                        waist_to_hip_ratio: old.waist_to_hip,
                        // Old was waist_to_chest. New wants chest_to_waist. Invert if possible.
                        chest_to_waist_ratio: (old.waist_to_chest && old.waist_to_chest > 0) ? (1 / old.waist_to_chest).toFixed(2) : null
                    };
                }
                props = props || {};
                document.getElementById('res-symmetry').innerText = props.symmetry_analysis || "";

                document.getElementById('res-prop-wh').innerHTML = `Cintura/Altura: <strong class="text-white">${props.waist_to_height_ratio || '--'}</strong>`;
                document.getElementById('res-prop-whip').innerHTML = `Cintura/Cadera: <strong class="text-white">${props.waist_to_hip_ratio || '--'}</strong>`;
                document.getElementById('res-prop-wc').innerHTML = `Pecho/Cintura: <strong class="text-white">${props.chest_to_waist_ratio || '--'}</strong>`;

                // Actions / Recommendations
                const actionsList = document.getElementById('res-actions');
                const photoListEl = document.getElementById('res-photos');
                if (actionsList) actionsList.innerHTML = '<li class="text-muted small">Sin acciones registradas</li>';
                if (photoListEl) photoListEl.innerHTML = '<li class="text-muted small">Sin feedback de fotos</li>';

                // Populate Recommendations
                if (rec.actions && rec.actions.length > 0) {
                    actionsList.innerHTML = '';
                    rec.actions.forEach(action => {
                        actionsList.innerHTML += `<li class="list-group-item bg-transparent text-white border-0 ps-0"><i class="fas fa-check text-success me-2"></i>${action}</li>`;
                    });
                }

                // Populate Photo Feedback
                const feedback = res.photo_feedback || [];
                if (feedback && feedback.length > 0) {
                    photoListEl.innerHTML = '';
                    feedback.forEach(item => {
                        photoListEl.innerHTML += `<li class="list-group-item bg-transparent text-white border-0 ps-0"><i class="fas fa-camera text-info me-2"></i>${item}</li>`;
                    });
                }

                // Activate Visual Tab
                const visualTabBtn = document.querySelector('#result-container button[data-bs-target="#tab-visual"]');
                if (visualTabBtn) { const t = new bootstrap.Tab(visualTabBtn); t.show(); }
            }

            // Global zoom helper
            function isLightZoom(src) {
                return /\/static\/images\/examples\/(ref[123]|rf[456])\.png$/i.test(src || "");
            }

            window.openZoomModal = function (src) {
                if (src && zoomModal) {
                    const modalEl = document.getElementById('imageZoomModal');
                    if (modalEl) modalEl.classList.toggle('image-zoom-light', isLightZoom(src));
                    document.getElementById('zoomedImage').src = src;
                    zoomModal.show();
                }
            };
        </script>
        <div id="appAlertModal" class="alert-modal-backdrop">
            <div class="alert-modal-card">
                <div id="appAlertTitle" class="alert-title"></div>
                <div id="appAlertMessage" class="alert-message"></div>
                <div class="alert-modal-actions">
                    <button id="appAlertCancel" class="btn btn-outline-secondary">Cancelar</button>
                    <button id="appAlertConfirm" class="btn btn-outline-danger">Confirmar</button>
                </div>
            </div>
        </div>

        <script>
            const appAlertModal = document.getElementById("appAlertModal");
            const appAlertTitle = document.getElementById("appAlertTitle");
            const appAlertMessage = document.getElementById("appAlertMessage");
            const appAlertCancel = document.getElementById("appAlertCancel");
            const appAlertConfirm = document.getElementById("appAlertConfirm");
            let appAlertResolve = null;

            const applyAlertTone = (tone) => {
                appAlertTitle.classList.remove("alert-tone-warning", "alert-tone-danger", "alert-tone-success");
                if (tone === "warning") appAlertTitle.classList.add("alert-tone-warning");
                if (tone === "danger") appAlertTitle.classList.add("alert-tone-danger");
                if (tone === "success") appAlertTitle.classList.add("alert-tone-success");
            };

            const showAlertModal = (title, message, tone = "warning") => {
                if (!appAlertModal) {
                    alert(message || title || "Aviso");
                    return Promise.resolve(true);
                }
                appAlertTitle.textContent = title || "Aviso";
                appAlertMessage.textContent = message || "";
                appAlertCancel.style.display = "none";
                appAlertConfirm.textContent = "Cerrar";
                appAlertConfirm.className = "btn btn-outline-light";
                applyAlertTone(tone);
                appAlertModal.classList.add("show");
                return new Promise(resolve => {
                    appAlertResolve = resolve;
                });
            };

            const showConfirmModal = (title, message, tone = "danger") => {
                if (!appAlertModal) {
                    return Promise.resolve(confirm(message || title || "Confirmar"));
                }
                appAlertTitle.textContent = title || "Confirmar";
                appAlertMessage.textContent = message || "";
                appAlertCancel.style.display = "inline-flex";
                appAlertConfirm.textContent = "Confirmar";
                appAlertConfirm.className = tone === "danger" ? "btn btn-outline-danger" : "btn btn-outline-success";
                applyAlertTone(tone);
                appAlertModal.classList.add("show");
                return new Promise(resolve => {
                    appAlertResolve = resolve;
                });
            };

            const closeAlertModal = (result) => {
                appAlertModal.classList.remove("show");
                if (appAlertResolve) appAlertResolve(result);
                appAlertResolve = null;
            };

            appAlertCancel?.addEventListener("click", () => closeAlertModal(false));
            appAlertConfirm?.addEventListener("click", () => closeAlertModal(true));
            appAlertModal?.addEventListener("click", (event) => {
                if (event.target === appAlertModal) closeAlertModal(false);
            });

            window.showAlertModal = showAlertModal;
            window.showConfirmModal = showConfirmModal;
            window.showAlertModal = showAlertModal;
            window.showConfirmModal = showConfirmModal;

            // History Button Logic matches sidebar behaviour
            window.goToHistory = function () {
                try {
                    const u = JSON.parse(localStorage.getItem('ai_fitness_user') || '{}');
                    if (u.user_id) {
                        window.location.href = '/ai/body_assessment/history/view/' + u.user_id;
                        return;
                    }
                } catch (e) {
                    console.error("Error parsing user from storage", e);
                }
                alert('Debes iniciar sesión para ver el historial.');
            };
        </script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        {% include 'components/loader.html' %}
        <script src="/static/js/loader.js"></script>
    </div>
</body>

</html>