<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synapse Fit | Seguimiento Corporal</title>

    <!-- CDNs -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- CSS personalizado -->
    <link href="/static/css/theme.css" rel="stylesheet">
    <link href="/static/css/sidebar.css" rel="stylesheet">

    <style>
        /* --- Overrides & AKTIBODY Theme Adaptation --- */
        :root {
            /* Definimos las variables específicas del clon si no existen o las mapeamos */
            --bg-body-tracking: #0a0a0a;
            /* Dark background from clon */
            --text-light: #ffffff;
            --text-dim: #888888;
            --accent-green: #c0df36;
            /* The specific lime green */
            --accent-red: #e74c3c;
            --accent-blue: #3498db;
            --modal-bg: #1a1a1a;
        }

        body {
            /* Force dark background for this page to match the design */
            background-color: var(--bg-body-tracking);
            color: var(--text-light);
        }

        /* Adjustment for main content to coexist with sidebar */
        .main-content {
            padding-bottom: 80px;
            /* Space for FAB */
        }

        .hidden {
            display: none !important;
        }

        /* --- Header Navigation (Custom Tab Styled) --- */
        .header-nav {
            display: flex;
            justify-content: space-around;
            padding: 15px 0;
            background: transparent;
            border-bottom: 1px solid #222;
            margin-bottom: 20px;
        }

        .nav-item-custom {
            color: var(--text-dim);
            text-decoration: none;
            font-size: 0.9rem;
            text-transform: uppercase;
            padding-bottom: 5px;
            cursor: pointer;
        }

        .nav-item-custom.active {
            color: var(--accent-green);
            font-weight: bold;
            border-bottom: 2px solid var(--accent-green);
        }

        .nav-item-custom:hover {
            color: var(--accent-green);
        }

        /* Top Bar styled as simple header */
        .top-bar {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            align-items: center;
        }

        .brand-custom {
            color: var(--accent-green);
            font-weight: bold;
            font-size: 1.2rem;
            font-family: 'Poppins', sans-serif;
        }

        /* --- Main Body Dashboard --- */
        .dashboard-container {
            position: relative;
            height: 550px;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            /* overflow: hidden; Removed to allow labels to float if needed, but safe to keep */
        }

        .body-image-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            height: 100%;
            width: 100%;
            opacity: 0.6;
            z-index: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .body-image-container img {
            height: 100%;
            max-height: 100%;
            width: auto;
            max-width: 100%;
            object-fit: contain;
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.1));
        }

        .opacity-control {
            position: absolute;
            top: 12px;
            right: 12px;
            z-index: 2;
            display: none;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 999px;
            background: rgba(10, 10, 10, 0.7);
            border: 1px solid #222;
            color: var(--text-dim);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            backdrop-filter: blur(4px);
        }

        .opacity-control input[type="range"] {
            width: 110px;
            accent-color: var(--accent-green);
        }

        /* Etiquetas de medición posicionadas */
        .measure-label {
            position: absolute;
            font-size: 0.85rem;
            white-space: nowrap;
            z-index: 1;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .measure-label:hover {
            transform: scale(1.1);
            color: var(--accent-green);
        }

        .measure-label .val {
            font-size: 1.1rem;
            font-weight: bold;
            color: #fff;
        }

        .measure-label .change {
            font-size: 0.75rem;
        }

        .change.pos {
            color: var(--accent-green);
        }

        .change.neutral {
            color: var(--accent-blue);
        }

        /* En medidas corporales, subir suele ser "alarma" si es grasa, pero aqui es generico */
        .change.neg {
            color: var(--accent-red);
        }

        /* Posicionamiento manual aproximado (ajustar según la imagen real) */
        /* Estas posiciones asumen un contenedor de ~400px ancho x 550px alto */
        .l-cuello {
            top: 10%;
            left: 50%;
            transform: translateX(-50%);
        }

        .l-torax {
            top: 28%;
            left: 50%;
            transform: translateX(-50%);
        }

        .l-hombros {
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
        }

        .l-biceps-izq {
            top: 28%;
            right: 74%;
            text-align: right;
        }

        .l-biceps-der {
            top: 28%;
            left: 74%;
        }

        .l-ant-izq {
            top: 38%;
            right: 74%;
            text-align: right;
        }

        .l-ant-der {
            top: 38%;
            left: 74%;
        }

        .l-cintura {
            top: 38%;
            left: 50%;
            transform: translateX(-50%);
        }

        .l-cadera {
            top: 48%;
            right: 72%;
            text-align: right;
        }

        .l-muslo-izq {
            top: 60%;
            right: 68%;
            text-align: right;
        }

        .l-muslo-der {
            top: 60%;
            left: 68%;
        }

        .l-pant-izq {
            top: 78%;
            right: 68%;
            text-align: right;
        }

        .l-pant-der {
            top: 78%;
            left: 68%;
        }

        /* --- Stats Footer --- */
        .stats-container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            background: #111;
            border-radius: 15px;
            margin-bottom: 80px;
            /* Space for FAB */
        }

        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding-bottom: 10px;
            margin-bottom: 15px;
            border-bottom: 1px solid #333;
        }

        .stats-header h3 {
            font-size: 1.1rem;
            color: var(--text-light);
            margin: 0;
            letter-spacing: 1px;
        }

        .stats-header i {
            color: var(--text-dim);
            transition: transform 0.3s ease;
        }

        .stats-header.collapsed i {
            transform: rotate(-90deg);
        }

        .stats-content {
            overflow: hidden;
            transition: max-height 0.4s ease-out;
            max-height: 1000px;
            /* Arbitrary high value for expanded state */
        }

        .stats-content.collapsed {
            max-height: 0;
        }

        .stat-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid #222;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .stat-data {
            flex-grow: 1;
            text-align: left;
        }

        .stat-data h4 {
            margin: 0;
            color: var(--text-dim);
            font-size: 0.8rem;
            text-transform: uppercase;
        }

        .stat-data p {
            margin: 5px 0 0 0;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--text-light);
        }

        .stat-trend {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .stat-trend.pos {
            color: var(--accent-green);
        }

        .stat-trend.neg {
            color: var(--accent-red);
        }

        .stat-trend.neutral {
            color: var(--accent-blue);
        }

        /* Colores de iconos */
        .icon-peso {
            background: #ccc;
            color: #333;
        }

        .icon-musculo {
            background: var(--accent-red);
            color: white;
        }

        .icon-agua {
            background: var(--accent-blue);
            color: white;
        }

        .icon-grasa {
            background: #e6c345;
            color: #333;
        }

        .icon-imc {
            background: var(--accent-red);
            color: white;
        }


        /* --- FAB y Menú --- */
        .fab-container {
            position: fixed;
            bottom: 30px;
            right: 12%;
            z-index: 100;
        }

        .fab-main {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--accent-green);
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            transition: transform 0.3s;
        }

        .fab-container.active .fab-main {
            transform: rotate(45deg);
            background: var(--accent-green);
        }

        .fab-menu {
            position: absolute;
            bottom: 70px;
            right: 5px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s;
            transform: translateY(20px);
        }

        .fab-container.active .fab-menu {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }

        .menu-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            cursor: pointer;
        }

        .menu-label {
            background: var(--accent-green);
            color: #333;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-right: 10px;
            text-transform: uppercase;
        }

        .menu-icon {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            color: #333;
        }

        .menu-icon img {
            width: 50px;
            height: 50px;
            object-fit: contain;
            display: block;
        }

        /* --- MENÚ IZQUIERDO (Counterpart) --- */
        .fab-menu-left {
            position: fixed;
            bottom: 30px;
            /* Same baseline as FAB container */
            left: 12%;
            z-index: 100;
            display: flex;
            flex-direction: column;
            /* gap: 53px; Removed, using margin instead for robustness */
            align-items: flex-start;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
            transform: translateY(20px);
        }

        .fab-menu-left.active {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }

        .menu-item-left {
            display: flex;
            align-items: center;
            cursor: pointer;
            margin-bottom: 18px;
        }

        .menu-item-left .menu-label-left {
            background: var(--accent-green);
            color: #333;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 10px;
            text-transform: uppercase;
        }

        /* --- Modales --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1050;
            /* Bootstrap z-index is 1050+ */
            display: none;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-custom-content {
            background: var(--modal-bg);
            width: 90%;
            max-width: 400px;
            border-radius: 10px;
            overflow: hidden;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
        }

        /* Modal de Selección de Lado */
        .side-select-header {
            padding: 20px;
            color: var(--text-dim);
            font-size: 0.9rem;
        }

        .side-select-title {
            margin: 0 0 20px 0;
            font-size: 1.1rem;
            color: var(--text-light);
            text-transform: uppercase;
            font-weight: 600;
        }

        .modal-btn {
            display: block;
            width: 100%;
            padding: 15px;
            background: #2a2a2a;
            color: white;
            border: none;
            border-bottom: 1px solid #222;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .modal-btn:hover {
            background: #3a3a3a;
        }

        .modal-btn.cancel {
            background: transparent;
            color: var(--text-dim);
        }

        .modal-btn.cancel:hover {
            color: #fff;
        }

        /* Modal de Entrada de Valor */
        .value-picker-header {
            padding: 20px;
        }

        .picker-title {
            font-size: 1.3rem;
            margin-bottom: 10px;
            text-transform: uppercase;
            color: var(--text-light);
        }

        .picker-date {
            color: var(--text-dim);
            font-size: 0.9rem;
        }

        .picker-side {
            color: var(--text-dim);
            font-size: 0.8rem;
            margin-top: 4px;
        }

        .picker-container-custom {
            display: flex;
            justify-content: center;
            align-items: baseline;
            padding: 30px 0;
            background: #000;
            font-size: 3rem;
            margin-bottom: 0;
        }

        .picker-input {
            background: transparent;
            border: none;
            color: white;
            font-size: 3rem;
            width: 180px;
            text-align: right;
            border-bottom: 2px solid var(--accent-green);
        }

        .picker-input:focus {
            outline: none;
            border-color: #fff;
        }

        .picker-unit {
            font-size: 1.5rem;
            margin-left: 10px;
            color: var(--text-dim);
        }

        .save-btn {
            width: 100%;
            padding: 20px;
            background: var(--accent-green);
            color: #333;
            font-size: 1.2rem;
            font-weight: bold;
            border: none;
            cursor: pointer;
        }

        .save-btn:hover {
            background: #b0cc32;
        }

        /* Embed mode adjustments for modal iframe */
        body.embed-mode .main-content {
            max-width: 720px;
            margin: 0 auto;
            padding: 12px 16px 24px;
        }

        body.embed-mode .tracking-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 24px;
            flex-wrap: wrap;
        }

        body.embed-mode .top-bar {
            justify-content: center;
            padding: 0;
        }

        body.embed-mode .top-bar a {
            display: none;
        }

        body.embed-mode .header-nav {
            justify-content: center;
            gap: 18px;
            margin-bottom: 0;
            border-bottom: 0;
        }
    </style>
</head>

<body class="{% if embed %}embed-mode{% endif %}">
    {% if not embed %}
    {% include 'components/sidebar.html' %}
    {% endif %}

    <div class="main-content">
        <div class="container-fluid" style="max-width: 600px;"> <!-- Ancho limitado para sensacion de app -->

            <div class="tracking-header">
                <div class="top-bar">
                    <div class="brand-custom">
                        <!-- Logo removido segun lo solicitado -->
                    </div>
                    <!-- Icono movido a dashboard-container -->
                </div>

                <nav class="header-nav">
                    <div class="nav-item-custom nav-item active" data-target="cuerpo">CUERPO</div>
                    <div class="nav-item-custom nav-item" data-target="peso">PESO</div>
                    <div class="nav-item-custom nav-item" data-target="musculo">MÚSCULOS</div>
                    <div class="nav-item-custom nav-item" data-target="agua">AGUA</div>
                    <div class="nav-item-custom nav-item" data-target="grasa">GRASA</div>
                </nav>
            </div>

            <!-- TAB: CUERPO -->
            <div id="cuerpo" class="tab-content active">
                <!-- Contenedor principal del panel -->
<div class="dashboard-container">
                    <!-- Selector de genero (movido aqui) -->
                    <div onclick="toggleGender()" class="text-secondary"
                        style="position: absolute; top: 20px; left: 20px; z-index: 10; cursor: pointer; background: rgba(0,0,0,0.5); padding: 8px; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;"
                        title="Cambiar Género">
                        <i class="fas fa-female" id="genderToggleIcon" style="font-size: 1.2rem; color: #fff;"></i>
                    </div>
                    <div class="opacity-control">
                        <span>Opacidad</span>
                        <input type="range" id="imageOpacity" min="0.1" max="1" step="0.05" value="0.6"
                            aria-label="Opacidad de la imagen">
                    </div>
                    <div class="body-image-container skeleton-pulse">
                        <!-- Placeholder o imagen del usuario si existe. Se usa placeholder si no existe el archivo -->
                        <img id="bodyImage" src="/static/images/examples/ref1.png" class="img-skeleton"
                            onerror="this.src='/static/images/icon/tx1.png'; this.style.opacity='0.2';"
                            onload="this.parentElement.classList.remove('skeleton-pulse'); this.classList.add('loaded')"
                            alt="Body Outline">
                    </div>

                    <!-- Etiquetas de medidas simuladas (inyectado por backend) -->
                    {% if data and data.measurements %}
                    {% for key, item in data.measurements.items() %}
                    <!-- Mapeo de claves a clases -->
                    {% set cls_map = {
                    'cuello': 'l-cuello', 'torax': 'l-torax', 'pecho': 'l-torax',
                    'biceps_izq': 'l-biceps-izq', 'biceps_der': 'l-biceps-der',
                    'antebrazo_izq': 'l-ant-izq', 'antebrazo_der': 'l-ant-der',
                    'cintura': 'l-cintura', 'cadera': 'l-cadera', 'hombros': 'l-hombros',
                    'muslo_izq': 'l-muslo-izq', 'muslo_der': 'l-muslo-der',
                    'pantorrilla_izq': 'l-pant-izq', 'pantorrilla_der': 'l-pant-der'
                    } %}
                    {% set name_map = {
                    'cuello': 'CUELLO', 'torax': 'TORAX', 'pecho': 'TORAX',
                    'biceps_izq': 'BICEPS', 'biceps_der': 'BICEPS',
                    'antebrazo_izq': 'ANTEBRAZO', 'antebrazo_der': 'ANTEBRAZO',
                    'cintura': 'CINTURA', 'cadera': 'CADERA', 'hombros': 'HOMBROS',
                    'muslo_izq': 'MUSLO', 'muslo_der': 'MUSLO',
                    'pantorrilla_izq': 'PANTORRILLA', 'pantorrilla_der': 'PANTORRILLA'
                    } %}
                    {% set pos_class = cls_map.get(key, '') %}
                    {% if pos_class %}
                    {% set change_class = 'pos' if item.change and item.change.startswith('+') else ('neg' if
                    item.change
                    and item.change.startswith('-') else 'neutral') %}
                    {% set side_label = 'IZQ' if key.endswith('_izq') else ('DER' if key.endswith('_der') else '') %}
                    <div class="measure-label {{ pos_class }}"
                        onclick="openValueModal('{{ key }}', null, '{{ item.value }}')">

                        <div class="label-text" style="font-size: 0.7rem; color: var(--text-dim); margin-bottom: -2px;">
                            {{
                            name_map.get(key, key|upper) }}{% if side_label %} {{ side_label }}{% endif %}</div>

                        <!-- Logica de orden de etiquetas segun lado de pantalla -->
                        {% if key in ['biceps_izq', 'cadera', 'muslo_izq', 'pantorrilla_izq', 'antebrazo_izq'] %}
                        <!-- Pantalla izquierda (alinear derecha): cambio primero -->
                        {% if item.change %}<span class="change {{ item.trend }}">{{ item.change }}</span>{% endif %}
                        <span class="val" id="val-{{ key }}">{{ item.value }}</span>cm
                        {% else %}
                        <!-- Pantalla derecha/centro: valor primero -->
                        <span class="val" id="val-{{ key }}">{{ item.value }}</span>cm
                        {% if item.change %}<span class="change {{ item.trend }}">{{ item.change }}</span>{% endif %}
                        {% endif %}
                    </div>
                    {% endif %}
                    {% endfor %}
                    {% endif %}
                </div>

                {% if data and data.stats %}
                <div class="stats-container collapsible-panel">
                    <div class="stats-header collapsed" onclick="toggleStats()">
                        <h3>INDICADORES CORPORALES</h3>
                        <i class="fas fa-chevron-down" id="statsChevron"></i>
                    </div>

                    <div class="stats-content collapsed" id="statsContent">
                        <!-- Peso -->
                        <div class="stat-row" onclick="activateTab('peso')" style="cursor: pointer;">
                            <div class="stat-icon icon-peso"><i class="fas fa-weight"></i></div>
                            <div class="stat-data">
                                <h4>Peso Corporal</h4>
                                <p id="val-peso">{{ data.stats.peso.value }}{{ data.stats.peso.unit }}</p>
                            </div>
                            <div class="stat-trend {{ data.stats.peso.trend }}">
                                {{ data.stats.peso.change }}
                            </div>
                        </div>
                        <!-- Musculo -->
                        {% if data.stats.musculo %}
                        <div class="stat-row" onclick="activateTab('musculo')" style="cursor: pointer;">
                            <div class="stat-icon icon-musculo"><i class="fas fa-dumbbell"></i></div>
                            <div class="stat-data">
                                <h4>Músculo</h4>
                                <p id="val-musculo">{{ data.stats.musculo.value }}{{ data.stats.musculo.unit }}</p>
                            </div>
                            <div class="stat-trend {{ data.stats.musculo.trend }}">
                                {{ data.stats.musculo.change }}
                            </div>
                        </div>
                        {% endif %}
                        <!-- Agua -->
                        {% if data.stats.agua %}
                        <div class="stat-row" onclick="activateTab('agua')" style="cursor: pointer;">
                            <div class="stat-icon icon-agua"><i class="fas fa-water"></i></div>
                            <div class="stat-data">
                                <h4>Porcentaje de Agua</h4>
                                <p id="val-agua">{{ data.stats.agua.value }}{{ data.stats.agua.unit }}</p>
                            </div>
                            <div class="stat-trend {{ data.stats.agua.trend }}">
                                {{ data.stats.agua.change }}
                            </div>
                        </div>
                        {% endif %}
                        <!-- Grasa -->
                        <div class="stat-row" onclick="activateTab('grasa')" style="cursor: pointer;">
                            <div class="stat-icon icon-grasa"><i class="fas fa-tint"></i></div>
                            <div class="stat-data">
                                <h4>Porcentaje de Grasa</h4>
                                <p id="val-grasa">{{ data.stats.grasa.value }}{{ data.stats.grasa.unit }}</p>
                            </div>
                            <div class="stat-trend {{ data.stats.grasa.trend }}">
                                {{ data.stats.grasa.change }}
                            </div>
                        </div>
                        <!-- IMC -->
                        {% if data.stats.imc %}
                        <div class="stat-row">
                            <div class="stat-icon icon-imc"><i class="fas fa-calculator"></i></div>
                            <div class="stat-data">
                                <h4>Índice de Masa Corporal (IMC)</h4>
                                <p>{{ data.stats.imc.value }}</p>
                            </div>
                            <div class="stat-trend {{ data.stats.imc.trend }}">
                                {{ data.stats.imc.change }}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Menu lateral izquierdo (con FAB) -->
                <div class="fab-menu-left" id="fabMenuLeft">
                    <!-- 1. Grasa -->
                    <div class="menu-item-left" onclick="openValueModal('body_fat_percent', null, '0.0')"
                        title="Grasa (%)">
                        <div class="menu-icon" style="background-color: #e6c345;"><i class="fas fa-tint"></i></div>
                    </div>
                    <!-- 2. Agua -->
                    <div class="menu-item-left" onclick="openValueModal('water_percent', null, '0.0')" title="Agua (%)">
                        <div class="menu-icon" style="background-color: var(--accent-blue); color: white;"><i
                                class="fas fa-water"></i></div>
                    </div>
                    <!-- 3. Musculos -->
                    <div class="menu-item-left" onclick="openValueModal('muscle_mass_percent', null, '0.0')"
                        title="Músculos (%)">
                        <div class="menu-icon" style="background-color: var(--accent-red); color: white;"><i
                                class="fas fa-dumbbell"></i></div>
                    </div>
                    <!-- 4. Peso -->
                    <div class="menu-item-left" onclick="openValueModal('weight_kg', null, '0.0')" title="Peso (kg)">
                        <div class="menu-icon" style="background-color: #ccc;"><i class="fas fa-weight"></i></div>
                    </div>
                </div>

                <!-- FAB -->
                <div class="fab-container" id="fabContainer">
                    <div class="fab-menu">
                        <!-- 1. Pantorrilla -->
                        <div class="menu-item" onclick="openSideModal('Pantorrilla')">
                            <span class="menu-label">PANTORRILLA</span>
                            <div class="menu-icon"><img src="/static/images/icon/male/pan.png" alt="Pantorrilla"></div>
                        </div>
                        <!-- 2. Muslos (usando logica de Muslo) -->
                        <div class="menu-item" onclick="openSideModal('Muslo')">
                            <span class="menu-label">MUSLOS</span>
                            <div class="menu-icon"><img src="/static/images/icon/male/mus.png" alt="Muslo"></div>
                        </div>
                        <!-- 3. Cadera -->
                        <div class="menu-item" onclick="openValueModal('Cadera', null, '96.5')">
                            <span class="menu-label">CADERA</span>
                            <div class="menu-icon"><img src="/static/images/icon/male/cd2.png" alt="Cadera"></div>
                        </div>
                        <!-- 4. Abdomen/Cintura (usando logica de Abdomen) -->
                        <div class="menu-item" onclick="openValueModal('Abdomen', null, '0.0')">
                            <span class="menu-label">ABDOMEN/CINTURA</span>
                            <div class="menu-icon"><img src="/static/images/icon/male/cn.png" alt="Abdomen"></div>
                        </div>
                        <!-- 5. Antebrazo -->
                        <div class="menu-item" onclick="openSideModal('Antebrazo')">
                            <span class="menu-label">ANTEBRAZO</span>
                            <div class="menu-icon"><img src="/static/images/icon/male/ant.png" alt="Antebrazo"></div>
                        </div>
                        <!-- 6. Brazo Superior (usando logica de Biceps) -->
                        <div class="menu-item" onclick="openSideModal('Bíceps')">
                            <span class="menu-label">BRAZO SUPERIOR</span>
                            <div class="menu-icon"><img src="/static/images/icon/male/bic.png" alt="Biceps"></div>
                        </div>
                        <!-- 7. Toráx (usando logica de Pecho) -->
                        <div class="menu-item" onclick="openValueModal('Pecho', null, '0.0')">
                            <span class="menu-label">TORÁX</span>
                            <div class="menu-icon"><img src="/static/images/icon/male/tx1.png" alt="Pecho"></div>
                        </div>
                        <!-- 8. Hombros (usando logica de Hombro) -->
                        <div class="menu-item" onclick="openValueModal('Hombro', null, '0.0')">
                            <span class="menu-label">HOMBROS</span>
                            <div class="menu-icon"><img src="/static/images/icon/male/hm.png" alt="Hombro"></div>
                        </div>
                        <!-- 9. Cuello -->
                        <div class="menu-item" onclick="openValueModal('Cuello', null, '0.0')">
                            <span class="menu-label">CUELLO</span>
                            <div class="menu-icon"><img src="/static/images/icon/male/cu.png" alt="Cuello"></div>
                        </div>
                    </div>

                    <div class="fab-main" id="fabButton"><i class="fas fa-plus"></i></div>
                </div>
            </div> <!-- Fin de pestana Cuerpo -->

            <!-- TAB: PESO -->
            <div id="peso" class="tab-content hidden" style="padding-top:20px;">
                <h3 style="text-align:center; color: var(--accent-green);">Historial de Peso</h3>
                <div style="width: 100%; height: 300px; padding: 20px;">
                    <canvas id="chartPeso"></canvas>
                </div>
            </div>

            <!-- TAB: MUSCULOS -->
            <div id="musculo" class="tab-content hidden" style="padding-top:20px;">
                <h3 style="text-align:center; color: var(--accent-red);">Historial de Músculo</h3>
                <div style="width: 100%; height: 300px; padding: 20px;">
                    <canvas id="chartMusculo"></canvas>
                </div>
            </div>

            <!-- TAB: AGUA -->
            <div id="agua" class="tab-content hidden" style="padding-top:20px;">
                <h3 style="text-align:center; color: var(--accent-blue);">Historial de Agua</h3>
                <div style="width: 100%; height: 300px; padding: 20px;">
                    <canvas id="chartAgua"></canvas>
                </div>
            </div>

            <!-- TAB: GRASA -->
            <div id="grasa" class="tab-content hidden" style="padding-top:20px;">
                <h3 style="text-align:center; color: #e6c345;">Historial de Grasa</h3>
                <div style="width: 100%; height: 300px; padding: 20px;">
                    <canvas id="chartGrasa"></canvas>
                </div>
            </div>

        </div>
    </div>

    <!-- Modales -->
    <div class="modal-overlay" id="sideModal">
        <div class="modal-custom-content">
            <div class="side-select-header">
                ACTUAL<br>
                <h3 class="side-select-title" id="sideModalTitle">CIRCUNFERENCIA DE...</h3>
            </div>
            <button class="modal-btn" onclick="selectSide('Izquierda')">IZQUIERDA</button>
            <button class="modal-btn" onclick="selectSide('Derecha')">DERECHO</button>
            <button class="modal-btn" onclick="selectSide('Ambos')">AMBOS</button>
            <button class="modal-btn cancel" onclick="closeModals()">CANCELAR</button>
        </div>
    </div>

    <div class="modal-overlay" id="valueModal">
        <div class="modal-custom-content">
            <div class="value-picker-header">
                <div style="color: var(--text-dim); font-size: 0.8rem;">ACTUAL</div>
                <h3 class="picker-title" id="valueModalTitle">MEDIDA DE CADERA</h3>
                <div class="picker-side" id="valueModalSideDesc"></div>
                <div class="picker-date" id="currentDateDisplay">10.01.2026, 5:08 A.M.</div>
            </div>

            <div class="picker-container-custom">
                <input type="number" id="measurementValueBtn" class="picker-input" value="0.0" step="0.1" min="0"
                    max="300" inputmode="decimal"
                    onkeydown="return event.key != 'e' && event.key != 'E' && event.key != '-' && event.key != '+'"
                    oninput="if(parseFloat(this.value)>300) this.value=300; if(this.value.length > 6) this.value=this.value.slice(0,6);">
                <span class="picker-unit">cm</span>
            </div>

            <button class="save-btn" onclick="saveData()">GUARDAR ENTRADA</button>
            <button class="modal-btn cancel" onclick="closeModals()" style="background: #222;">CANCELAR</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/theme.js"></script>

    <script>
        // Global variables for Charts
        let chartInstances = {};

        function activateTab(targetId) {
            // 1. Update Top Nav
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(nav => {
                nav.classList.remove('active');
                if (nav.dataset.target === targetId) {
                    nav.classList.add('active');
                }
            });

            // 2. Update Content Sections
            const sections = document.querySelectorAll('.tab-content');
            sections.forEach(sec => {
                if (sec.id === targetId) {
                    sec.classList.remove('hidden');
                    sec.classList.add('active');

                    // Resize chart if this section has one, to ensure it renders correctly after being hidden
                    // Map section ID to chart key (e.g. 'peso' -> 'chartPeso')
                    let chartKey = 'chart' + targetId.charAt(0).toUpperCase() + targetId.slice(1);
                    if (chartInstances[chartKey]) {
                        setTimeout(() => {
                            chartInstances[chartKey].resize();
                        }, 10);
                    }
                } else {
                    sec.classList.add('hidden');
                    sec.classList.remove('active');
                }
            });

            // 3. Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
            console.log("Tab activated:", targetId);
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Bind Nav Clicks
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    activateTab(item.dataset.target);
                });
            });

            // Initialize Charts safely
            try {
                // Peso
                if (document.getElementById('chartPeso')) {
                    const ctxPeso = document.getElementById('chartPeso').getContext('2d');
                    chartInstances['chartPeso'] = new Chart(ctxPeso, {
                        type: 'line',
                        data: {
                            labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'],
                            datasets: [{
                                label: 'Peso',
                                data: [71, 71.5, 72, 72.8, 73.5, 73.7],
                                borderColor: '#ccc',
                                borderWidth: 2,
                                tension: 0.4,
                                pointRadius: 3
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { x: { display: true, grid: { color: '#333' } }, y: { grid: { color: '#333' } } }
                        }
                    });
                }

                // Others
                ['chartMusculo', 'chartAgua', 'chartGrasa'].forEach(id => {
                    if (document.getElementById(id)) {
                        const ctx = document.getElementById(id).getContext('2d');
                        let color = '#fff';
                        if (id.includes('Musculo')) color = '#e74c3c';
                        if (id.includes('Agua')) color = '#3498db';
                        if (id.includes('Grasa')) color = '#e6c345';

                        chartInstances[id] = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'],
                                datasets: [{
                                    label: 'Data',
                                    data: [20, 21, 22, 21.5, 22, 22.5],
                                    borderColor: color,
                                    borderWidth: 2,
                                    tension: 0.4
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { display: false } },
                                scales: { x: { grid: { color: '#333' } }, y: { grid: { color: '#333' } } }
                            }
                        });
                    }
                });
            } catch (e) {
                console.error("Chart initialization error:", e);
            }
        });

        // Provide alias if needed (though we updated onclicks to activateTab in next step)
        // Actually, I need to update the onclick="switchTab" in the HTML to "activateTab".
        window.switchTab = activateTab; 
    </script>

    <script>
        // Variables de estado
        let currentPart = null;
        let currentSide = null;

        // Gender Toggle
        let currentGender = 'male'; // Default
        const imgMale = '/static/images/examples/ref1.png';
        const imgFemale = '/static/images/examples/rf4.png';

        function toggleGender() {
            const img = document.getElementById('bodyImage');
            const icon = document.getElementById('genderToggleIcon');
            const menuIcons = document.querySelectorAll('.menu-icon img');

            if (currentGender === 'male') {
                currentGender = 'female';
                img.src = imgFemale;
                // Set to match male image styling
                img.style.transform = "none";
                // Switch icon to Male (to switch back)
                icon.classList.remove('fa-female');
                icon.classList.add('fa-male');

                // Update menu icons
                menuIcons.forEach(i => {
                    i.src = i.src.replace('/male/', '/female/');
                });
            } else {
                currentGender = 'male';
                img.src = imgMale;
                img.style.transform = "none";
                // Switch icon to Female
                icon.classList.remove('fa-male');
                icon.classList.add('fa-female');

                // Update menu icons
                menuIcons.forEach(i => {
                    i.src = i.src.replace('/female/', '/male/');
                });
            }
        }

        // Elementos DOM
        const fabContainer = document.getElementById('fabContainer');
        const fabButton = document.getElementById('fabButton');
        const sideModal = document.getElementById('sideModal');
        const valueModal = document.getElementById('valueModal');
        const sideModalTitle = document.getElementById('sideModalTitle');
        const valueModalTitle = document.getElementById('valueModalTitle');
        const valueModalSideDesc = document.getElementById('valueModalSideDesc');
        const measurementInput = document.getElementById('measurementValueBtn');
        const currentDateDisplay = document.getElementById('currentDateDisplay');
        const imageOpacity = document.getElementById('imageOpacity');
        const bodyImageContainer = document.querySelector('.body-image-container');

        // Stats Toggle
        function toggleStats() {
            const content = document.getElementById('statsContent');
            const chevron = document.getElementById('statsChevron');
            const header = chevron.parentElement;

            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                header.classList.remove('collapsed');
            } else {
                content.classList.add('collapsed');
                header.classList.add('collapsed');
            }
        }

        const partDisplayMap = {
            cuello: 'Cuello',
            torax: 'Torax',
            pecho: 'Torax',
            cintura: 'Cintura',
            cadera: 'Cadera',
            abdomen: 'Abdomen',
            espalda: 'Espalda',
            hombro: 'Hombro',
            hombros: 'Ancho de Hombros',
            gluteos: 'Gluteos',
            biceps: 'Biceps',
            triceps: 'Triceps',
            antebrazo: 'Antebrazo',
            muslo: 'Muslo',
            cuadriceps: 'Cuadriceps',
            femoral: 'Femoral',
            pantorrilla: 'Pantorrilla',
            // Stat keys for display
            body_fat_percent: 'Grasa Corp.',
            water_percent: 'Agua Corp.',
            muscle_mass_percent: 'Musculo Corp.',
            weight_kg: 'Peso Corp.'
        };

        function resolvePartMeta(partName, side) {
            let resolvedSide = side || null;
            let baseKey = partName || '';
            if (typeof partName === 'string') {
                const lower = partName.toLowerCase();
                if (lower.endsWith('_izq')) {
                    baseKey = partName.slice(0, -4);
                    if (!resolvedSide) resolvedSide = 'Izquierda';
                } else if (lower.endsWith('_der')) {
                    baseKey = partName.slice(0, -4);
                    if (!resolvedSide) resolvedSide = 'Derecha';
                }
            }
            const displayKey = (baseKey || '').toString().toLowerCase();
            const displayName = partDisplayMap[displayKey] || baseKey || partName || '';
            return { displayName, baseKey, resolvedSide };
        }

        // Initial Date
        const now = new Date();
        if (currentDateDisplay) currentDateDisplay.textContent = now.toLocaleString();

        if (imageOpacity && bodyImageContainer) {
            bodyImageContainer.style.opacity = imageOpacity.value;
            imageOpacity.addEventListener('input', () => {
                bodyImageContainer.style.opacity = imageOpacity.value;
            });
        }


        // Toggle FAB Menu (Both sides)
        fabButton.addEventListener('click', () => {
            fabContainer.classList.toggle('active');
            const leftMenu = document.getElementById('fabMenuLeft');
            if (leftMenu) leftMenu.classList.toggle('active');
        });

        // Cerrar todos los modales
        function closeModals() {
            if (sideModal) sideModal.classList.remove('active');
            if (valueModal) valueModal.classList.remove('active');
            if (fabContainer) fabContainer.classList.remove('active');
            const leftMenu = document.getElementById('fabMenuLeft');
            if (leftMenu) leftMenu.classList.remove('active');
            currentPart = null;
            currentSide = null;
        }

        // Expose to window for inline onclicks
        window.closeModals = closeModals;

        // Flujo 1: Abrir modal de selección de lado
        window.openSideModal = function (partName) {
            currentPart = partName;
            const meta = resolvePartMeta(partName, null);
            sideModalTitle.textContent = `CIRCUNFERENCIA DE ${meta.displayName.toUpperCase()}`;
            sideModal.classList.add('active');
        }

        // Paso intermedio: Lado seleccionado
        window.selectSide = function (side) {
            currentSide = side;
            sideModal.classList.remove('active');
            openValueModal(currentPart, currentSide, '0.0'); // Default value ?
        }

        // Flujo 2: Abrir modal de valor
        window.openValueModal = function (partName, side, initialValue) {
            const meta = resolvePartMeta(partName, side);
            currentPart = meta.baseKey || partName;
            currentSide = meta.resolvedSide || side;

            let title = `MEDIDA DE ${meta.displayName.toUpperCase()}`;
            if (currentSide && currentSide !== 'Ambos') {
                title += ` (${currentSide.toUpperCase()})`;
            }
            valueModalTitle.textContent = title;
            if (valueModalSideDesc) {
                valueModalSideDesc.textContent = currentSide ? `Lado: ${currentSide}` : '';
            }
            measurementInput.value = initialValue || "0.0";

            // Set Unit Logic
            const unitEl = document.querySelector('.picker-unit');
            if (['weight_kg'].includes(currentPart)) {
                unitEl.textContent = 'kg';
            } else if (['body_fat_percent', 'water_percent', 'muscle_mass_percent'].includes(currentPart)) {
                unitEl.textContent = '%';
            } else {
                unitEl.textContent = 'cm';
            }

            valueModal.classList.add('active');
            setTimeout(() => {
                measurementInput.focus();
                measurementInput.select();
            }, 100);
        }

        // Helper to update UI label
        function updateLabelUI(part, side, value) {
            // Map part/side to ID
            // Common IDs: val-cuello, val-hombros, val-torax, val-biceps_izq, val-biceps_der, val-cintura...
            // currentPart might be internal key like 'neck', 'shoulders'.
            // Mappings based on template inspection or knowledge:
            const partMap = {
                // Internal keys
                'neck': 'cuello',
                'shoulders': 'hombros',
                'chest': 'torax',
                'waist': 'cintura',
                'hips': 'cadera',
                'thigh': 'muslo',
                'calf': 'pantorrilla',
                'biceps': 'biceps',
                'forearm': 'antebrazo',
                'weight_kg': 'peso',
                'body_fat_percent': 'grasa',
                'muscle_mass_percent': 'musculo',
                'water_percent': 'agua',

                // Spanish Display Names (from FAB)
                'Cuello': 'cuello',
                'Hombro': 'hombros', 'Hombros': 'hombros',
                'Pecho': 'torax', 'Torax': 'torax',
                'Abdomen': 'cintura', 'Cintura': 'cintura',
                'Cadera': 'cadera',
                'Muslo': 'muslo', 'Muslos': 'muslo',
                'Pantorrilla': 'pantorrilla',
                'Bíceps': 'biceps', 'Biceps': 'biceps',
                'Antebrazo': 'antebrazo'
            };

            let baseIds = [];
            const pKey = partMap[part] || part; // Fallback to part if match

            const s = (side || '').toLowerCase();
            if (s === 'left' || s === 'izquierda') {
                baseIds.push(`val-${pKey}_izq`);
            } else if (s === 'right' || s === 'derecha' || s === 'derecho') {
                baseIds.push(`val-${pKey}_der`);
            } else if (s === 'both' || s === 'ambos') {
                baseIds.push(`val-${pKey}_izq`);
                baseIds.push(`val-${pKey}_der`);
            } else {
                // Singular (e.g., neck, waist, chest)
                baseIds.push(`val-${pKey}`);

                // Edge case: If no side provided but part is bilateral, ideally do nothing or default? 
                // User said: "only update pairs if Both selected".
                // So we do NOT push _izq/_der here.
            }

            baseIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    // Start of text node usually contains number + unit. 
                    // Or check structure: innerHTML typically `{{ val }}<small>cm</small>` or just text.
                    // Previous template view showed: `(measurements['biceps_izq'].value)<small>cm</small>`
                    // So we should replace the text content but keep the unit? Or overwrite innerHTML?
                    // Safest: Overwrite text of first child or just innerHTML with value + generic unit

                    // Determine unit
                    let unit = 'cm';
                    if (part === 'weight_kg') unit = 'kg';
                    if (part.includes('percent')) unit = '%';

                    el.innerHTML = `${value}<small>${unit}</small>`;

                    // Also update potential delta label if we had it? (Maybe too complex for quick fix)
                }
            });
        }

        // Guardar datos
        window.saveData = function () {
            let rawVal = parseFloat(measurementInput.value);
            if (isNaN(rawVal)) rawVal = 0.0;
            // Enforce constraints
            rawVal = Math.max(0, Math.min(300, rawVal));
            const value = parseFloat(rawVal.toFixed(1)).toString();

            const payload = {
                part: currentPart,
                side: currentSide,
                value: value,
                timestamp: new Date().toISOString()
            };

            console.log("Enviando datos:", payload);

            // 1. Update LocalStorage for cross-page sync
            try {
                const existing = JSON.parse(localStorage.getItem('updated_body_measurements') || '{}');
                // Create a unique key for the map
                let key = currentPart;
                if (currentSide) key += `_${currentSide}`;
                existing[key] = value; // Store raw value
                localStorage.setItem('updated_body_measurements', JSON.stringify(existing));
            } catch (e) { console.error("LS Error", e); }

            fetch('/api/user/measurement/save', { // Updated API endpoint
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload),
            })
                .then(response => response.json())
                .then(data => {
                    console.log('Success:', data);
                    // Simple feedback
                    const btn = document.querySelector('.save-btn');
                    const originalText = btn.textContent;
                    btn.textContent = "GUARDADO!";
                    btn.style.background = "#fff";

                    // 2. Update UI in runtime (Instant Feedback)
                    updateLabelUI(currentPart, currentSide, value);

                    setTimeout(() => {
                        closeModals();
                        btn.textContent = originalText;
                        btn.style.background = "";
                        // NO LOAD RELOAD
                    }, 500);
                })
                .catch((error) => {
                    console.error('Error:', error);
                    alert("Error guardando datos");
                });
        }

        // Cerrar modales al hacer clic fuera
        window.onclick = function (event) {
            if (event.target == sideModal || event.target == valueModal) {
                closeModals();
            }
        }
    </script>
</body>

</html>