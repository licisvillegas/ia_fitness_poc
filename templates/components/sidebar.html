<link href="/static/css/theme.css" rel="stylesheet">
{% import 'components/macros.html' as macros %}
<div class="d-flex flex-column flex-shrink-0 p-3 bg-panel sidebar-fixed sidebar-panel">
    <div class="d-flex align-items-center justify-content-between mb-3 text-theme sidebar-header">
        <a href="/landing" class="text-decoration-none brand-text">
            <img src="/static/images/logo.png" alt="AI Fitness" class="sidebar-logo">
        </a>
        <div class="d-flex align-items-center gap-2">
            <button id="theme-toggle" class="btn btn-link p-0 fs-5 text-secondary" title="Cambiar Tema">
                <i class="fas fa-moon transition-icon"></i>
            </button>
            <button id="sidebar-toggle" class="btn btn-link text-theme p-0 fs-5" title="Colapsar/Expandir">
                <i class="fas fa-arrow-left transition-icon"></i>
            </button>
        </div>
    </div>

    <!-- User Identity -->
    <a href="#" class="d-flex align-items-center text-theme text-decoration-none dropdown-toggle-user"
        data-bs-toggle="collapse" data-bs-target="#user-collapse" aria-expanded="false" title="Usuario">
        <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-2 user-icon-container {{ 'skeleton-pulse' if user_data and user_data.profile_image_url else '' }}"
            style="width: 32px; height: 32px; min-width: 32px; overflow: hidden;">
            <img id="sidebar-avatar-img" alt="Usuario"
                src="{{ user_data.profile_image_url if user_data and user_data.profile_image_url else '' }}"
                class="{{ 'd-block img-skeleton' if user_data and user_data.profile_image_url else 'd-none' }}" onload="this.parentElement.classList.remove('skeleton-pulse'); this.classList.add('loaded')"
                style="width: 100%; height: 100%; object-fit: cover;"
                data-profile-url="{{ user_data.profile_image_url if user_data and user_data.profile_image_url else '' }}">
            <i id="sidebar-avatar-icon"
                class="fas fa-user {{ 'd-none' if user_data and user_data.profile_image_url else '' }}"></i>
        </div>
        <strong><span id="sidebar-username">{{ user_data.name if user_data and user_data.name else (user_data.username
                if user_data and user_data.username else 'Usuario') }}</span></strong>
        <i class="fas fa-chevron-down ms-2 small transition-icon"></i>
    </a>

    <!-- Collapsible Menu -->
    <div class="collapse" id="user-collapse">
        <ul class="list-unstyled fw-normal pb-1 small ms-5 mt-2">
            <li>
                <a href="/profile"
                    class="d-flex align-items-center text-secondary text-decoration-none py-1 hover-white">
                    <i class="fas fa-id-card me-2"></i> Perfil
                </a>
            </li>
            <!-- Revert Impersonation (Visible if impersonating) -->
            {% if is_impersonating %}
            <li id="revert-impersonation-li">
                <a href="#" id="revert-impersonation-btn"
                    class="d-flex align-items-center text-info text-decoration-none py-1 hover-white">
                    <i class="fas fa-undo me-2"></i> Volver a Admin
                </a>
            </li>
            {% endif %}

            <!-- Admin Token / Lock Logic -->
            {% if current_user_role == 'admin' and not is_impersonating %}
            <li>
                <a href="#" id="sidebar-lock-btn"
                    class="d-flex align-items-center text-danger text-decoration-none py-1 hover-white"
                    title="Bloquear sesi?n de admin"
                    {% if not has_admin_token %}style="display:none"{% endif %}>
                    <i class="fas fa-lock me-2"></i> Bloquear Admin
                </a>
                <a href="#" id="sidebar-token-btn"
                    class="d-flex align-items-center text-warning text-decoration-none py-1 hover-white"
                    data-bs-toggle="modal" data-bs-target="#adminTokenModal"
                    {% if has_admin_token %}style="display:none"{% endif %}>
                    <i class="fas fa-key me-2"></i> Token Admin
                </a>
            </li>
            {% endif %}

            <li>
                <a href="#" id="sidebar-logout"
                    class="d-flex align-items-center text-secondary text-decoration-none py-1 hover-white">
                    <i class="fas fa-sign-out-alt me-2"></i> Cerrar sesión
                </a>
            </li>
            <!-- Admin User Search Button (Replaces container) -->
            {% if current_user_role == 'admin' %}
            <li id="sidebar-search-user-li">
                <a href="#" id="sidebar-search-user-btn"
                    class="d-flex align-items-center text-primary text-decoration-none py-1 hover-white"
                    data-bs-toggle="modal" data-bs-target="#userContextModal">
                    <i class="fas fa-search me-2"></i> Buscar Usuario
                </a>
            </li>
            {% endif %}
        </ul>
    </div>

    <hr class="border-theme" style="margin: 1rem 0;">

    <ul class="nav nav-pills flex-column mb-auto">
        {{ macros.nav_link('/landing', 'Inicio', 'fas fa-home') }}
        {{ macros.nav_link('/dashboard', 'Dashboard', 'fas fa-tachometer-alt') }}
        {{ macros.nav_link('/workout/adherence', 'Adherencia', 'fas fa-fire-alt') }}
        {{ macros.nav_link('/plan', 'Mi Plan', 'fas fa-dumbbell') }}
        {{ macros.nav_link('/nutrition', 'Nutrición', 'fas fa-utensils') }}

        <li class="nav-item sidebar-section">
            Entrenamiento
        </li>

        {{ macros.nav_link('/workout/routines', 'Mis Rutinas', 'fas fa-clipboard-list') }}
        {{ macros.nav_link('/workout/routines/builder-guided', 'Crear Rutina', 'fas fa-layer-group') }}
        {{ macros.nav_link('/workout/exercises', 'Ejercicios', 'fas fa-book') }}
        {{ macros.nav_link('/workout/rm-calculator', 'Calculadora RM', 'fas fa-calculator') }}

        <li class="nav-item sidebar-section">
            Progreso
        </li>

        {{ macros.nav_link('/ai/body_assessment/user', 'Evaluación Corporal', 'fas fa-camera') }}
        <li>
            {% set history_user_id = (user_data.user_id if user_data and user_data.user_id else request.cookies.get('user_session', '')) %}
            <a href="/ai/body_assessment/history/view/{{ history_user_id }}"
                class="nav-link {% if 'history/view' in request.path %}active{% endif %}" title="Historial">
                <i class="fas fa-history me-2 nav-icon"></i>
                <span>Historial</span>
            </a>
        </li>

        <li class="nav-item sidebar-section">
            Recursos
        </li>

        {{ macros.nav_link('/muscle-map', 'Mapa Muscular', 'fas fa-project-diagram') }}
        {{ macros.nav_link('/glossary', 'Glosario', 'fas fa-book-open') }}

        <hr class="sidebar-divider my-2">

        {{ macros.nav_link('/about', 'Acerca de', 'fas fa-info-circle') }}

        {% if current_user_role == 'admin' %}
        <li class="mt-3 border-top border-secondary pt-3">
            <a href="/admin/login" class="nav-link text-warning" title="Panel Admin">
                <i class="fas fa-user-shield me-2 nav-icon"></i>
                <span>Panel Admin</span>
            </a>
        </li>
        {% endif %}
    </ul>

    <!-- Sidebar Settings (Only visible when expanded) -->
    <div class="mb-3 px-1" id="sidebar-settings">
        <label class="text-secondary small fw-bold mb-1 d-block"
            style="font-size: 0.7rem; text-transform: uppercase;">Posición</label>
        <div class="d-flex w-100" id="pos-toggle-group">
            <button class="btn btn-sm pos-toggle-btn active" data-pos="left" title="Izquierda">
                <i class="fas fa-align-left"></i> Left
            </button>
            <button class="btn btn-sm pos-toggle-btn" data-pos="right" title="Derecha">
                Right <i class="fas fa-align-right"></i>
            </button>
        </div>
    </div>
</div>

<!-- Admin Token Modal -->
<div class="modal fade" id="adminTokenModal" tabindex="-1" aria-hidden="true" style="z-index: 1060;">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-start bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-warning">Autenticación Admin</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-secondary small mb-3">Ingresa el token de administrador para desbloquear funciones
                    avanzadas.</p>
                <div class="input-group">
                    <span class="input-group-text bg-dark border-secondary text-secondary"><i
                            class="fas fa-shield-alt"></i></span>
                    <input type="password" id="adminTokenInput" class="form-control" placeholder="Token secreto">
                </div>
                <div id="adminTokenMsg" class="mt-2 text-danger small"></div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" id="verifyTokenBtn" class="btn btn-warning btn-sm">Verificar</button>
            </div>
        </div>
    </div>
</div>

<!-- Impersonation Confirm Modal -->
<div class="modal fade" id="impersonateConfirmModal" tabindex="-1" aria-hidden="true" style="z-index: 1060;">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-start bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-warning">Cambiar de Usuario</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-white mb-1">¿Estás seguro de iniciar sesión como <strong id="impersonateTargetName"
                        class="text-info"></strong>?</p>
                <p class="text-secondary small">Podrás volver a tu usuario administrador desde el menú de usuario.
                </p>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" id="confirmImpersonateBtn" class="btn btn-warning btn-sm">Confirmar</button>
            </div>
        </div>
    </div>
</div>

<!-- Revert Impersonation Confirm Modal -->
<div class="modal fade" id="revertConfirmModal" tabindex="-1" aria-hidden="true" style="z-index: 1060;">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-start bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-info">Volver a Administrador</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-white mb-1">¿Deseas cerrar la sesión del usuario actual y volver a tu panel de
                    administrador?</p>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" id="confirmRevertBtn" class="btn btn-info btn-sm">Volver a Admin</button>
            </div>
        </div>
    </div>
</div>

<!-- Admin Lock Confirm Modal -->
<div class="modal fade" id="adminLockConfirmModal" tabindex="-1" aria-hidden="true" style="z-index: 1060;">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-start bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-danger">Bloquear Sesión Admin</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-white mb-1">¿Estás seguro de bloquear las funciones de administrador?</p>
                <p class="text-secondary small">Tendrás que volver a ingresar el token para acceder.</p>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" id="confirmLockAdminBtn" class="btn btn-danger btn-sm">Bloquear</button>
            </div>
        </div>
    </div>
</div>

<script src="/static/js/user_search.js"></script>
<script>
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(";").shift();
        return "";
    }

    function setAdminMenuState(isUnlocked) {
        const lockBtn = document.getElementById('sidebar-lock-btn');
        const tokenBtn = document.getElementById('sidebar-token-btn');
        if (lockBtn) lockBtn.style.display = isUnlocked ? "" : "none";
        if (tokenBtn) tokenBtn.style.display = isUnlocked ? "none" : "";

        const searchBtn = document.getElementById('sidebar-search-user-btn');
        if (!searchBtn) return;

        if (isUnlocked) {
            searchBtn.classList.remove('disabled');
            searchBtn.removeAttribute('aria-disabled');
            searchBtn.setAttribute('data-bs-toggle', 'modal');
            searchBtn.setAttribute('data-bs-target', '#userContextModal');
            searchBtn.onclick = null;
        } else {
            searchBtn.classList.add('disabled');
            searchBtn.setAttribute('aria-disabled', 'true');
            searchBtn.removeAttribute('data-bs-toggle');
            searchBtn.removeAttribute('data-bs-target');
            searchBtn.onclick = (e) => {
                e.preventDefault();
                if (window.showAlertModal) {
                    window.showAlertModal("Token requerido", "Valida el token admin para habilitar la busqueda de usuarios.", "warning");
                } else {
                    alert("Valida el token admin para habilitar la busqueda de usuarios.");
                }
            };
        }
    }

    // 1. Admin Token Logic
    document.addEventListener('DOMContentLoaded', () => {
        const verifyBtn = document.getElementById('verifyTokenBtn');
        const tokenInput = document.getElementById('adminTokenInput');
        const msg = document.getElementById('adminTokenMsg');
        const modalEl = document.getElementById('adminTokenModal');
        let bootstrapModal = null;

        if (verifyBtn && tokenInput) {
            tokenInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    verifyBtn.click();
                }
            });

            verifyBtn.addEventListener('click', async () => {
                const val = tokenInput.value.trim();
                if (!val) return;

                verifyBtn.disabled = true;
                verifyBtn.textContent = 'Verificando...';
                msg.textContent = '';

                try {
                    const resp = await fetch('/auth/verify_admin_token', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ token: val })
                    });
                    const data = await resp.json().catch(() => ({}));

                    if (resp.ok && data.ok) {
                        // Success
                        sessionStorage.setItem('admin_unlocked', 'true');
                        msg.className = 'mt-2 text-success small';
                        msg.textContent = 'Token correcto. Desbloqueando...';
                        setTimeout(() => {
                            if (!bootstrapModal && modalEl) bootstrapModal = bootstrap.Modal.getInstance(modalEl);
                            if (bootstrapModal) bootstrapModal.hide();
                            setAdminMenuState(true);
                            if (window.checkAdminLockAndInit) window.checkAdminLockAndInit();
                        }, 800);
                    } else {
                        msg.className = 'mt-2 text-danger small';
                        msg.textContent = data.error || data.message || 'Token incorrecto';
                    }
                } catch (e) {
                    msg.className = 'mt-2 text-danger small';
                    msg.textContent = 'Error de conexion';
                } finally {
                    verifyBtn.textContent = 'Verificar';
                    verifyBtn.disabled = false;
                }
            });
        }
    });






    document.addEventListener("DOMContentLoaded", () => {
        const sInput = document.getElementById('sidebar-user-search');
        const sResults = document.getElementById('sidebar-search-results');
        const revertLi = document.getElementById('revert-impersonation-li');
        const revertBtn = document.getElementById('revert-impersonation-btn');

        // Modal Elements
        const modalEl = document.getElementById('impersonateConfirmModal');
        const confirmBtn = document.getElementById('confirmImpersonateBtn');
        const targetNameEl = document.getElementById('impersonateTargetName');
        let pendingUser = null;
        let impModal = null;

        // Check if admin unlocked
        const isAdminUnlocked = sessionStorage.getItem('admin_unlocked') === 'true';
        if (isAdminUnlocked) {
            const cont = document.getElementById('admin-user-search-container');
            // Only show if available and not impersonating
            if (cont && cont.dataset.impersonating !== 'true') {
                cont.classList.remove('d-none');
            }
        }

        // Lock Admin Logic
        const lockBtn = document.getElementById('sidebar-lock-btn');
        const lockModalEl = document.getElementById('adminLockConfirmModal');
        const confirmLockBtn = document.getElementById('confirmLockAdminBtn');
        let lockModal = null;

        if (lockBtn) {
            lockBtn.addEventListener('click', (e) => {
                e.preventDefault();
                if (!lockModal && lockModalEl) lockModal = new bootstrap.Modal(lockModalEl);
                if (lockModal) lockModal.show();
            });
        }

        if (confirmLockBtn) {
            confirmLockBtn.addEventListener('click', async () => {
                confirmLockBtn.disabled = true;

                try {
                    await fetch('/admin/api/lock', { method: 'POST', headers: { 'X-CSRF-Token': getCookie('admin_csrf') } });
                } catch (e) { console.error(e); }

                sessionStorage.removeItem('admin_unlocked');

                // Hide modal properly before reload to avoid freeze
                const modalInstance = bootstrap.Modal.getInstance(lockModalEl);
                if (modalInstance) {
                    modalInstance.hide();
                }

                // Slight delay to ensure modal transition finishes
                setTimeout(() => {
                    setAdminMenuState(false);
                }, 300);
            });
        }

        const searchBtn = document.getElementById('sidebar-search-user-btn');
        setAdminMenuState(isAdminUnlocked);

        if (sInput && sResults) {
            function renderSidebarUserResult(u) {
                return "<div>" + (u.name || u.username || "Usuario") + "</div>" +
                    "<div class=\"text-muted\" style=\"font-size:0.7em\">" + (u.email || "") + "</div>";
            }

            initUserSearch({
                inputId: "sidebar-user-search",
                resultsId: "sidebar-search-results",
                minChars: 2,
                debounceMs: 300,
                storeSelection: false,
                itemClass: "p-2 border-bottom border-secondary text-white small cursor-pointer hover-bg-secondary",
                clearButtonId: "sidebar-clear-search",
                renderItem: renderSidebarUserResult,
                onSelect: function (u) { openConfirmModal(u); }
            });
        }

        function openConfirmModal(u) {
            const isAdmin = u && u.role === "admin";
            pendingUser = isAdmin ? null : u;
            targetNameEl.textContent = u.name || u.username;
            if (confirmBtn) confirmBtn.disabled = !!isAdmin;
            if (isAdmin && window.showAlertModal) {
                window.showAlertModal("Impersonacion bloqueada", "No puedes impersonar a un administrador.", "warning");
            }
            if (!impModal && modalEl) impModal = new bootstrap.Modal(modalEl);
            if (impModal) impModal.show();
        }

        if (confirmBtn) {
            confirmBtn.addEventListener('click', async () => {
                if (!pendingUser) return;

                confirmBtn.disabled = true;
                await impersonateUserAPI(pendingUser);
                confirmBtn.disabled = false;
                if (impModal) impModal.hide();
            });
        }

        async function impersonateUserAPI(u) {
            try {
                const res = await fetch('/admin/api/impersonate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': getCookie('admin_csrf') },
                    body: JSON.stringify({ user_id: u.user_id })
                });

                if (res.ok) {
                    const userData = {
                        user_id: u.user_id,
                        name: u.name,
                        username: u.username,
                        email: u.email
                    };
                    localStorage.setItem('ai_fitness_user', JSON.stringify(userData));
                    localStorage.setItem('ai_fitness_uid', u.user_id);
                    window.location.reload();
                } else {
                    const err = await res.json().catch(() => ({}));
                    const msg = err.error || "No se pudo cambiar de usuario.";
                    if (window.showAlertModal) {
                        window.showAlertModal("Impersonacion bloqueada", msg, "warning");
                    } else {
                        alert(msg);
                    }
                }
            } catch (e) {
                console.error(e);
                alert("Error de conexión");
            }
        }
        // Revert Impersonation Logic
        const revertModalEl = document.getElementById('revertConfirmModal');
        const confirmRevertBtn = document.getElementById('confirmRevertBtn');
        let revertModal = null;

        if (revertBtn) {
            revertBtn.addEventListener('click', (e) => {
                e.preventDefault();
                if (!revertModal && revertModalEl) revertModal = new bootstrap.Modal(revertModalEl);
                if (revertModal) revertModal.show();
            });
        }

        if (confirmRevertBtn) {
            confirmRevertBtn.addEventListener('click', async () => {
                confirmRevertBtn.disabled = true;

                try {
                    const res = await fetch('/admin/api/revert_impersonation', { method: 'POST', headers: { 'X-CSRF-Token': getCookie('admin_csrf') } });
                    const data = await res.json();

                    if (res.ok) {
                        localStorage.setItem('ai_fitness_user', JSON.stringify(data.user));
                        localStorage.setItem('ai_fitness_uid', data.user.user_id);
                        localStorage.removeItem('admin_working_user');
                        localStorage.removeItem('admin_working_user_id');

                        const modalInstance = bootstrap.Modal.getInstance(revertModalEl);
                        if (modalInstance) modalInstance.hide();
                        window.location.reload();
                    } else {
                        alert(data.error || "No se pudo volver a la sesiИn original.");
                    }
                } catch (e) { console.error(e); }
                confirmRevertBtn.disabled = false;
            });
        }

        // --- Admin Context Search Logic (Mirrors sidebar_admin.html) ---
        // Initialize User Search inside the Modal
        function initSidebarContextSearch() {
            const modalMsgEl = document.getElementById("modalUserSearchMsg");
            const confirmBtn = document.getElementById("modalConfirmUserSelection");
            const hiddenEl = document.getElementById("modalAdminUserId");
            let pendingContextUser = null;

                        function setPendingUser(user, prefix) {
                const isAdmin = user && user.role === "admin";
                pendingContextUser = isAdmin ? null : (user || null);
                if (hiddenEl) hiddenEl.value = pendingContextUser && pendingContextUser.user_id ? pendingContextUser.user_id : "";
                if (confirmBtn) confirmBtn.disabled = !pendingContextUser;
                if (modalMsgEl) {
                    if (isAdmin) {
                        modalMsgEl.textContent = "No puedes impersonar a un administrador.";
                        modalMsgEl.classList.remove("text-info");
                        modalMsgEl.classList.add("text-warning");
                    } else if (user) {
                        modalMsgEl.textContent = (prefix || "Usuario seleccionado: ") +
                            (user.name || user.username || user.user_id || "");
                        modalMsgEl.classList.remove("text-warning");
                        modalMsgEl.classList.add("text-info");
                    } else {
                        modalMsgEl.textContent = "";
                        modalMsgEl.classList.remove("text-warning");
                        modalMsgEl.classList.add("text-info");
                    }
                }
            }

function confirmSelection() {
                if (!pendingContextUser) {
                    if (modalMsgEl) modalMsgEl.textContent = "Selecciona un usuario primero.";
                    return;
                }
                if (confirmBtn) confirmBtn.disabled = true;
                try {
                    localStorage.setItem("admin_working_user", JSON.stringify(pendingContextUser));
                    if (pendingContextUser.user_id) {
                        localStorage.setItem("admin_working_user_id", String(pendingContextUser.user_id));
                    }
                } catch (e) { }

                if (modalMsgEl) {
                    modalMsgEl.textContent = "Usuario activo: " +
                        (pendingContextUser.name || pendingContextUser.username || pendingContextUser.user_id || "");
                }
                window.dispatchEvent(new CustomEvent("admin-user-selected", { detail: pendingContextUser }));

                fetch('/admin/api/impersonate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': getCookie('admin_csrf') },
                    body: JSON.stringify({ user_id: pendingContextUser.user_id })
                })
                    .then((res) => {
                        if (!res.ok) {
                            return res.json().then((data) => {
                                throw new Error(data.error || "No se pudo cambiar de usuario");
                            });
                        }
                        const userData = {
                            user_id: pendingContextUser.user_id,
                            name: pendingContextUser.name,
                            username: pendingContextUser.username,
                            email: pendingContextUser.email
                        };
                        localStorage.setItem('ai_fitness_user', JSON.stringify(userData));
                        localStorage.setItem('ai_fitness_uid', pendingContextUser.user_id);
                        const modalEl = document.getElementById('userContextModal');
                        if (modalEl) {
                            const modalInstance = bootstrap.Modal.getInstance(modalEl);
                            if (modalInstance) modalInstance.hide();
                        }
                        window.location.reload();
                    })
                    .catch((e) => {
                        const msg = e.message || "Error al cambiar de usuario.";
                        if (modalMsgEl) modalMsgEl.textContent = msg;
                        if (window.showAlertModal) {
                            window.showAlertModal("Impersonacion bloqueada", msg, "warning");
                        }
                    })
                    .finally(() => {
                        if (confirmBtn) confirmBtn.disabled = false;
                    });
            }

            initUserSearch({
                inputId: "modalUserSearchInput",
                resultsId: "modalUserSearchResults",
                hiddenId: "modalAdminUserId",
                buttonId: "modalBtnLookupUser",
                minChars: 2,
                debounceMs: 300,
                clearButtonId: "modalBtnClearSearch",
                storageKey: "admin_working_user",
                storageUidKey: "admin_working_user_id",
                storeSelection: false,
                itemClass: "list-group-item list-group-item-action bg-dark text-white border-secondary text-start",
                onSelect: (u) => {
                    setPendingUser(u);
                },
                onClear: () => {
                    setPendingUser(null);
                    window.dispatchEvent(new CustomEvent("admin-user-cleared"));
                }
            });

            if (confirmBtn) {
                confirmBtn.addEventListener("click", confirmSelection);
            }

            // Restore context if exists
            try {
                const stored = localStorage.getItem("admin_working_user");
                if (stored) {
                    const user = JSON.parse(stored);
                    const inputEl = document.getElementById("modalUserSearchInput");
                    if (inputEl && user) {
                        const label = user.name || user.username || "";
                        const email = user.email || "";
                        inputEl.value = label && email ? `${label} (${email})` : (label || user.user_id || "");
                    }
                    setPendingUser(user, "Usuario activo: ");
                }
            } catch (e) { }
        }

        let sidebarContextSearchReady = false;
        // Show button for admins and init search once.
        window.checkAdminLockAndInit = function () {
            const btnLi = document.getElementById('sidebar-search-user-li');
            if (btnLi) btnLi.classList.remove('d-none');
            if (sidebarContextSearchReady) return;

            if (typeof window.initUserSearch === "function") {
                initSidebarContextSearch();
                sidebarContextSearchReady = true;
                return;
            }

            let s = document.querySelector('script[src="/static/js/user_search.js"]');
            if (!s) {
                s = document.createElement("script");
                s.src = "/static/js/user_search.js";
                document.head.appendChild(s);
            }
            const existingOnload = s.onload;
            s.onload = function () {
                if (existingOnload) existingOnload();
                initSidebarContextSearch();
                sidebarContextSearchReady = true;
            };
        };

        // Run on load
        window.checkAdminLockAndInit();

        // Failsafe: Retry check a few times to handle any race conditions or slow DOM updates
        let retryCount = 0;
        const retryInterval = setInterval(() => {
            window.checkAdminLockAndInit();
            retryCount++;
            if (retryCount > 5) clearInterval(retryInterval);
        }, 500);
    });
</script>

<!-- User Context Selection Modal -->
<div class="modal fade" id="userContextModal" tabindex="-1" aria-hidden="true" style="z-index: 1060;">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-white border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title fs-5">Seleccionar Usuario de Trabajo</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <p class="small text-muted mb-2">Busca y selecciona un usuario para ver el sitio como el.</p>

                <div class="input-group mb-3">
                    <input type="text" class="form-control bg-dark text-white border-secondary"
                        id="modalUserSearchInput" placeholder="Buscar por nombre, correo o ID...">
                    <button class="btn btn-outline-primary" type="button" id="modalBtnLookupUser">
                        <i class="fas fa-search"></i>
                    </button>
                    <button class="btn btn-outline-secondary" type="button" id="modalBtnClearSearch">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div id="modalUserSearchResults" class="list-group shadow"
                    style="max-height: 300px; overflow-y: auto; display: none;">
                    <!-- Results will appear here -->
                </div>

                <input type="hidden" id="modalAdminUserId">
                <div id="modalUserSearchMsg" class="mt-2 text-info small"></div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" id="modalConfirmUserSelection" class="btn btn-primary btn-sm" disabled>
                    Confirmar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Mobile Toggle Button (Visible only on mobile) -->
<!-- Mobile Fixed Navbar (Visible only on mobile) -->
<nav class="navbar navbar-dark bg-dark fixed-top d-lg-none shadow-sm sidebar-mobile-nav"
    style="height: 60px; z-index: 1040;">
    <div class="container-fluid">
        <button id="mobile-sidebar-toggle" class="btn text-white border-0" type="button">
            <i class="fas fa-bars fs-3"></i>
        </button>
        <a class="navbar-brand me-auto ms-2 fw-bold text-primary" href="#">
            <img src="/static/images/logo.png" alt="AI Fitness" style="height: 36px; width: auto;">
        </a>
    </div>
</nav>

<!-- Sidebar Overlay (Backdrop for mobile) -->
<div id="sidebar-overlay" class="sidebar-overlay"></div>

<script src="/static/js/sidebar_ui.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // 1. Initialize Sidebar UI (Toggle, Mobile, Position)
        initSidebar({
            collapsedKey: "sidebar_collapsed",
            rightKey: "sidebar_right"
        });

        // 2. Logout Logic (User Sidebar specific)
        const logoutBtn = document.getElementById('sidebar-logout');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', async function (e) {
                e.preventDefault();
                try {
                    await fetch('/auth/logout', { method: 'POST' });
                } catch (e) { console.error(e); }

                // Clear User Session Data
                localStorage.removeItem('ai_fitness_user');
                localStorage.removeItem('ai_fitness_uid');
                sessionStorage.removeItem('admin_unlocked');

                window.location.href = '/';
            });
        }

        // 3. Ensure history link includes user_id when missing.
        const historyLink = document.querySelector('a[href^="/ai/body_assessment/history/view/"]');
        if (historyLink && historyLink.getAttribute('href').endsWith('/view/')) {
            const uid =
                localStorage.getItem('admin_working_user_id') ||
                localStorage.getItem('ai_fitness_uid') ||
                "";
            if (uid) {
                historyLink.setAttribute('href', '/ai/body_assessment/history/view/' + encodeURIComponent(uid));
            }
        }
    });
</script>
