<link href="/static/css/theme.css" rel="stylesheet">
<div class="d-flex flex-column flex-shrink-0 p-3 bg-panel sidebar-fixed"
    style="width: 250px; height: 100vh; position: fixed; top: 0; left: 0; overflow-y: auto; z-index: 1030;">
    <div class="d-flex align-items-center justify-content-between mb-3 text-theme sidebar-header">
        <a href="/" class="text-decoration-none brand-text">
            <span class="fs-4 fw-bold" style="color: var(--primary);">AI Fitness</span>
        </a>
        <div class="d-flex align-items-center gap-2">
            <button id="theme-toggle" class="btn btn-link p-0 fs-5 text-secondary" title="Cambiar Tema">
                <i class="fas fa-moon transition-icon"></i>
            </button>
            <button id="sidebar-toggle" class="btn btn-link text-theme p-0 fs-5" title="Colapsar/Expandir">
                <i class="fas fa-arrow-left transition-icon"></i>
            </button>
        </div>
    </div>

    <!-- User Identity -->
    <a href="#" class="d-flex align-items-center text-theme text-decoration-none dropdown-toggle-user"
        data-bs-toggle="collapse" data-bs-target="#user-collapse" aria-expanded="false" title="Usuario">
        <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-2 user-icon-container"
            style="width: 32px; height: 32px; min-width: 32px;">
            <i class="fas fa-user"></i>
        </div>
        <strong><span id="sidebar-username">{{ user_data.name if user_data and user_data.name else (user_data.username
                if user_data and user_data.username else 'Usuario') }}</span></strong>
        <i class="fas fa-chevron-down ms-2 small transition-icon"></i>
    </a>

    <!-- Collapsible Menu -->
    <div class="collapse" id="user-collapse">
        <ul class="list-unstyled fw-normal pb-1 small ms-5 mt-2">
            <li>
                <a href="/profile"
                    class="d-flex align-items-center text-secondary text-decoration-none py-1 hover-white">
                    <i class="fas fa-id-card me-2"></i> Perfil
                </a>
            </li>
            {% if current_user_role == 'admin' %}
            <li>
                <a href="#" id="sidebar-token-btn"
                    class="d-flex align-items-center text-warning text-decoration-none py-1 hover-white"
                    data-bs-toggle="modal" data-bs-target="#adminTokenModal">
                    <i class="fas fa-key me-2"></i> Token Admin
                </a>
            </li>
            {% endif %}
            <li>
                <a href="#" id="sidebar-logout"
                    class="d-flex align-items-center text-secondary text-decoration-none py-1 hover-white">
                    <i class="fas fa-sign-out-alt me-2"></i> Cerrar sesión
                </a>
            </li>
        </ul>
    </div>



    <hr class="border-theme" style="margin: 1rem 0;">

    <ul class="nav nav-pills flex-column mb-auto">
        <li class="nav-item">
            <a href="/landing" class="nav-link {% if request.path == '/landing' %}active{% endif %}" aria-current="page"
                title="Inicio">
                <i class="fas fa-home me-2" style="width: 24px; text-align: center;"></i>
                <span>Inicio</span>
            </a>
        </li>
        <li>
            <a href="/dashboard" class="nav-link {% if request.path == '/dashboard' %}active{% endif %}"
                title="Dashboard">
                <i class="fas fa-tachometer-alt me-2" style="width: 24px; text-align: center;"></i>
                <span>Dashboard</span>
            </a>
        </li>
        <li>
            <a href="/ai/body_assessment/user"
                class="nav-link {% if request.path == '/ai/body_assessment/user' %}active{% endif %}"
                title="Evaluación Corporal">
                <i class="fas fa-camera me-2" style="width: 24px; text-align: center;"></i>
                <span>Evaluación Corporal</span>
            </a>
        </li>
        <li>
            <a href="/plan" class="nav-link {% if request.path == '/plan' %}active{% endif %}" title="Mi Plan">
                <i class="fas fa-dumbbell me-2" style="width: 24px; text-align: center;"></i>
                <span>Mi Plan</span>
            </a>
        </li>
        <li>
            <a href="/nutrition" class="nav-link {% if request.path == '/nutrition' %}active{% endif %}"
                title="Nutrición">
                <i class="fas fa-utensils me-2" style="width: 24px; text-align: center;"></i>
                <span>Nutrición</span>
            </a>
        </li>
        <li>
            <a href="/about" class="nav-link {% if request.path == '/about' %}active{% endif %}" title="Acerca de">
                <i class="fas fa-info-circle me-2" style="width: 24px; text-align: center;"></i>
                <span>Acerca de</span>
            </a>
        </li>
        {% if current_user_role == 'admin' %}
        <li class="mt-3 border-top border-secondary pt-3">
            <a href="/admin" class="nav-link text-warning" title="Panel Admin">
                <i class="fas fa-user-shield me-2" style="width: 24px; text-align: center;"></i>
                <span>Panel Admin</span>
            </a>
        </li>
        {% endif %}
    </ul>

    <hr style="border-color: #374151; margin: 1rem 0;">

    {% if current_user_role != 'admin' %}
    <div class="mb-4">
        <small class="text-secondary text-uppercase fw-bold mb-2 d-block"
            style="font-size: 0.75rem; letter-spacing: 0.05em;">Idioma</small>
        <div class="d-flex w-100" id="lang-toggle-group">
            <button id="lang-es" class="btn btn-sm pos-toggle-btn active" data-lang="es"
                title="Español (ES)">ES</button>
            <button id="lang-en" class="btn btn-sm pos-toggle-btn" data-lang="en" title="English (EN)">EN</button>
        </div>
    </div>
    {% endif %}

    <!-- Sidebar Settings (Only visible when expanded) -->
    <div class="mb-3 px-1" id="sidebar-settings">
        <label class="text-secondary small fw-bold mb-1 d-block"
            style="font-size: 0.7rem; text-transform: uppercase;">Posición</label>
        <div class="d-flex w-100" id="pos-toggle-group">
            <button class="btn btn-sm pos-toggle-btn active" data-pos="left" title="Izquierda">
                <i class="fas fa-align-left"></i> Left
            </button>
            <button class="btn btn-sm pos-toggle-btn" data-pos="right" title="Derecha">
                Right <i class="fas fa-align-right"></i>
            </button>
        </div>
    </div>
</div>

<!-- Admin Token Modal (Moved outside fixed sidebar) -->
<div class="modal fade" id="adminTokenModal" tabindex="-1" aria-hidden="true" style="z-index: 1060;">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-start">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-warning">Autenticación Admin</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-secondary small mb-3">Ingresa el token de administrador para desbloquear funciones
                    avanzadas.</p>
                <div class="input-group">
                    <span class="input-group-text bg-dark border-secondary text-secondary"><i
                            class="fas fa-shield-alt"></i></span>
                    <input type="password" id="adminTokenInput" class="form-control" placeholder="Token secreto">
                </div>
                <div id="adminTokenMsg" class="mt-2 text-danger small"></div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" id="verifyTokenBtn" class="btn btn-warning btn-sm">Verificar</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const verifyBtn = document.getElementById('verifyTokenBtn');
        const tokenInput = document.getElementById('adminTokenInput');
        const msg = document.getElementById('adminTokenMsg');
        const modalEl = document.getElementById('adminTokenModal');
        let bootstrapModal = null;

        if (verifyBtn && tokenInput) {
            verifyBtn.addEventListener('click', async () => {
                const val = tokenInput.value.trim();
                if (!val) return;

                verifyBtn.disabled = true;
                verifyBtn.textContent = 'Verificando...';
                msg.textContent = '';

                try {
                    const resp = await fetch('/auth/verify_admin_token', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ token: val })
                    });
                    const data = await resp.json();

                    if (data.ok) {
                        // Success
                        sessionStorage.setItem('admin_unlocked', 'true');
                        msg.className = 'mt-2 text-success small';
                        msg.textContent = 'Token correcto. Desbloqueando...';
                        setTimeout(() => {
                            if (!bootstrapModal && modalEl) bootstrapModal = bootstrap.Modal.getInstance(modalEl);
                            if (bootstrapModal) bootstrapModal.hide();
                            location.reload(); // Reload to apply changes (e.g. show dashboard controls)
                        }, 800);
                    } else {
                        msg.textContent = 'Token incorrecto';
                    }
                } catch (e) {
                    msg.textContent = 'Error de conexión';
                } finally {
                    verifyBtn.disabled = false;
                    verifyBtn.textContent = 'Verificar';
                }
            });
        }
    });
</script>


<!-- Mobile Toggle Button (Visible only on mobile) -->
<!-- Mobile Fixed Navbar (Visible only on mobile) -->
<nav class="navbar navbar-dark bg-dark fixed-top d-lg-none shadow-sm" style="height: 60px; z-index: 1040;">
    <div class="container-fluid">
        <button id="mobile-sidebar-toggle" class="btn text-white border-0" type="button">
            <i class="fas fa-bars fs-3"></i>
        </button>
        <a class="navbar-brand me-auto ms-2 fw-bold text-primary" href="#">AI Fitness</a>
    </div>
</nav>

<!-- Sidebar Overlay (Backdrop for mobile) -->
<div id="sidebar-overlay" class="sidebar-overlay"></div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const body = document.body;
        const sidebarToggle = document.getElementById("sidebar-toggle");
        const toggleIcon = sidebarToggle.querySelector("i");
        const posButtons = document.querySelectorAll("#pos-toggle-group .pos-toggle-btn");

        // 1. Cargar preferencias
        const savedCollapsed = localStorage.getItem("sidebar_collapsed") === "true";
        const savedRight = localStorage.getItem("sidebar_right") === "true";

        function updateToggleIcon() {
            if (body.classList.contains("sb-collapsed")) {
                toggleIcon.className = "fas fa-bars";
            } else {
                toggleIcon.className = "fas fa-arrow-left transition-icon";
                if (body.classList.contains("sb-right")) {
                    toggleIcon.className = "fas fa-arrow-right transition-icon";
                }
            }
        }

        function updatePosButtons(isRight) {
            posButtons.forEach(btn => {
                const isBtnRight = btn.dataset.pos === "right";
                if ((isRight && isBtnRight) || (!isRight && !isBtnRight)) {
                    btn.classList.add("active");
                } else {
                    btn.classList.remove("active");
                }
            });
        }

        if (savedCollapsed) body.classList.add("sb-collapsed");

        if (savedRight) {
            body.classList.add("sb-right");
            updatePosButtons(true);
        } else {
            updatePosButtons(false);
        }
        updateToggleIcon();


        // 2. Toggle Sidebar
        if (sidebarToggle) {
            sidebarToggle.addEventListener("click", () => {
                body.classList.toggle("sb-collapsed");
                const isCollapsed = body.classList.contains("sb-collapsed");
                localStorage.setItem("sidebar_collapsed", isCollapsed);
                updateToggleIcon();
            });
        }

        // 3. Toggle Position via Buttons
        posButtons.forEach(btn => {
            btn.addEventListener("click", () => {
                const targetPos = btn.dataset.pos; // 'left' or 'right'
                if (targetPos === "right") {
                    body.classList.add("sb-right");
                    localStorage.setItem("sidebar_right", "true");
                    updatePosButtons(true);
                } else {
                    body.classList.remove("sb-right");
                    localStorage.setItem("sidebar_right", "false");
                    updatePosButtons(false);
                }
                updateToggleIcon();
            });
        });


        // Mobile Sidebar Logic
        const mobileToggle = document.getElementById("mobile-sidebar-toggle");
        const sidebarFixed = document.querySelector(".sidebar-fixed");
        const sidebarOverlay = document.getElementById("sidebar-overlay");

        function closeMobileSidebar() {
            if (sidebarFixed) sidebarFixed.classList.remove("show-mobile");
            if (sidebarOverlay) sidebarOverlay.classList.remove("show");
        }

        if (mobileToggle) {
            mobileToggle.addEventListener("click", function () {
                if (sidebarFixed) sidebarFixed.classList.toggle("show-mobile");
                if (sidebarOverlay) sidebarOverlay.classList.toggle("show");
            });
        }

        if (sidebarOverlay) {
            sidebarOverlay.addEventListener("click", closeMobileSidebar);
        }

        // Close sidebar when clicking a link on mobile
        const navLinks = sidebarFixed ? sidebarFixed.querySelectorAll(".nav-link") : [];
        navLinks.forEach(link => {
            link.addEventListener("click", () => {
                if (window.innerWidth < 992) {
                    closeMobileSidebar();
                }
            });
        });


        // 4. Mostrar nombre de usuario
        const userJson = localStorage.getItem('ai_fitness_user');
        if (userJson) {
            try {
                const user = JSON.parse(userJson);
                const displayName = user.name || user.username || 'Usuario';
                const userEl = document.getElementById('sidebar-username');
                if (userEl) userEl.textContent = displayName;
            } catch (e) { console.error(e); }
        }

        // 5. Logout
        const logoutBtn = document.getElementById('sidebar-logout');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', function (e) {
                e.preventDefault();
                localStorage.removeItem('ai_fitness_user');
                localStorage.removeItem('ai_fitness_uid');
                sessionStorage.removeItem('admin_unlocked');
                window.location.href = '/';
            });
        }
        // 6. Redirect Home/Brand logic if logged in
        const redirectIfLogged = (e) => {
            try {
                if (localStorage.getItem('ai_fitness_user')) {
                    e.preventDefault();
                    window.location.href = '/dashboard';
                }
            } catch (ex) { }
        };

        const brandLink = document.querySelector('.brand-text')?.closest('a');
        const homeLink = document.querySelector('a[href="/"][title="Inicio"]');

        if (brandLink) brandLink.addEventListener('click', redirectIfLogged);
        if (homeLink) homeLink.addEventListener('click', redirectIfLogged);

        // 7. Theme Toggle Logic (Added Fix)
        const themeToggle = document.getElementById('theme-toggle');
        if (themeToggle) {
            const icon = themeToggle.querySelector('i');
            const html = document.documentElement;

            // Load saved theme
            const savedTheme = localStorage.getItem('theme') || 'dark';
            if (savedTheme === 'light') {
                html.setAttribute('data-theme', 'light');
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
            } else {
                // Ensure default is dark if cleared
                html.removeAttribute('data-theme');
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
            }

            themeToggle.addEventListener('click', () => {
                const currentTheme = html.getAttribute('data-theme');
                if (currentTheme === 'light') {
                    // Switch to Dark
                    html.removeAttribute('data-theme');
                    localStorage.setItem('theme', 'dark');
                    icon.classList.remove('fa-sun');
                    icon.classList.add('fa-moon');
                } else {
                    // Switch to Light
                    html.setAttribute('data-theme', 'light');
                    localStorage.setItem('theme', 'light');
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                }
            });
        }
    });
</script>