<link href="/static/css/theme.css" rel="stylesheet">
<style>
    body.sb-collapsed .sidebar-fixed {
        width: 80px !important;
        padding-left: 0.75rem !important;
        padding-right: 0.75rem !important;
    }

    body.sb-collapsed .sidebar-header .brand-text,
    body.sb-collapsed .sidebar-section,
    body.sb-collapsed .sidebar-heading,
    body.sb-collapsed #sidebar-settings,
    body.sb-collapsed #sidebar-username,
    body.sb-collapsed .nav-link span,
    body.sb-collapsed .collapse-inner,
    body.sb-collapsed .sidebar-divider,
    body.sb-collapsed hr.border-theme {
        display: none !important;
    }

    body.sb-collapsed .sidebar-fixed .nav-link {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    body.sb-collapsed .sidebar-fixed .nav-link i {
        margin-right: 0 !important;
        width: auto !important;
        text-align: center !important;
    }

    body.sb-collapsed .user-icon-container {
        margin-right: 0 !important;
    }

    /* Smart Workout links stay in the root list. */
</style>
{% import 'components/macros.html' as macros %}
<div class="d-flex flex-column flex-shrink-0 p-3 bg-panel sidebar-fixed sidebar-panel">

    <div class="d-flex align-items-center justify-content-between mb-3 text-theme sidebar-header">
        <a href="/admin" class="text-decoration-none brand-text">
            <img src="/static/images/logo.png" alt="AI Fitness" class="sidebar-logo">
        </a>
        <div class="d-flex align-items-center gap-2">
            <button id="theme-toggle" class="btn btn-link p-0 fs-5 text-secondary" title="Cambiar Tema">
                <i class="fas fa-moon transition-icon"></i>
            </button>
            <button id="sidebar-toggle" class="btn btn-link text-theme p-0 fs-5" title="Colapsar/Expandir">
                <i class="fas fa-arrow-left transition-icon"></i>
            </button>
        </div>
    </div>

    <!-- Admin Identity -->
    <div class="d-flex align-items-center text-theme text-decoration-none mb-3 px-2 py-2 rounded"
        style="background-color: rgba(239, 68, 68, 0.1);">
        <div class="bg-danger rounded-circle d-flex align-items-center justify-content-center me-2 user-icon-container"
            style="width: 32px; height: 32px; min-width: 32px; overflow: hidden;">
            <img id="sidebar-admin-avatar-img" alt="Administrador"
                src="{{ user_data.profile_image_url if user_data and user_data.profile_image_url else '' }}"
                class="{{ 'd-block' if user_data and user_data.profile_image_url else 'd-none' }}"
                style="width: 100%; height: 100%; object-fit: cover;"
                onerror="this.classList.add('d-none'); document.getElementById('sidebar-admin-avatar-icon').classList.remove('d-none');">
            <i id="sidebar-admin-avatar-icon"
                class="fas fa-user-shield {{ 'd-none' if user_data and user_data.profile_image_url else '' }}"></i>
        </div>
        <strong><span id="sidebar-username">{{ user_data.name if user_data and user_data.name else (user_data.username
                if user_data and user_data.username else (current_user_role|capitalize if current_user_role else
                'Usuario')) }}</span></strong>
    </div>

    <!-- Admin User Search -->
    <div class="px-2 mb-2 sidebar-section position-relative">
        <label class="form-label small text-uppercase fw-bold text-secondary mb-1">Usuario</label>
        <div class="input-group input-group-sm">
            <input type="text" class="form-control bg-dark text-white border-secondary" id="sidebarUserSearchTerm"
                placeholder="Nombre, Email o ID...">
            <button class="btn btn-outline-primary" type="button" id="sidebarBtnLookupUser">
                <i class="fas fa-search"></i>
            </button>
            <button class="btn btn-outline-secondary" type="button" id="sidebarBtnClearUserSearch" title="Limpiar">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="sidebarUserSearchResults" class="list-group position-absolute w-100 start-0 mt-1 shadow rounded-0"
            style="display: none; z-index: 1050;"></div>
        <input type="hidden" id="sidebarAdminUserId">
        <div id="sidebarUserSearchMsg" class="text-info small mt-2 fst-italic"></div>
    </div>

    <hr class="border-theme" style="margin: 1rem 0;">

    <ul class="nav nav-pills flex-column mb-auto">
        <!-- Section: Platform -->
        <li class="nav-item text-secondary small text-uppercase fw-bold mt-3 mb-2 px-3 sidebar-section">
            Plataforma
        </li>
        {{ macros.nav_link('/admin/users', 'Gestor Usuarios', 'fas fa-users') }}
        {{ macros.nav_link('/admin/profiles', 'Gestor Perfiles', 'fas fa-id-card-alt') }}
        {{ macros.nav_link('/admin/privileges', 'Gestor Roles', 'fas fa-user-shield') }}

        <!-- Section: Modules -->
        <li class="nav-item sidebar-section">
            Inteligencia Artificial
        </li>
        {{ macros.nav_link('/ai/body_assessment/tester', 'Evaluaciones', 'fas fa-camera-retro') }}
        {{ macros.nav_link('/ai/routine/generator', 'Rutinas AI', 'fas fa-robot') }}
        {{ macros.nav_link('/ai/routine/generator_mongo', 'Routine Mongo', 'fas fa-database') }}

        <!-- Section: Workout -->
        <li class="nav-item sidebar-section">
            Entrenamiento
        </li>
        {{ macros.nav_link('/workout/routines/builder-guided?source=admin', 'Constructor Rutinas', 'fas fa-hammer') }}
        {{ macros.nav_link('/admin/exercises', 'Catalogo Ejercicios', 'fas fa-dumbbell') }}
        {{ macros.nav_link('/admin/routines', 'Catalogo Rutinas', 'fas fa-clipboard-list') }}
        {{ macros.nav_link('/workout/dashboard', 'Runner / Historial', 'fas fa-running') }}
        {{ macros.nav_link('/admin/plans', 'Planes (Gym)', 'fas fa-clipboard-check') }}

        <!-- Section: Nutrition -->
        <li class="nav-item sidebar-section">
            Nutrición
        </li>
        {{ macros.nav_link('/admin/meal_plans', 'Meal Plans', 'fas fa-utensils') }}

        <!-- Section: Reports -->
        <li class="nav-item sidebar-section">
            Reportes
        </li>
        {{ macros.nav_link('/admin/body_assessments', 'Informes', 'fas fa-file-medical-alt') }}

        <hr class="sidebar-divider my-2">
        {{ macros.nav_link('/admin/logout', 'Salir de Admin', 'fas fa-sign-out-alt') }}
    </ul>

    <!-- Sidebar Settings (Only visible when expanded) -->
    <div class="mb-3 px-1 mt-4" id="sidebar-settings">
        <label class="text-secondary small fw-bold mb-1 d-block"
            style="font-size: 0.7rem; text-transform: uppercase;">Posición</label>
        <div class="d-flex w-100" id="pos-toggle-group">
            <button class="btn btn-sm pos-toggle-btn active" data-pos="left" title="Izquierda">
                <i class="fas fa-align-left"></i> Left
            </button>
            <button class="btn btn-sm pos-toggle-btn" data-pos="right" title="Derecha">
                Right <i class="fas fa-align-right"></i>
            </button>
        </div>
    </div>
</div>

<!-- Mobile Fixed Navbar (Visible only on mobile) -->
<nav class="navbar navbar-dark bg-dark fixed-top d-lg-none shadow-sm sidebar-mobile-nav"
    style="height: 60px; z-index: 1040;">
    <div class="container-fluid">
        <button id="mobile-sidebar-toggle" class="btn text-white border-0" type="button">
            <i class="fas fa-bars fs-3"></i>
        </button>
        <span class="navbar-brand me-auto ms-2 fw-bold text-danger">
            <img src="/static/images/logo.png" alt="AI Fitness" style="height: 36px; width: auto;">
        </span>
    </div>
</nav>

<!-- Sidebar Overlay (Backdrop for mobile) -->
<div id="sidebar-overlay" class="sidebar-overlay"></div>

<script src="/static/js/user_search.js"></script>
<script src="/static/js/sidebar_ui.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // 1. Initialize Sidebar UI
        initSidebar({
            collapsedKey: "sidebar_admin_collapsed",
            rightKey: "sidebar_admin_right"
        });

        // 2. Admin User Search Logic
        function initSidebarUserSearch() {
            if (typeof window.initUserSearch !== "function") return;
            const msgEl = document.getElementById("sidebarUserSearchMsg");
            initUserSearch({
                inputId: "sidebarUserSearchTerm",
                resultsId: "sidebarUserSearchResults",
                hiddenId: "sidebarAdminUserId",
                buttonId: "sidebarBtnLookupUser",
                clearButtonId: "sidebarBtnClearUserSearch",
                storageKey: "admin_working_user",
                storageUidKey: "admin_working_user_id",
                itemClass: "list-group-item list-group-item-action bg-dark text-white border-secondary text-start",
                onSelect: (u) => {
                    if (msgEl) {
                        msgEl.textContent = "Usuario activo: " + (u.name || u.username || u.user_id || "");
                    }
                    window.dispatchEvent(new CustomEvent("admin-user-selected", { detail: u }));
                },
                onClear: () => {
                    if (msgEl) msgEl.textContent = "";
                    window.dispatchEvent(new CustomEvent("admin-user-cleared"));
                }
            });

            try {
                const stored = localStorage.getItem("admin_working_user");
                if (stored) {
                    const user = JSON.parse(stored);
                    const inputEl = document.getElementById("sidebarUserSearchTerm");
                    const hiddenEl = document.getElementById("sidebarAdminUserId");
                    if (hiddenEl && user && user.user_id) hiddenEl.value = user.user_id;
                    if (inputEl && user) {
                        const label = user.name || user.username || "";
                        const email = user.email || "";
                        inputEl.value = label && email ? `${label} (${email})` : (label || user.user_id || "");
                    }
                    if (msgEl) {
                        msgEl.textContent = "Usuario activo: " + (user.name || user.username || user.user_id || "");
                    }
                }
            } catch (e) { }
        }

        if (typeof window.initUserSearch === "function") {
            initSidebarUserSearch();
        } else {
            const script = document.createElement("script");
            script.src = "/static/js/user_search.js";
            script.onload = initSidebarUserSearch;
            document.head.appendChild(script);
        }
    });


    // 3. User Info Sync (Robustness)
    (function () {
        // Only run if we suspect data might be stale or missing (e.g. "Administrador" or "Usuario" default)
        const nameEl = document.getElementById("sidebar-username");
        const imgEl = document.getElementById("sidebar-admin-avatar-img");
        const iconEl = document.getElementById("sidebar-admin-avatar-icon");

        const currentName = nameEl ? nameEl.textContent.trim() : "";
        const needsUpdate = currentName === "Administrador" || currentName === "Usuario" || !currentName;

        if (needsUpdate) {
            fetch("/api/user/my_profile")
                .then(res => {
                    if (!res.ok) throw new Error("No auth");
                    return res.json();
                })
                .then(data => {
                    if (data && !data.error) {
                        // Update Name
                        const displayName = data.name || data.username || "Usuario";
                        if (nameEl) nameEl.textContent = displayName;

                        // Update Image
                        if (data.profile_image_url) {
                            if (imgEl) {
                                imgEl.src = data.profile_image_url;
                                imgEl.classList.remove("d-none");
                                imgEl.classList.add("d-block");
                            }
                            if (iconEl) iconEl.classList.add("d-none");
                        }
                    }
                })
                .catch(() => { });
        }
    })();
</script>