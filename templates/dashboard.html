<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Fitness | Dashboard de Progreso</title>

  <!-- CDNs: Bootstrap para estilos, Google Fonts (Poppins) y Chart.js para grÃ¡ficos -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Estilos base del dashboard (tema oscuro) -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
  <link href="/static/css/theme.css" rel="stylesheet">
  <link href="/static/css/sidebar.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--bg-body);
      color: var(--text-main);
    }

    .navbar {
      background-color: var(--bg-panel);
      border-bottom: 1px solid var(--border-color);
    }

    .navbar-brand {
      color: var(--primary) !important;
      font-weight: 700;
    }

    .hero {
      background: linear-gradient(to right, rgba(0, 0, 0, 0.8), rgba(37, 99, 235, 0.4)),
        url('/static/images/IMG_1552.jpg');
      background-size: cover;
      background-position: center;
      height: 65vh;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: white;
      /* Keep hero text white as it has dark overlay */
    }

    /* Stats Cards */
    #stats .row {
      align-items: stretch;
    }

    #stats .col-md-3 {
      display: flex;
    }

    .stat-card {
      background-color: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 15px;
      padding: 1.25rem;
      text-align: center;
      transition: 0.3s ease;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      flex: 1;
      min-height: 160px;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 0 20px rgba(37, 99, 235, 0.3);
      background-color: var(--bg-card-hover);
    }

    .stat-icon {
      font-size: 2.5rem;
      color: var(--primary);
      margin-bottom: 10px;
    }


    .stat-card h5 {
      color: var(--text-main);
    }

    .stat-card h3 {
      color: var(--text-main);
    }

    .progress-bar {
      background-color: var(--primary);
    }

    canvas {
      background-color: var(--bg-card);
      border-radius: 10px;
      padding: 10px;
      min-height: 280px;
      width: 100%;
      border: 1px solid var(--border-color);
    }

    .chart-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      font-size: 1rem;
      background: rgba(17, 24, 39, 0.75);
      /* Keep dark overlay for now or adjust */
      border-radius: 10px;
      visibility: hidden;
    }

    footer {
      background-color: var(--bg-panel);
      color: var(--text-muted);
      text-align: center;
      padding: 1rem 0;
      margin-top: 3rem;
      border-top: 1px solid var(--border-color);
    }

    #loading {
      display: none;
      text-align: center;
      color: var(--primary);
      margin-top: 1rem;
    }

    #message {
      text-align: center;
      margin-top: 1rem;
      font-weight: 500;
      color: var(--text-main) !important;
    }

    /* AI Section Overrides */
    .ai-card-theme {
      background-color: var(--bg-card) !important;
      color: var(--text-main) !important;
      border: 1px solid var(--border-color);
    }

    .ai-subcard-theme {
      background: var(--bg-card-hover) !important;
      border: 1px solid var(--border-color);
      color: var(--text-main);
    }

    .list-group-item-theme {
      background: var(--bg-card) !important;
      color: var(--text-main) !important;
      border-color: var(--border-color) !important;
    }

    /* Heatmap Grid */
    .heatmap-grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 4px;
      width: 100%;
      max-width: 280px;
    }

    .heatmap-cell {
      aspect-ratio: 1;
      background-color: #2c3035;
      border-radius: 2px;
    }

    .heatmap-cell.level-1 {
      background-color: #0e4429;
    }

    .heatmap-cell.level-2 {
      background-color: #006d32;
    }

    .heatmap-cell.level-3 {
      background-color: #26a641;
    }

    .heatmap-cell.level-4 {
      background-color: #39d353;
      box-shadow: 0 0 5px #39d353;
    }
  </style>
</head>

<body>
  <!-- Navbar -->
  {% include 'components/sidebar.html' %}
  <div class="main-content">

    <!-- Hero -->
    <section class="hero">
      <div class="container">
        <!-- TÃ­tulo principal y subtÃ­tulo del dashboard -->
        <h1 id="dashboard-hero-title">Monitorea tu evolución</h1>
        <p id="dashboard-hero-p" class="lead mt-3">Selecciona tu usuario, carga tus datos y observa tu progreso en
          tiempo real.</p>
      </div>
    </section>

    <!-- Selector de usuario (Visible solo si Token Admin OK) -->
    <div id="admin-controls" class="container text-center mt-5" style="display:none;">
      <!-- Input del ID de usuario y bootón; el spinner aparece durante la carga -->
      <label id="select-user-label" class="fw-bold text-primary mb-2">Selecciona tu ID de usuario</label>
      <div class="input-group mb-3 justify-content-center" style="max-width: 720px; margin: 0 auto; gap: 8px;">
        <input type="text" id="userIdInput" class="form-control text-center" placeholder="Ejemplo: usr_001">
        <button id="loadDataBtn" class="btn btn-primary">Cargar progreso</button>
        <button id="aiSuggestBtn" class="btn btn-outline-info">Ajustes AI</button>
        <button id="aiHistoryBtn" class="btn btn-outline-secondary">Histórico AI</button>
        {% if is_admin %}
        <a href="/workout/assign-routine" class="btn btn-warning"><i class="fas fa-tasks me-1"></i> Asignar Rutinas</a>
        {% endif %}
      </div>
      <script>
        (function () {
          try {
            if (sessionStorage.getItem('admin_unlocked') === 'true') {
              document.getElementById('admin-controls').style.display = 'block';
            }
          } catch (e) { }
        })();
      </script>
      <div id="loading">
        <div class="spinner-border text-primary" role="status"></div>
        <p id="loading-text">Cargando datos...</p>
      </div>
      <p id="message" class="text-light"></p>
      <div id="active-plan-indicator" class="mt-2" style="display:none; color:#10b981;"></div>
    </div>

    <!-- EstadÃ­sticas -->

    <!-- Ajustes del Agente -->
    <section id="ai-section" class="container mt-5" style="display:none;">
      <div class="card ai-card-theme" style="border-radius:12px;">
        <div class="card-body">
          <h4 class="card-title mb-3">Ajustes recomendados por el Agente</h4>
          <div id="ai-loading" class="text-info mb-2" style="display:none;">Calculando ajustes...</div>
          <div id="ai-error" class="text-danger mb-2" style="display:none;"></div>
          <div id="ai-content" style="display:none;">
            <div class="row g-3">
              <div class="col-md-6">
                <div class="p-3 ai-subcard-theme" style="border-radius:10px;">
                  <h6 class="text-primary">Plan de alimentación</h6>
                  <div id="ai-kcal"></div>
                  <div id="ai-macros"></div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="p-3 ai-subcard-theme" style="border-radius:10px;">
                  <h6 class="text-primary">Plan de entrenamiento</h6>
                  <div id="ai-train"></div>
                </div>
              </div>
            </div>
            <div class="mt-3">
              <h6 class="text-primary">Resumen</h6>
              <p id="ai-reason" class="mb-1"></p>
              <small id="ai-next" class="text-secondary"></small>
              <div class="mt-2">
                <button id="btnSaveAgentPlan" class="btn btn-success btn-sm" style="display:none;">Guardar y
                  activar</button>
                <span id="ai-save-msg" class="text-info ms-2"></span>
              </div>
            </div>
          </div>
          <hr class="text-secondary" />
          <div>
            <h5 class="mb-2">Histórico de ajustes</h5>
            <div id="ai-history-loading" class="text-info mb-2" style="display:none;">Cargando histórico...</div>
            <div id="ai-history-error" class="text-danger mb-2" style="display:none;"></div>
            <ul id="ai-history-list" class="list-group list-group-flush" style="background:transparent;"></ul>
          </div>
        </div>
      </div>
    </section>

    <section id="stats" class="mt-5 container">
      <!-- Tarjetas con Ãºltimo registro (peso, grasa, rendimiento, adherencia) -->
      <div class="row g-4">

        <!-- Admin Card (Visible only if is_admin) -->
        {% if is_admin %}
        <div class="col-12 col-md-12 mb-2">
          <a href="/workout/assign-routine" class="text-decoration-none">
            <div class="stat-card flex-row align-items-center justify-content-start px-4 py-3"
              style="background: linear-gradient(45deg, var(--primary), #1e40af); border: none;">
              <div class="stat-icon text-white mb-0 me-3"><i class="fas fa-tasks"></i></div>
              <div class="text-start">
                <h5 class="text-white mb-0">Panel de Entrenador</h5>
                <p class="text-white-50 mb-0 small">Asignar nuevas rutinas y gestionar plantillas</p>
              </div>
              <div class="ms-auto text-white"><i class="fas fa-chevron-right"></i></div>
            </div>
          </a>
        </div>
        {% endif %}

        <!-- Heatmap Card -->
        <div class="col-12 col-md-12 mb-3">
          <div class="card bg-panel border-0 shadow">
            <div class="card-header border-secondary text-white fw-bold text-center">
              <img src="/static/images/logo.png" alt="AI Fitness" style="height: 200px; width: auto;">
              <div class="mt-2">
                <i class="fas fa-th text-success me-2"></i>Consistencia (Últimos 60 días)
              </div>
            </div>
            <div class="card-body d-flex justify-content-center py-4">
              <div id="heatmapGrid" class="heatmap-grid"></div>
            </div>
          </div>
        </div>

        <div class="col-6 col-md-3">
          <div class="stat-card">
            <div class="stat-icon">🔥</div>
            <h5 id="stat-weight-title">Peso Actual</h5>
            <h3 id="stat-weight" class="text-theme">â€”</h3>
            <p id="stat-last-0" class="text-secondary">Último registro</p>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="stat-card">
            <div class="stat-icon">💪</div>
            <h5 id="stat-fat-title">Grasa Corporal</h5>
            <h3 id="stat-fat" class="text-theme">â€”</h3>
            <p id="stat-last-1" class="text-secondary">Último registro</p>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="stat-card">
            <div class="stat-icon">⚡</div>
            <h5 id="stat-performance-title">Rendimiento</h5>
            <h3 id="stat-performance" class="text-theme">â€”</h3>
            <div class="progress mt-2">
              <div class="progress-bar" id="bar-performance" style="width:0%"></div>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="stat-card">
            <div class="stat-icon">🥗</div>
            <h5 id="stat-nutrition-title">Adherencia Nutricional</h5>
            <h3 id="stat-nutrition" class="text-theme">â€”</h3>
            <div class="progress mt-2">
              <div class="progress-bar" id="bar-nutrition" style="width:0%"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- My Routines Section -->
    <section id="my-routines" class="container mt-5" style="display:none;">
      <h4 class="mb-3">Mis Rutinas Asignadas</h4>
      <div id="routines-list" class="row g-3">
        <!-- Routines injected here -->
      </div>
    </section>

    <section id="my-created-routines" class="container mt-4" style="display:none;">
      <div class="card bg-panel border-0 shadow">
        <div class="card-header border-secondary text-white fw-bold d-flex justify-content-between align-items-center">
          <div><i class="fas fa-user-edit text-cyber-blue me-2"></i>Rutinas creadas</div>
          <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse"
            data-bs-target="#createdRoutinesCollapse" aria-expanded="false" aria-controls="createdRoutinesCollapse">
            <i class="fas fa-chevron-down"></i>
          </button>
        </div>
        <div id="createdRoutinesCollapse" class="collapse">
          <div class="card-body">
            <div id="created-routines-list" class="row g-3">
              <div class="col-12 text-center py-3">
                <div class="spinner-border text-primary" role="status"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- GrÃ¡ficos -->
    <section id="charts" class="container mt-5">
      <!-- 4 grÃ¡ficos (peso, grasa, rendimiento, adherencia) con overlays de "Sin datos" -->
      <div class="row g-4">
        <div class="col-md-6 position-relative"><canvas id="weightChart"></canvas>
          <div class="chart-overlay" id="msg-weight">Sin datos disponibles</div>
        </div>
        <div class="col-md-6 position-relative"><canvas id="fatChart"></canvas>
          <div class="chart-overlay" id="msg-fat">Sin datos disponibles</div>
        </div>
        <div class="col-md-6 position-relative"><canvas id="performanceChart"></canvas>
          <div class="chart-overlay" id="msg-performance">Sin datos disponibles</div>
        </div>
        <div class="col-md-6 position-relative"><canvas id="nutritionChart"></canvas>
          <div class="chart-overlay" id="msg-nutrition">Sin datos disponibles</div>
        </div>
      </div>
    </section>

    <footer>
      <p id="footer-text">© 2025 AI Fitness | Dashboard de Progreso Inteligente</p>
      <small class="text-secondary d-block">v. beta 1.0.2</small>
    </footer>

    <script>
      // JS del dashboard: maneja carga de progreso, actualizaciÃ³n de tarjetas y grÃ¡ficos
      // Endpoint: GET /get_progress/{userId}
      // Respuesta: Array de { date, weight_kg, body_fat, performance, nutrition_adherence }
      const btn = document.getElementById("loadDataBtn");
      const userIdInput = document.getElementById("userIdInput");
      const message = document.getElementById("message");
      const loading = document.getElementById("loading");
      let charts = [];

      async function loadProgress(userId) {
        if (!userId) return;
        message.textContent = "";
        loading.style.display = "block";

        // PeticiÃ³n al backend para obtener el historial de progreso del usuario
        const res = await fetch(`/get_progress/${userId}`);
        const data = await res.json();
        loading.style.display = "none";

        // Oculta overlays de "Sin datos" antes de validar la respuesta
        const overlays = ["weight", "fat", "performance", "nutrition"];
        overlays.forEach(id => document.getElementById(`msg-${id}`).style.visibility = "hidden");

        // Manejo de error o falta de datos: limpiar UI y mostrar overlays
        if (res.status !== 200 || !Array.isArray(data) || data.length === 0) {
          message.textContent = data.error || "â No se encontraron registros de progreso.";
          clearDashboard();
          overlays.forEach(id => document.getElementById(`msg-${id}`).style.visibility = "visible");
          return;
        }

        message.textContent = t('data_loaded');
        // Guardar el Ãºltimo usuario consultado en localStorage para precargarlo la prÃ³xima vez
        localStorage.setItem("ai_fitness_uid", userId);

        const last = data[data.length - 1];
        document.getElementById("stat-weight").innerText = `${last.weight_kg} kg`;
        document.getElementById("stat-fat").innerText = `${last.body_fat}%`;
        document.getElementById("stat-performance").innerText = `${last.performance}%`;
        document.getElementById("bar-performance").style.width = `${last.performance}%`;
        document.getElementById("stat-nutrition").innerText = `${last.nutrition_adherence}%`;
        document.getElementById("bar-nutrition").style.width = `${last.nutrition_adherence}%`;

        // Limpiar grÃ¡ficos previos antes de volver a dibujar
        charts.forEach(c => c.destroy());
        charts = [];

        // Preparar series para Chart.js
        const labels = data.map(d => d.date);
        const weights = data.map(d => d.weight_kg);
        const fats = data.map(d => d.body_fat);
        const performance = data.map(d => d.performance);
        const nutrition = data.map(d => d.nutrition_adherence);

        // Paleta y opciones de tema para Chart.js
        const isLight = document.documentElement.getAttribute('data-theme') === 'light';
        const textColor = isLight ? '#374151' : '#e5e7eb';
        const gridColor = isLight ? '#e5e7eb' : '#374151';

        const colors = { blue: "#3b82f6", green: "#10b981", yellow: "#facc15", red: "#ef4444" };
        const opts = {
          plugins: { legend: { labels: { color: textColor } } },
          scales: {
            x: { ticks: { color: textColor }, grid: { color: gridColor } },
            y: { ticks: { color: textColor }, grid: { color: gridColor } }
          }
        };

        // Gráfico de peso (línea)
        charts.push(new Chart("weightChart", { type: "line", data: { labels, datasets: [{ label: t('chart_weight'), data: weights, borderColor: colors.blue, backgroundColor: "rgba(59,130,246,0.2)", fill: true, tension: 0.3 }] }, options: opts }));
        // Gráfico de grasa corporal (línea)
        charts.push(new Chart("fatChart", { type: "line", data: { labels, datasets: [{ label: t('chart_fat'), data: fats, borderColor: colors.red, backgroundColor: "rgba(239,68,68,0.2)", fill: true, tension: 0.3 }] }, options: opts }));
        // Gráfico de rendimiento (barras)
        charts.push(new Chart("performanceChart", { type: "bar", data: { labels, datasets: [{ label: t('chart_performance'), data: performance, backgroundColor: colors.green }] }, options: opts }));
        // Gráfico de adherencia nutricional (barras)
        charts.push(new Chart("nutritionChart", { type: "bar", data: { labels, datasets: [{ label: t('chart_nutrition'), data: nutrition, backgroundColor: colors.yellow }] }, options: opts }));

        // Expose a helper to update chart labels when language changes
        window.updateChartLabels = function () {
          try {
            // Update dataset labels
            if (!charts) return;
            if (charts[0] && charts[0].data && charts[0].data.datasets[0]) charts[0].data.datasets[0].label = t('chart_weight');
            if (charts[1] && charts[1].data && charts[1].data.datasets[0]) charts[1].data.datasets[0].label = t('chart_fat');
            if (charts[2] && charts[2].data && charts[2].data.datasets[0]) charts[2].data.datasets[0].label = t('chart_performance');
            if (charts[3] && charts[3].data && charts[3].data.datasets[0]) charts[3].data.datasets[0].label = t('chart_nutrition');
            charts.forEach(c => c.update());
          } catch (e) {/* ignore */ }
        };
      }

      // Restablece las tarjetas y limpia los grÃ¡ficos cuando no hay datos
      function clearDashboard() {
        document.getElementById("stat-weight").innerText = "?";
        document.getElementById("stat-fat").innerText = "?";
        document.getElementById("stat-performance").innerText = "?";
        document.getElementById("bar-performance").style.width = "0%";
        document.getElementById("stat-nutrition").innerText = "?";
        document.getElementById("bar-nutrition").style.width = "0%";
        charts.forEach(c => c.destroy());
        charts = [];
      }

      // Click: valida el input y dispara la carga de datos
      btn.addEventListener("click", () => {
        const typed = userIdInput.value.trim();
        let targetId = typed;
        try {
          const raw = localStorage.getItem('ai_fitness_user');
          if (raw) {
            const u = JSON.parse(raw);
            const loggedId = String(u.user_id || u._id || '').trim();
            const uname = (u.username || '').trim();
            const email = (u.email || '').trim().toLowerCase();
            // If the user typed their username/email (or left empty), use the logged-in id
            if (!typed || typed === uname || typed.toLowerCase() === email) {
              targetId = loggedId || typed;
            }
          }
        } catch (e) { /* ignore */ }
        if (!targetId) { message.textContent = "â ï¸ Ingresa un ID de usuario."; return; }
        loadProgress(targetId);
        loadActivePlanIndicator(targetId);
        loadRoutines(targetId);
        loadCreatedRoutines();
        loadHeatmap(targetId);
      });

      const countExercises = (routine) => {
        const items = Array.isArray(routine.items) ? routine.items : [];
        const hasInlineGroups = items.some(item => Array.isArray(item.items));
        if (hasInlineGroups) {
          let total = 0;
          items.forEach(item => {
            if (item.item_type === "group" || Array.isArray(item.items)) {
              const groupItems = Array.isArray(item.items) ? item.items : [];
              total += groupItems.filter(entry => entry && entry.item_type !== "rest").length;
            } else if (item.item_type === "exercise") {
              total += 1;
            }
          });
          return total;
        }
        return items.filter(item => item && item.item_type === "exercise").length;
      };

      // --- New Function: Load Routines ---
      async function loadRoutines(userId) {
        const listEl = document.getElementById('routines-list');
        const sectionEl = document.getElementById('my-routines');

        if (!listEl || !sectionEl) return;

        // Clear current
        listEl.innerHTML = '<div class="col-12 text-center py-3"><div class="spinner-border text-primary" role="status"></div></div>';
        sectionEl.style.display = 'block';

        try {
          const res = await fetch(`/workout/api/routines?user_id=${encodeURIComponent(userId)}`);
          const routines = await res.json();

          listEl.innerHTML = '';

          if (!routines || routines.length === 0) {
            listEl.innerHTML = `<div class="col-12 text-muted text-center py-3">No hay rutinas asignadas para este usuario.</div>`;
            return;
          }

          routines.forEach(r => {
            const cardCol = document.createElement('div');
            cardCol.className = 'col-md-6 col-lg-4';

            // Safe checks
            const name = r.name || 'Rutina sin nombre';
            const exCount = (r.items ? r.items.length : 0);
            const id = r._id;

            cardCol.innerHTML = `
                    <div class="card h-100" style="background-color: var(--bg-card); border: 1px solid var(--border-color);">
                        <div class="card-body">
                            <h5 class="card-title text-primary mb-2 text-truncate" title="${name}">${name}</h5>
                            <p class="card-text text-muted small mb-3">
                                <i class="fas fa-dumbbell me-1"></i> ${exCount} ejercicios
                            </p>
                            <a href="/workout/run/${id}?return_to=/dashboard" class="btn btn-sm btn-outline-primary w-100">
                                <i class="fas fa-play me-1"></i> Iniciar
                            </a>
                        </div>
                    </div>
                  `;
            listEl.appendChild(cardCol);
          });

        } catch (e) {
          console.error(e);
          listEl.innerHTML = `<div class="col-12 text-danger text-center">Error cargando rutinas.</div>`;
        }
      }

      async function loadCreatedRoutines() {
        const listEl = document.getElementById('created-routines-list');
        const sectionEl = document.getElementById('my-created-routines');
        if (!listEl || !sectionEl) return;

        listEl.innerHTML = '<div class="col-12 text-center py-3"><div class="spinner-border text-primary" role="status"></div></div>';
        sectionEl.style.display = 'block';

        try {
          const res = await fetch('/workout/api/my-routines');
          const routines = await res.json();
          listEl.innerHTML = '';

          if (!routines || routines.length === 0) {
            listEl.innerHTML = `<div class="col-12 text-muted text-center py-3">No tienes rutinas creadas.</div>`;
            return;
          }

          routines.forEach(r => {
            const cardCol = document.createElement('div');
            cardCol.className = 'col-md-6 col-lg-4';
            const name = r.name || 'Rutina sin nombre';
            const exCount = countExercises(r);
            const id = r._id;
            cardCol.innerHTML = `
              <div class="card h-100" style="background-color: var(--bg-card); border: 1px solid var(--border-color);">
                <div class="card-body">
                  <h5 class="card-title text-primary mb-2 text-truncate" title="${name}">${name}</h5>
                  <p class="card-text text-muted small mb-3">
                    <i class="fas fa-dumbbell me-1"></i> ${exCount} ejercicios
                  </p>
                  <a href="/workout/run/${id}?return_to=/dashboard" class="btn btn-sm btn-outline-primary w-100">
                    <i class="fas fa-play me-1"></i> Iniciar
                  </a>
                </div>
              </div>
            `;
            listEl.appendChild(cardCol);
          });
        } catch (e) {
          console.error(e);
          listEl.innerHTML = `<div class="col-12 text-danger text-center">Error cargando rutinas creadas.</div>`;
        }
      }

      // --- New Function: Load Heatmap ---
      async function loadHeatmap(userId) {
        try {
          const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
          const hRes = await fetch(`/workout/api/stats/heatmap?user_id=${userId}&timezone=${encodeURIComponent(tz)}`);
          const hMap = await hRes.json();
          const grid = document.getElementById("heatmapGrid");

          // Generate last 60 days
          grid.innerHTML = "";
          grid.style.gridTemplateColumns = `repeat(10, 1fr)`;

          const today = new Date();
          for (let i = 59; i >= 0; i--) {
            const d = new Date();
            d.setDate(today.getDate() - i);
            // Use local date string (YYYY-MM-DD)
            const key = d.toLocaleDateString('en-CA');
            const count = hMap[key] || 0;

            const cell = document.createElement("div");
            cell.className = `heatmap-cell level-${Math.min(count * 2, 4)}`;
            if (count === 0) cell.className = "heatmap-cell";
            else if (count >= 2) cell.className = "heatmap-cell level-4";
            else cell.className = "heatmap-cell level-2";

            cell.title = `${key}: ${count} workouts`;
            grid.appendChild(cell);
          }
        } catch (e) { console.error("Heatmap error", e); }
      }

      // BotÃ³n: solicitar ajustes AI y mostrar resumen en el mensaje
      const aiBtn = document.getElementById("aiSuggestBtn");
      aiBtn.addEventListener("click", async () => {
        const typed = userIdInput.value.trim();
        let targetId = typed;
        try {
          const raw = localStorage.getItem('ai_fitness_user');
          if (raw) {
            const u = JSON.parse(raw);
            const loggedId = String(u.user_id || u._id || '').trim();
            const uname = (u.username || '').trim();
            const email = (u.email || '').trim().toLowerCase();
            if (!typed || typed === uname || typed.toLowerCase() === email) {
              targetId = loggedId || typed;
            }
          }
        } catch (e) { /* ignore */ }
        if (!targetId) { message.textContent = "Ingresa un ID de usuario."; return; }
        return loadAiAdjustments(targetId);
      });

      // Click: cargar histórico del agente
      const aiHistoryBtn = document.getElementById('aiHistoryBtn');
      aiHistoryBtn.addEventListener('click', async () => {
        const typed = userIdInput.value.trim();
        let targetId = typed;
        try {
          const raw = localStorage.getItem('ai_fitness_user');
          if (raw) {
            const u = JSON.parse(raw);
            const loggedId = String(u.user_id || u._id || '').trim();
            const uname = (u.username || '').trim();
            const email = (u.email || '').trim().toLowerCase();
            if (!typed || typed === uname || typed.toLowerCase() === email) {
              targetId = loggedId || typed;
            }
          }
        } catch (e) { /* ignore */ }
        if (!targetId) { message.textContent = "Ingresa un ID de usuario."; return; }
        return loadAiHistory(targetId);
      });

      // Al cargar la pÃ¡gina, recupera el Ãºltimo usuario desde localStorage
      async function loadAiAdjustments(userId) {
        const section = document.getElementById('ai-section');
        const loadEl = document.getElementById('ai-loading');
        const errEl = document.getElementById('ai-error');
        const content = document.getElementById('ai-content');
        const kcalEl = document.getElementById('ai-kcal');
        const macrosEl = document.getElementById('ai-macros');
        const trainEl = document.getElementById('ai-train');
        const reasonEl = document.getElementById('ai-reason');
        const nextEl = document.getElementById('ai-next');
        const btnSave = document.getElementById('btnSaveAgentPlan');
        const saveMsg = document.getElementById('ai-save-msg');

        if (section) section.style.display = 'block';
        if (loadEl) loadEl.style.display = 'block';
        if (errEl) { errEl.style.display = 'none'; errEl.textContent = ''; }
        if (content) content.style.display = 'none';
        if (btnSave) { btnSave.style.display = 'none'; btnSave.dataset.userId = userId; }
        if (saveMsg) { saveMsg.textContent = ''; }
        try {
          const resp = await fetch(`/ai/reason/${encodeURIComponent(userId)}?limit=12`);
          if (!resp.ok) {
            const err = await resp.json().catch(() => ({ error: 'Error desconocido' }));
            throw new Error(err.error || `HTTP ${resp.status}`);
          }
          const data = await resp.json();
          const out = data.output || {};
          const adj = out.ajustes || {};
          const food = adj.plan_alimentacion || {};
          const macros = food.macros || {};
          const train = adj.plan_entrenamiento || {};

          if (kcalEl) kcalEl.textContent = `Objetivo kcal: ${food.kcal_obj ?? '-'} (delta: ${food.kcal_delta ?? 0})`;
          if (macrosEl) macrosEl.textContent = `Macros (p/c/g): ${macros.p ?? '-'} / ${macros.c ?? '-'} / ${macros.g ?? '-'}`;
          if (trainEl) trainEl.textContent = `Volumen: ${train.volumen_delta_ratio ?? 0}, Cardio: ${train.cardio ?? '-'}`;
          if (reasonEl) reasonEl.textContent = out.razonamiento_resumido || '';
          if (nextEl) nextEl.textContent = (out.proxima_revision_dias != null) ? `Próxima revisión: ${out.proxima_revision_dias} días` : '';

          if (content) content.style.display = 'block';
          if (btnSave) btnSave.style.display = 'inline-block';
        } catch (e) {
          if (errEl) { errEl.textContent = `No se pudieron obtener los ajustes: ${e.message}`; errEl.style.display = 'block'; }
        } finally {
          if (loadEl) loadEl.style.display = 'none';
        }
      }

      // Guardar y activar plan desde el último ajuste AI
      (function () {
        const btn = document.getElementById('btnSaveAgentPlan');
        const msg = document.getElementById('ai-save-msg');
        if (!btn) return;
        btn.addEventListener('click', async () => {
          const input = document.getElementById('userIdInput');
          let targetId = btn.dataset.userId || (input ? input.value.trim() : '');
          try {
            const raw = localStorage.getItem('ai_fitness_user');
            if (raw) {
              const u = JSON.parse(raw);
              const loggedId = String(u.user_id || u._id || '').trim();
              const uname = (u.username || '').trim();
              const email = (u.email || '').trim().toLowerCase();
              if (!targetId || targetId === uname || targetId.toLowerCase() === email) {
                targetId = loggedId || targetId;
              }
            }
          } catch (e) { /* ignore */ }
          if (!targetId) { if (msg) msg.textContent = 'Ingresa un ID de usuario.'; return; }
          if (msg) msg.textContent = 'Guardando y activando plan...';
          try {
            const resp = await fetch(`/ai/adjustments/${encodeURIComponent(targetId)}/apply_latest`, { method: 'POST' });
            if (!resp.ok) {
              const err = await resp.json().catch(() => ({ error: 'Error desconocido' }));
              throw new Error(err.error || `HTTP ${resp.status}`);
            }
            const data = await resp.json();
            if (msg) msg.textContent = 'Plan guardado y activado';
            btn.style.display = 'none';
            try { loadActivePlanIndicator(targetId); } catch (_) { }
          } catch (e) { if (msg) msg.textContent = `No se pudo guardar: ${e.message}`; }
        });
      })();

      async function loadAiHistory(userId) {
        const section = document.getElementById('ai-section');
        const loadEl = document.getElementById('ai-history-loading');
        const errEl = document.getElementById('ai-history-error');
        const listEl = document.getElementById('ai-history-list');
        if (section) section.style.display = 'block';
        if (loadEl) loadEl.style.display = 'block';
        if (errEl) { errEl.style.display = 'none'; errEl.textContent = ''; }
        if (listEl) listEl.innerHTML = '';
        try {
          const resp = await fetch(`/ai/adjustments/${encodeURIComponent(userId)}?limit=10`);
          if (!resp.ok) {
            const err = await resp.json().catch(() => ({ error: 'Error desconocido' }));
            throw new Error(err.error || `HTTP ${resp.status}`);
          }
          const rows = await resp.json();
          if (!Array.isArray(rows)) throw new Error('Formato inválido');
          const frag = document.createDocumentFragment();
          rows.forEach((r, idx) => {
            const li = document.createElement('li');
            li.className = 'list-group-item list-group-item-theme d-flex justify-content-between align-items-start';
            // li.style.background = '#111827'; li.style.color = '#e5e7eb'; // REMOVED hardcoded styles
            const title = document.createElement('div');
            const ts = (r.created_at || '').replace('T', ' ').replace('Z', '');
            title.innerHTML = `<div><strong>#${idx + 1}</strong> · ${ts || 'sin-fecha'}</div>`;
            const small = document.createElement('small');
            const aj = (r.output && r.output.ajustes) || {};
            const food = aj.plan_alimentacion || {}; const train = aj.plan_entrenamiento || {};
            small.textContent = `kcal: ${food.kcal_obj ?? '-'} (? ${food.kcal_delta ?? 0}), vol: ${train.volumen_delta_ratio ?? 0}, cardio: ${train.cardio ?? '-'}`;
            title.appendChild(small);
            li.appendChild(title);

            const actions = document.createElement('div');
            const saveBtn = document.createElement('button');
            saveBtn.className = 'btn btn-sm btn-outline-light';
            saveBtn.textContent = 'Guardar como plan';
            saveBtn.addEventListener('click', async (ev) => {
              ev.stopPropagation();
              try {
                const resp = await fetch(`/ai/adjustments/${encodeURIComponent(r._id)}/save_plan`, { method: 'POST' });
                if (!resp.ok) {
                  const err = await resp.json().catch(() => ({ error: 'Error desconocido' }));
                  throw new Error(err.error || `HTTP ${resp.status}`);
                }
                const out = await resp.json();
                const msg = document.getElementById('message');
                if (msg) msg.textContent = 'Plan guardado correctamente';
              } catch (e) {
                const msg = document.getElementById('message');
                if (msg) msg.textContent = `No se pudo guardar el plan: ${e.message}`;
              }
            });
            actions.appendChild(saveBtn);
            li.appendChild(actions);
            li.addEventListener('click', () => {
              // Al hacer click, cargar detalle en la tarjeta superior
              if (r.output) {
                const macros = (r.output.ajustes && r.output.ajustes.plan_alimentacion && r.output.ajustes.plan_alimentacion.macros) || {};
                const food2 = (r.output.ajustes && r.output.ajustes.plan_alimentacion) || {};
                const train2 = (r.output.ajustes && r.output.ajustes.plan_entrenamiento) || {};
                document.getElementById('ai-kcal').textContent = `Objetivo kcal: ${food2.kcal_obj ?? '-'} (delta: ${food2.kcal_delta ?? 0})`;
                document.getElementById('ai-macros').textContent = `Macros (p/c/g): ${macros.p ?? '-'} / ${macros.c ?? '-'} / ${macros.g ?? '-'}`;
                document.getElementById('ai-train').textContent = `Volumen ?: ${train2.volumen_delta_ratio ?? 0}, Cardio: ${train2.cardio ?? '-'}`;
                document.getElementById('ai-reason').textContent = r.output.razonamiento_resumido || '';
                document.getElementById('ai-next').textContent = (r.output.proxima_revision_dias != null) ? `Próxima revisión: ${r.output.proxima_revision_dias} días` : '';
                document.getElementById('ai-section').style.display = 'block';
                document.getElementById('ai-content').style.display = 'block';
              }
            });
            frag.appendChild(li);
          });
          if (listEl) listEl.appendChild(frag);
        } catch (e) {
          if (errEl) { errEl.textContent = `No se pudo cargar el histórico: ${e.message}`; errEl.style.display = 'block'; }
        } finally {
          if (loadEl) loadEl.style.display = 'none';
        }
      }

      window.addEventListener("DOMContentLoaded", () => {
        // Prefer the logged-in user's id for loading, but show their username in the input
        let loadId = null;
        let displayLabel = null;
        try {
          const raw = localStorage.getItem('ai_fitness_user');
          if (raw) {
            const u = JSON.parse(raw);
            loadId = String(u.user_id || u._id || '').trim() || null;
            displayLabel = (u.username || '').trim() || null;
          }
        } catch (e) { /* ignore */ }
        const lastUser = localStorage.getItem("ai_fitness_uid");
        if (!loadId && lastUser) {
          loadId = lastUser;
          displayLabel = lastUser;
        }
        if (displayLabel) {
          userIdInput.value = displayLabel;
        }
        if (loadId) {
          loadProgress(loadId);
          loadActivePlanIndicator(loadId);
          loadRoutines(loadId);
          loadCreatedRoutines();
          loadHeatmap(loadId);
        } else {
          loadCreatedRoutines();
        }
      });
    </script>
    <script>
      async function loadActivePlanIndicator(userId) {
        const el = document.getElementById('active-plan-indicator');
        try {
          if (!userId) { if (el) el.style.display = 'none'; return; }
          const resp = await fetch(`/plans/${encodeURIComponent(userId)}/active`);
          if (resp.ok) {
            const data = await resp.json();
            const ts = data.activated_at || data.created_at || '';
            let label = '';
            try {
              const d = new Date(ts);
              if (!isNaN(d.getTime())) {
                const dd = String(d.getDate()).padStart(2, '0');
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const yyyy = d.getFullYear();
                label = `${dd}/${mm}/${yyyy}`;
              } else {
                label = ts.toString().split('T')[0];
                if (label && label.includes('-')) {
                  const parts = label.split('-');
                  if (parts.length === 3) { label = `${parts[2]}/${parts[1]}/${parts[0]}`; }
                }
              }
            } catch (_) { label = ts; }
            if (el) {
              el.innerHTML = `Plan activo desde ${label} · <a href="/plan" class="link-info">ver en Mi Plan</a>`;
              el.style.display = 'block';
            }
          } else {
            if (el) el.style.display = 'none';
          }
        } catch (e) {
          if (el) el.style.display = 'none';
        }
      }
    </script>

    <!-- Ajustes del Agente (secciÃ³n visual) -->

    <!-- Language selector script: guarda la preferencia en localStorage y actualiza document.lang -->
    <!-- centralized language script -->
  </div> <!-- End main-content -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/static/js/lang.js"></script>
</body>

</html>