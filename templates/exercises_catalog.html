{% extends 'layout.html' %}

{% block title %}AI Fitness - Catálogo Ejercicios{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12 d-flex flex-column flex-md-row justify-content-between align-items-center gap-3">
        <h2 class="fw-bold text-cyber-green mb-0 text-center text-md-start"><i
                class="fas fa-book-medical me-2"></i>Catálogo de Ejercicios</h2>

        <div
            class="d-flex flex-wrap gap-2 align-items-center justify-content-center justify-content-md-end w-100 w-md-auto">
            <div class="input-group" style="min-width: 200px; flex-grow: 1; max-width: 100%;">
                <span class="input-group-text bg-dark border-secondary text-secondary"><i
                        class="fas fa-search"></i></span>
                <input type="text" class="form-control border-secondary" id="mainSearch"
                    placeholder="Buscar ejercicio...">
            </div>

            <div class="d-flex gap-2 w-100 w-md-auto overflow-auto pb-1 pb-md-0" style="scrollbar-width: none;">
                <!-- Filtros desplazables en pantallas pequenas -->
                <select class="form-select border-secondary flex-grow-1 flex-md-grow-0" id="filterBodyPart"
                    style="min-width: 130px;">
                    <option value="">Grupo</option>
                    <!-- Opciones cargadas por JS -->
                </select>
                <select class="form-select border-secondary flex-grow-1 flex-md-grow-0" id="filterEquipment"
                    style="min-width: 130px;">
                    <option value="">Equipo</option>
                    <option value="barbell">Barra</option>
                    <option value="dumbbell">Mancuernas</option>
                    <option value="machine">M&#225;quina</option>
                    <option value="cable">Polea / Cable</option>
                    <option value="band">Banda</option>
                    <option value="bench">Banco</option>
                    <option value="bodyweight">Peso Corporal</option>
                    <option value="other">Otro</option>
                </select>
                <select class="form-select border-secondary flex-grow-1 flex-md-grow-0" id="filterType"
                    style="min-width: 100px;">
                    <option value="">Tipo</option>
                    <option value="weight">Peso</option>
                    <option value="time">Tiempo</option>
                    <option value="cardio">Cardio</option>
                </select>
            </div>

            <div class="d-flex gap-2 w-100 w-md-auto justify-content-between justify-content-md-end">
                <button class="btn btn-outline-secondary text-nowrap flex-grow-1 flex-md-grow-0"
                    onclick="resetFilters()">
                    <i class="fas fa-undo me-1"></i> <span class="d-none d-md-inline">Restablecer</span>
                </button>
                <button class="btn btn-cyber-primary text-nowrap flex-grow-1 flex-md-grow-0"
                    onclick="openExerciseModal()">
                    <i class="fas fa-plus me-1"></i> Nuevo <span class="d-none d-md-inline">Ejercicio</span>
                </button>
            </div>
        </div>
    </div>
</div>

<div class="card bg-panel border-0 shadow-lg d-none d-md-block">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-dark table-hover align-middle" id="exercisesTable">
                <thead>
                    <tr class="text-cyber-blue">
                        <th>Nombre</th>
                        <th>Grupo Muscular</th>
                        <th>Equipo</th>
                        <th>Tipo</th>
                        <th>Video</th>
                        <th>Origen</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody id="exercisesList">
                    <!-- Completado por JS -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Vista de lista movil -->
<div id="mobileExercisesList" class="d-md-none d-flex flex-column gap-3">
    <!-- Cargado por JS -->
</div>

<!-- Modal Crear/Editar Ejercicio -->
<div class="modal fade" id="exerciseModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-panel text-white border-cyber">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-cyber-green">Ejercicio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="exerciseForm">
                    <input type="hidden" id="exId">

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label text-secondary">Nombre *</label>
                            <input type="text" class="form-control border-secondary" id="exName" required
                                placeholder="Ej. Press Banca">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-secondary">Parte del Cuerpo</label>
                            <select class="form-select border-secondary" id="exBodyPart">
                                <!-- Opciones cargadas por JS -->
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label text-secondary">Patron</label>
                            <select class="form-select border-secondary" id="exPattern">
                                <option value="">Sin definir</option>
                                <option value="Push">Push</option>
                                <option value="Pull">Pull</option>
                                <option value="Squat">Squat</option>
                                <option value="Hinge">Hinge</option>
                                <option value="Carry">Carry</option>
                                <option value="Rotation">Rotation</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-secondary">Plano</label>
                            <select class="form-select border-secondary" id="exPlane">
                                <option value="">Sin definir</option>
                                <option value="Vertical">Vertical</option>
                                <option value="Horizontal">Horizontal</option>
                                <option value="Diagonal">Diagonal</option>
                                <option value="Sagittal">Sagittal</option>
                                <option value="Frontal">Frontal</option>
                                <option value="Transversal">Transversal</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-secondary">Nivel</label>
                            <select class="form-select border-secondary" id="exLevel">
                                <option value="">Sin definir</option>
                                <option value="Beginner">Beginner</option>
                                <option value="Intermediate">Intermediate</option>
                                <option value="Advanced">Advanced</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label text-secondary">Tipo de Registro</label>
                            <select class="form-select border-secondary" id="exType">
                                <option value="weight">Peso (Series x Reps)</option>
                                <option value="time">Tiempo (Duracion)</option>
                                <option value="cardio">Cardio (Distancia/Tiempo)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-secondary">Equipo Requerido</label>
                            <select class="form-select border-secondary" id="exEquipment" multiple size="4">
                                <option value="barbell">Barra</option>
                                <option value="dumbbell">Mancuernas</option>
                                <option value="machine">Maquina</option>
                                <option value="cable">Polea / Cable</option>
                                <option value="band">Banda</option>
                                <option value="bench">Banco</option>
                                <option value="bodyweight">Peso Corporal</option>
                                <option value="other">Otro</option>
                            </select>
                            <small class="text-muted">Puedes seleccionar mas de uno.</small>
                        </div>

                        <div class="col-md-8">
                            <label class="form-label text-secondary">Musculo Primario</label>
                            <input type="text" class="form-control border-secondary" id="exPrimaryMuscle"
                                placeholder="Ej. Lats">
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="exUnilateral">
                                <label class="form-check-label text-secondary" for="exUnilateral">Unilateral</label>
                            </div>
                        </div>

                        <div class="col-12">
                            <label class="form-label text-secondary">Nombres Alternativos</label>
                            <input type="text" class="form-control border-secondary" id="exAlternativeNames"
                                placeholder="Separa con comas">
                        </div>

                        <div class="col-12">
                            <label class="form-label text-secondary">Video Demostrativo (URL)</label>
                            <div class="input-group">
                                <span class="input-group-text bg-dark border-secondary text-secondary"><i
                                        class="fab fa-youtube"></i></span>
                                <input type="url" class="form-control border-secondary" id="exVideo"
                                    placeholder="https://youtube.com/...">
                            </div>
                        </div>

                        <div class="col-12">
                            <label class="form-label text-secondary">Descripción / Notas Técnicas</label>
                            <textarea class="form-control border-secondary" id="exDescription" rows="3"
                                placeholder="Ej. Mantener codos pegados al cuerpo..."></textarea>
                        </div>

                        <div class="col-12">
                            <label class="form-label text-secondary">Sustitutos / Equivalentes</label>
                            <div class="mb-2">
                                <input type="text" class="form-control form-control-sm border-secondary" id="subSearch"
                                    placeholder="Buscar por nombre, equipo o tipo...">
                            </div>
                            <div class="bg-input border border-secondary rounded p-2"
                                style="max-height: 200px; overflow-y: auto;" id="substitutesContainer">
                                <!-- Llenado dinámicamente con checkboxes -->
                            </div>
                            <small class="text-muted">Selecciona los ejercicios que pueden reemplazar a este.</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="saveExercise()">Guardar Cambios</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Mensajes -->
<div class="modal fade" id="messageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-panel text-white border-cyber">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-cyber-green">Mensaje</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body"></div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" id="messageCancel"
                    data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-cyber-primary" id="messageConfirm">Confirmar</button>
                <button type="button" class="btn btn-cyber-primary" id="messageOk"
                    data-bs-dismiss="modal">Aceptar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de video -->
<div class="modal fade" id="videoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-panel text-white border-cyber">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-cyber-green">Video</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="ratio ratio-16x9">
                    <iframe id="videoFrame" src="" title="Video ejercicio"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen></iframe>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<style>
    .sub-item:hover {
        background-color: rgba(255, 255, 255, 0.05);
    }
</style>

<script>
    let allExercises = [];
    let exercises = [];
    let currentExerciseId = null;
    let currentSubstitutes = [];
    let currentBodyPart = null;
    let bodyPartMap = {}; // Will hold key -> label
    let messageModalInstance = null;

    const EQUIPMENT_META = {
        barbell: { label: "Barra", icon: "fas fa-grip-lines" },
        dumbbell: { label: "Mancuerna", icon: "fas fa-dumbbell" },
        machine: { label: "MÃ¡quina", icon: "fas fa-cogs" },
        cable: { label: "Polea", icon: "fas fa-wave-square" },
        band: { label: "Banda", icon: "fas fa-link" },
        bench: { label: "Banco", icon: "fas fa-chair" },
        bodyweight: { label: "Corporal", icon: "fas fa-running" },
        other: { label: "Otro", icon: "fas fa-toolbox" }
    };

    function normalizeEquipmentList(value) {
        if (!value) return [];
        if (Array.isArray(value)) {
            return value.map(v => String(v).trim()).filter(Boolean);
        }
        if (typeof value === "string") {
            return value.split(",").map(v => v.trim()).filter(Boolean);
        }
        return [String(value).trim()].filter(Boolean);
    }

    function getEquipmentLabels(value) {
        const list = normalizeEquipmentList(value);
        return list.map(item => {
            const key = String(item).toLowerCase();
            return (EQUIPMENT_META[key] || { label: item }).label;
        });
    }

    function renderEquipmentBadges(value) {
        const list = normalizeEquipmentList(value);
        if (!list.length) {
            return '<span class="badge bg-dark border border-secondary text-info">N/A</span>';
        }
        return list.map(item => {
            const key = String(item).toLowerCase();
            const meta = EQUIPMENT_META[key] || { label: item, icon: "fas fa-dumbbell" };
            return `<span class="badge bg-dark border border-secondary text-info me-1"><i class="${meta.icon} me-1"></i>${meta.label}</span>`;
        }).join("");
    }

    function setMultiSelectValues(selectEl, values) {
        if (!selectEl) return;
        const list = Array.isArray(values) ? values : normalizeEquipmentList(values);
        const normalized = new Set(list.map(v => String(v).toLowerCase()));
        Array.from(selectEl.options).forEach(opt => {
            opt.selected = normalized.has(String(opt.value).toLowerCase());
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
        currentBodyPart = null;

        loadBodyParts().then(() => {
            loadExercises();
        });

        // Listeners
        const mainSearch = document.getElementById("mainSearch");
        const filterBodyPart = document.getElementById("filterBodyPart");
        const filterEquipment = document.getElementById("filterEquipment");
        const filterType = document.getElementById("filterType");
        const subSearch = document.getElementById("subSearch");
        const exBodyPart = document.getElementById("exBodyPart");

        if (mainSearch) mainSearch.addEventListener("input", filterExercises);
        if (filterBodyPart) filterBodyPart.addEventListener("change", filterExercises);
        if (filterEquipment) filterEquipment.addEventListener("change", filterExercises);
        if (filterType) filterType.addEventListener("change", filterExercises);

        if (subSearch) {
            subSearch.addEventListener("input", () => {
                const bodyPart = document.getElementById("exBodyPart").value;
                populateSubstitutes(allExercises, currentExerciseId, getSelectedSubstitutes(), bodyPart);
            });
        }

        if (exBodyPart) {
            exBodyPart.addEventListener("change", () => {
                // Logic to confirm clearing substitutes on body part change
                const nextBodyPart = exBodyPart.value;
                // (Simple version for now, assuming user accepts)
                currentBodyPart = nextBodyPart;
                populateSubstitutes(allExercises, currentExerciseId, [], nextBodyPart);
            });
        }
    });

    async function loadBodyParts() {
        try {
            const res = await fetch("/workout/api/body-parts");
            const parts = await res.json();
            const filterSel = document.getElementById("filterBodyPart");
            const formSel = document.getElementById("exBodyPart");

            if (filterSel) filterSel.innerHTML = '<option value="">Grupo</option>';
            if (formSel) formSel.innerHTML = '';

            console.log("Body Parts Loaded:", parts); // Debug log

            parts.forEach(p => {
                bodyPartMap[p.key] = p.label_es || p.label_en || p.key;

                if (filterSel) {
                    const opt1 = document.createElement("option");
                    opt1.value = p.key;
                    opt1.textContent = bodyPartMap[p.key];
                    filterSel.appendChild(opt1);
                }

                if (formSel) {
                    const opt2 = document.createElement("option");
                    opt2.value = p.key;
                    opt2.textContent = bodyPartMap[p.key];
                    formSel.appendChild(opt2);
                }
            });
        } catch (e) {
            console.error("Error loading body parts", e);
        }
    }

    async function loadExercises() {
        showLoader("Cargando catálogo...");
        try {
            const res = await fetch("/api/exercises");
            allExercises = await res.json();
            filterExercises();
            // populateSubstitutes called when opening modal now
        } catch (e) { console.error(e); }
        finally { hideLoader(); }
    }

    function renderExercises(exercises) {
        const tbody = document.getElementById("exercisesList");
        const mobileContainer = document.getElementById("mobileExercisesList");

        tbody.innerHTML = "";
        mobileContainer.innerHTML = "";

        if (exercises.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-3">No se encontraron ejercicios</td></tr>';
            mobileContainer.innerHTML = '<div class="text-center text-muted py-5">No se encontraron ejercicios con los filtros seleccionados.</div>';
            return;
        }

        exercises.forEach(ex => {
            const hasVideo = ex.video_url && ex.video_url.trim() !== "";

            // Desktop Table Row
            const tr = document.createElement("tr");
            tr.innerHTML = `
            <td>
                <div class="fw-bold">${ex.name}</div>
                <small class="text-secondary text-truncate d-block" style="max-width: 200px;">${ex.description || ''}</small>
            </td>
            <td><span class="badge bg-secondary">${translateBodyPart(ex.body_part)}</span></td>
            <td>${renderEquipmentBadges(ex.equipment)}</td>
            <td>${ex.type}</td>
            <td>
                ${hasVideo ? `<button class="btn btn-sm btn-outline-danger" onclick="openVideoModal('${ex.video_url}')" title="Ver video"><i class="fab fa-youtube"></i></button>` : '<span class="text-muted">-</span>'}
            </td>
            <td>${ex.is_custom ? '<span class="text-info">Custom</span>' : '<span class="text-secondary">Global</span>'}</td>
            <td>
                <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-outline-warning" onclick="duplicateExercise('${ex._id}')" title="Duplicar ejercicio">
                        <i class="fas fa-copy"></i>
                    </button>
                    <button class="btn btn-outline-info" onclick="openExerciseModal('${ex._id}')" title="Editar">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="deleteExercise('${ex._id}')" title="Eliminar">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;
            tbody.appendChild(tr);

            // Mobile Card
            const card = document.createElement("div");
            card.className = "card bg-panel border-secondary shadow-sm";
            const videoBtn = hasVideo ? `<button class="btn btn-sm btn-outline-danger ms-2" onclick="openVideoModal('${ex.video_url}')"><i class="fab fa-youtube"></i></button>` : '';

            card.innerHTML = `
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="flex-grow-1">
                            <h5 class="card-title text-white fw-bold mb-1 d-flex align-items-center">
                                ${ex.name}
                                ${videoBtn}
                            </h5>
                            <div class="d-flex flex-wrap gap-1 mb-1">
                                <span class="badge bg-secondary" style="font-size: 0.7rem;">${translateBodyPart(ex.body_part)}</span>
                                <span class="badge bg-dark border border-secondary text-info" style="font-size: 0.7rem;">${getEquipmentLabels(ex.equipment).join(', ') || 'N/A'}</span>
                            </div>
                        </div>
                        <span class="badge ${ex.is_custom ? 'bg-info text-dark' : 'bg-secondary'} ms-2" style="font-size: 0.65rem;">
                            ${ex.is_custom ? 'CUSTOM' : 'GLOBAL'}
                        </span>
                    </div>
                    <p class="card-text text-secondary small text-truncate mb-3">${ex.description || 'Sin descripción'}</p>
                    
                    <div class="d-flex justify-content-between align-items-center border-top border-secondary pt-2 mt-2">
                        <small class="text-muted text-uppercase fw-bold" style="font-size:0.7rem;">
                            <i class="fas fa-dumbbell me-1"></i> ${ex.type}
                        </small>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-warning" onclick="duplicateExercise('${ex._id}')"><i class="fas fa-copy"></i></button>
                            <button class="btn btn-outline-info" onclick="openExerciseModal('${ex._id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-outline-danger" onclick="deleteExercise('${ex._id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </div>
            `;
            mobileContainer.appendChild(card);
        });
    }

    function translateBodyPart(bp) {
        return bodyPartMap[bp] || bp;
    }

    function getSelectedSubstitutes() {
        const checkboxes = document.querySelectorAll("#substitutesContainer input[type='checkbox']:checked");
        return Array.from(checkboxes).map(cb => cb.value);
    }

    function toEmbedUrl(url) {
        const trimmed = (url || "").trim();
        if (!trimmed) return "";
        if (trimmed.includes("youtube.com/watch")) {
            const match = trimmed.match(/[?&]v=([^&]+)/);
            if (match && match[1]) return `https://www.youtube.com/embed/${match[1]}`;
        }
        if (trimmed.includes("youtu.be/")) {
            const match = trimmed.match(/youtu\.be\/([^?&]+)/);
            if (match && match[1]) return `https://www.youtube.com/embed/${match[1]}`;
        }
        return trimmed;
    }

    function openVideoModal(url) {
        const modalEl = document.getElementById("videoModal");
        const iframe = document.getElementById("videoFrame");
        const embedUrl = toEmbedUrl(url);
        iframe.src = embedUrl;
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
        modalEl.addEventListener("hidden.bs.modal", () => {
            iframe.src = "";
        }, { once: true });
    }

    function getSubSearchTerm() {
        const subSearch = document.getElementById("subSearch");
        return subSearch ? subSearch.value.trim().toLowerCase() : "";
    }

    function ensureMessageModalInstance() {
        if (!messageModalInstance) {
            const modalEl = document.getElementById("messageModal");
            messageModalInstance = new bootstrap.Modal(modalEl);
        }
        return messageModalInstance;
    }

    const getLocalMessageModal = () => {
        const modalEl = document.getElementById("messageModal");
        if (!modalEl) return null;
        return bootstrap.Modal.getOrCreateInstance(modalEl);
    };

    const localShowConfirmModal = (title, message, tone = "warning") => {
        if (window.showConfirmModal) {
            return window.showConfirmModal(title, message, tone);
        }
        const modalEl = document.getElementById("messageModal");
        if (!modalEl) return Promise.resolve(confirm(message || title || "Confirmar"));
        const modalTitle = modalEl.querySelector(".modal-title");
        const modalBody = modalEl.querySelector(".modal-body");
        const confirmBtn = modalEl.querySelector("#messageConfirm");
        const cancelBtn = modalEl.querySelector("#messageCancel");
        const okBtn = modalEl.querySelector("#messageOk");

        modalTitle.textContent = title || "Confirmar";
        modalBody.textContent = message || "";
        confirmBtn.classList.remove("d-none");
        cancelBtn.classList.remove("d-none");
        okBtn.classList.add("d-none");

        confirmBtn.className = tone === "danger" ? "btn btn-outline-danger" : "btn btn-outline-success";
        cancelBtn.className = "btn btn-outline-secondary";

        return new Promise(resolve => {
            const onConfirm = () => {
                getLocalMessageModal()?.hide();
                resolve(true);
            };
            const onCancel = () => {
                resolve(false);
            };
            confirmBtn.onclick = onConfirm;
            cancelBtn.onclick = onCancel;
            modalEl.addEventListener("hidden.bs.modal", () => resolve(false), { once: true });
            getLocalMessageModal()?.show();
        });
    };

    const localShowAlertModal = (title, message, tone = "warning") => {
        if (window.showAlertModal) {
            return window.showAlertModal(title, message, tone);
        }
        const modalEl = document.getElementById("messageModal");
        if (!modalEl) {
            alert(message || title || "Aviso");
            return Promise.resolve(true);
        }
        const modalTitle = modalEl.querySelector(".modal-title");
        const modalBody = modalEl.querySelector(".modal-body");
        const confirmBtn = modalEl.querySelector("#messageConfirm");
        const cancelBtn = modalEl.querySelector("#messageCancel");
        const okBtn = modalEl.querySelector("#messageOk");

        modalTitle.textContent = title || "Aviso";
        modalBody.textContent = message || "";
        confirmBtn.classList.add("d-none");
        cancelBtn.classList.add("d-none");
        okBtn.classList.remove("d-none");
        okBtn.className = tone === "danger" ? "btn btn-outline-danger" : "btn btn-outline-light";

        return new Promise(resolve => {
            okBtn.onclick = () => {
                getLocalMessageModal()?.hide();
                resolve(true);
            };
            modalEl.addEventListener("hidden.bs.modal", () => resolve(true), { once: true });
            getLocalMessageModal()?.show();
        });
    };

    function filterExercises() {
        const mainSearch = document.getElementById("mainSearch");
        const filterBodyPart = document.getElementById("filterBodyPart");
        const filterEquipment = document.getElementById("filterEquipment");
        const filterType = document.getElementById("filterType");

        const term = (mainSearch ? mainSearch.value : "").trim().toLowerCase();
        const bodyPart = filterBodyPart ? filterBodyPart.value : "";
        const equipment = filterEquipment ? filterEquipment.value : "";
        const type = filterType ? filterType.value : "";

        const filtered = allExercises.filter(ex => {
            const altNames = Array.isArray(ex.alternative_names) ? ex.alternative_names.join(" ") : "";
            const nameMatch = !term || (ex.name || "").toLowerCase().includes(term) || altNames.toLowerCase().includes(term);
            const bodyPartMatch = !bodyPart || ex.body_part === bodyPart;
            const equipmentList = normalizeEquipmentList(ex.equipment).map(e => String(e).toLowerCase());
            const equipmentMatch = !equipment || equipmentList.includes(String(equipment).toLowerCase());
            const typeMatch = !type || ex.type === type;
            return nameMatch && bodyPartMatch && equipmentMatch && typeMatch;
        });

        renderExercises(filtered);
    }

    async function resetFilters() {
        const mainSearch = document.getElementById("mainSearch");
        const filterBodyPart = document.getElementById("filterBodyPart");
        const filterEquipment = document.getElementById("filterEquipment");
        const filterType = document.getElementById("filterType");

        if (mainSearch) mainSearch.value = "";
        if (filterBodyPart) filterBodyPart.value = "";
        if (filterEquipment) filterEquipment.value = "";
        if (filterType) filterType.value = "";

        // Reload from database to ensure up-to-date data
        await loadExercises();
    }

    function populateSubstitutes(exercises, currentId, selectedIds = [], bodyPart = null) {
        const container = document.getElementById("substitutesContainer");
        container.innerHTML = "";

        const filtered = bodyPart ? exercises.filter(ex => ex.body_part === bodyPart) : exercises;
        const searchTerm = getSubSearchTerm();
        const searchFiltered = searchTerm
            ? filtered.filter(ex => {
                const name = (ex.name || "").toLowerCase();
                const equipment = getEquipmentLabels(ex.equipment).join(' ').toLowerCase();
                const type = (ex.type || "").toLowerCase();
                return name.includes(searchTerm) || equipment.includes(searchTerm) || type.includes(searchTerm);
            })
            : filtered;
        const allowedIds = new Set(filtered.map(ex => ex._id));
        const filteredSelected = selectedIds.filter(id => allowedIds.has(id));

        searchFiltered.forEach(ex => {
            // Self-exclusion
            if (ex._id === currentId) return;

            const isChecked = filteredSelected.includes(ex._id) ? "checked" : "";
            const hasVideo = ex.video_url ? '<i class="fab fa-youtube text-danger ms-1"></i>' : '';

            const item = document.createElement("div");
            item.className = "form-check sub-item border-bottom border-secondary py-2";
            item.innerHTML = `
                <input class="form-check-input border-secondary" type="checkbox" value="${ex._id}" id="sub_${ex._id}" ${isChecked}>
                <label class="form-check-label w-100 cursor-pointer" for="sub_${ex._id}">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="fw-bold">${ex.name} ${hasVideo}</span>
                        <span class="badge bg-secondary ms-2">${translateBodyPart(ex.body_part)}</span>
                    </div>
                    <div class="d-flex justify-content-between small text-secondary">
                        <span>${getEquipmentLabels(ex.equipment).join(', ') || 'N/A'}</span>
                        <span>${ex.type}</span>
                    </div>
                </label>
            `;
            container.appendChild(item);
        });

        if (container.children.length === 0) {
            container.innerHTML = searchTerm
                ? '<p class="text-muted text-center my-2">No hay resultados para este filtro.</p>'
                : '<p class="text-muted text-center my-2">No hay otros ejercicios del mismo grupo muscular.</p>';
        }
    }


    function openExerciseModal(id = null) {
        const form = document.getElementById("exerciseForm");
        form.reset();
        document.getElementById("exId").value = "";

        // Reset/init local Vars
        currentSubstitutes = [];
        currentExerciseId = id;
        currentBodyPart = null;

        const modalTitle = document.querySelector("#exerciseModal .modal-title");
        let isGlobalEdit = false;

        if (id) {
            const ex = allExercises.find(e => e._id === id);
            if (ex) {
                // Allow editing ANY exercise (Global or Custom)
                modalTitle.textContent = "Editar Ejercicio";
                document.getElementById("exId").value = ex._id;
                document.getElementById("exName").value = ex.name;

                // Removed "Force Copy for Global" logic
                /* 
                if (!ex.is_custom) { ... } 
                */

                document.getElementById("exBodyPart").value = ex.body_part;
                document.getElementById("exType").value = ex.type || "weight";
                setMultiSelectValues(document.getElementById("exEquipment"), ex.equipment || []);
                document.getElementById("exPattern").value = ex.pattern || "";
                document.getElementById("exPlane").value = ex.plane || "";
                document.getElementById("exLevel").value = ex.level || "";
                document.getElementById("exPrimaryMuscle").value = ex.primary_muscle || "";
                document.getElementById("exUnilateral").checked = !!ex.unilateral;
                document.getElementById("exAlternativeNames").value = (ex.alternative_names || []).join(", ");
                document.getElementById("exDescription").value = ex.description || '';
                document.getElementById("exVideo").value = ex.video_url || '';

                currentSubstitutes = ex.substitutes || [];
            }
        } else {
            modalTitle.textContent = "Nuevo Ejercicio";
            setMultiSelectValues(document.getElementById("exEquipment"), []);
            document.getElementById("exUnilateral").checked = false;
            document.getElementById("exAlternativeNames").value = "";
        }

        const bodyPart = document.getElementById("exBodyPart").value;
        currentBodyPart = bodyPart;
        // Populate rich list excluding self (use original ID for exclusion even if creating copy)
        populateSubstitutes(allExercises, isGlobalEdit ? id : (id || null), currentSubstitutes, bodyPart);

        new bootstrap.Modal(document.getElementById("exerciseModal")).show();
    }

    async function saveExercise() {
        const id = document.getElementById("exId").value;
        const name = document.getElementById("exName").value;
        const bodyPart = document.getElementById("exBodyPart").value;
        const type = document.getElementById("exType").value;
        const pattern = document.getElementById("exPattern").value;
        const plane = document.getElementById("exPlane").value;
        const level = document.getElementById("exLevel").value;
        const primaryMuscle = document.getElementById("exPrimaryMuscle").value;
        const unilateral = document.getElementById("exUnilateral").checked;

        const equipmentSelect = document.getElementById("exEquipment");
        const equipment = Array.from(equipmentSelect.selectedOptions || []).map(opt => opt.value);
        const description = document.getElementById("exDescription").value;
        const videoUrl = document.getElementById("exVideo").value;
        const alternativeNamesRaw = document.getElementById("exAlternativeNames").value || "";
        const alternativeNames = alternativeNamesRaw.split(",").map(v => v.trim()).filter(Boolean);

        // Get Substitutes from Checkboxes
        const substitutes = getSelectedSubstitutes();

        if (!name) {
            localShowAlertModal("Campo requerido", "El nombre es obligatorio");
            return;
        }

        const payload = {
            id,
            name,
            body_part: bodyPart,
            type,
            equipment,
            description,
            video_url: videoUrl,
            substitutes,
            alternative_names: alternativeNames,
            pattern,
            plane,
            unilateral,
            primary_muscle: primaryMuscle,
            level
        };

        showLoader("Guardando ejercicio...");
        try {
            await fetch("/api/exercises/save", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            bootstrap.Modal.getInstance(document.getElementById("exerciseModal")).hide();
            loadExercises();
        } catch (e) {
            hideLoader();
            localShowAlertModal("Error al guardar", "Ocurrio un error al guardar el ejercicio.");
        }
    }

    async function duplicateExercise(id) {
        const ex = allExercises.find(e => e._id === id);
        if (!ex) {
            localShowAlertModal("Error", "No se encontró el ejercicio a duplicar.");
            return;
        }

        const confirmed = await localShowConfirmModal(
            "Duplicar Ejercicio",
            `¿Deseas crear una copia personalizada de "${ex.name}"?`
        );

        if (!confirmed) return;

        showLoader("Duplicando ejercicio...");
        try {
            const payload = {
                id: null, // No ID means create new
                name: ex.name + " (Copia)",
                body_part: ex.body_part,
                type: ex.type,
                equipment: normalizeEquipmentList(ex.equipment),
                description: ex.description || '',
                video_url: ex.video_url || '',
                substitutes: ex.substitutes || [],
                alternative_names: ex.alternative_names || [],
                pattern: ex.pattern || "",
                plane: ex.plane || "",
                unilateral: !!ex.unilateral,
                primary_muscle: ex.primary_muscle || "",
                level: ex.level || ""
            };

            await fetch("/api/exercises/save", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            await localShowAlertModal("Éxito", "Ejercicio duplicado correctamente. Ahora puedes editarlo.");
            loadExercises();
        } catch (e) {
            hideLoader();
            localShowAlertModal("Error", "Ocurrió un error al duplicar el ejercicio.");
        }
    }

    async function deleteExercise(id) {
        const confirmed = await localShowConfirmModal(
            "Eliminar ejercicio",
            "¿Estás seguro de que deseas eliminar este ejercicio?",
            "danger"
        );
        if (!confirmed) return;

        showLoader("Eliminando ejercicio...");
        try {
            const res = await fetch(`/api/exercises/delete/${id}`, { method: "DELETE" });
            if (res.ok) {
                loadExercises();
            } else {
                hideLoader();
                const err = await res.json();
                localShowAlertModal("Error", err.error || "No se pudo eliminar", "danger");
            }
        } catch (e) {
            hideLoader();
            localShowAlertModal("Error", `Error de conexión: ${e}`, "danger");
        }
    }
</script>
<script src="/static/js/loader.js"></script>
{% endblock %}
