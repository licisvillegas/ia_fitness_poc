<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Ejercicios | AI Fitness</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/theme.css" rel="stylesheet">
    <link href="/static/css/sidebar.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
        }

        .hero-sm {
            background: linear-gradient(to right, rgba(0, 0, 0, 0.8), rgba(37, 99, 235, 0.4)), url('/static/images/IMG_1558.JPG');
            background-size: cover;
            background-position: center;
            padding: 3rem 0;
            text-align: center;
            color: white;
            margin-bottom: 2rem;
        }

        .exercise-card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            height: 100%;
            transition: 0.3s;
        }

        .exercise-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(37, 99, 235, 0.2);
        }

        .exercise-img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            background-color: #000;
        }

        .badge-muscle {
            background-color: rgba(37, 99, 235, 0.2);
            color: #60a5fa;
            border: 1px solid rgba(37, 99, 235, 0.4);
        }

        .back-link {
            color: var(--text-muted);
            text-decoration: none;
            margin-bottom: 1rem;
            display: inline-block;
        }

        .back-link:hover {
            color: var(--primary);
        }
    </style>
</head>

<body>
    {% include 'components/sidebar.html' %}
    <div class="main-content">
        <div class="hero-sm">
            <div class="container">
                <h2 id="pageTitle">Ejercicios</h2>
                <p class="lead text-light mb-0" id="pageSubtitle">Explora nuestra biblioteca</p>
            </div>
        </div>

        <div class="container pb-5">
            <a href="/plan" class="back-link"><i class="fas fa-arrow-left"></i> Volver al Plan</a>

            <div id="loader" class="text-center py-5">
                <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando...</span>
                </div>
            </div>

            <!-- Filters -->
            <div class="row mb-4" id="filtersArea" style="display:none;">
                <div class="col-md-8 mx-auto">
                    <div class="d-flex gap-2">
                        <div class="input-group">
                            <span class="input-group-text bg-dark border-secondary text-secondary"><i
                                    class="fas fa-search"></i></span>
                            <input type="text" class="form-control bg-dark text-white border-secondary" id="searchInput"
                                placeholder="Buscar ejercicio...">
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-dark border-secondary dropdown-toggle text-white" type="button"
                                id="muscleFilterBtn" data-bs-toggle="dropdown" aria-expanded="false">
                                Filtrar Músculos
                            </button>
                            <ul class="dropdown-menu dropdown-menu-dark p-3" aria-labelledby="muscleFilterBtn"
                                style="min-width: 250px; max-height: 400px; overflow-y: auto;" id="muscleDropdownList">
                                <li>
                                    <div class="form-check">
                                        <input class="form-check-input muscle-check" type="checkbox" value="all"
                                            id="checkAll" checked>
                                        <label class="form-check-label" for="checkAll">Todos</label>
                                    </div>
                                </li>
                                <li>
                                    <hr class="dropdown-divider">
                                </li>
                                <!-- Populated via JS -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div id="exercisesContainer" style="display:none;" class="accordion" id="exercisesAccordion">
                <!-- Dynamic Accordion Items -->
            </div>

            <div id="emptyMsg" class="text-center py-5 text-muted" style="display:none;">
                <i class="fas fa-dumbbell fa-3x mb-3"></i>
                <p>No se encontraron ejercicios para este grupo muscular.</p>
            </div>
        </div>

        <!-- Modal Video -->
        <div class="modal fade" id="videoModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content bg-dark text-white border-secondary">
                    <div class="modal-header border-secondary">
                        <h5 class="modal-title text-info">Video Demostrativo</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-0">
                        <div class="ratio ratio-16x9">
                            <iframe id="videoFrame" src="" title="Video ejercicio"
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                allowfullscreen></iframe>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/lang.js"></script>
    <script>
        let currentMuscles = "all";
        let currentQ = "";

        document.addEventListener("DOMContentLoaded", async () => {
            const params = new URLSearchParams(window.location.search);
            currentMuscles = params.get("muscles") || "all";
            currentQ = params.get("q") || "";

            const titleEl = document.getElementById("pageTitle");
            const searchInput = document.getElementById("searchInput");
            const muscleList = document.getElementById("muscleDropdownList");

            // Init Inputs
            searchInput.value = currentQ;

            // Load Body Parts
            try {
                const bpRes = await fetch("/workout/api/body-parts");
                const parts = await bpRes.json();

                parts.forEach(p => {
                    const li = document.createElement("li");
                    li.innerHTML = `
                        <div class="form-check">
                            <input class="form-check-input muscle-check" type="checkbox" value="${p.key}" id="check_${p.key}">
                            <label class="form-check-label" for="check_${p.key}">${p.label_es || p.label}</label>
                        </div>
                     `;
                    muscleList.appendChild(li);
                });

                // Set initial values
                syncCheckboxesFromUrl(parts);

            } catch (e) { console.error("Error loading parts", e); }

            filtersArea.style.display = "flex";

            // Listeners
            let debounceTimer;
            searchInput.addEventListener("input", () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    currentQ = searchInput.value.trim();
                    fetchExercises();
                }, 300);
            });

            // Delegate change event for checkboxes
            muscleList.addEventListener("change", (e) => {
                if (e.target.classList.contains("muscle-check")) {
                    handleCheckboxChange(e.target);
                }
            });

            updateTitle();
            fetchExercises();
        });

        function syncCheckboxesFromUrl(allParts) {
            const allCheck = document.getElementById("checkAll");
            const checkboxes = document.querySelectorAll(".muscle-check:not(#checkAll)");

            if (currentMuscles === "all") {
                allCheck.checked = true;
                checkboxes.forEach(cb => cb.checked = false);
            } else {
                allCheck.checked = false;
                const selectedKeys = currentMuscles.toLowerCase().split(",");

                checkboxes.forEach(cb => {
                    // Match key or label ES
                    const key = cb.value;
                    // Find part to check labels if needed, simpler to just check key if we rely on key
                    // But url might have "Pecho" -> we need to resolve it.
                    // Let's iterate selectedKeys and set checked if matches key OR label
                    // We need the part obj for that. 
                    // To simplify: let's assume `allParts` is available or passed. 
                    const part = allParts.find(p => p.key === key);
                    const matches = selectedKeys.includes(key.toLowerCase()) ||
                        (part && part.label_es && selectedKeys.includes(part.label_es.toLowerCase()));

                    cb.checked = matches;
                });
            }
        }

        function handleCheckboxChange(target) {
            const allCheck = document.getElementById("checkAll");
            const checkboxes = document.querySelectorAll(".muscle-check:not(#checkAll)");

            if (target.id === "checkAll") {
                if (target.checked) {
                    checkboxes.forEach(cb => cb.checked = false);
                    currentMuscles = "all";
                } else {
                    // Can't uncheck all to have nothing. If uncheck All, maybe nothing select? 
                    // Let's enforce: At least one must be checked. If checks 'all', uncheck others.
                    // actually if user unchecks All, effectively 0 selected -> meaning?? 
                    // Let's keep it simple: If 'All' is clicked, it becomes sole selection.
                    target.checked = true;
                    return;
                }
            } else {
                // Determine new state
                // If a specific muscle is checked, uncheck "All"
                if (target.checked) {
                    allCheck.checked = false;
                }

                // Collect all checked
                const checked = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);

                if (checked.length === 0) {
                    // If none checked, revert to All
                    allCheck.checked = true;
                    currentMuscles = "all";
                } else {
                    currentMuscles = checked.join(",");
                }
            }

            updateTitle();
            fetchExercises();
        }


        function updateTitle() {
            const titleEl = document.getElementById("pageTitle");
            if (currentMuscles !== "all" && currentMuscles.trim() !== "") {
                // If it's a list, readable. If key like 'Chest', maybe translate?
                // Minimal: just show it. 
                titleEl.textContent = `Ejercicios: ${currentMuscles}`;
            } else {
                titleEl.textContent = "Todos los Ejercicios";
            }
        }

        async function fetchExercises() {
            const container = document.getElementById("exercisesContainer");
            const loader = document.getElementById("loader");
            const emptyMsg = document.getElementById("emptyMsg");

            container.style.display = "none";
            loader.style.display = "block";
            emptyMsg.style.display = "none";

            try {
                const resp = await fetch(`/workout/api/exercises/filter?muscles=${encodeURIComponent(currentMuscles)}&q=${encodeURIComponent(currentQ)}`);
                const exercises = await resp.json();

                loader.style.display = "none";

                if (!exercises || exercises.length === 0) {
                    emptyMsg.style.display = "block";
                    return;
                }

                // Equipment Map (copied from catalog)
                const equipmentMap = {
                    'barbell': '<i class="fas fa-grip-lines me-1"></i> Barra',
                    'dumbbell': '<i class="fas fa-dumbbell me-1"></i> Mancuerna',
                    'machine': '<i class="fas fa-cogs me-1"></i> Máquina',
                    'cable': '<i class="fas fa-wave-square me-1"></i> Polea',
                    'bodyweight': '<i class="fas fa-running me-1"></i> Corporal',
                    'other': 'Otro'
                };

                // Group by body_part
                const groups = exercises.reduce((acc, ex) => {
                    const key = ex.body_part || "Otros";
                    if (!acc[key]) acc[key] = [];
                    acc[key].push(ex);
                    return acc;
                }, {});

                container.style.display = "block"; // Accordion container is block
                container.innerHTML = Object.keys(groups).sort().map((part, index) => {
                    const groupExercises = groups[part];
                    const collapseId = `collapse_${index}`;
                    const headerId = `heading_${index}`;

                    // Render Grid for this group
                    const gridHtml = groupExercises.map(ex => {
                        const hasVideo = ex.video_url && ex.video_url.trim() !== "";
                        const videoBtn = hasVideo ?
                            `<button class="btn btn-sm btn-danger rounded-circle position-absolute top-0 end-0 m-2 shadow" 
                                    onclick="openVideoModal('${ex.video_url}')" title="Ver Video">
                                <i class="fas fa-play"></i>
                             </button>` : '';

                        // Formatted tags similar to mobile admin view
                        const equipLabel = equipmentMap[ex.equipment] || ex.equipment || 'N/A';

                        return `
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="exercise-card position-relative h-100">
                                ${videoBtn}
                                <img src="${ex.image_url || '/static/images/placeholder_exercise.jpg'}" class="exercise-img" alt="${ex.name}">
                                <div class="card-body p-3">
                                    <h5 class="card-title text-light mb-1">${ex.name}</h5>
                                    
                                    <div class="d-flex flex-wrap gap-1 mb-2">
                                        <span class="badge bg-secondary" style="font-size: 0.7rem;">${ex.body_part}</span>
                                        <span class="badge bg-dark border border-secondary text-info" style="font-size: 0.7rem;">${equipLabel}</span>
                                    </div>

                                    <p class="card-text text-muted small text-truncate">${ex.description || 'Sin descripción'}</p>
                                </div>
                            </div>
                        </div>`;
                    }).join("");

                    // Accordion Item
                    return `
                    <div class="accordion-item bg-transparent border-0 mb-3">
                        <h2 class="accordion-header" id="${headerId}">
                            <button class="accordion-button collapsed bg-dark text-white border border-secondary rounded" type="button" 
                                data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="false" aria-controls="${collapseId}">
                                <span class="fw-bold text-primary me-2">${part}</span> 
                                <span class="badge bg-secondary rounded-pill">${groupExercises.length}</span>
                            </button>
                        </h2>
                        <div id="${collapseId}" class="accordion-collapse collapse show" aria-labelledby="${headerId}">
                            <div class="accordion-body bg-transparent p-0 pt-3">
                                <div class="row">
                                    ${gridHtml}
                                </div>
                            </div>
                        </div>
                    </div>`;
                }).join("");

            } catch (e) {
                console.error(e);
                loader.style.display = "none";
                emptyMsg.innerHTML = "<p class='text-danger'>Error al cargar ejercicios</p>";
                emptyMsg.style.display = "block";
            }
        }

        function toEmbedUrl(url) {
            const trimmed = (url || "").trim();
            if (!trimmed) return "";
            if (trimmed.includes("youtube.com/watch")) {
                const match = trimmed.match(/[?&]v=([^&]+)/);
                if (match && match[1]) return `https://www.youtube.com/embed/${match[1]}`;
            }
            if (trimmed.includes("youtu.be/")) {
                const match = trimmed.match(/youtu\.be\/([^?&]+)/);
                if (match && match[1]) return `https://www.youtube.com/embed/${match[1]}`;
            }
            return trimmed;
        }

        function openVideoModal(url) {
            const modalEl = document.getElementById("videoModal");
            const iframe = document.getElementById("videoFrame");
            const embedUrl = toEmbedUrl(url);
            iframe.src = embedUrl;
            const modal = new bootstrap.Modal(modalEl);
            modal.show();
            modalEl.addEventListener("hidden.bs.modal", () => {
                iframe.src = "";
            }, { once: true });
        }
    </script>
</body>

</html>