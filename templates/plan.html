<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Synapse Fit | Plan de Alimentación y Entrenamiento</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
  <link href="/static/css/theme.css" rel="stylesheet">
  <link href="/static/css/sidebar.css" rel="stylesheet">
  <link href="/static/css/assigned_routines.css" rel="stylesheet">
  <link href="/static/css/loader.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--bg-body);
      color: var(--text-main);
    }

    /* Navbar */
    .navbar {
      background-color: var(--bg-panel);
      border-bottom: 1px solid var(--border-color);
    }

    .navbar-brand {
      color: var(--primary) !important;
      font-weight: 700;
    }

    .navbar a {
      color: var(--text-main) !important;
    }

    /* Hero */
    .hero {
      background: linear-gradient(to right, rgba(0, 0, 0, 0.8), rgba(37, 99, 235, 0.4)),
        url('/static/images/IMG_1558.JPG');
      background-size: cover;
      background-position: center;
      aspect-ratio: 16 / 5;
      height: auto;
      min-height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: #ffffff !important;
      /* Keep white on image */
    }

    .hero h1 {
      font-size: clamp(1.5rem, 2.5vw, 2.2rem);
      font-weight: 700;
      color: #ffffff !important;
      margin-bottom: 0.5rem;
    }

    .hero p {
      font-size: 0.95rem;
      color: #ffffff !important;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }

    @media (max-width: 767px) {
      .hero {
        aspect-ratio: 16 / 9;
        min-height: 180px;
        padding: 1.5rem 0;
        background-position: center 25%;
      }

      .hero h1 {
        font-size: 1.4rem;
      }

      .hero p {
        font-size: 0.85rem;
        display: none;
        /* Hide subtext on small mobiles for compactness */
      }
    }

    /* Sección Alimentación */
    .nutrition {
      padding: 4rem 0;
      background-color: var(--bg-panel);
    }

    .nutrition h2 {
      color: var(--primary);
      font-weight: 700;
      margin-bottom: 1rem;
    }

    .nutrition img {
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(37, 99, 235, 0.3);
    }

    /* Entrenamientos */
    .workouts {
      padding: 4rem 0;
    }

    .workouts h2 {
      color: var(--primary);
      font-weight: 700;
    }

    .workout-card {
      background-color: var(--bg-card);
      border-radius: 15px;
      padding: 1.5rem;
      transition: 0.3s ease;
      border: 1px solid var(--border-color);
    }

    .workout-card:hover {
      transform: scale(1.03);
      box-shadow: 0 0 20px rgba(37, 99, 235, 0.4);
      background-color: var(--bg-card-hover);
    }

    .workout-card img {
      border-radius: 10px;
      margin-bottom: 1rem;
    }

    /* Ajustes de contraste para textos grises */
    .text-secondary {
      color: var(--text-secondary) !important;
    }

    .text-muted {
      color: var(--text-muted) !important;
    }

    /* Ocultar subsecciones "Histórico de planes" y "Detalle de plan" */
    #my-plan .row.g-4 {
      display: none !important;
    }

    /* Ocultar sección de cargar planes (buscador y botón) */
    #my-plan .mb-3.text-center {
      display: none !important;
    }

    /* Ocultar botones de acciones AI en Plan Activo */
    #active-plan #btnUseLatestAI,
    #active-plan #btnReloadActive {
      display: none !important;
    }

    /* Footer */
    footer {
      background-color: var(--bg-panel);
      color: var(--text-muted);
      text-align: center;
      padding: 1rem 0;
      margin-top: 2rem;
      border-top: 1px solid var(--border-color);
    }
  </style>
</head>

<body>
  <!-- Estructura general: hero, secciones de planes y alimentacion. -->

  <!-- Navbar (unificada con dashboard.html) -->
  <!-- Navbar (unificada con dashboard.html) -->
  {% include 'components/sidebar.html' %}
  <div class="main-content">

    <!-- Seccion hero -->
    <!-- Hero del plan -->
    <section class="hero">
      <div class="container">
        <h1 id="plan-hero-title">Plan de Alimentación y Entrenamiento</h1>
        <p id="plan-hero-p" class="lead text-light mt-3">Descubre cómo equilibrar tu nutrición y potenciar tus
          resultados físicos.</p>
      </div>
    </section> <!-- Seccion de Mis Rutinas (reutilizable) -->
    {% include 'components/assigned_routines.html' %}

    <!-- Sección de Entrenamientos -->
    <!-- Entrenamientos sugeridos -->
    <!-- Grid de entrenamientos sugeridos -->
    <section class="workouts">
      <div class="container">
        <h2 id="workouts-title" class="text-center mb-5" data-i18n="workouts_title">Entrenamientos por Grupo Muscular
        </h2>

        <!-- Primera fila -->
        <div class="row g-4">
          <!-- Pecho y Tríceps -->
          <div class="col-md-4">
            <a href="/exercises/list?muscles=Pecho,Tríceps" class="text-decoration-none">
              <div class="workout-card text-center">
                <img src="/static/images/IMG_1612.JPG" class="img-fluid" alt="Entrenamiento de Pecho y Tríceps">
                <h5 class="fw-bold mt-3" data-i18n="pecho_y_tríceps">Pecho y Tríceps</h5>
                <p data-i18n="fortalece_tu_tren_superior_con_ejercicios_compuestos_como_pr" class="text-muted">Fortalece
                  tu tren superior con
                  ejercicios compuestos como press de banca, fondos y flexiones.
                  Desarrolla masa muscular y potencia en tus empujes.</p>
              </div>
            </a>
          </div>

          <!-- Espalda y Bíceps -->
          <div class="col-md-4">
            <a href="/exercises/list?muscles=Espalda,Bíceps" class="text-decoration-none">
              <div class="workout-card text-center">
                <img src="/static/images/IMG_1614.JPG" class="img-fluid" alt="Entrenamiento de Espalda y Bíceps">
                <h5 class="fw-bold mt-3" data-i18n="espalda_y_bíceps">Espalda y Bíceps</h5>
                <p data-i18n="rutinas_centradas_en_dominadas_remos_y_curls_para_mejorar_la" class="text-muted">Rutinas
                  centradas en
                  dominadas, remos y curls para mejorar la postura, la fuerza y la definición de la espalda.</p>
              </div>
            </a>
          </div>

          <!-- Piernas y Glúteos -->
          <div class="col-md-4">
            <a href="/exercises/list?muscles=Piernas,Glúteos,Cuádriceps,Isquiosurales" class="text-decoration-none">
              <div class="workout-card text-center">
                <img src="/static/images/IMG_1615.JPG" class="img-fluid" alt="Entrenamiento de Piernas y Glúteos">
                <h5 class="fw-bold mt-3" data-i18n="piernas_y_glúteos">Piernas y Glúteos</h5>
                <p data-i18n="ejercicios_de_fuerza_como_sentadillas_peso_muerto_y_zancadas" class="text-muted">
                  Ejercicios de fuerza como
                  sentadillas, peso muerto y zancadas para potenciar la estabilidad y la potencia del tren inferior.</p>
              </div>
            </a>
          </div>
        </div>

        <!-- Segunda fila -->
        <div class="row g-4 mt-4">
          <!-- Hombros y Core -->
          <div class="col-md-4">
            <a href="/exercises/list?muscles=Hombros,Core,Abdominales" class="text-decoration-none">
              <div class="workout-card text-center">
                <img src="/static/images/IMG_1616.JPG" class="img-fluid" alt="Entrenamiento de Hombros y Core">
                <h5 class="fw-bold mt-3" data-i18n="hombros_y_core">Hombros y Core</h5>
                <p data-i18n="desarrolla_equilibrio_y_fuerza_funcional_con_ejercicios_para" class="text-muted">
                  Desarrolla equilibrio y fuerza
                  funcional con ejercicios para el abdomen, la espalda baja y los hombros.</p>
              </div>
            </a>
          </div>

          <!-- Cardio -->
          <div class="col-md-4">
            <a href="/exercises/list?muscles=Cardio" class="text-decoration-none">
              <div class="workout-card text-center">
                <img src="/static/images/TAFT2576.JPEG" class="img-fluid" alt="Entrenamiento de Cardio">
                <h5 class="fw-bold mt-3" data-i18n="cardio">Cardio</h5>
                <p data-i18n="ejercicios_cardio_caminadora_eliptica_natacion" class="text-muted">Ejercicios de cardio
                  como caminadora,
                  elíptica y natación para mejorar la resistencia y la salud cardiovascular.</p>
              </div>
            </a>
          </div>

          <!-- Cuerpo completo -->
          <div class="col-md-4">
            <a href="/exercises/list?muscles=all" class="text-decoration-none">
              <div class="workout-card text-center">
                <img src="/static/images/IMG_1617.JPG" class="img-fluid" alt="Entrenamiento Full Body">
                <h5 class="fw-bold mt-3" data-i18n="entrenamiento_full_body">Entrenamiento Full Body</h5>
                <p data-i18n="sesiones_completas_que_activan_todos_los_grupos_musculares_p" class="text-muted">Sesiones
                  completas que activan
                  todos los grupos musculares.
                  Perfecto para mantenerte en forma cuando dispones de poco tiempo.</p>
              </div>
            </a>
          </div>
        </div>
      </div>
    </section>

    <!-- Plan Activo -->
    <section class="container mt-5" id="active-plan">
      <div class="card" style="background:var(--bg-card);border-radius:12px;border:1px solid var(--border-color);">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <h4 class="card-title mb-0">Plan activo</h4>
            <div class="d-flex gap-2">
              <button id="btnUseLatestAI" class="btn btn-outline-info btn-sm">Usar ajuste AI más reciente</button>
              <button id="btnReloadActive" class="btn btn-outline-light btn-sm">Refrescar</button>
            </div>
          </div>
          <small id="active-meta" class="text-secondary"></small>
          <hr />
          <div>
            <div class="mb-2"><span class="text-secondary">Objetivo:</span> <strong id="active-goal"
                class="text-theme">-</strong></div>
            <h6 class="text-primary">Nutrición</h6>
            <div id="active-kcal" class="text-theme"></div>
            <div id="active-macros" class="text-theme"></div>
            <div id="active-meals-list" class="mt-3"></div>
          </div>
          <div class="mt-3">
            <h6 class="text-primary">Entrenamiento</h6>
            <div id="active-training" class="text-theme"></div>
          </div>
          <div class="mt-3" id="active-ai" style="display:none;">
            <h6 class="text-primary">Resumen AI</h6>
            <div id="active-ai-reason" class="text-theme"></div>
            <small id="active-ai-next" class="text-secondary"></small>
          </div>
        </div>
      </div>
    </section>

    <!-- Mis Planes (listado + detalle) -->
    <section class="container mt-5" id="my-plan">
      <div class="mb-3 text-center">
        <div class="input-group justify-content-center" style="max-width:720px;margin:0 auto;gap:8px;">
          <input type="text" id="planUserId" class="form-control text-center"
            placeholder="Ingresa tu user_id (o deja vacío para usar el de login)">
          <button id="btnLoadPlans" class="btn btn-primary">Cargar planes</button>
        </div>
        <div id="planMsg" class="mt-2 text-info"></div>
      </div>

      <div class="row g-4">
        <div class="col-md-5">
          <div class="card" style="background:var(--bg-card);border-radius:12px;border:1px solid var(--border-color);">
            <div class="card-body">
              <h5 class="card-title">Histórico de planes</h5>
              <ul id="plan-list" class="list-group list-group-flush" style="background:transparent;"></ul>
            </div>
          </div>
        </div>
        <div class="col-md-7">
          <div class="card" style="background:var(--bg-card);border-radius:12px;border:1px solid var(--border-color);">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Detalle de plan</h5>
                <button id="btnActivatePlan" class="btn btn-outline-light btn-sm" disabled>Activar este plan</button>
              </div>
              <small id="plan-meta" class="text-secondary"></small>
              <hr />
              <div>
                <div class="mb-2"><span class="text-secondary">Objetivo:</span> <strong id="plan-goal"
                    class="text-theme">-</strong></div>
                <h6 class="text-primary">Nutrición</h6>
                <div id="plan-kcal" class="text-theme"></div>
                <div id="plan-macros" class="text-theme"></div>
                <div id="plan-meals-list" class="mt-3"></div>
              </div>
              <div class="mt-3">
                <h6 class="text-primary">Entrenamiento</h6>
                <div id="plan-training" class="text-theme"></div>
              </div>
              <div class="mt-3" id="plan-ai" style="display:none;">
                <h6 class="text-primary">Resumen AI</h6>
                <div id="plan-ai-reason" class="text-theme"></div>
                <small id="plan-ai-next" class="text-secondary"></small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Sección de Alimentación -->
    <!-- Seccion de alimentacion -->
    <section class="nutrition">
      <div class="container">
        <div class="row align-items-center">
          <div class="col-md-6">
            <h2 id="nutrition-importance">La importancia de una buena alimentación</h2>
            <p class="text-light" data-i18n="nutrition_intro">
              Una alimentación adecuada no solo mejora tu rendimiento físico, sino que también impulsa tu bienestar
              mental y tu capacidad de recuperación.
              En Synapse Fit creemos que cada cuerpo es único, y por eso nuestros planes están diseñados con
              inteligencia
              artificial para adaptarse a ti.
            </p>
            <ul>
              <li data-i18n="balance_correcto_de_macronutrientes_proteínas_carbohidratos_">Balance correcto de
                macronutrientes (proteínas, carbohidratos y grasas).</li>
              <li data-i18n="planificación_personalizada_según_tus_objetivos_y_nivel_de_a">Planificación personalizada
                según tus objetivos y nivel de actividad.</li>
              <li data-i18n="recomendaciones_de_alimentos_naturales_y_saludables">Recomendaciones de alimentos naturales
                y saludables.</li>
            </ul>
          </div>
          <div class="col-md-6 text-center">
            <img src="https://images.unsplash.com/photo-1504674900247-0877df9cc836?auto=format&fit=crop&w=900&q=80"
              alt="Comida Saludable" class="img-fluid">
          </div>
        </div>
      </div>
    </section>

    <footer>
      <p id="footer-text">© 2025 Synapse Fit | Alimentación y Entrenamiento Inteligente</p>
      <small class="text-secondary d-block">v. beta 1.1.0.5_00</small>
    </footer>

    <!-- script de idioma centralizado -->
    <script src="/static/js/lang.js"></script>
    <script src="/static/js/theme.js"></script>
    <script src="/static/js/assigned_routines.js"></script>
    <script>
      (function () {
        const listEl = document.getElementById('plan-list');
        const msgEl = document.getElementById('planMsg');
        const metaEl = document.getElementById('plan-meta');
        const kcalEl = document.getElementById('plan-kcal');
        const macrosEl = document.getElementById('plan-macros');
        const trainEl = document.getElementById('plan-training');
        const aiBox = document.getElementById('plan-ai');
        const aiReason = document.getElementById('plan-ai-reason');
        const aiNext = document.getElementById('plan-ai-next');
        const activateBtn = document.getElementById('btnActivatePlan');
        let currentPlanId = null;

        // Active plan refs
        const aMeta = document.getElementById('active-meta');
        const aKcal = document.getElementById('active-kcal');
        const aMacros = document.getElementById('active-macros');
        const aTrain = document.getElementById('active-training');
        const aBox = document.getElementById('active-ai');
        const aReason = document.getElementById('active-ai-reason');
        const aNext = document.getElementById('active-ai-next');
        const btnUseLatest = document.getElementById('btnUseLatestAI');
        const btnReloadActive = document.getElementById('btnReloadActive');

        function resolveUserId(inputVal) {
          const typed = (inputVal || '').trim();
          try {
            const raw = localStorage.getItem('ai_fitness_user');
            if (raw) {
              const u = JSON.parse(raw);
              const loggedId = String(u.user_id || u._id || '').trim();
              const uname = (u.username || '').trim();
              const email = (u.email || '').trim().toLowerCase();
              if (!typed || typed === uname || typed.toLowerCase() === email) {
                return loggedId || typed;
              }
            }
          } catch (e) { }
          return typed;
        }

        async function loadPlans() {
          const input = document.getElementById('planUserId');
          const uid = resolveUserId(input.value);
          if (!uid) { msgEl.textContent = 'Ingresa un user_id'; return; }
          showLoader("Cargando planes...");
          listEl.innerHTML = '';
          try {
            const resp = await fetch(`/plans/${encodeURIComponent(uid)}?limit=20`);
            if (!resp.ok) {
              const err = await resp.json().catch(() => ({ error: 'Error desconocido' }));
              throw new Error(err.error || `HTTP ${resp.status}`);
            }
            const rows = await resp.json();
            if (!Array.isArray(rows)) { throw new Error('Formato invalido'); }
            msgEl.textContent = rows.length ? '' : 'No hay planes para este usuario';
            const frag = document.createDocumentFragment();
            rows.forEach((p, idx) => {
              const li = document.createElement('li');
              li.className = 'list-group-item d-flex justify-content-between align-items-start';
              li.style.background = '#111827'; li.style.color = '#ffffff';
              const left = document.createElement('div');
              const ts = (p.created_at || '').toString().replace('T', ' ').replace('Z', '');
              const label = p.source === 'ai_adjustment' ? '[AI]' : '[Manual]';
              left.innerHTML = `<div><strong>#${idx + 1}</strong> · ${label} · ${ts || 'sin-fecha'}</div>`;
              const small = document.createElement('small');
              const np = p.nutrition_plan || {}; const tr = p.training_plan || {};
              small.textContent = `kcal: ${np.calories_per_day ?? np.kcal_obj ?? '-'} · cardio: ${tr.cardio ?? '-'} · active: ${p.active ? 'sí' : 'no'}`;
              left.appendChild(small);
              li.appendChild(left);
              li.addEventListener('click', () => renderPlan(p));
              frag.appendChild(li);
            });
            listEl.appendChild(frag);
            listEl.appendChild(frag);
            if (rows[0] && !currentPlanId) renderPlan(rows[0]);
          } catch (e) {
            msgEl.textContent = `Error al cargar planes: ${e.message}`;
          } finally {
            hideLoader();
          }
        }

        function renderPlan(p) {
          currentPlanId = p._id || null;
          activateBtn.disabled = !currentPlanId;
          const ts = (p.created_at || '').toString().replace('T', ' ').replace('Z', '');
          metaEl.textContent = `id: ${p._id || '-'} · fecha: ${ts || '-'} · activo: ${p.active ? 'sí' : 'no'}`;
          document.getElementById('plan-goal').textContent = p.goal || '-';
          const np = p.nutrition_plan || {}; const tr = p.training_plan || {};
          const macros = np.macros || {}; const macros2 = (np && np.macros) || {};
          const kcal = (np.calories_per_day ?? np.kcal_obj ?? '-');
          const pG = macros.protein ?? macros2.protein ?? macros2.p;
          const cG = macros.carbs ?? macros2.carbs ?? macros2.c;
          const fG = macros.fat ?? macros2.fat ?? macros2.g;
          kcalEl.textContent = `Calorias/día: ${kcal} ${np.kcal_delta != null ? `(delta: ${np.kcal_delta})` : ''}`;
          macrosEl.textContent = `Macros (p/c/g): ${pG ?? '-'} / ${cG ?? '-'} / ${fG ?? '-'}`;
          renderMeals(np.meals || [], 'plan-meals-list');
          trainEl.textContent = `Cardio: ${tr.cardio ?? '-'} · Volumen Δ: ${tr.ai_volumen_delta_ratio ?? '-'}`;
          const ai = p.ai_summary || {};
          if (ai && (ai.razonamiento_resumido || ai.proxima_revision_dias != null)) {
            aiBox.style.display = 'block';
            aiReason.textContent = ai.razonamiento_resumido || '';
            aiNext.textContent = ai.proxima_revision_dias != null ? `Próxima revisión: ${ai.proxima_revision_dias} días` : '';
          } else {
            aiBox.style.display = 'none';
            aiReason.textContent = '';
            aiNext.textContent = '';
          }
        }

        function renderMeals(meals, containerId) {
          const container = document.getElementById(containerId);
          if (!container) return;
          container.innerHTML = '';
          if (!meals || meals.length === 0) {
            container.innerHTML = '<div class="text-muted small">No hay detalle de comidas disponible.</div>';
            return;
          }

          const accordionId = `acc-${containerId}`;
          const wrapper = document.createElement('div');
          wrapper.className = 'accordion';
          wrapper.id = accordionId;

          meals.forEach((m, idx) => {
            const itemId = `${accordionId}-item-${idx}`;
            const isFirst = idx === 0;

            // Safe access to macros
            const p = (m.macros && (m.macros.p || m.macros.protein)) || 0;
            const c = (m.macros && (m.macros.c || m.macros.carbs)) || 0;
            const f = (m.macros && (m.macros.f || m.macros.fat)) || 0;

            const item = document.createElement('div');
            item.className = 'accordion-item bg-panel border-secondary text-theme';

            // Build items list HTML
            let itemsHtml = '<ul class="list-group list-group-flush">';
            if (m.items && Array.isArray(m.items)) {
              m.items.forEach(i => {
                const ip = (i.macros && i.macros.p) || 0;
                const ic = (i.macros && i.macros.c) || 0;
                const if_ = (i.macros && i.macros.f) || 0;
                const macroStr = `P:${ip} C:${ic} G:${if_}`;

                itemsHtml += `
                   <li class="list-group-item bg-transparent text-theme border-secondary d-flex justify-content-between align-items-center">
                     <div>
                       <div class="fw-bold fs-6">${i.food}</div>
                       <div class="small text-muted">${i.qty}</div>
                     </div>
                     <div class="text-end small">
                       <div class="text-warning">${i.kcal} kcal</div>
                       <div class="text-secondary" style="font-size:0.75rem;">${macroStr}</div>
                     </div>
                   </li>
                 `;
              });
            }
            itemsHtml += '</ul>';

            item.innerHTML = `
              <h2 class="accordion-header" id="heading-${itemId}">
                <button class="accordion-button ${isFirst ? '' : 'collapsed'} bg-panel text-theme shadow-none" type="button" data-bs-toggle="collapse" data-bs-target="#${itemId}" aria-expanded="${isFirst}" aria-controls="${itemId}">
                  <div class="d-flex w-100 justify-content-between align-items-center me-3">
                    <span class="fw-bold text-primary">${m.name}</span>
                    <span class="badge bg-secondary rounded-pill">${m.kcal} kcal</span>
                  </div>
                </button>
              </h2>
              <div id="${itemId}" class="accordion-collapse collapse ${isFirst ? 'show' : ''}" aria-labelledby="heading-${itemId}" data-bs-parent="#${accordionId}">
                <div class="accordion-body p-0">
                  <div class="p-2 border-bottom border-secondary bg-panel small">
                    <div class="d-flex justify-content-around text-theme">
                      <span>Prot: ${p}g</span>
                      <span>Carb: ${c}g</span>
                      <span>Grasa: ${f}g</span>
                    </div>
                  </div>
                  ${itemsHtml}
                </div>
              </div>
            `;
            wrapper.appendChild(item);
          });
          container.appendChild(wrapper);
        }

        function formatDateDMY(value) {
          try {
            const d = new Date(value);
            if (isNaN(d)) return '';
            const dd = String(d.getDate()).padStart(2, '0');
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const yyyy = d.getFullYear();
            return `${dd}/${mm}/${yyyy}`;
          } catch (e) { return ''; }
        }

        async function loadActive() {
          const input = document.getElementById('planUserId');
          const uid = resolveUserId(input.value);
          if (!uid) { aMeta.textContent = ''; aKcal.textContent = ''; aMacros.textContent = ''; aTrain.textContent = ''; aBox.style.display = 'none'; return; }
          showLoader("Cargando plan activo...");
          try {
            const resp = await fetch(`/plans/${encodeURIComponent(uid)}/active`);
            if (!resp.ok) {
              aMeta.textContent = 'Sin plan activo';
              aKcal.textContent = ''; aMacros.textContent = ''; aTrain.textContent = ''; aBox.style.display = 'none';
              return;
            }
            const p = await resp.json();
            const ts = (p.activated_at || p.created_at || '').toString().replace('T', ' ').replace('Z', '');
            aMeta.textContent = `id: ${p._id || '-'} · activado: ${ts || '-'}`;
            document.getElementById('active-goal').textContent = p.goal || '-';
            const __formattedActiveDate = formatDateDMY(p.activated_at || p.created_at || '');
            aMeta.textContent = __formattedActiveDate ? `Activado: ${__formattedActiveDate}` : '';
            const np = p.nutrition_plan || {}; const tr = p.training_plan || {};
            const macros = np.macros || {};
            const kcal = (np.calories_per_day ?? np.kcal_obj ?? '-');
            aKcal.textContent = `Calorias/día: ${kcal} ${np.kcal_delta != null ? `(delta: ${np.kcal_delta})` : ''}`;
            aMacros.textContent = `Macros (p/c/g): ${macros.protein ?? '-'} / ${macros.carbs ?? '-'} / ${macros.fat ?? '-'}`;
            renderMeals(np.meals || [], 'active-meals-list');
            aTrain.textContent = `Cardio: ${tr.cardio ?? '-'} · Volumen Δ: ${tr.ai_volumen_delta_ratio ?? '-'}`;
            const ai = p.ai_summary || {};
            if (ai && (ai.razonamiento_resumido || ai.proxima_revision_dias != null)) {
              aBox.style.display = 'block';
              aReason.textContent = ai.razonamiento_resumido || '';
              aNext.textContent = ai.proxima_revision_dias != null ? `Próxima revisión: ${ai.proxima_revision_dias} días` : '';
            } else {
              aBox.style.display = 'none';
              aReason.textContent = '';
              aNext.textContent = '';
            }
          } catch (e) {
            aMeta.textContent = `Error cargando plan activo: ${e.message}`;
            aKcal.textContent = ''; aMacros.textContent = ''; aTrain.textContent = ''; aBox.style.display = 'none';
          } finally {
            hideLoader();
          }
        }

        activateBtn.addEventListener('click', async () => {
          if (!currentPlanId) { return; }
          showLoader("Activando plan...");
          try {
            const resp = await fetch(`/plans/${encodeURIComponent(currentPlanId)}/activate`, { method: 'POST' });
            if (!resp.ok) {
              const err = await resp.json().catch(() => ({ error: 'Error desconocido' }));
              throw new Error(err.error || `HTTP ${resp.status}`);
            }
            msgEl.textContent = 'Plan activado';
            loadPlans();
            loadActive();
          } catch (e) {
            msgEl.textContent = `No se pudo activar el plan: ${e.message}`;
          } finally {
            hideLoader();
          }
        });

        btnUseLatest.addEventListener('click', async () => {
          const input = document.getElementById('planUserId');
          const uid = resolveUserId(input.value);
          if (!uid) { msgEl.textContent = 'Ingresa un user_id'; return; }
          showLoader("Aplicando último ajuste AI...");
          try {
            const resp = await fetch(`/ai/adjustments/${encodeURIComponent(uid)}/apply_latest`, { method: 'POST' });
            if (!resp.ok) {
              const err = await resp.json().catch(() => ({ error: 'Error desconocido' }));
              throw new Error(err.error || `HTTP ${resp.status}`);
            }
            msgEl.textContent = 'Plan creado y activado desde AI';
            loadPlans();
            loadActive();
          } catch (e) {
            msgEl.textContent = `No se pudo aplicar el último ajuste: ${e.message}`;
          } finally {
            hideLoader();
          }
        });

        btnReloadActive.addEventListener('click', loadActive);

        document.getElementById('btnLoadPlans').addEventListener('click', async () => {
          loadPlans();
          const input = document.getElementById('planUserId');
          const uid = resolveUserId(input.value);
          if (uid) {
            await ensureRoutineDependencies();
            loadRoutines(uid, { returnTo: '/plan' });
          }
        });

        // Auto-cargar para el usuario logueado
        window.addEventListener('DOMContentLoaded', async () => {
          try {
            const raw = localStorage.getItem('ai_fitness_user');
            if (raw) {
              const u = JSON.parse(raw);
              const display = (u.username || '').trim();
              if (display) { document.getElementById('planUserId').value = display; }
              const uid = resolveUserId(display);
              loadPlans();
              loadActive();
              if (uid) {
                await ensureRoutineDependencies();
                loadRoutines(uid, { returnTo: '/plan' });
              }
            }
          } catch (e) { }
        });
      })();
    </script>
    {% include 'components/loader.html' %}
    <script src="/static/js/loader.js"></script>

  </div><!-- Fin de main-content -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>