{% extends 'layout.html' %}

{% block title %}AI Fitness - Catálogo Rutinas{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12 d-flex flex-column flex-md-row justify-content-between align-items-center gap-3">
        <h2 class="fw-bold text-cyber-green mb-0 text-center text-md-start">
            <i class="fas fa-clipboard-list me-2"></i>Catálogo de Rutinas
        </h2>

        <div
            class="d-flex flex-wrap gap-2 align-items-center justify-content-center justify-content-md-end w-100 w-md-auto">
            <div class="input-group" style="min-width: 200px; flex-grow: 1; max-width: 100%;">
                <span class="input-group-text bg-dark border-secondary text-secondary"><i
                        class="fas fa-search"></i></span>
                <input type="text" class="form-control bg-dark text-white border-secondary" id="mainSearch"
                    placeholder="Buscar rutina...">
            </div>

            <div class="d-flex gap-2 w-100 w-md-auto overflow-auto pb-1 pb-md-0" style="scrollbar-width: none;">
                <select class="form-select bg-dark text-white border-secondary flex-grow-1 flex-md-grow-0"
                    id="filterBodyPart" style="min-width: 130px;">
                    <option value="">Grupo</option>
                </select>
                <select class="form-select bg-dark text-white border-secondary flex-grow-1 flex-md-grow-0"
                    id="filterDay" style="min-width: 130px;">
                    <option value="">Día</option>
                    <option value="Monday">Lunes</option>
                    <option value="Tuesday">Martes</option>
                    <option value="Wednesday">Miércoles</option>
                    <option value="Thursday">Jueves</option>
                    <option value="Friday">Viernes</option>
                    <option value="Saturday">Sábado</option>
                    <option value="Sunday">Domingo</option>
                </select>
            </div>

            <div class="d-flex gap-2 w-100 w-md-auto justify-content-between justify-content-md-end">
                <button class="btn btn-outline-secondary text-nowrap flex-grow-1 flex-md-grow-0"
                    onclick="resetFilters()">
                    <i class="fas fa-undo me-1"></i> <span class="d-none d-md-inline">Restablecer</span>
                </button>
                <button class="btn btn-cyber-primary text-nowrap flex-grow-1 flex-md-grow-0" onclick="goToBuilder()">
                    <i class="fas fa-plus me-1"></i> Nueva <span class="d-none d-md-inline">Rutina</span>
                </button>
            </div>
        </div>
    </div>
</div>

<div class="card bg-panel border-0 shadow-lg d-none d-md-block">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-dark table-hover align-middle" id="routinesTable">
                <thead>
                    <tr class="text-cyber-blue">
                        <th>Nombre</th>
                        <th>Grupos</th>
                        <th>Día</th>
                        <th>Ejercicios</th>
                        <th>Actualización</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody id="routinesList">
                    <!-- Completado por JS -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Vista de lista movil -->
<div id="mobileRoutinesList" class="d-md-none d-flex flex-column gap-3">
    <!-- Cargado por JS -->
</div>

<!-- Modal Detalle Rutina -->
<div class="modal fade" id="routineModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-panel text-white border-cyber">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-cyber-green" id="routineModalTitle">Rutina</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="routineModalBody"></div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Mensajes -->
<div class="modal fade" id="messageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-panel text-white border-cyber">
            <div class="modal-header border-secondary d-flex align-items-center gap-2">
                <div id="messageModalIcon" class="rounded-circle d-flex align-items-center justify-content-center"
                    style="width: 36px; height: 36px;">
                    <i class="fas fa-info"></i>
                </div>
                <h5 class="modal-title mb-0" id="messageModalTitle">Mensaje</h5>
                <button type="button" class="btn-close btn-close-white ms-auto" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="messageModalBody" class="text-secondary"></div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" id="messageModalCancel"
                    data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-cyber-primary" id="messageModalConfirm">Aceptar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de video -->
<div class="modal fade" id="videoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-panel text-white border-cyber">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-cyber-green">Video</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="ratio ratio-16x9">
                    <iframe id="videoFrame" src="" title="Video ejercicio"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen></iframe>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<style>
    .text-cyber-green {
        color: #00ff9d;
        text-shadow: 0 0 10px rgba(0, 255, 157, 0.3);
    }

    .text-cyber-blue {
        color: #00d2ff;
    }

    .btn-cyber-primary {
        background: linear-gradient(45deg, #00d2ff, #007bff);
        color: var(--text-main);
        border: none;
        box-shadow: 0 0 15px rgba(0, 210, 255, 0.4);
    }

    .btn-cyber-primary:hover {
        background: linear-gradient(45deg, #007bff, #0056b3);
        box-shadow: 0 0 20px rgba(0, 210, 255, 0.6);
        color: var(--text-main);
    }

    .border-cyber {
        border: 1px solid rgba(0, 210, 255, 0.3);
    }

    .routine-preview-card {
        background: var(--bg-card);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 18px;
        padding: 16px;
    }

    .routine-preview-scroll {
        max-height: 360px;
        overflow-y: auto;
        padding-right: 6px;
    }

    .routine-preview-group {
        background: var(--bg-card);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 12px;
        padding: 10px 12px;
    }

    .routine-preview-item {
        background: var(--bg-card);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 10px;
        padding: 10px 12px;
    }
</style>

<script>
    let routines = [];
    let bodyPartMap = {};
    let exerciseLookup = {};
    let messageModalInstance = null;

    document.addEventListener("DOMContentLoaded", async () => {
        if (window.showLoader) window.showLoader("Cargando catálogo...");
        try {
            await Promise.all([
                loadBodyParts(),
                loadExercises(),
                loadRoutines()
            ]);
        } catch (e) {
            console.error("Error inicializando catálogo", e);
        } finally {
            if (window.hideLoader) window.hideLoader();
        }

        const mainSearch = document.getElementById("mainSearch");
        const filterBodyPart = document.getElementById("filterBodyPart");
        const filterDay = document.getElementById("filterDay");

        if (mainSearch) mainSearch.addEventListener("input", filterRoutines);
        if (filterBodyPart) filterBodyPart.addEventListener("change", filterRoutines);
        if (filterDay) filterDay.addEventListener("change", filterRoutines);
    });

    async function loadBodyParts() {
        try {
            const res = await fetch("/workout/api/body-parts");
            const parts = await res.json();
            const filterSel = document.getElementById("filterBodyPart");

            if (filterSel) filterSel.innerHTML = '<option value="">Grupo</option>';

            parts.forEach(p => {
                bodyPartMap[p.key] = p.label_es || p.label_en || p.key;
                if (filterSel) {
                    const opt = document.createElement("option");
                    opt.value = p.key;
                    opt.textContent = bodyPartMap[p.key];
                    filterSel.appendChild(opt);
                }
            });
        } catch (e) {
            console.error("Error loading body parts", e);
        }
    }

    async function loadExercises() {
        try {
            const res = await fetch("/api/exercises");
            const data = await res.json();
            if (Array.isArray(data)) {
                exerciseLookup = data.reduce((acc, ex) => {
                    if (ex && ex._id) acc[ex._id] = ex;
                    return acc;
                }, {});
            }
        } catch (e) {
            console.error("Error loading exercises", e);
            exerciseLookup = {};
        }
    }

    async function loadRoutines() {
        try {
            const res = await fetch("/api/routines");
            routines = await res.json();
            filterRoutines();
        } catch (e) {
            console.error("Error loading routines", e);
        }
    }

    function filterRoutines() {
        const mainSearch = document.getElementById("mainSearch");
        const filterBodyPart = document.getElementById("filterBodyPart");
        const filterDay = document.getElementById("filterDay");

        const term = (mainSearch ? mainSearch.value : "").trim().toLowerCase();
        const bodyPart = filterBodyPart ? filterBodyPart.value : "";
        const day = filterDay ? filterDay.value : "";

        const filtered = routines.filter(r => {
            const nameMatch = !term || (r.name || "").toLowerCase().includes(term);
            const routineBodyParts = Array.isArray(r.routine_body_parts) ? r.routine_body_parts : [];
            const bodyMatch = !bodyPart || routineBodyParts.includes(bodyPart);
            const dayMatch = !day || r.routine_day === day;
            return nameMatch && bodyMatch && dayMatch;
        });

        renderRoutines(filtered);
    }

    function resetFilters() {
        const mainSearch = document.getElementById("mainSearch");
        const filterBodyPart = document.getElementById("filterBodyPart");
        const filterDay = document.getElementById("filterDay");

        if (mainSearch) mainSearch.value = "";
        if (filterBodyPart) filterBodyPart.value = "";
        if (filterDay) filterDay.value = "";

        renderRoutines(routines);
    }

    function translateBodyPart(bp) {
        return bodyPartMap[bp] || bp;
    }

    function getRoutineBodyPartsLabel(routine) {
        const parts = Array.isArray(routine.routine_body_parts) ? routine.routine_body_parts : [];
        if (parts.length === 0) return "N/A";
        return parts.map(p => translateBodyPart(p)).join(", ");
    }

    function getExerciseCount(routine) {
        const items = Array.isArray(routine.items) ? routine.items : [];
        return items.filter(item => item && item.item_type === "exercise").length;
    }

    function getRestSeconds(item) {
        if (!item) return 60;
        if (item.rest_seconds != null) return item.rest_seconds;
        if (item.rest != null && item.rest !== item.target_time_seconds) return item.rest;
        return 60;
    }

    function formatDate(value) {
        if (!value) return "-";
        const dt = new Date(value);
        if (Number.isNaN(dt.getTime())) return value;
        return dt.toLocaleDateString();
    }

    function renderRoutines(list) {
        const tbody = document.getElementById("routinesList");
        const mobileContainer = document.getElementById("mobileRoutinesList");

        tbody.innerHTML = "";
        mobileContainer.innerHTML = "";

        if (list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-3">No se encontraron rutinas</td></tr>';
            mobileContainer.innerHTML = '<div class="text-center text-muted py-5">No se encontraron rutinas con los filtros seleccionados.</div>';
            return;
        }

        list.forEach(r => {
            const partsLabel = getRoutineBodyPartsLabel(r);
            const exercises = getExerciseCount(r);
            const day = r.routine_day || "-";
            const updated = formatDate(r.updated_at || r.created_at);

            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>
                    <div class="fw-bold">${r.name || "Sin nombre"}</div>
                    <small class="text-secondary text-truncate d-block" style="max-width: 220px;">${r.description || ""}</small>
                </td>
                <td><span class="badge bg-secondary">${partsLabel}</span></td>
                <td>${day}</td>
                <td>${exercises}</td>
                <td>${updated}</td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-outline-info" onclick="openRoutineModal('${r._id}')" title="Ver detalle">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="confirmDeleteRoutine('${r._id}')" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);

            const card = document.createElement("div");
            card.className = "card bg-panel border-secondary shadow-sm";
            card.innerHTML = `
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="flex-grow-1">
                            <h5 class="card-title text-white fw-bold mb-1">${r.name || "Sin nombre"}</h5>
                            <div class="d-flex flex-wrap gap-1 mb-1">
                                <span class="badge bg-secondary" style="font-size: 0.7rem;">${partsLabel}</span>
                                <span class="badge bg-dark border border-secondary text-info" style="font-size: 0.7rem;">${day}</span>
                            </div>
                        </div>
                        <span class="badge bg-dark border border-secondary text-info ms-2" style="font-size: 0.65rem;">
                            ${exercises} ejercicios
                        </span>
                    </div>
                    <p class="card-text text-secondary small text-truncate mb-3">${r.description || "Sin descripción"}</p>
                    <div class="d-flex justify-content-between align-items-center border-top border-secondary pt-2 mt-2">
                        <small class="text-muted text-uppercase fw-bold" style="font-size:0.7rem;">
                            Actualizada: ${updated}
                        </small>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-info" onclick="openRoutineModal('${r._id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="confirmDeleteRoutine('${r._id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            mobileContainer.appendChild(card);
        });
    }

    async function confirmDeleteRoutine(id) {
        const confirmed = window.showConfirmModal
            ? await window.showConfirmModal(
                "Eliminar rutina",
                "¿Eliminar esta rutina? Esta acción no se puede deshacer.",
                "danger"
            )
            : confirm("¿Eliminar esta rutina? Esta acción no se puede deshacer.");
        if (!confirmed) return;
        if (window.showLoader) window.showLoader("Eliminando rutina...");
        try {
            const res = await fetch(`/api/routines/${id}`, { method: "DELETE" });
            const data = await res.json();
            if (!res.ok) {
                if (window.showAlertModal) {
                    window.showAlertModal("Error", data.error || "Error al eliminar", "danger");
                } else {
                    alert(data.error || "Error al eliminar");
                }
                return;
            }
            await loadRoutines();
        } catch (e) {
            console.error(e);
            if (window.showAlertModal) {
                window.showAlertModal("Error", "Error de conexión", "danger");
            } else {
                alert("Error de conexión");
            }
        } finally {
            if (window.hideLoader) window.hideLoader();
        }
    }

    async function openRoutineModal(id) {
        const routine = routines.find(r => r._id === id);
        if (!routine) return;

        const modalTitle = document.getElementById("routineModalTitle");
        const modalBody = document.getElementById("routineModalBody");

        const partsLabel = getRoutineBodyPartsLabel(routine);
        const exercises = getExerciseCount(routine);
        const day = routine.routine_day || "-";
        const updated = formatDate(routine.updated_at || routine.created_at);

        modalTitle.textContent = routine.name || "Rutina";
        const previewHtml = buildRoutinePreviewHtml(routine);
        modalBody.innerHTML = `
            <div class="routine-preview-card">
                <div class="text-center mb-3">
                    <div class="h3 fw-bold text-white mb-1">${routine.name || "Rutina"}</div>
                    <div class="text-secondary">${exercises} ejercicios - Revisa los detalles antes de iniciar</div>
                </div>
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <div class="text-secondary small">Grupos</div>
                        <div class="text-white">${partsLabel}</div>
                    </div>
                    <div class="col-6">
                        <div class="text-secondary small">Día</div>
                        <div class="text-white">${day}</div>
                    </div>
                    <div class="col-6">
                        <div class="text-secondary small">Ejercicios</div>
                        <div class="text-white">${exercises}</div>
                    </div>
                    <div class="col-6">
                        <div class="text-secondary small">Actualización</div>
                        <div class="text-white">${updated}</div>
                    </div>
                </div>
                <div class="routine-preview-scroll d-flex flex-column gap-2">${previewHtml}</div>
            </div>
        `;

        new bootstrap.Modal(document.getElementById("routineModal")).show();
    }

    function buildRoutinePreviewHtml(routine) {
        const items = Array.isArray(routine.items) ? routine.items : [];
        const isRestItem = (item) => item && (item.item_type === "rest" || (!item.exercise_id && item.rest_seconds != null));
        const isExerciseItem = (item) => item && item.item_type === "exercise";
        const isGroupHeader = (item) => item && item.item_type === "group";
        const safeId = (value) => String(value || "").replace(/[^a-zA-Z0-9_-]/g, "");

        // 1. Pre-scan for Group Metadata
        const groupMetaMap = new Map();
        items.forEach(item => {
            if (isGroupHeader(item)) {
                groupMetaMap.set(item._id || item.id, {
                    name: item.group_name || item.name || "Circuito",
                    note: item.note || item.description || ""
                });
            }
        });

        // 2. Cluster items (Match buildQueue logic)
        const blocks = [];
        const blockIds = new Set();
        const groupEntries = new Map();

        const ensureGroupBlock = (groupId) => {
            if (!groupId || blockIds.has(groupId)) return;
            blockIds.add(groupId);
            blocks.push({ type: 'group', id: groupId });
        };

        items.forEach((item, idx) => {
            // Inline groups (legacy/recursive structure handling)
            if (item.item_type === "group" || Array.isArray(item.items)) {
                if (Array.isArray(item.items) && item.items.length > 0) {
                    // It's a fully contained group. Treat as atomic block.
                    blocks.push({ type: 'inline_group', item: item });
                    return;
                }
                // Just a header
                ensureGroupBlock(item._id || item.id);
                return;
            }

            if (isExerciseItem(item) || isRestItem(item)) {
                const gid = item.group_id;
                if (gid) {
                    ensureGroupBlock(gid);
                    if (!groupEntries.has(gid)) groupEntries.set(gid, []);
                    groupEntries.get(gid).push(item);
                } else {
                    blocks.push({ type: 'ungrouped', entry: item });
                }
            }
        });

        // 3. Render Blocks
        const htmlParts = [];

        const renderEntry = (item, idxKey) => {
            if (isRestItem(item)) {
                const restLabel = item.note || "Descanso";
                const restSeconds = getRestSeconds(item);
                return `
                    <div class="routine-preview-item d-flex justify-content-between align-items-center">
                        <div>
                            <div class="text-white fw-bold">${restLabel}</div>
                            <div class="text-secondary small">Pausa</div>
                        </div>
                        <div class="text-end text-secondary small">${restSeconds}s</div>
                    </div>
                `;
            }

            const name = item.exercise_name || item.name || "Ejercicio";
            const bodyPartLabel = translateBodyPart(item.body_part);
            const sets = item.target_sets || item.sets || 1;
            const reps = item.target_reps || item.reps || "-";
            const time = item.target_time_seconds || item.time_seconds || 60;
            const isTime = (item.exercise_type || item.type) === "time" || (item.exercise_type || item.type) === "cardio";
            const rest = getRestSeconds(item);
            const equipmentMeta = getEquipmentMeta(item.equipment);
            const hasVideo = item.video_url && item.video_url.trim() !== "";
            const substitutes = resolveSubstitutes(item.substitutes || []);
            const subsId = `subs_${safeId(routine._id)}_${idxKey}`;

            return `
                <div class="routine-preview-item d-flex justify-content-between align-items-start">
                    <div>
                        <div class="d-flex align-items-center gap-2">
                            <div class="text-white fw-bold">${name}</div>
                            ${hasVideo ? `
                                <button class="btn btn-sm btn-outline-danger" onclick="openVideoModal('${item.video_url}')">
                                    <i class="fab fa-youtube"></i>
                                </button>
                            ` : ""}
                        </div>
                        <div class="d-flex flex-wrap gap-2 mt-1">
                            <span class="badge bg-secondary">${bodyPartLabel}</span>
                            <span class="badge bg-dark border border-secondary text-info">
                                <i class="${equipmentMeta.icon} me-1"></i>${equipmentMeta.label}
                            </span>
                        </div>
                         ${substitutes.length ? `
                            <button class="btn btn-sm btn-outline-info mt-2" type="button" data-bs-toggle="collapse" data-bs-target="#${subsId}">
                                Sustitutos (${substitutes.length})
                            </button>
                            <div class="collapse mt-2" id="${subsId}">
                                <div class="d-flex flex-column gap-2">
                                    ${substitutes.map(sub => `
                                        <div class="routine-preview-item d-flex align-items-center justify-content-between">
                                            <div>
                                                <div class="fw-bold text-white">${sub.name || "Ejercicio"}</div>
                                                <div class="text-secondary small">
                                                    <i class="${getEquipmentMeta(sub.equipment).icon} me-1"></i>${getEquipmentMeta(sub.equipment).label}
                                                </div>
                                            </div>
                                            ${sub.video_url ? `
                                                <button class="btn btn-sm btn-outline-danger" onclick="openVideoModal('${sub.video_url}')">
                                                    <i class="fab fa-youtube"></i>
                                                </button>
                                            ` : ""}
                                        </div>
                                    `).join("")}
                                </div>
                            </div>
                        ` : ""}
                    </div>
                    <div class="text-end text-secondary small">
                        <div>${sets} sets ${isTime ? `x ${time}s` : `x ${reps}`}</div>
                        <div>Descanso ${rest}s</div>
                    </div>
                </div>
            `;
        };

        let lastBlockWasUngrouped = false;

        blocks.forEach((block, bIdx) => {
            if (block.type === 'ungrouped') {
                if (!lastBlockWasUngrouped) {
                    htmlParts.push(`
                        <div class="routine-preview-group">
                            <div class="text-cyber-blue fw-bold">Sin grupo</div>
                        </div>
                    `);
                    lastBlockWasUngrouped = true;
                }
                htmlParts.push(renderEntry(block.entry, `u_${bIdx}`));
            } else if (block.type === 'group') {
                lastBlockWasUngrouped = false;
                const entries = groupEntries.get(block.id) || [];
                const meta = groupMetaMap.get(block.id) || { name: "Circuito", note: "" };

                if (entries.length > 0) {
                    htmlParts.push(`
                        <div class="routine-preview-group">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="text-cyber-orange fw-bold">${meta.name}</div>
                                <div class="text-secondary small">${entries.length} items</div>
                            </div>
                            ${meta.note ? `<div class="text-secondary small mt-1">"${meta.note}"</div>` : ""}
                        </div>
                    `);
                    entries.forEach((entry, eIdx) => {
                        htmlParts.push(renderEntry(entry, `g_${block.id}_${eIdx}`));
                    });
                }
            } else if (block.type === 'inline_group') {
                // Legacy inline group structure
                lastBlockWasUngrouped = false;
                const item = block.item;
                const entries = (item.items || []).filter(sub => isExerciseItem(sub) || isRestItem(sub));
                if (entries.length > 0) {
                    htmlParts.push(`
                        <div class="routine-preview-group">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="text-cyber-orange fw-bold">${item.group_name || item.name || "Circuito"}</div>
                                <div class="text-secondary small">${entries.length} items</div>
                            </div>
                            ${(item.note || item.description) ? `<div class="text-secondary small mt-1">"${item.note || item.description}"</div>` : ""}
                        </div>
                    `);
                    entries.forEach((entry, eIdx) => {
                        htmlParts.push(renderEntry(entry, `ig_${bIdx}_${eIdx}`));
                    });
                }
            }
        });

        return htmlParts.join("");
    }

    function resolveSubstitutes(substitutes) {
        if (!Array.isArray(substitutes) || substitutes.length === 0) return [];
        return substitutes.map(sub => {
            if (typeof sub === "string") return exerciseLookup[sub];
            if (sub && typeof sub === "object") return sub;
            return null;
        }).filter(Boolean);
    }

    function getEquipmentMeta(equipmentKey) {
        const raw = Array.isArray(equipmentKey) ? (equipmentKey[0] || "") : equipmentKey;
        const map = {
            barbell: { label: "Barra", icon: "fas fa-grip-lines" },
            dumbbell: { label: "Mancuernas", icon: "fas fa-dumbbell" },
            machine: { label: "Máquina", icon: "fas fa-cogs" },
            cable: { label: "Polea", icon: "fas fa-wave-square" },
            band: { label: "Banda", icon: "fas fa-link" },
            bench: { label: "Banco", icon: "fas fa-chair" },
            bodyweight: { label: "Corporal", icon: "fas fa-running" },
            other: { label: "Otro", icon: "fas fa-toolbox" }
        };
        return map[raw] || { label: raw || "N/A", icon: "fas fa-dumbbell" };
    }

    function toEmbedUrl(url) {
        const trimmed = (url || "").trim();
        if (!trimmed) return "";
        if (trimmed.includes("youtube.com/watch")) {
            const match = trimmed.match(/[?&]v=([^&]+)/);
            if (match && match[1]) return `https://www.youtube.com/embed/${match[1]}`;
        }
        if (trimmed.includes("youtu.be/")) {
            const match = trimmed.match(/youtu\.be\/([^?&]+)/);
            if (match && match[1]) return `https://www.youtube.com/embed/${match[1]}`;
        }
        return trimmed;
    }

    function openVideoModal(url) {
        const modalEl = document.getElementById("videoModal");
        const iframe = document.getElementById("videoFrame");
        const embedUrl = toEmbedUrl(url);
        if (!embedUrl) return;
        iframe.src = embedUrl;
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
        modalEl.addEventListener("hidden.bs.modal", () => {
            iframe.src = "";
        }, { once: true });
    }

    function goToBuilder() {
        window.location.href = "/workout/routines/builder-guided?source=admin";
    }
</script>
<script src="/static/js/loader.js"></script>
{% endblock %}
