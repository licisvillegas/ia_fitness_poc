{% extends 'layout.html' %}

{% block title %}Synapse Fit - Mis Rutinas{% endblock %}

{% block sidebar %}
{% include 'components/sidebar.html' %}
{% endblock %}

{% block head %}
<link href="/static/css/assigned_routines.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12 d-flex flex-column flex-md-row justify-content-between align-items-center gap-3">
        <h2 class="fw-bold text-cyber-green mb-0 text-center text-md-start">
            <i class="fas fa-clipboard-list me-2"></i>Mis Rutinas
        </h2>

        <div
            class="d-flex flex-wrap gap-2 align-items-center justify-content-center justify-content-md-end w-100 w-md-auto">
            <div class="input-group" style="min-width: 200px; flex-grow: 1; max-width: 100%;">
                <span class="input-group-text bg-dark border-secondary text-secondary"><i
                        class="fas fa-search"></i></span>
                <input type="text" class="form-control bg-dark text-white border-secondary" id="mainSearch"
                    placeholder="Buscar rutina...">
            </div>

            <div class="d-flex gap-2 w-100 w-md-auto overflow-auto pb-1 pb-md-0" style="scrollbar-width: none;">
                <select class="form-select bg-dark text-white border-secondary flex-grow-1 flex-md-grow-0"
                    id="filterBodyPart" style="min-width: 130px;">
                    <option value="">Grupo</option>
                </select>
                <select class="form-select bg-dark text-white border-secondary flex-grow-1 flex-md-grow-0"
                    id="filterDay" style="min-width: 130px;">
                    <option value="">Día</option>
                    <option value="Monday">Lunes</option>
                    <option value="Tuesday">Martes</option>
                    <option value="Wednesday">Miércoles</option>
                    <option value="Thursday">Jueves</option>
                    <option value="Friday">Viernes</option>
                    <option value="Saturday">Sábado</option>
                    <option value="Sunday">Domingo</option>
                </select>
            </div>


            <button id="btnPrintPreview" class="btn btn-outline-info text-nowrap flex-grow-1 flex-md-grow-0"
                style="display:none;" onclick="openPrintPreview()">
                <i class="fas fa-print me-1"></i> <span class="d-none d-md-inline">Vista de Impresión</span>
            </button>
            <button class="btn btn-outline-secondary text-nowrap flex-grow-1 flex-md-grow-0" onclick="resetFilters()">
                <i class="fas fa-undo me-1"></i> <span class="d-none d-md-inline">Restablecer</span>
            </button>
            <button class="btn btn-cyber-primary text-nowrap flex-grow-1 flex-md-grow-0" onclick="goToBuilder()">
                <i class="fas fa-plus me-1"></i> Nueva <span class="d-none d-md-inline">Rutina</span>
            </button>
        </div>
    </div>
</div>


<!-- Navegacion de pestanas -->
<ul class="nav nav-tabs border-secondary mb-3">
    <li class="nav-item">
        <button class="nav-link active text-theme" id="tab-created" onclick="setTab('created')">
            <i class="fas fa-list me-2"></i>Creadas
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link text-theme" id="tab-assigned" onclick="setTab('assigned')">
            <i class="fas fa-clipboard-check me-2"></i>Vigentes Asignadas
        </button>
    </li>
</ul>

<div class="card bg-panel border-0 shadow-lg d-none d-md-block">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-dark table-hover align-middle" id="routinesTable">
                <thead>
                    <tr class="text-cyber-blue">
                        <th>Nombre</th>
                        <th>Grupos</th>
                        <th>Día</th>
                        <th>Ejercicios</th>
                        <th>Estado</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody id="routinesList">
                    <!-- Completado por JS -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Vista de lista movil -->
<div id="mobileRoutinesList" class="d-md-none d-flex flex-column gap-3">
    <!-- Cargado por JS -->
</div>



<!-- Modal Detalle Rutina -->
<div class="modal fade" id="routineModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-panel text-white border-cyber">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-cyber-green" id="routineModalTitle">Rutina</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="routineModalBody"></div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Mensajes -->
<div class="modal fade" id="messageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-panel text-white border-cyber">
            <div class="modal-header border-secondary d-flex align-items-center gap-2">
                <div id="messageModalIcon" class="rounded-circle d-flex align-items-center justify-content-center"
                    style="width: 36px; height: 36px;">
                    <i class="fas fa-info"></i>
                </div>
                <h5 class="modal-title mb-0" id="messageModalTitle">Mensaje</h5>
                <button type="button" class="btn-close btn-close-white ms-auto" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="messageModalBody" class="text-secondary"></div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" id="messageModalCancel"
                    data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-cyber-primary" id="messageModalConfirm">Aceptar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de video -->
<div class="modal fade" id="videoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-panel text-white border-cyber">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-cyber-green">Video</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="ratio ratio-16x9">
                    <iframe id="videoFrame" src="" title="Video ejercicio"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen></iframe>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Vista Previa Impresión -->
<div class="modal fade" id="printPreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content bg-panel text-white border-cyber">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-cyber-green">Vista de Impresión (Rutinas Asignadas)</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="printPreviewBody">
                <!-- Cargado por JS -->
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" onclick="printModalContent()">
                    <i class="fas fa-print me-2"></i>Imprimir
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .text-cyber-green {
        color: #00ff9d;
        text-shadow: 0 0 10px rgba(0, 255, 157, 0.3);
    }

    .text-cyber-blue {
        color: #00d2ff;
    }

    .btn-cyber-primary {
        background: linear-gradient(45deg, #00d2ff, #007bff);
        color: var(--text-main);
        border: none;
        box-shadow: 0 0 15px rgba(0, 210, 255, 0.4);
    }

    .btn-cyber-primary:hover {
        background: linear-gradient(45deg, #007bff, #0056b3);
        box-shadow: 0 0 20px rgba(0, 210, 255, 0.6);
        color: var(--text-main);
    }

    .border-cyber {
        border: 1px solid rgba(0, 210, 255, 0.3);
    }

    .routine-preview-card {
        background: var(--bg-card);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 18px;
        padding: 16px;
    }

    .routine-preview-scroll {
        max-height: 360px;
        overflow-y: auto;
        padding-right: 6px;
    }

    .routine-preview-group {
        background: var(--bg-card);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 12px;
        padding: 10px 12px;
    }

    .routine-preview-item {
        background: var(--bg-card);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 10px;
        padding: 10px 12px;
    }

    .nav-tabs .nav-link {
        color: var(--text-secondary);
        border: none;
        border-bottom: 2px solid transparent;
        transition: all 0.3s ease;
    }

    .nav-tabs .nav-link:hover {
        color: var(--text-main);
        border-color: transparent;
    }

    .nav-tabs .nav-link.active {
        background-color: transparent;
        color: #00d2ff !important;
        border-bottom: 2px solid #00d2ff;
        font-weight: bold;
    }

    @media print {

        /* Hide everything by default */
        /* Reset body and containers for full page printing */
        body,
        html,
        .modal-open {
            overflow: visible !important;
            height: auto !important;
        }

        /* Unhide the print modal content */
        #printPreviewModal,
        #printPreviewModal * {
            visibility: visible;
        }

        /* Position the modal content naturally */
        #printPreviewModal {
            position: absolute !important;
            left: 0;
            top: 0;
            margin: 0;
            padding: 0;
            min-height: 100%;
            width: 100%;
            height: auto !important;
            overflow: visible !important;
            background: white;
            color: black;
            z-index: 9999 !important;
        }

        .modal-dialog,
        .modal-content,
        .modal-body {
            overflow: visible !important;
            height: auto !important;
            width: 100% !important;
            background: white !important;
            box-shadow: none !important;
            border: none !important;
            max-width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        .modal-body {
            padding: 20px !important;
        }

        .modal-header,
        .modal-footer,
        .btn-close {
            display: none !important;
        }

        /* Ensure cards look good on print */
        .print-preview-card {
            border: 1px solid #ccc;
            margin-bottom: 20px;
            padding: 15px;
            page-break-inside: avoid;
            color: black;
            background: white;
        }

        .text-muted {
            color: #666 !important;
        }

        .fw-bold {
            font-weight: bold !important;
        }

        /* Force Accordion Expansion on Print */
        /* Force Accordion Expansion on Print */
        .accordion-collapse {
            display: block !important;
            height: auto !important;
            visibility: visible !important;
        }

        .accordion-button::after {
            display: none !important;
        }

        /* Invert Dark Mode Styles for Print */
        .routine-preview-card,
        .routine-preview-item,
        .routine-preview-group,
        .accordion-body,
        .modal-content,
        .card {
            background-color: var(--text-main) !important;
            color: black !important;
            border: 1px solid #ddd !important;
            box-shadow: none !important;
        }

        .text-white,
        .text-cyber-green,
        .text-cyber-blue,
        .text-cyber-orange {
            color: black !important;
            text-shadow: none !important;
        }

        .text-secondary,
        .text-muted {
            color: #555 !important;
        }

        .badge {
            background-color: var(--text-main) !important;
            color: black !important;
            border: 1px solid #000 !important;
        }

        .btn {
            display: none !important;
        }
    }
</style>

<script>
    let routines = [];
    let bodyPartMap = {};
    let exerciseLookup = {};
    let messageModalInstance = null;
    let activeTab = 'created'; // 'created' or 'assigned'

    document.addEventListener("DOMContentLoaded", async () => {
        if (window.showLoader) window.showLoader("Cargando rutinas...");
        try {
            await Promise.all([
                loadBodyParts(),
                loadExercises(),
                loadRoutines()
            ]);
        } catch (e) {
            console.error("Error inicializando catálogo", e);
        } finally {
            if (window.hideLoader) window.hideLoader();
        }

        const mainSearch = document.getElementById("mainSearch");
        const filterBodyPart = document.getElementById("filterBodyPart");
        const filterDay = document.getElementById("filterDay");

        if (mainSearch) mainSearch.addEventListener("input", filterRoutines);
        if (filterBodyPart) filterBodyPart.addEventListener("change", filterRoutines);
        if (filterDay) filterDay.addEventListener("change", filterRoutines);
    });

    async function loadBodyParts() {
        try {
            const res = await fetch("/workout/api/body-parts");
            const parts = await res.json();
            const filterSel = document.getElementById("filterBodyPart");

            if (filterSel) filterSel.innerHTML = '<option value="">Grupo</option>';

            parts.forEach(p => {
                bodyPartMap[p.key] = p.label_es || p.label_en || p.key;
                if (filterSel) {
                    const opt = document.createElement("option");
                    opt.value = p.key;
                    opt.textContent = bodyPartMap[p.key];
                    filterSel.appendChild(opt);
                }
            });
        } catch (e) {
            console.error("Error loading body parts", e);
        }
    }

    async function loadExercises() {
        try {
            const res = await fetch("/workout/api/exercises");
            const data = await res.json();
            if (Array.isArray(data)) {
                exerciseLookup = data.reduce((acc, ex) => {
                    if (ex && ex._id) acc[ex._id] = ex;
                    return acc;
                }, {});
            }
        } catch (e) {
            console.error("Error loading exercises", e);
            exerciseLookup = {};
        }
    }

    function getUserId() {
        const stored = localStorage.getItem("ai_fitness_uid");
        if (stored) return stored;
        const match = document.cookie.match(/(?:^|; )user_session=([^;]+)/);
        return match ? decodeURIComponent(match[1]) : "";
    }

    function setTab(mode) {
        activeTab = mode;

        // Update UI
        document.querySelectorAll('.nav-link').forEach(btn => btn.classList.remove('active', 'text-white'));
        document.querySelectorAll('.nav-link').forEach(btn => btn.classList.add('text-theme'));

        const activeBtn = document.getElementById(mode === 'assigned' ? 'tab-assigned' : 'tab-created');
        if (activeBtn) {
            activeBtn.classList.add('active', 'text-white');
            activeBtn.classList.remove('text-theme');
        }

        // Toggle Print Preview Button
        const btnPreview = document.getElementById('btnPrintPreview');
        if (btnPreview) {
            btnPreview.style.display = (mode === 'assigned') ? 'block' : 'none';
        }

        filterRoutines();
    }

    function openPrintPreview_deprecated() {
        const modalEl = document.getElementById('printPreviewModal');
        const modalBody = document.getElementById('printPreviewBody');
        if (!modalEl || !modalBody) return;

        // Filter and Sort
        const assignedRoutines = routines.filter(r => r.assigned_expires_at);
        const dayOrder = { "Monday": 1, "Tuesday": 2, "Wednesday": 3, "Thursday": 4, "Friday": 5, "Saturday": 6, "Sunday": 7 };

        assignedRoutines.sort((a, b) => {
            const dA = dayOrder[a.routine_day] || 8;
            const dB = dayOrder[b.routine_day] || 8;
            if (dA !== dB) return dA - dB;
            return (a.name || "").localeCompare(b.name || "");
        });

        if (assignedRoutines.length === 0) {
            modalBody.innerHTML = '<div class="text-center text-muted p-4">No hay rutinas asignadas para mostrar.</div>';
        } else {
            let html = '<div class="accordion" id="printPreviewAccordion">';

            assignedRoutines.forEach((r, idx) => {
                const dayLabel = r.routine_day ? translateDay(r.routine_day) : 'Sin día asignado';
                const expires = r.assigned_expires_at ? new Date(r.assigned_expires_at).toLocaleDateString() : 'N/A';
                const routineId = `previewRoutine${idx}`;

                html += `
                <div class="accordion-item border mb-2">
                    <h2 class="accordion-header" id="heading${routineId}">
                        <button class="accordion-button collapsed text-dark bg-white" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${routineId}" aria-expanded="false" aria-controls="collapse${routineId}">
                            <div class="d-flex w-100 justify-content-between align-items-center me-3">
                                <span class="fw-bold">${r.name || 'Rutina'}</span>
                                <span class="badge bg-secondary text-white ms-2 text-nowrap">${dayLabel}</span>
                            </div>
                        </button>
                    </h2>
                    <div id="collapse${routineId}" class="accordion-collapse collapse" aria-labelledby="heading${routineId}" data-bs-parent="#printPreviewAccordion">
                        <div class="accordion-body text-dark bg-white">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div class="small text-muted">${r.description || ''}</div>
                                <div class="small text-muted fw-bold">Vence: ${expires}</div>
                            </div>
                            
                            <div class="exercises-list">`;

                if (r.exercises && r.exercises.length > 0) {
                    html += '<ul class="list-group list-group-flush">';
                    r.exercises.forEach((exItem, idxEx) => {
                        const exName = exerciseLookup[exItem.exercise_id]?.name || 'Ejercicio Desconocido';
                        const sets = exItem.sets || [];
                        const setsText = sets.length > 0 ? `${sets.length} series` : '';
                        const repsText = sets.map(s => s.reps || s.time || '-').join(', ');

                        html += `
                         <li class="list-group-item px-0 border-bottom">
                            <div class="d-flex justify-content-between">
                                <span class="fw-bold">${idxEx + 1}. ${exName}</span>
                                <span class="small border px-2 rounded">${setsText}</span>
                            </div>
                            <div class="small text-muted">Reps/Tiempo: ${repsText}</div>
                            ${exItem.note ? `<div class="small fst-italic text-muted mt-1">Nota: ${exItem.note}</div>` : ''}
                         </li>`;
                    });
                    html += '</ul>';
                } else {
                    html += '<div class="text-muted fst-italic">Sin ejercicios.</div>';
                }

                html += `</div></div></div></div>`;
            });
            html += '</div>';
            modalBody.innerHTML = html;
        }

        const modal = new bootstrap.Modal(modalEl);
        modal.show();
    }

    function printModalContent() {
        window.print();
    }

    function translateDay(eng) {
        const map = { "Monday": "Lunes", "Tuesday": "Martes", "Wednesday": "Miércoles", "Thursday": "Jueves", "Friday": "Viernes", "Saturday": "Sábado", "Sunday": "Domingo" };
        return map[eng] || eng;
    }

    async function loadRoutines() {
        try {
            const uid = getUserId();
            if (!uid) {
                routines = [];
                renderRoutines(routines);
                return;
            }
            // Fetch separated to avoid confusion
            const [assignedRes, createdRes] = await Promise.all([
                fetch(`/workout/api/routines?user_id=${encodeURIComponent(uid)}`),
                fetch("/workout/api/my-routines")
            ]);

            const assigned = await assignedRes.json().catch(() => []);
            const created = await createdRes.json().catch(() => []);

            // Normalizar Assigned
            assigned.forEach(r => {
                r.source_type = 'assigned';
            });

            // Normalizar Created
            created.forEach(r => {
                r.source_type = 'created';
                // Active por defecto true si no existe
                if (r.is_active === undefined) r.is_active = true;
            });

            // Merge simple para almacenar todo, but filtering will separate them
            routines = [...created, ...assigned];

            // Remove duplicates via ID mapping if creating overlaps (unlikely by design, but safe)
            const map = new Map();
            routines.forEach(r => {
                // Key composite to handle if same displayed in both (shouldn't happen logic-wise but...)
                // Let's just use ID. If same ID exists, Assigned props override for validity check
                if (!map.has(r._id)) map.set(r._id, r);
                else {
                    const exist = map.get(r._id);
                    // Merge properties
                    map.set(r._id, { ...exist, ...r });
                }
            });
            routines = Array.from(map.values());

            setTab('created'); // Force start on created
        } catch (e) {
            console.error("Error loading routines", e);
        }
    }

    function filterRoutines() {
        const mainSearch = document.getElementById("mainSearch");
        const filterBodyPart = document.getElementById("filterBodyPart");
        const filterDay = document.getElementById("filterDay");

        const term = (mainSearch ? mainSearch.value : "").trim().toLowerCase();
        const bodyPart = filterBodyPart ? filterBodyPart.value : "";
        const day = filterDay ? filterDay.value : "";

        const filtered = routines.filter(r => {
            const nameMatch = !term || (r.name || "").toLowerCase().includes(term);
            const routineBodyParts = Array.isArray(r.routine_body_parts) ? r.routine_body_parts : [];
            const bodyMatch = !bodyPart || routineBodyParts.includes(bodyPart);
            const dayMatch = !day || r.routine_day === day;

            // Tab Filter
            let tabMatch = true;
            if (activeTab === 'assigned') {
                tabMatch = !!r.source_type && r.source_type === 'assigned';
            } else {
                // Created tab
                // Either explicitly created source OR authored by me (check user_id logic if available, or assume non-assigned source)
                // Best approximation: source_type 'created' OR (no assigned_expires_at AND no source_type assigned)
                tabMatch = (r.source_type === 'created');
            }

            return nameMatch && bodyMatch && dayMatch && tabMatch;
        });

        // SORTING: Day of week (Mon->Sun), then others
        const dayOrder = {
            "Monday": 1, "Tuesday": 2, "Wednesday": 3, "Thursday": 4,
            "Friday": 5, "Saturday": 6, "Sunday": 7
        };

        filtered.sort((a, b) => {
            const da = dayOrder[a.routine_day] || 99;
            const db = dayOrder[b.routine_day] || 99;
            return da - db;
        });

        renderRoutines(filtered);
    }

    function resetFilters() {
        const mainSearch = document.getElementById("mainSearch");
        const filterBodyPart = document.getElementById("filterBodyPart");
        const filterDay = document.getElementById("filterDay");

        if (mainSearch) mainSearch.value = "";
        if (filterBodyPart) filterBodyPart.value = "";
        if (filterDay) filterDay.value = "";

        filterRoutines();
    }

    function translateBodyPart(bp) {
        return bodyPartMap[bp] || bp;
    }

    function getRoutineBodyPartsLabel(routine) {
        const parts = Array.isArray(routine.routine_body_parts) ? routine.routine_body_parts : [];
        if (parts.length === 0) return "N/A";
        return parts.map(p => translateBodyPart(p)).join(", ");
    }

    function getExerciseCount(routine) {
        const items = Array.isArray(routine.items) ? routine.items : [];
        return items.filter(item => item && item.item_type === "exercise").length;
    }

    function getRestSeconds(item) {
        if (!item) return 60;
        if (item.rest_seconds != null) return item.rest_seconds;
        if (item.rest != null && item.rest !== item.target_time_seconds) return item.rest;
        return 60;
    }

    function formatDate(value) {
        if (!value) return "-";
        const dt = new Date(value);
        if (Number.isNaN(dt.getTime())) return value;
        return dt.toLocaleDateString();
    }

    function renderRoutines(list) {
        const tbody = document.getElementById("routinesList");
        const mobileContainer = document.getElementById("mobileRoutinesList");

        tbody.innerHTML = "";
        mobileContainer.innerHTML = "";

        if (list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-3">No se encontraron rutinas</td></tr>';
            mobileContainer.innerHTML = '<div class="text-center text-muted py-5">No se encontraron rutinas con los filtros seleccionados.</div>';
            return;
        }

        list.forEach(r => {
            const partsLabel = getRoutineBodyPartsLabel(r);
            const exercises = getExerciseCount(r);
            const day = r.routine_day || "-";
            const isActive = (r.is_active !== false); // Default True
            const statusHtml = activeTab === 'created'
                ? `
                   <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="switch_${r._id}" 
                               ${isActive ? 'checked' : ''} onchange="toggleRoutineDash('${r._id}')">
                        <label class="form-check-label small text-secondary" for="switch_${r._id}">Dash</label>
                   </div>
                  `
                : (r.assigned_expires_at ? `<div class="text-secondary small">Vence: ${formatDate(r.assigned_expires_at)}</div>` : '-');

            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>
                    <div class="fw-bold">${r.name || "Sin nombre"}</div>
                    <small class="text-secondary text-truncate d-block" style="max-width: 220px;">${r.description || ""}</small>
                </td>
                <td><span class="badge bg-secondary">${partsLabel}</span></td>
                <td>${day}</td>
                <td>${exercises}</td>
                <td>${statusHtml}</td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-outline-info" onclick="openRoutineModal('${r._id}')" title="Ver detalle">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);

            const card = document.createElement("div");
            card.className = "card bg-panel border-secondary shadow-sm";
            card.innerHTML = `
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="flex-grow-1">
                            <h5 class="card-title text-white fw-bold mb-1">${r.name || "Sin nombre"}</h5>
                            <div class="d-flex flex-wrap gap-1 mb-1">
                                <span class="badge bg-secondary" style="font-size: 0.7rem;">${partsLabel}</span>
                                <span class="badge bg-dark border border-secondary text-info" style="font-size: 0.7rem;">${day}</span>
                            </div>
                        </div>
                        <span class="badge bg-dark border border-secondary text-info ms-2" style="font-size: 0.65rem;">
                            ${exercises} ejercicios
                        </span>
                    </div>
                    <p class="card-text text-secondary small text-truncate mb-3">${r.description || "Sin descripción"}</p>
                    <div class="d-flex justify-content-between align-items-center border-top border-secondary pt-2 mt-2">
                        <div class="d-flex align-items-center">
                            ${activeTab === 'created'
                    ? `<div class="form-check form-switch me-2">
                                     <input class="form-check-input" type="checkbox" role="switch" ${isActive ? 'checked' : ''} onchange="toggleRoutineDash('${r._id}')">
                                     <label class="form-check-label small text-secondary">Dash</label>
                                   </div>`
                    : (r.assigned_expires_at ? `<small class="text-muted text-uppercase fw-bold" style="font-size:0.7rem;">Vence: ${formatDate(r.assigned_expires_at)}</small>` : '-')
                }
                        </div>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-info" onclick="openRoutineModal('${r._id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            mobileContainer.appendChild(card);
        });
    }


    async function openRoutineModal(id) {
        // Find routine in global list
        // Note: 'routines' is global in this template scope.
        // It might be filtered, but the main list has them all logic-wise if we didn't overwrite it with filtered.
        // In this file, 'routines' holds the currently displayed list. 
        // We should check if we can find it there.
        const routine = routines.find(r => r._id === id);
        if (!routine) return;

        const modalTitle = document.getElementById("routineModalTitle");
        const modalBody = document.getElementById("routineModalBody");

        // Use RoutineRenderer
        if (typeof RoutineRenderer === 'undefined') {
            console.error("RoutineRenderer not found");
            return;
        }

        const previewHtml = RoutineRenderer.buildPreviewHtml(routine);
        // ... (rest of logic using routine properties)
        // Re-construct the modal body as per new design

        const partsLabel = RoutineRenderer.translateBodyPart(routine.routine_body_parts ? routine.routine_body_parts[0] : ""); // Simplified or use helper
        // Actually we need a helper for array of body parts if we want to match exact output
        // let's define local helper or use renderer if available (Renderer has translateBodyPart but not array joiner, we do it here)
        const parts = Array.isArray(routine.routine_body_parts) ? routine.routine_body_parts : [];
        const partsStr = parts.map(p => RoutineRenderer.translateBodyPart(p)).join(", ");

        const exercises = (routine.items || []).filter(i => i.item_type === 'exercise').length; // simple count
        const day = routine.routine_day || "-";
        const updated = routine.updated_at ? new Date(routine.updated_at).toLocaleDateString() : "-";

        modalTitle.textContent = routine.name || "Rutina";

        modalBody.innerHTML = `
            <div class="routine-preview-card" style="background: transparent; border: none; padding: 0;">
                <div class="text-center mb-3">
                    <h2 class="display-6 fw-bold text-white mb-2">${routine.name || "Rutina"}</h2>
                    <p class="text-secondary m-0">${exercises} ejercicios - Revisa los detalles</p>
                </div>
                
                <div class="row g-2 mb-3 border-bottom border-secondary pb-3">
                   <div class="col-4 text-center border-end border-secondary">
                      <div class="text-secondary small text-uppercase">Grupos</div>
                      <div class="text-white small">${partsStr || "N/A"}</div>
                   </div>
                   <div class="col-4 text-center border-end border-secondary">
                      <div class="text-secondary small text-uppercase">Día</div>
                      <div class="text-white small">${day}</div>
                   </div>
                    <div class="col-4 text-center">
                      <div class="text-secondary small text-uppercase">Actualizado</div>
                      <div class="text-white small">${updated}</div>
                   </div>
                </div>

                <div class="routine-preview-scroll d-flex flex-column gap-2" style="max-height: 400px; overflow-y: auto;">
                    ${previewHtml}
                </div>
                
                 <div class="d-grid mt-3">
                   <a href="#" onclick="startRoutine('${routine._id}'); return false;" class="btn btn-primary btn-lg">
                     <i class="fas fa-play me-2"></i> Iniciar Rutina
                   </a>
                </div>
            </div>
        `;

        new bootstrap.Modal(document.getElementById("routineModal")).show();
    }

    // Helper to redirect to runner
    function startRoutine(id) {
        window.location.href = `/workout/run/${id}`;
    }

    async function toggleRoutineDash(id) {
        try {
            const res = await fetch(`/workout/api/my-routines/${id}/toggle-dash`, { method: "POST" });
            const data = await res.json();
            if (!res.ok) {
                alert(data.error || "Error al actualizar estado");
                // revert check visually if possible or reload
                return;
            }
            // Update local state
            const r = routines.find(x => x._id === id);
            if (r) r.is_active = data.is_active;

        } catch (e) {
            console.error(e);
            alert("Error de conexión");
        }
    }

    function openPrintPreview() {
        const modalEl = document.getElementById('printPreviewModal');
        const modalBody = document.getElementById('printPreviewBody');
        if (!modalEl || !modalBody) return;

        // Filter and Sort
        const assignedRoutines = routines.filter(r => r.assigned_expires_at);
        const dayOrder = { "Monday": 1, "Tuesday": 2, "Wednesday": 3, "Thursday": 4, "Friday": 5, "Saturday": 6, "Sunday": 7 };

        assignedRoutines.sort((a, b) => {
            const dA = dayOrder[a.routine_day] || 8;
            const dB = dayOrder[b.routine_day] || 8;
            if (dA !== dB) return dA - dB;
            return (a.name || "").localeCompare(b.name || "");
        });

        if (assignedRoutines.length === 0) {
            modalBody.innerHTML = '<div class="text-center text-muted p-4">No hay rutinas asignadas para mostrar.</div>';
        } else {
            let html = '<div class="accordion" id="printPreviewAccordion">';

            assignedRoutines.forEach((r, idx) => {
                const dayLabel = r.routine_day ? translateDay(r.routine_day) : 'Sin día asignado';
                const expires = r.assigned_expires_at ? new Date(r.assigned_expires_at).toLocaleDateString() : 'N/A';
                const partsLabel = getRoutineBodyPartsLabel(r);
                const exercisesCount = getExerciseCount(r);
                const routineId = `previewRoutine${idx}`;

                // Generate rich details using the same function as the Detail Modal
                const detailsHtml = RoutineRenderer.buildPreviewHtml(r);

                html += `
                <div class="accordion-item border mb-2">
                    <h2 class="accordion-header" id="heading${routineId}">
                        <button class="accordion-button collapsed text-dark bg-white" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${routineId}" aria-expanded="false" aria-controls="collapse${routineId}">
                            <div class="d-flex w-100 flex-column flex-sm-row justify-content-between align-items-sm-center me-3 gap-2">
                                <div>
                                    <span class="fw-bold d-block">${r.name || 'Rutina'}</span>
                                    <div class="small text-muted fw-normal">${partsLabel} • ${exercisesCount} ejercicios</div>
                                </div>
                                <div class="text-start text-sm-end">
                                    <span class="badge bg-secondary text-white">${dayLabel}</span>
                                    <div class="small text-muted mt-1">Vence: ${expires}</div>
                                </div>
                            </div>
                        </button>
                    </h2>
                    <div id="collapse${routineId}" class="accordion-collapse collapse" aria-labelledby="heading${routineId}" data-bs-parent="#printPreviewAccordion">
                        <div class="accordion-body bg-panel text-white">
                            <div class="small text-secondary mb-3">${r.description || ''}</div>
                             <div class="routine-preview-scroll d-flex flex-column gap-2" style="max-height: none;">
                                ${detailsHtml}
                            </div>
                        </div>
                    </div>
                </div>`;
            });
            html += '</div>';
            modalBody.innerHTML = html;
        }

        const modal = new bootstrap.Modal(modalEl);
        modal.show();
    }

    function goToBuilder() {
        window.location.href = "/workout/routines/builder-guided";
    }
</script>
<script src="/static/js/utils/routine_renderer.js"></script>
<script src="/static/js/loader.js"></script>
{% endblock %}