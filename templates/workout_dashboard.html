{% extends 'layout.html' %}

{% block title %}Smart Workout - Dashboard{% endblock %}

{% block head %}
<link href="/static/css/assigned_routines.css" rel="stylesheet">
<link href="/static/css/dashboard.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h2 class="fw-bold text-cyber-green">Smart Workout Hub</h2>
        <p class="text-secondary">Tu centro de comando para hipertrofia y fuerza.</p>
    </div>
    {% if is_admin %}
    <div class="col-md-4 d-flex justify-content-md-end align-items-center">
        <div class="w-100" style="max-width: 360px;">
            <label class="text-secondary small fw-bold mb-1">VISUALIZAR COMO:</label>
            <div class="d-flex gap-2">
                <div class="position-relative flex-grow-1">
                    <div class="input-group">
                        <input type="text" class="form-control" id="userSearchTerm"
                            placeholder="Buscar: nombre, email o ID...">
                        <button class="btn btn-outline-secondary" type="button" id="btnLookupUser">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <input type="hidden" id="userSelector" value="{{ current_user_id }}">
                    <div id="userSearchResults" class="list-group mt-1 position-absolute shadow-sm"
                        style="z-index: 1000; display: none; width: 100%;"></div>
                </div>
                <button id="btnClearUserSearch" class="btn btn-outline-secondary" title="Limpiar">
                    <i class="fas fa-times"></i>
                </button>
                <button id="btnRefreshUser" class="btn btn-dark border-secondary" title="Refrescar">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<div class="row g-4 mb-5">
    <!-- Tarjetas de accion -->
    <div class="col-md-6 col-lg-4">
        <div class="card bg-panel border-0 shadow h-100 hover-card" onclick="location.href='/admin/routines/builder'">
            <div class="card-body text-center py-4 py-md-5">
                <i class="fas fa-plus-circle fa-4x text-cyber-blue mb-3"></i>
                <h4 class="text-white">Crear Rutina</h4>
                <p class="text-muted">Dise?a un nuevo plan de entrenamiento.</p>
            </div>
        </div>
    </div>

    <div class="col-md-6 col-lg-4">
        <div class="card bg-panel border-0 shadow h-100 hover-card" onclick="location.href='/admin/exercises'">
            <div class="card-body text-center py-4 py-md-5">
                <i class="fas fa-dumbbell fa-4x text-cyber-orange mb-3"></i>
                <h4 class="text-white">Catálogo Ejercicios</h4>
                <p class="p-muted">Gestiona tu librería de movimientos.</p>
            </div>
        </div>
    </div>

    {% if is_admin %}
    <div class="col-md-6 col-lg-4">
        <div class="card bg-panel border-0 shadow h-100 hover-card"
            onclick="location.href='/admin/routines/assign?source=user'">
            <div class="card-body text-center py-4 py-md-5">
                <i class="fas fa-users-cog fa-4x text-success mb-3"></i>
                <h4 class="text-white">Asignar Rutinas</h4>
                <p class="text-muted">Gestiona y asigna planes a usuarios.</p>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<div class="row g-4 mb-4">
    <!-- Fila de estadisticas -->
    <div class="col-lg-8">
        <div class="card bg-panel border-0 shadow h-100">
            <div class="card-header border-secondary text-white fw-bold">
                <i class="fas fa-chart-line text-cyber-blue me-2"></i>Progreso (Volumen vs Peso)
            </div>
            <div class="card-body">
                <canvas id="volumeChart" style="max-height: 250px;"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card bg-panel border-0 shadow h-100">
            <div class="card-header border-secondary text-white fw-bold">
                <i class="fas fa-th text-cyber-green me-2"></i>Consistencia (Heatmap)
            </div>
            <div class="card-body d-flex flex-column align-items-center justify-content-center">
                <div id="heatmapGrid" class="heatmap-grid mb-3"></div>
                <small class="text-muted">Últimos 3 meses</small>
            </div>
        </div>
    </div>
</div>

<style>
    @media (max-width: 768px) {
        h2.fw-bold {
            font-size: 1.75rem;
        }

        .card-body {
            padding: 1rem;
        }

        .heatmap-grid {
            max-width: 100%;
            justify-content: center;
        }

        /* Make user selector full width on mobile */
        #userSelector {
            width: 100%;
        }

        /* Adjust search input width */
        #searchInput {
            max-width: 100% !important;
            width: 100%;
            margin-top: 0.5rem;
        }

        /* Flex improvements for header */
        .d-flex.justify-content-between.align-items-end.mb-3 {
            flex-direction: column;
            align-items: stretch !important;
            gap: 0.5rem;
        }

        .input-group.w-auto {
            width: 100% !important;
        }

        /* Smaller text/icons for mobile cards */
        .card-title {
            font-size: 1.1rem;
        }

        .fa-4x {
            font-size: 3em;
        }
    }
</style>

{% include 'components/assigned_routines.html' %}
<div class="mb-4"></div>

{% include 'components/created_routines.html' %}

{% include 'components/session_history.html' %}



<!-- CDN de Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="/static/js/utils/routine_renderer.js"></script>
<script src="/static/js/assigned_routines.js"></script>
<script src="/static/js/user_search.js"></script>


<style>
    .text-cyber-green {
        color: #00ff9d;
    }

    .text-cyber-blue {
        color: #00d2ff;
    }

    .text-cyber-orange {
        color: #ff9d00;
    }

    .hover-card {
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
    }

    .hover-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
    }

    /* Heatmap Grid */
    .heatmap-grid {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        /* aprox weeks/days grid */
        gap: 4px;
        width: 100%;
        max-width: 280px;
    }

    .heatmap-cell {
        aspect-ratio: 1;
        background-color: #2c3035;
        /* inactive */
        border-radius: 2px;
    }

    .heatmap-cell.level-1 {
        background-color: #0e4429;
    }

    .heatmap-cell.level-2 {
        background-color: #006d32;
    }

    .heatmap-cell.level-3 {
        background-color: #26a641;
    }

    .heatmap-cell.level-4 {
        background-color: #39d353;
        box-shadow: 0 0 5px #39d353;
    }

    .btn-cyber-success {
        background: linear-gradient(45deg, #00ff9d, #10b981);
        color: #000;
        border: none;
        box-shadow: 0 0 15px rgba(0, 255, 157, 0.4);
        transition: all 0.3s ease;
    }

    .btn-cyber-success:hover {
        background: linear-gradient(45deg, #10b981, #059669);
        box-shadow: 0 0 25px rgba(0, 255, 157, 0.6);
        color: #000;
        transform: translateY(-2px);
    }
</style>

<script>
    window.currentUserId = {{ current_user_id | default ('', true) | tojson }};

    // Admin Override logic
    const userSelector = document.getElementById('userSelector');

    function getActiveUserId() {
        // If the selector exists (Admin mode), strictly respect its value (even if empty)
        if (userSelector) return userSelector.value;
        // Only fallback to logged-in user if NOT in admin mode (no selector)
        return window.currentUserId;
    }

    function selectDashboardUser(u) {
        if (!u || !u.user_id) return;
        if (userSelector) userSelector.value = u.user_id;
        try { localStorage.setItem("ai_fitness_uid", u.user_id); } catch (e) { }
        refreshDashboard();
    }

    document.addEventListener("DOMContentLoaded", () => {
        // Sync with local storage if Admin
        if (userSelector) {
            let storedUid = localStorage.getItem("ai_fitness_uid");
            let storedUser = null;
            try {
                const ctx = localStorage.getItem("admin_working_user");
                if (ctx) {
                    const u = JSON.parse(ctx);
                    if (u && u.user_id) {
                        storedUid = u.user_id;
                        storedUser = u;
                    }
                }
            } catch (e) { }
            if (storedUid) {
                userSelector.value = storedUid;
            } else if (window.currentUserId) {
                userSelector.value = window.currentUserId;
            }
            if (storedUser) {
                const searchInput = document.getElementById("userSearchTerm");
                if (searchInput) {
                    const label = storedUser.name || storedUser.username || "";
                    const email = storedUser.email || "";
                    searchInput.value = label && email ? `${label} (${email})` : (label || storedUser.user_id || "");
                }
                selectDashboardUser(storedUser);
            } else if (userSelector.value) {
                refreshDashboard();
            }

            initUserSearch({
                inputId: "userSearchTerm",
                resultsId: "userSearchResults",
                hiddenId: "userSelector",
                buttonId: "btnLookupUser",
                clearButtonId: "btnClearUserSearch",
                storageKey: "admin_working_user",
                onSelect: selectDashboardUser,
                onClear: () => {
                    if (userSelector) userSelector.value = "";
                    refreshDashboard();
                }
            });

            window.addEventListener("admin-user-selected", (evt) => {
                const u = evt.detail || {};
                if (!u.user_id) return;
                selectDashboardUser(u);
            });
            window.addEventListener("admin-user-cleared", () => {
                if (userSelector) userSelector.value = "";
                refreshDashboard();
            });
        } else if (window.currentUserId) {
            try {
                localStorage.setItem("ai_fitness_uid", window.currentUserId);
            } catch (e) { }
        }

        const refreshBtn = document.getElementById('btnRefreshUser');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', () => {
                refreshDashboard();
            });
        }

        // Search Logic
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const cards = document.querySelectorAll('#routinesList > div');
                cards.forEach(card => {
                    const title = card.querySelector('.card-title')?.textContent.toLowerCase() || '';
                    if (title.includes(term)) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
            });
        }

        if (window.initSessionUnitControls) {
            window.initSessionUnitControls();
        }
        refreshDashboard();
    });

    function resetDashboardForNoUser() {
        const assignedList = document.getElementById("routines-list");
        const createdList = document.getElementById("created-routines-list");
        const heatmapGrid = document.getElementById("heatmapGrid");
        const volumeCanvas = document.getElementById("volumeChart");

        if (assignedList) {
            assignedList.innerHTML = '<div class="col-12 text-muted text-center py-3">Selecciona un usuario para ver rutinas asignadas.</div>';
        }
        if (createdList) {
            createdList.innerHTML = '<div class="col-12 text-muted text-center py-3">Selecciona un usuario para ver rutinas creadas.</div>';
        }
        if (heatmapGrid) {
            heatmapGrid.innerHTML = "";
        }
        if (volumeCanvas) {
            const ctx = volumeCanvas.getContext('2d');
            if (window.volumeChart) {
                window.volumeChart.destroy();
                window.volumeChart = null;
            }
            ctx.clearRect(0, 0, volumeCanvas.width, volumeCanvas.height);
            ctx.font = "14px Arial";
            ctx.fillStyle = "#888";
            ctx.fillText("Selecciona un usuario", 10, 50);
        }
    }

    function refreshDashboard() {
        const uid = getActiveUserId();
        if (!uid) {
            resetDashboardForNoUser();
            return;
        }
        if (window.loadRoutines) {
            window.loadRoutines(uid, { returnTo: '/workout/dashboard' });
        }
        if (window.loadCreatedRoutines) {
            window.loadCreatedRoutines({
                returnTo: '/workout/dashboard',
                userId: uid
            });
        }
        loadStats();
        if (window.loadSessions) {
            window.loadSessions(uid);
        }
    }



    async function loadStats() {
        // 1. Volume Chart
        try {
            const uid = getActiveUserId();

            if (!uid) {
                resetDashboardForNoUser();
                return;
            }

            // Fetch Latest Weight for reference
            let latestWeight = null;
            try {
                const mRes = await fetch(`/api/user/${uid}/latest_metrics`);
                if (mRes.ok) {
                    const mData = await mRes.json();
                    latestWeight = mData.weight_kg;
                }
            } catch (e) { console.error("Error fetching latest weight", e); }

            const vRes = await fetch(`/workout/api/stats/volume?user_id=${uid}`);
            const vData = await vRes.json(); // returns array or error
            const cleanVData = Array.isArray(vData) ? vData : [];

            let labels = [];
            let volumeSeries = [];
            let weightSeries = [];

            if (cleanVData.length > 0) {
                labels = cleanVData.map(d => d.date.substring(5)); // MM-DD
                volumeSeries = cleanVData.map(d => d.volume);

                // Use Flat Line for Weight (Robust Approach from /dashboard)
                weightSeries = cleanVData.map(() => latestWeight);
            }

            const canvas = document.getElementById('volumeChart');
            const ctx = canvas.getContext('2d');
            if (window.volumeChartInstance) {
                window.volumeChartInstance.destroy();
                window.volumeChartInstance = null;
            }

            if (labels.length > 0) {
                window.volumeChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [{
                            label: 'Volumen Avg. (kg)',
                            data: volumeSeries,
                            borderColor: '#00d2ff',
                            backgroundColor: 'rgba(0, 210, 255, 0.1)',
                            yAxisID: 'y',
                            tension: 0.3,
                            fill: true
                        }, {
                            label: 'Peso Corporal (kg)',
                            data: weightSeries,
                            borderColor: '#ff9d00',
                            borderDash: [5, 5],
                            tension: 0,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        interaction: { mode: 'index', intersect: false },
                        plugins: { legend: { labels: { color: '#ccc' } } },
                        scales: {
                            x: { ticks: { color: '#888' }, grid: { color: '#333' } },
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                beginAtZero: true,
                                ticks: { color: '#ccc' },
                                grid: { color: '#333' }
                            }
                        }
                    }
                });
            } else {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillText("Sin datos de entrenamiento recientes", 10, 50);
            }
        } catch (e) { console.error("Chart error", e); }

        // 2. Heatmap (Mini grid simulation)
        try {
            const uid = getActiveUserId();
            const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
            const hRes = await fetch(`/workout/api/stats/heatmap?user_id=${uid}&timezone=${encodeURIComponent(tz)}`, {
                credentials: "include"
            });
            const hMap = await hRes.json();
            const grid = document.getElementById("heatmapGrid");

            // Generate last 60 days
            grid.innerHTML = "";
            grid.style.gridTemplateColumns = `repeat(10, 1fr)`; // 6x10 grid?

            const today = new Date();
            for (let i = 59; i >= 0; i--) { // 60 days
                const d = new Date();
                d.setDate(today.getDate() - i);
                const key = d.toLocaleDateString('en-CA');
                const count = hMap[key] || 0;

                const cell = document.createElement("div");
                cell.className = `heatmap-cell level-${Math.min(count * 2, 4)}`; // 0, 2, 4
                if (count === 0) cell.className = "heatmap-cell";
                else if (count >= 2) cell.className = "heatmap-cell level-4";
                else cell.className = "heatmap-cell level-2";

                cell.title = `${key}: ${count} workouts`;
                grid.appendChild(cell);
            }
        } catch (e) { console.error("Heatmap error", e); }
    }


</script>
{% endblock %}