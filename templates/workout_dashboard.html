{% extends 'layout.html' %}

{% block title %}Smart Workout - Dashboard{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h2 class="fw-bold text-cyber-green">Smart Workout Hub</h2>
        <p class="text-secondary">Tu centro de comando para hipertrofia y fuerza.</p>
    </div>
    {% if is_admin %}
    <div class="col-md-4 d-flex justify-content-md-end align-items-center">
        <div class="w-100" style="max-width: 250px;">
            <label class="text-secondary small fw-bold mb-1">VISUALIZAR COMO:</label>
            <select id="userSelector" class="form-select form-select-sm bg-dark text-white border-secondary">
                {% for u in all_users %}
                <option value="{{ u.user_id }}" {% if u.user_id==current_user_id %}selected{% endif %}>
                    {{ u.name }}
                </option>
                {% endfor %}
            </select>
        </div>
    </div>
    {% endif %}
</div>

<div class="row g-4 mb-5">
    <!-- Action Cards -->
    <div class="col-md-6 col-lg-4">
        <div class="card bg-panel border-0 shadow h-100 hover-card" onclick="location.href='/admin/routines/builder'">
            <div class="card-body text-center py-4 py-md-5">
                <i class="fas fa-plus-circle fa-4x text-cyber-blue mb-3"></i>
                <h4 class="text-white">Crear Rutina</h4>
                <p class="text-muted">Diseña un nuevo plan de entrenamiento.</p>
            </div>
        </div>
    </div>

    <div class="col-md-6 col-lg-4">
        <div class="card bg-panel border-0 shadow h-100 hover-card" onclick="location.href='/admin/exercises'">
            <div class="card-body text-center py-4 py-md-5">
                <i class="fas fa-dumbbell fa-4x text-cyber-orange mb-3"></i>
                <h4 class="text-white">Catálogo Ejercicios</h4>
                <p class="p-muted">Gestiona tu librería de movimientos.</p>
            </div>
        </div>
    </div>
</div>


<div class="row g-4 mb-4">
    <!-- STATS ROW -->
    <div class="col-lg-8">
        <div class="card bg-panel border-0 shadow h-100">
            <div class="card-header border-secondary text-white fw-bold">
                <i class="fas fa-chart-line text-cyber-blue me-2"></i>Progreso (Volumen vs Peso)
            </div>
            <div class="card-body">
                <canvas id="volumeChart" style="max-height: 250px;"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card bg-panel border-0 shadow h-100">
            <div class="card-header border-secondary text-white fw-bold">
                <i class="fas fa-th text-cyber-green me-2"></i>Consistencia (Heatmap)
            </div>
            <div class="card-body d-flex flex-column align-items-center justify-content-center">
                <div id="heatmapGrid" class="heatmap-grid mb-3"></div>
                <small class="text-muted">Últimos 3 meses</small>
            </div>
        </div>
    </div>
</div>

<style>
    @media (max-width: 768px) {
        h2.fw-bold {
            font-size: 1.75rem;
        }

        .card-body {
            padding: 1rem;
        }

        .heatmap-grid {
            max-width: 100%;
            justify-content: center;
        }

        /* Make user selector full width on mobile */
        #userSelector {
            width: 100%;
        }

        /* Adjust search input width */
        #searchInput {
            max-width: 100% !important;
            width: 100%;
            margin-top: 0.5rem;
        }

        /* Flex improvements for header */
        .d-flex.justify-content-between.align-items-end.mb-3 {
            flex-direction: column;
            align-items: stretch !important;
            gap: 0.5rem;
        }

        .input-group.w-auto {
            width: 100% !important;
        }

        /* Smaller text/icons for mobile cards */
        .card-title {
            font-size: 1.1rem;
        }

        .fa-4x {
            font-size: 3em;
        }
    }
</style>

<div class="d-flex justify-content-between align-items-end mb-3">
    <h4 class="text-white m-0">Mis Rutinas</h4>
    <div class="input-group input-group-sm w-auto">
        <span class="input-group-text bg-dark border-secondary text-secondary"><i class="fas fa-search"></i></span>
        <input type="text" id="searchInput" class="form-control bg-dark text-white border-secondary"
            placeholder="Buscar rutina..." style="max-width: 200px;">
    </div>
</div>
<div class="row g-3" id="routinesList">
    <!-- Loaded via JS -->
    <div class="col-12 text-center py-5">
        <div class="spinner-border text-secondary" role="status"></div>
    </div>
</div>

<div class="row g-4 mt-4">
    <div class="col-12">
        <div class="card bg-panel border-0 shadow h-100">
            <div class="card-header border-secondary text-white fw-bold">
                <i class="fas fa-history text-cyber-green me-2"></i>Historial de Sesiones
            </div>
            <div class="card-body">
                <div id="sessionsList" class="d-flex flex-column gap-3">
                    <div class="text-center text-muted py-4">
                        <div class="spinner-border text-secondary" role="status"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    .text-cyber-green {
        color: #00ff9d;
    }

    .text-cyber-blue {
        color: #00d2ff;
    }

    .text-cyber-orange {
        color: #ff9d00;
    }

    .hover-card {
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
    }

    .hover-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
    }

    /* Heatmap Grid */
    .heatmap-grid {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        /* aprox weeks/days grid */
        gap: 4px;
        width: 100%;
        max-width: 280px;
    }

    .heatmap-cell {
        aspect-ratio: 1;
        background-color: #2c3035;
        /* inactive */
        border-radius: 2px;
    }

    .heatmap-cell.level-1 {
        background-color: #0e4429;
    }

    .heatmap-cell.level-2 {
        background-color: #006d32;
    }

    .heatmap-cell.level-3 {
        background-color: #26a641;
    }

    .heatmap-cell.level-4 {
        background-color: #39d353;
        box-shadow: 0 0 5px #39d353;
    }
</style>

<script>
    window.currentUserId = {{ current_user_id | default ('', true) | tojson }};

    // Admin Override logic
    const userSelector = document.getElementById('userSelector');

    function getActiveUserId() {
        if (userSelector) return userSelector.value;
        return window.currentUserId;
    }

    document.addEventListener("DOMContentLoaded", () => {
        // Sync with local storage if Admin
        if (userSelector) {
            const storedUid = localStorage.getItem("ai_fitness_uid");
            if (storedUid) {
                // Try to select if exists in options
                const option = userSelector.querySelector(`option[value="${storedUid}"]`);
                if (option) {
                    userSelector.value = storedUid;
                }
            }

            userSelector.addEventListener('change', () => {
                localStorage.setItem("ai_fitness_uid", userSelector.value);
                refreshDashboard();
            });
        } else if (window.currentUserId) {
            try {
                localStorage.setItem("ai_fitness_uid", window.currentUserId);
            } catch (e) { }
        }

        // Search Logic
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const cards = document.querySelectorAll('#routinesList > div');
                cards.forEach(card => {
                    const title = card.querySelector('.card-title')?.textContent.toLowerCase() || '';
                    if (title.includes(term)) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
            });
        }

        refreshDashboard();
    });

    function refreshDashboard() {
        loadRoutines();
        loadStats();
        loadSessions();
    }

    async function loadRoutines() {
        const uid = getActiveUserId();
        const res = await fetch(`/api/routines?user_id=${uid}`);
        const data = await res.json();
        const container = document.getElementById("routinesList");

        if (data.length === 0) {
            container.innerHTML = `<p class="text-muted col-12 text-center">No tienes rutinas creadas aún.</p>`;
            return;
        }


        const countExercises = (routine) => {
            const items = Array.isArray(routine.items) ? routine.items : [];
            const hasInlineGroups = items.some(item => Array.isArray(item.items));
            if (hasInlineGroups) {
                let total = 0;
                items.forEach(item => {
                    if (item.item_type === "group" || Array.isArray(item.items)) {
                        const groupItems = Array.isArray(item.items) ? item.items : [];
                        total += groupItems.filter(entry => entry && entry.item_type !== "rest").length;
                    } else if (item.item_type === "exercise") {
                        total += 1;
                    }
                });
                return total;
            }
            return items.filter(item => item && item.item_type === "exercise").length;
        };

        container.innerHTML = data.map(r => `
        <div class="col-md-6 col-lg-4">
            <div class="card bg-dark border border-secondary text-white h-100">
                <div class="card-body">
                    <h5 class="card-title text-cyber-green fw-bold">${r.name}</h5>
                    <p class="card-text small text-secondary">${r.description || 'Sin descripción'}</p>
                    <span class="badge bg-secondary mb-3">${countExercises(r)} Ejercicios</span>
                    
                    <div class="d-grid">
                        <a href="/workout/run/${r._id}" class="btn btn-cyber-primary">
                            <i class="fas fa-play me-2"></i> INICIAR
                        </a>
                    </div>
                </div>
            </div>
        </div>
    `).join("");
    }

    async function loadStats() {
        // 1. Volume Chart
        try {
            const uid = getActiveUserId();
            const vRes = await fetch(`/workout/api/stats/volume?user_id=${uid}`);
            const vData = await vRes.json();

            const ctx = document.getElementById('volumeChart').getContext('2d');
            if (vData.length > 0) {
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: vData.map(d => d.date.substring(5)), // MM-DD
                        datasets: [{
                            label: 'Volumen Total (kg)',
                            data: vData.map(d => d.volume),
                            borderColor: '#00d2ff',
                            backgroundColor: 'rgba(0, 210, 255, 0.1)',
                            yAxisID: 'y',
                            tension: 0.3,
                            fill: true
                        }, {
                            label: 'Peso Corporal (kg)',
                            data: vData.map(d => d.weight),
                            borderColor: '#ff9d00',
                            borderDash: [5, 5],
                            yAxisID: 'y1',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        interaction: { mode: 'index', intersect: false },
                        plugins: { legend: { labels: { color: '#ccc' } } },
                        scales: {
                            x: { ticks: { color: '#888' }, grid: { color: '#333' } },
                            y: { type: 'linear', display: true, position: 'left', ticks: { color: '#00d2ff' }, grid: { color: '#333' } },
                            y1: { type: 'linear', display: true, position: 'right', ticks: { color: '#ff9d00' }, grid: { drawOnChartArea: false } }
                        }
                    }
                });
            } else {
                ctx.font = "14px Arial";
                ctx.fillStyle = "#888";
                ctx.fillText("Sin datos suficientes", 10, 50);
            }
        } catch (e) { console.error("Chart error", e); }

        // 2. Heatmap (Mini grid simulation)
        try {
            const uid = getActiveUserId();
            const hRes = await fetch(`/workout/api/stats/heatmap?user_id=${uid}`); // { "2025-01-01": 1 }
            const hMap = await hRes.json();
            const grid = document.getElementById("heatmapGrid");

            // Generate last 60 days
            grid.innerHTML = "";
            grid.style.gridTemplateColumns = `repeat(10, 1fr)`; // 6x10 grid?

            const today = new Date();
            for (let i = 59; i >= 0; i--) { // 60 days
                const d = new Date();
                d.setDate(today.getDate() - i);
                const key = d.toISOString().split('T')[0];
                const count = hMap[key] || 0;

                const cell = document.createElement("div");
                cell.className = `heatmap-cell level-${Math.min(count * 2, 4)}`; // 0, 2, 4
                if (count === 0) cell.className = "heatmap-cell";
                else if (count >= 2) cell.className = "heatmap-cell level-4";
                else cell.className = "heatmap-cell level-2";

                cell.title = `${key}: ${count} workouts`;
                grid.appendChild(cell);
            }
        } catch (e) { console.error("Heatmap error", e); }
    }

    let sessionData = [];

    const formatDate = (value) => {
        const d = value ? new Date(value) : null;
        if (!d || Number.isNaN(d.getTime())) return "-";
        return d.toLocaleString("es-ES", { dateStyle: "medium", timeStyle: "short" });
    };

    const renderSessions = (data) => {
        const container = document.getElementById("sessionsList");
        if (!Array.isArray(data) || data.length === 0) {
            container.innerHTML = `<p class="text-muted text-center m-0">Aún no hay sesiones registradas.</p>`;
            return;
        }

        container.innerHTML = data.map((session, index) => {
            const sets = Array.isArray(session.sets) ? session.sets : [];
            const totalSets = sets.length;
            const duration = session.duration_seconds
                ? `${Math.floor(session.duration_seconds / 60)}min`
                : '-';

            // Group sets by exercise
            const exerciseGroups = {};
            sets.forEach(set => {
                const exId = set.exercise_id || set.exerciseId || 'unknown';
                if (!exerciseGroups[exId]) {
                    exerciseGroups[exId] = {
                        name: set.name || set.exercise_name || set.exerciseName || set.exercise_id || set.exerciseId || 'Ejercicio',
                        sets: []
                    };
                }
                exerciseGroups[exId].sets.push(set);
            });

            const detailsRows = Object.entries(exerciseGroups).flatMap(([exId, group]) => {
                return group.sets.map((set, idx) => {
                    const timeValue = set.time_seconds != null ? set.time_seconds : set.time;
                    return `
                        <tr class="text-center">
                            <td class="text-start">${group.name}</td>
                            <td>${idx + 1}</td>
                            <td>${set.weight || '-'}</td>
                            <td>${set.reps || '-'}</td>
                            <td>${timeValue != null ? `${timeValue}s` : '-'}</td>
                            <td>${set.rpe || '-'}</td>
                        </tr>
                    `;
                });
            }).join('');

            const detailsHtml = `
                <div class="table-responsive">
                    <table class="table table-sm table-dark table-bordered mb-0">
                        <thead>
                            <tr class="text-center">
                                <th>Ejercicio</th>
                                <th>Serie</th>
                                <th>Peso (kg)</th>
                                <th>Reps</th>
                                <th>Tiempo</th>
                                <th>RPE</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${detailsRows || `
                                <tr class="text-center">
                                    <td colspan="6" class="text-muted">No hay detalles de ejercicios disponibles.</td>
                                </tr>
                            `}
                        </tbody>
                    </table>
                </div>
            `;

            return `
                <div class="border border-secondary rounded mb-3 bg-dark-elem">
                    <div class="d-flex justify-content-between align-items-center p-3 cursor-pointer" 
                         onclick="toggleSessionDetails(${index})" 
                         style="cursor: pointer;">
                        <div>
                            <div class="text-white fw-bold">
                                <i class="fas fa-dumbbell text-cyber-green me-2"></i>
                                ${session.routine_name || session.routine_id || 'Rutina'}
                            </div>
                            <div class="text-secondary small">
                                <i class="far fa-calendar me-1"></i>
                                ${formatDate(session.start_time || session.created_at)}
                            </div>
                        </div>
                        <div class="text-end">
                            <div class="text-secondary small">
                                <span class="me-3">
                                    <i class="fas fa-weight-hanging text-cyber-blue me-1"></i>
                                    <span class="text-white">${session.total_volume || 0}</span> kg
                                </span>
                                <span class="me-3">
                                    <i class="fas fa-list text-cyber-orange me-1"></i>
                                    <span class="text-white">${totalSets}</span> series
                                </span>
                                <span>
                                    <i class="far fa-clock text-cyber-green me-1"></i>
                                    <span class="text-white">${duration}</span>
                                </span>
                            </div>
                            <div class="text-secondary small mt-1">
                                <i id="chevron-${index}" class="fas fa-chevron-down"></i>
                                <span class="ms-1">Ver detalles</span>
                            </div>
                        </div>
                    </div>
                    <div id="session-details-${index}" class="p-3 pt-0" style="display: none;">
                        <hr class="border-secondary my-2">
                        ${session.body_weight ? `
                            <div class="mb-3 text-secondary small">
                                <i class="fas fa-user text-cyber-orange me-2"></i>
                                Peso corporal: <span class="text-white">${session.body_weight} kg</span>
                            </div>
                        ` : ''}
                        ${detailsHtml || '<p class="text-muted small">No hay detalles de ejercicios disponibles.</p>'}
                    </div>
                </div>
            `;
        }).join('');
    };

    window.toggleSessionDetails = function (index) {
        const details = document.getElementById(`session-details-${index}`);
        const chevron = document.getElementById(`chevron-${index}`);

        if (details.style.display === 'none') {
            details.style.display = 'block';
            chevron.classList.remove('fa-chevron-down');
            chevron.classList.add('fa-chevron-up');
        } else {
            details.style.display = 'none';
            chevron.classList.remove('fa-chevron-up');
            chevron.classList.add('fa-chevron-down');
        }
    };

    async function loadSessions() {
        const container = document.getElementById("sessionsList");
        try {
            const uid = getActiveUserId();
            const res = await fetch(`/workout/api/sessions?user_id=${uid}`);
            const data = await res.json();
            sessionData = Array.isArray(data) ? data : [];
            renderSessions(sessionData);
        } catch (e) {
            console.error("Error loading sessions:", e);
            container.innerHTML = `<p class="text-danger text-center m-0">Error cargando sesiones.</p>`;
        }
    }

</script>
{% endblock %}