{% extends 'layout.html' %}

{% block title %}Proposal Runner - AI Fitness{% endblock %}

{% block head %}
<!-- Estilos Originales -->
<link href="/static/css/runner/base.css" rel="stylesheet">
<link href="/static/css/runner/components.css" rel="stylesheet">
<link href="/static/css/runner/modals.css" rel="stylesheet">
<link href="/static/css/runner/overlays.css" rel="stylesheet">
<link href="/static/css/runner/responsive.css" rel="stylesheet">

<!-- Estilos Propuesta -->
<link href="/static/proposals/workout_runner/css/ProposalStyles.css" rel="stylesheet">
{% endblock %}

{% block sidebar %}{% endblock %}

{% block content %}
<div id="react-root" class="h-100"></div>

{% include 'partials/runner/video_modal.html' %}
{% endblock %}

{% block page_scripts %}
<!-- 1. DEPENDENCIAS EXTERNAS -->
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<!-- 2. NAMESPACES -->
<script src="/static/js/runner/namespace.js"></script>
<script src="/static/proposals/workout_runner/namespace.js"></script>
<script src="/static/js/runner/bootstrap.js"></script>

<!-- 3. DATA INJECTION -->
<script>
    (function () {
        console.log("3. Initializing __RUNNER__...");
        window.__RUNNER__ = {
            routine: {{ routine | tojson | safe }},
            currentUserName: {{ (current_user_name or "") | tojson | safe }},
            currentUserId: {{ (current_user_id or "") | tojson | safe }},
            restoredState: {{ (restored_state or None) | tojson | safe }}
        };

        // Aliases globales
        window.initialRoutine = window.__RUNNER__.routine;
        window.currentUserName = window.__RUNNER__.currentUserName;
        window.currentUserId = window.__RUNNER__.currentUserId;
        window.restoredState = window.__RUNNER__.restoredState;
        window.RESTORED_STATE = window.__RUNNER__.restoredState;
        window.CURRENT_USER_ID = window.__RUNNER__.currentUserId;

        console.log("Data loaded:", { routine: !!window.initialRoutine });
    })();
</script>

<!-- 4. LOGICA Y UTILIDADES -->
<script src="/static/js/runner/utils.js"></script>
<script src="/static/js/runner/constants.js"></script>
<script src="/static/js/runner/logic.js"></script>
<script type="text/babel" src="/static/js/runner/hooks/useWorkout.js"></script>

<!-- 5. COMPONENTES DEL SHELL -->
<script type="text/babel" src="/static/js/runner/components/MessageBar.js"></script>
<script type="text/babel" src="/static/js/runner/components/ConfirmModal.js"></script>
<script type="text/babel" src="/static/js/runner/components/PlateCalculatorModal.js"></script>
<script type="text/babel" src="/static/js/runner/components/SubstitutesModal.js"></script>
<script type="text/babel" src="/static/js/runner/components/RMCalculatorModal.js"></script>
<script type="text/babel" src="/static/js/runner/components/Header.js"></script>
<script type="text/babel" src="/static/js/runner/components/PendingPanel.js"></script>
<script type="text/babel" src="/static/js/runner/components/RestOverlay.js"></script>
<script type="text/babel" src="/static/js/runner/components/RoutineDetails.js"></script>
<script type="text/babel" src="/static/js/runner/components/PreStart.js"></script>

<!-- 6. COMPONENTES DE LA PROPUESTA -->
<script type="text/babel" src="/static/proposals/workout_runner/components/ProgressTimeline.js"></script>
<script type="text/babel" src="/static/proposals/workout_runner/components/QuickActionControls.js"></script>
<script type="text/babel" src="/static/proposals/workout_runner/components/ModernExerciseCard.js"></script>
<script type="text/babel" src="/static/proposals/workout_runner/components/ModernApp.js"></script>

<!-- 7. ARRANQUE (MOUNTING) -->
<script type="text/babel">
    (function () {
        let currentTries = 0;
        const maxLimit = 100;

        const bootApp = () => {
            currentTries++;
            const reactReady = window.React && window.ReactDOM;
            const runnerReady = window.Runner && window.Runner.hooks && window.Runner.hooks.WorkoutProvider;
            const proposalReady = window.Runner && window.Runner.proposals && window.Runner.proposals.ModernApp;

            if (reactReady && runnerReady && proposalReady) {
                console.log("7. Dependencias listas. Montando...");
                const { WorkoutProvider } = window.Runner.hooks;
                const { ModernApp } = window.Runner.proposals;

                if (!window.initialRoutine) {
                    console.error("CRITICAL: Routine missing at mount.");
                    return;
                }

                try {
                    const container = document.getElementById('react-root');
                    const rootInstance = ReactDOM.createRoot(container);
                    rootInstance.render(
                        <WorkoutProvider routine={window.initialRoutine}>
                            <ModernApp />
                        </WorkoutProvider>
                    );
                } catch (err) {
                    console.error("MOUNT ERROR:", err);
                }
            } else if (currentTries < maxLimit) {
                if (currentTries % 20 === 0) console.warn("Esperando...", { reactReady, runnerReady, proposalReady });
                setTimeout(bootApp, 50);
            } else {
                console.error("FAILED TO LOAD");
                document.getElementById('react-root').innerHTML = '<div class="p-5 text-center text-danger">Error de Carga</div>';
            }
        };

        bootApp();
    })();
</script>
{% endblock %}
